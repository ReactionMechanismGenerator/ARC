

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>arc.species.conformers &mdash; ARC 1.1.0 Documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> ARC
          

          
          </a>

          
            
            
              <div class="version">
                1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../running.html">Running ARC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced.html">Advanced Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../output.html">Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">ARCâ€™s API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools.html">Standalone tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../media.html">Media</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cite.html">How to cite ARC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../licence.html">Licence</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ARC</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>arc.species.conformers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for arc.species.conformers</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A module for (non-TS) species conformer generation</span>

<span class="sd">Note:</span>
<span class="sd">    variables that contain atom indices such as torsions and tops are 1-indexed,</span>
<span class="sd">    while atoms in Molecules are 0-indexed.</span>

<span class="sd">Todo:</span>
<span class="sd">    * Consider boat-chair conformers (https://en.wikipedia.org/wiki/Cyclohexane_conformation)</span>
<span class="sd">    * finally, consider h-bonds</span>
<span class="sd">    * Does it take the scan energy into account when generating combinations??</span>
<span class="sd">    * The secretary problem - incorporate for stochastic searching</span>
<span class="sd">    * What&#39;s the confirmed bottleneck?</span>

<span class="sd">conformers is a list of dictionaries, each with the following keys::</span>

<span class="sd">    {&#39;xyz&#39;: &lt;dict&gt;,</span>
<span class="sd">     &#39;index&#39;: &lt;int&gt;,</span>
<span class="sd">     &#39;FF energy&#39;: &lt;float&gt;,</span>
<span class="sd">     &#39;source&#39;: &lt;str&gt;,</span>
<span class="sd">     &#39;torsion_dihedrals&#39;: {&lt;torsion tuple 0&gt;: angle 0,</span>
<span class="sd">                           &lt;torsion tuple 1&gt;: angle 1,</span>
<span class="sd">     }</span>


<span class="sd">Module workflow::</span>

<span class="sd">    generate_conformers</span>
<span class="sd">        generate_force_field_conformers</span>
<span class="sd">            get_force_field_energies, rdkit_force_field or openbabel_force_field_on_rdkit_conformers,</span>
<span class="sd">            determine_dihedrals</span>
<span class="sd">        deduce_new_conformers</span>
<span class="sd">            get_torsion_angles, determine_torsion_symmetry, determine_torsion_sampling_points,</span>
<span class="sd">            change_dihedrals_and_force_field_it</span>
<span class="sd">        get_lowest_confs</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">openbabel</span> <span class="kn">import</span> <span class="n">openbabel</span> <span class="k">as</span> <span class="n">ob</span>
<span class="kn">from</span> <span class="nn">openbabel</span> <span class="kn">import</span> <span class="n">pybel</span> <span class="k">as</span> <span class="n">pyb</span>
<span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem.rdchem</span> <span class="kn">import</span> <span class="n">EditableMol</span> <span class="k">as</span> <span class="n">RDMol</span>

<span class="kn">import</span> <span class="nn">rmgpy.molecule.group</span> <span class="k">as</span> <span class="nn">gr</span>
<span class="kn">from</span> <span class="nn">rmgpy.molecule.converter</span> <span class="kn">import</span> <span class="n">to_ob_mol</span>
<span class="kn">from</span> <span class="nn">rmgpy.molecule.molecule</span> <span class="kn">import</span> <span class="n">Atom</span><span class="p">,</span> <span class="n">Bond</span><span class="p">,</span> <span class="n">Molecule</span>
<span class="kn">from</span> <span class="nn">rmgpy.molecule.element</span> <span class="kn">import</span> <span class="n">C</span> <span class="k">as</span> <span class="n">C_ELEMENT</span><span class="p">,</span> <span class="n">H</span> <span class="k">as</span> <span class="n">H_ELEMENT</span><span class="p">,</span> <span class="n">F</span> <span class="k">as</span> <span class="n">F_ELEMENT</span><span class="p">,</span> <span class="n">Cl</span> <span class="k">as</span> <span class="n">Cl_ELEMENT</span><span class="p">,</span> <span class="n">I</span> <span class="k">as</span> <span class="n">I_ELEMENT</span>

<span class="kn">from</span> <span class="nn">arc.common</span> <span class="kn">import</span> <span class="p">(</span><span class="n">convert_list_index_0_to_1</span><span class="p">,</span>
                        <span class="n">determine_top_group_indices</span><span class="p">,</span>
                        <span class="n">get_single_bond_length</span><span class="p">,</span>
                        <span class="n">generate_resonance_structures</span><span class="p">,</span>
                        <span class="n">logger</span><span class="p">,</span>
                        <span class="p">)</span>
<span class="kn">from</span> <span class="nn">arc.exceptions</span> <span class="kn">import</span> <span class="n">ConformerError</span><span class="p">,</span> <span class="n">InputError</span>
<span class="kn">import</span> <span class="nn">arc.plotter</span>
<span class="kn">from</span> <span class="nn">arc.species</span> <span class="kn">import</span> <span class="n">converter</span><span class="p">,</span> <span class="n">vectors</span>


<span class="c1"># The number of conformers to generate per range of heavy atoms in the molecule</span>
<span class="c1"># (will be increased if there are chiral centers)</span>
<span class="n">CONFS_VS_HEAVY_ATOMS</span> <span class="o">=</span> <span class="p">{(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span> <span class="mi">75</span><span class="p">,</span>
                        <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">):</span> <span class="mi">500</span><span class="p">,</span>
                        <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">29</span><span class="p">):</span> <span class="mi">1000</span><span class="p">,</span>
                        <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">59</span><span class="p">):</span> <span class="mi">2500</span><span class="p">,</span>
                        <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">99</span><span class="p">):</span> <span class="mi">5000</span><span class="p">,</span>
                        <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;inf&#39;</span><span class="p">):</span> <span class="mi">7500</span><span class="p">,</span>
                        <span class="p">}</span>

<span class="c1"># The number of conformers to generate per range of potential torsions in the molecule</span>
<span class="c1"># (will be increased if there are chiral centers)</span>
<span class="n">CONFS_VS_TORSIONS</span> <span class="o">=</span> <span class="p">{(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mi">75</span><span class="p">,</span>
                     <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span> <span class="mi">500</span><span class="p">,</span>
                     <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">19</span><span class="p">):</span> <span class="mi">1000</span><span class="p">,</span>
                     <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">34</span><span class="p">):</span> <span class="mi">2500</span><span class="p">,</span>
                     <span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="mi">49</span><span class="p">):</span> <span class="mi">5000</span><span class="p">,</span>
                     <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;inf&#39;</span><span class="p">):</span> <span class="mi">7500</span><span class="p">,</span>
                     <span class="p">}</span>

<span class="c1"># The resolution (in degrees) for scanning smeared wells</span>
<span class="n">SMEARED_SCAN_RESOLUTIONS</span> <span class="o">=</span> <span class="mf">30.0</span>

<span class="c1"># An energy threshold (in kJ/mol) above which wells in a torsion will not be considered (rel. to the most stable well)</span>
<span class="n">DE_THRESHOLD</span> <span class="o">=</span> <span class="mf">5.</span>

<span class="c1"># The gap (in degrees) that defines different wells</span>
<span class="n">WELL_GAP</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1"># The maximum number of times to iteratively search for the lowest conformer</span>
<span class="n">MAX_COMBINATION_ITERATIONS</span> <span class="o">=</span> <span class="mi">25</span>

<span class="c1"># A threshold below which all combinations will be generated. Above it just samples of the entire search space.</span>
<span class="n">COMBINATION_THRESHOLD</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># Consolidation tolerances for Z matrices</span>
<span class="n">CONSOLIDATION_TOLS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="mf">1e-2</span><span class="p">}</span>

<span class="n">CHEAT_SHEET</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;[H][H]&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="n">converter</span><span class="o">.</span><span class="n">str_to_xyz</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;H  0.0  0.0  0.3715170</span>
<span class="s2">                                                         H  0.0  0.0 -0.3715170&quot;&quot;&quot;</span><span class="p">),</span>
                          <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="s1">&#39;FF energy&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;CHEAT_SHEET&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;torsion_dihedrals&#39;</span><span class="p">:</span> <span class="p">{}},</span>
               <span class="s1">&#39;[CH2]&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="n">converter</span><span class="o">.</span><span class="n">str_to_xyz</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;C  0.0	0.000000  0.1051320</span>
<span class="s2">                                                        H  0.0  0.988263 -0.3153960</span>
<span class="s2">                                                        H  0.0 -0.988263 -0.3153960&quot;&quot;&quot;</span><span class="p">),</span>
                         <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Singlet CH2 forms the same H-C-H angle as triplet CH2</span>
                         <span class="s1">&#39;FF energy&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;CHEAT_SHEET&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;torsion_dihedrals&#39;</span><span class="p">:</span> <span class="p">{}},</span>
               <span class="s1">&#39;[CH]=C&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="n">converter</span><span class="o">.</span><span class="n">str_to_xyz</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;C  0.0513140  0.7351300  0.0000000</span>
<span class="s2">                                                         C  0.0513140 -0.5980320  0.0000000</span>
<span class="s2">                                                         H -0.7050560  1.5248940  0.0000000</span>
<span class="s2">                                                         H -0.8925320 -1.1684180  0.0000000</span>
<span class="s2">                                                         H  0.9818240 -1.1790600  0.0000000&quot;&quot;&quot;</span><span class="p">),</span>
                          <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="s1">&#39;FF energy&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;CHEAT_SHEET&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;torsion_dihedrals&#39;</span><span class="p">:</span> <span class="p">{}}</span>
               <span class="p">}</span>


<div class="viewcode-block" id="cheat_sheet"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.cheat_sheet">[docs]</a><span class="k">def</span> <span class="nf">cheat_sheet</span><span class="p">(</span><span class="n">mol_list</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Molecule</span><span class="p">],</span> <span class="n">Molecule</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the species is in the cheat sheet, and return its correct xyz if it is.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol_list (Union[List[Molecule], Molecule]): Molecule objects to consider (or Molecule, resonance structures will be generated).</span>
<span class="sd">    </span>
<span class="sd">    Returns: Optional[lis[Dict]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mol_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol_list</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">mol_list</span>
    <span class="k">for</span> <span class="n">smiles</span> <span class="ow">in</span> <span class="n">CHEAT_SHEET</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">cheat_mol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">(</span><span class="n">smiles</span><span class="o">=</span><span class="n">smiles</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">mol_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cheat_mol</span><span class="o">.</span><span class="n">is_isomorphic</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">CHEAT_SHEET</span><span class="p">[</span><span class="n">smiles</span><span class="p">]]</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="generate_conformers"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.generate_conformers">[docs]</a><span class="k">def</span> <span class="nf">generate_conformers</span><span class="p">(</span><span class="n">mol_list</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Molecule</span><span class="p">],</span> <span class="n">Molecule</span><span class="p">],</span>
                        <span class="n">label</span><span class="p">,</span>
                        <span class="n">xyzs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">torsions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">tops</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">multiplicity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">num_confs_to_generate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">n_confs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">e_confs</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
                        <span class="n">de_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">smeared_scan_res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">combination_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">force_field</span><span class="o">=</span><span class="s1">&#39;MMFF94s&#39;</span><span class="p">,</span>
                        <span class="n">max_combination_iterations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">diastereomers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">return_all_conformers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">plot_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">print_logs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">]]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate conformers for (non-TS) species starting from a list of RMG Molecules.</span>
<span class="sd">    (resonance structures are assumed to have already been generated and included in the molecule list)</span>

<span class="sd">    Args:</span>
<span class="sd">        mol_list (Union[List[Molecule], Molecule]): Molecule objects to consider (or Molecule, resonance structures will be generated).</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        xyzs (list), optional: A list of user guess xyzs that will also be taken into account, each in a dict format.</span>
<span class="sd">        torsions (list, optional): A list of all possible torsions in the molecule. Will be determined if not given.</span>
<span class="sd">        tops (list, optional): A list of tops corresponding to torsions. Will be determined if not given.</span>
<span class="sd">        charge (int, optional): The species charge. Used to perceive a molecule from xyz.</span>
<span class="sd">        multiplicity (int, optional): The species multiplicity. Used to perceive a molecule from xyz.</span>
<span class="sd">        num_confs_to_generate (int, optional): The number of conformers to generate (can be determined automatically)</span>
<span class="sd">        n_confs (int, optional): The number of conformers to return.</span>
<span class="sd">        e_confs (float, optional): The energy threshold in kJ/mol above the lowest energy conformer</span>
<span class="sd">                                   below which all (unique) generated conformers will be returned.</span>
<span class="sd">        de_threshold (float, optional): Energy threshold (in kJ/mol) above which wells will not be considered.</span>
<span class="sd">        smeared_scan_res (float, optional): The resolution (in degrees) for scanning smeared wells.</span>
<span class="sd">        combination_threshold (int, optional): A threshold below which all combinations will be generated.</span>
<span class="sd">        force_field (str, optional): The type of force field to use (MMFF94, MMFF94s, UFF, GAFF).</span>
<span class="sd">        max_combination_iterations (int, optional): The maximum number of times to iteratively search</span>
<span class="sd">                                                    for the lowest conformer.</span>
<span class="sd">        diastereomers (list, optional): Entries are xyz&#39;s in a dictionary format or conformer structures</span>
<span class="sd">                                        representing specific diastereomers to keep.</span>
<span class="sd">        return_all_conformers (bool, optional): Whether to return the full conformers list of conformer dictionaries</span>
<span class="sd">                                                In addition to the lowest conformers list. Tru to return it.</span>
<span class="sd">        plot_path (str, optional): A folder path in which the plot will be saved.</span>
<span class="sd">                                   If None, the plot will not be shown (nor saved).</span>
<span class="sd">        print_logs (bool, optional): Whether define a logger so logs are also printed to stdout.</span>
<span class="sd">                                     Useful when run outside of ARC. True to print.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConformerError: If something goes wrong.</span>
<span class="sd">        TypeError: If xyzs has entries of a wrong type.</span>

<span class="sd">    Returns: Optional[Union[list, Tuple[list, list]]]</span>
<span class="sd">        - Lowest conformers</span>
<span class="sd">        - Lowest conformers and all new conformers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cheat</span> <span class="o">=</span> <span class="n">cheat_sheet</span><span class="p">(</span><span class="n">mol_list</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">cheat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cheat</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol_list</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
        <span class="c1"># Try generating resonance structures, but strictly keep atom order.</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">mol_copy</span> <span class="o">=</span> <span class="n">mol_list</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mol_copy</span><span class="o">.</span><span class="n">reactive</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">new_mol_list</span> <span class="o">=</span> <span class="n">generate_resonance_structures</span><span class="p">(</span><span class="n">mol_copy</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">order_atoms_in_mol_list</span><span class="p">(</span><span class="n">ref_mol</span><span class="o">=</span><span class="n">mol_list</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">mol_list</span><span class="o">=</span><span class="n">new_mol_list</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">mol_list</span> <span class="o">=</span> <span class="n">new_mol_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mol_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol_list</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The `mol_list` argument must be a list, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">mol_list</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mol_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">mol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Must get a non-empty `mol_list` argument.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">mol_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Each entry in the `mol_list` argument must be an RMG Molecule object, &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">mol_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">update_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span> <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">mol_list</span><span class="p">]</span>

    <span class="c1"># A quick bypass for monoatomic and diatomic species:</span>
    <span class="n">confs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">confs</span> <span class="o">=</span> <span class="p">[</span><span class="n">generate_monoatomic_conformer</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="n">mol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">symbol</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">mol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">confs</span> <span class="o">=</span> <span class="p">[</span><span class="n">generate_diatomic_conformer</span><span class="p">(</span><span class="n">symbol_1</span><span class="o">=</span><span class="n">mol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                                             <span class="n">symbol_2</span><span class="o">=</span><span class="n">mol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                                             <span class="n">multiplicity</span><span class="o">=</span><span class="n">multiplicity</span><span class="p">,</span>
                                             <span class="p">)]</span>
    <span class="k">if</span> <span class="n">confs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_all_conformers</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">confs</span><span class="p">,</span> <span class="n">confs</span>
        <span class="k">return</span> <span class="n">confs</span>

    <span class="k">if</span> <span class="n">xyzs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">xyzs</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;xyz entries of xyzs must be dictionaries, e.g.:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{</span><span class="s2">&#39;symbols&#39;: (&#39;O&#39;, &#39;C&#39;, &#39;H&#39;, &#39;H&#39;),</span><span class="se">\n</span><span class="s2">&#39;isotopes&#39;: (16, 12, 1, 1),</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;&#39;coords&#39;: ((0.0, 0.0, 0.678514),</span><span class="se">\n</span><span class="s2">           (0.0, 0.0, -0.532672),</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;           (0.0, 0.935797, -1.116041),</span><span class="se">\n</span><span class="s2">           (0.0, -0.935797, -1.116041))</span><span class="se">}}\n\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span> <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">xyzs</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">print_logs</span><span class="p">:</span>
        <span class="n">initialize_log</span><span class="p">()</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generating conformers for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">max_combination_iterations</span> <span class="o">=</span> <span class="n">max_combination_iterations</span> <span class="ow">or</span> <span class="n">MAX_COMBINATION_ITERATIONS</span>
    <span class="n">combination_threshold</span> <span class="o">=</span> <span class="n">combination_threshold</span> <span class="ow">or</span> <span class="n">COMBINATION_THRESHOLD</span>

    <span class="k">if</span> <span class="n">torsions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tops</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">torsions</span><span class="p">,</span> <span class="n">tops</span> <span class="o">=</span> <span class="n">determine_rotors</span><span class="p">(</span><span class="n">mol_list</span><span class="p">)</span>
    <span class="n">conformers</span> <span class="o">=</span> <span class="n">generate_force_field_conformers</span><span class="p">(</span>
        <span class="n">mol_list</span><span class="o">=</span><span class="n">mol_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyzs</span><span class="o">=</span><span class="n">xyzs</span><span class="p">,</span> <span class="n">torsion_num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">torsions</span><span class="p">),</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">multiplicity</span><span class="o">=</span><span class="n">multiplicity</span><span class="p">,</span>
        <span class="n">num_confs</span><span class="o">=</span><span class="n">num_confs_to_generate</span><span class="p">,</span> <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">)</span>

    <span class="n">lowest_confs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conformers</span><span class="p">):</span>
        <span class="n">conformers</span> <span class="o">=</span> <span class="n">determine_dihedrals</span><span class="p">(</span><span class="n">conformers</span><span class="p">,</span> <span class="n">torsions</span><span class="p">)</span>

        <span class="n">new_conformers</span><span class="p">,</span> <span class="n">symmetries</span> <span class="o">=</span> <span class="n">deduce_new_conformers</span><span class="p">(</span>
            <span class="n">label</span><span class="p">,</span> <span class="n">conformers</span><span class="p">,</span> <span class="n">torsions</span><span class="p">,</span> <span class="n">tops</span><span class="p">,</span> <span class="n">mol_list</span><span class="p">,</span> <span class="n">smeared_scan_res</span><span class="p">,</span> <span class="n">plot_path</span><span class="o">=</span><span class="n">plot_path</span><span class="p">,</span>
            <span class="n">combination_threshold</span><span class="o">=</span><span class="n">combination_threshold</span><span class="p">,</span> <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">,</span>
            <span class="n">max_combination_iterations</span><span class="o">=</span><span class="n">max_combination_iterations</span><span class="p">,</span> <span class="n">diastereomers</span><span class="o">=</span><span class="n">diastereomers</span><span class="p">,</span>
            <span class="n">de_threshold</span><span class="o">=</span><span class="n">de_threshold</span><span class="p">)</span>

        <span class="n">new_conformers</span> <span class="o">=</span> <span class="n">determine_chirality</span><span class="p">(</span><span class="n">conformers</span><span class="o">=</span><span class="n">new_conformers</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_conformers</span><span class="p">):</span>
            <span class="n">lowest_confs</span> <span class="o">=</span> <span class="n">get_lowest_confs</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">new_conformers</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n_confs</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="n">e_confs</span><span class="p">)</span>
            <span class="n">lowest_confs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;FF energy&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Sort by output confs, lowest to highest energy.</span>

        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">execution_time</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">d</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
        <span class="n">days</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="si">}</span><span class="s1"> days and &#39;</span> <span class="k">if</span> <span class="n">d</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">execution_time</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Conformer execution time using </span><span class="si">{</span><span class="n">force_field</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">days</span><span class="si">}{</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not generate conformers for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">mol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">lowest_confs</span><span class="p">,</span> <span class="n">new_conformers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_all_conformers</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lowest_confs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lowest_confs</span><span class="p">,</span> <span class="n">new_conformers</span></div>


<div class="viewcode-block" id="deduce_new_conformers"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.deduce_new_conformers">[docs]</a><span class="k">def</span> <span class="nf">deduce_new_conformers</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">conformers</span><span class="p">,</span> <span class="n">torsions</span><span class="p">,</span> <span class="n">tops</span><span class="p">,</span> <span class="n">mol_list</span><span class="p">,</span> <span class="n">smeared_scan_res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">combination_threshold</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">force_field</span><span class="o">=</span><span class="s1">&#39;MMFF94s&#39;</span><span class="p">,</span> <span class="n">max_combination_iterations</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                          <span class="n">diastereomers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">de_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    By knowing the existing torsion wells, get the geometries of all important conformers.</span>
<span class="sd">    Validate that atoms don&#39;t collide in the generated conformers (don&#39;t consider ones where they do).</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        conformers (list): Entries are conformer dictionaries.</span>
<span class="sd">        torsions (list): A list of all possible torsion angles in the molecule, each torsion angles list is sorted.</span>
<span class="sd">        tops (list): A list of tops corresponding to torsions.</span>
<span class="sd">        mol_list (list): A list of RMG Molecule objects.</span>
<span class="sd">        smeared_scan_res (float, optional): The resolution (in degrees) for scanning smeared wells.</span>
<span class="sd">        plot_path (str, optional): A folder path in which the plot will be saved.</span>
<span class="sd">                                   If None, the plot will not be shown (nor saved).</span>
<span class="sd">        combination_threshold (int, optional): A threshold below which all combinations will be generated.</span>
<span class="sd">        force_field (str, optional): The type of force field to use.</span>
<span class="sd">        max_combination_iterations (int, optional): The max num of times to iteratively search for the lowest conformer.</span>
<span class="sd">        diastereomers (list, optional): Entries are xyz&#39;s in a dictionary format or conformer structures</span>
<span class="sd">                                        representing specific diastereomers to keep.</span>
<span class="sd">        de_threshold (float, optional): An energy threshold (in kJ/mol) above which wells in a torsion</span>
<span class="sd">                                        will not be considered.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[list, dict]:</span>
<span class="sd">            - The deduced conformers.</span>
<span class="sd">            - Keys are torsion tuples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">smeared_scan_res</span> <span class="o">=</span> <span class="n">smeared_scan_res</span> <span class="ow">or</span> <span class="n">SMEARED_SCAN_RESOLUTIONS</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="s1">&#39;torsion_dihedrals&#39;</span> <span class="ow">in</span> <span class="n">conformer</span> <span class="k">for</span> <span class="n">conformer</span> <span class="ow">in</span> <span class="n">conformers</span><span class="p">]):</span>
        <span class="n">conformers</span> <span class="o">=</span> <span class="n">determine_dihedrals</span><span class="p">(</span><span class="n">conformers</span><span class="p">,</span> <span class="n">torsions</span><span class="p">)</span>
    <span class="n">torsion_angles</span> <span class="o">=</span> <span class="n">get_torsion_angles</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">conformers</span><span class="p">,</span> <span class="n">torsions</span><span class="p">,</span> <span class="n">mol_list</span><span class="p">,</span> <span class="n">tops</span><span class="p">)</span>  <span class="c1"># get all wells per torsion</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">mol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">symmetries</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">torsion</span><span class="p">,</span> <span class="n">top</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">torsions</span><span class="p">,</span> <span class="n">tops</span><span class="p">):</span>
        <span class="c1"># identify symmetric torsions so we don&#39;t bother considering them in the conformational combinations</span>
        <span class="n">symmetry</span> <span class="o">=</span> <span class="n">determine_torsion_symmetry</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">mol_list</span><span class="p">,</span> <span class="n">torsion_angles</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">torsion</span><span class="p">)])</span>
        <span class="n">symmetries</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">torsion</span><span class="p">)]</span> <span class="o">=</span> <span class="n">symmetry</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Identified </span><span class="si">{</span><span class="nb">len</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">symmetries</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s1"> symmetric wells for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">torsions_sampling_points</span><span class="p">,</span> <span class="n">wells_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tor</span><span class="p">,</span> <span class="n">tor_angles</span> <span class="ow">in</span> <span class="n">torsion_angles</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">torsions_sampling_points</span><span class="p">[</span><span class="n">tor</span><span class="p">],</span> <span class="n">wells_dict</span><span class="p">[</span><span class="n">tor</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">determine_torsion_sampling_points</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">tor_angles</span><span class="p">,</span> <span class="n">smeared_scan_res</span><span class="o">=</span><span class="n">smeared_scan_res</span><span class="p">,</span>
                                              <span class="n">symmetry</span><span class="o">=</span><span class="n">symmetries</span><span class="p">[</span><span class="n">tor</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">plot_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">arc</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">plot_torsion_angles</span><span class="p">(</span><span class="n">torsion_angles</span><span class="p">,</span> <span class="n">torsions_sampling_points</span><span class="p">,</span> <span class="n">wells_dict</span><span class="o">=</span><span class="n">wells_dict</span><span class="p">,</span>
                                        <span class="n">plot_path</span><span class="o">=</span><span class="n">plot_path</span><span class="p">)</span>

    <span class="n">hypothetical_num_comb</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">points</span> <span class="ow">in</span> <span class="n">torsions_sampling_points</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">hypothetical_num_comb</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">number_of_chiral_centers</span> <span class="o">=</span> <span class="n">get_number_of_chiral_centers</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">conformers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                            <span class="n">just_get_the_number</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">hypothetical_num_comb</span> <span class="o">*=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">number_of_chiral_centers</span>
    <span class="k">if</span> <span class="n">hypothetical_num_comb</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">hypothetical_num_comb_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0:.2E}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hypothetical_num_comb</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hypothetical_num_comb_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">hypothetical_num_comb</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Hypothetical number of conformer combinations for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">hypothetical_num_comb_str</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># split torsions_sampling_points into two lists, use combinations only for those with multiple sampling points</span>
    <span class="n">single_tors</span><span class="p">,</span> <span class="n">multiple_tors</span><span class="p">,</span> <span class="n">single_sampling_point</span><span class="p">,</span> <span class="n">multiple_sampling_points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">multiple_sampling_points_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># used for plotting an energy &quot;scan&quot;</span>
    <span class="k">for</span> <span class="n">tor</span><span class="p">,</span> <span class="n">points</span> <span class="ow">in</span> <span class="n">torsions_sampling_points</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">single_tors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tor</span><span class="p">)</span>
            <span class="n">single_sampling_point</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">multiple_sampling_points_dict</span><span class="p">[</span><span class="n">tor</span><span class="p">]</span> <span class="o">=</span> <span class="n">points</span>
            <span class="n">multiple_tors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tor</span><span class="p">)</span>
            <span class="n">multiple_sampling_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

    <span class="n">diastereomeric_conformers</span> <span class="o">=</span> <span class="n">get_lowest_diastereomers</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">conformers</span><span class="o">=</span><span class="n">conformers</span><span class="p">,</span>
                                                         <span class="n">diastereomers</span><span class="o">=</span><span class="n">diastereomers</span><span class="p">)</span>
    <span class="n">new_conformers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">diastereomeric_conformer</span> <span class="ow">in</span> <span class="n">diastereomeric_conformers</span><span class="p">:</span>
        <span class="c1"># set symmetric (single well) torsions to the mean of the well</span>
        <span class="k">if</span> <span class="s1">&#39;chirality&#39;</span> <span class="ow">in</span> <span class="n">diastereomeric_conformer</span> <span class="ow">and</span> <span class="n">diastereomeric_conformer</span><span class="p">[</span><span class="s1">&#39;chirality&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Considering diastereomer </span><span class="si">{</span><span class="n">diastereomeric_conformer</span><span class="p">[</span><span class="s1">&#39;chirality&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">base_xyz</span> <span class="o">=</span> <span class="n">diastereomeric_conformer</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">]</span>  <span class="c1"># base_xyz is modified within the loop below</span>
        <span class="k">for</span> <span class="n">torsion</span><span class="p">,</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">single_tors</span><span class="p">,</span> <span class="n">single_sampling_point</span><span class="p">):</span>
            <span class="n">torsion_0_indexed</span> <span class="o">=</span> <span class="p">[</span><span class="n">tor</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">tor</span> <span class="ow">in</span> <span class="n">torsion</span><span class="p">]</span>
            <span class="n">conf</span><span class="p">,</span> <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">rdkit_conf_from_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">base_xyz</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">base_xyz</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">set_rdkit_dihedrals</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">rd_mol</span><span class="p">,</span> <span class="n">torsion_0_indexed</span><span class="p">,</span> <span class="n">deg_abs</span><span class="o">=</span><span class="n">dihedral</span><span class="p">)</span>

        <span class="n">new_conformers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">generate_conformer_combinations</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">base_xyz</span><span class="o">=</span><span class="n">base_xyz</span><span class="p">,</span> <span class="n">hypothetical_num_comb</span><span class="o">=</span><span class="n">hypothetical_num_comb</span><span class="p">,</span>
            <span class="n">multiple_tors</span><span class="o">=</span><span class="n">multiple_tors</span><span class="p">,</span> <span class="n">multiple_sampling_points</span><span class="o">=</span><span class="n">multiple_sampling_points</span><span class="p">,</span>
            <span class="n">combination_threshold</span><span class="o">=</span><span class="n">combination_threshold</span><span class="p">,</span> <span class="n">len_conformers</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">conformers</span><span class="p">),</span> <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">,</span>
            <span class="n">max_combination_iterations</span><span class="o">=</span><span class="n">max_combination_iterations</span><span class="p">,</span> <span class="n">plot_path</span><span class="o">=</span><span class="n">plot_path</span><span class="p">,</span> <span class="n">torsion_angles</span><span class="o">=</span><span class="n">torsion_angles</span><span class="p">,</span>
            <span class="n">multiple_sampling_points_dict</span><span class="o">=</span><span class="n">multiple_sampling_points_dict</span><span class="p">,</span> <span class="n">wells_dict</span><span class="o">=</span><span class="n">wells_dict</span><span class="p">,</span>
            <span class="n">de_threshold</span><span class="o">=</span><span class="n">de_threshold</span><span class="p">,</span> <span class="n">symmetries</span><span class="o">=</span><span class="n">symmetries</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">plot_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_conformers</span><span class="p">):</span>
        <span class="n">lowest_conf</span> <span class="o">=</span> <span class="n">get_lowest_confs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">confs</span><span class="o">=</span><span class="n">new_conformers</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lowest_conf</span> <span class="o">=</span> <span class="n">determine_chirality</span><span class="p">([</span><span class="n">lowest_conf</span><span class="p">],</span> <span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">diastereomer</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; (diastereomer: </span><span class="si">{</span><span class="n">lowest_conf</span><span class="p">[</span><span class="s1">&#39;chirality&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">if</span> <span class="s1">&#39;chirality&#39;</span> <span class="ow">in</span> <span class="n">lowest_conf</span> \
                                                                         <span class="ow">and</span> <span class="n">lowest_conf</span><span class="p">[</span><span class="s1">&#39;chirality&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Lowest force field conformer for </span><span class="si">{</span><span class="n">label</span><span class="si">}{</span><span class="n">diastereomer</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">converter</span><span class="o">.</span><span class="n">xyz_to_str</span><span class="p">(</span><span class="n">lowest_conf</span><span class="p">[</span><span class="s2">&quot;xyz&quot;</span><span class="p">])</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">arc</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">lowest_conf</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">new_conformers</span><span class="p">,</span> <span class="n">symmetries</span></div>


<div class="viewcode-block" id="generate_conformer_combinations"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.generate_conformer_combinations">[docs]</a><span class="k">def</span> <span class="nf">generate_conformer_combinations</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">base_xyz</span><span class="p">,</span> <span class="n">hypothetical_num_comb</span><span class="p">,</span> <span class="n">multiple_tors</span><span class="p">,</span>
                                    <span class="n">multiple_sampling_points</span><span class="p">,</span> <span class="n">combination_threshold</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">len_conformers</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">force_field</span><span class="o">=</span><span class="s1">&#39;MMFF94s&#39;</span><span class="p">,</span> <span class="n">max_combination_iterations</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">plot_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">torsion_angles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multiple_sampling_points_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wells_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">de_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">symmetries</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Call either conformers_combinations_by_lowest_conformer() or generate_all_combinations(),</span>
<span class="sd">    according to the hypothetical_num_comb.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        mol (Molecule): The RMG molecule with the connectivity information.</span>
<span class="sd">        base_xyz (dict): The base 3D geometry to be changed.</span>
<span class="sd">        hypothetical_num_comb (int): The number of combinations that could be generated by changing dihedrals,</span>
<span class="sd">                                     considering symmetry but not considering atom collisions.</span>
<span class="sd">        combination_threshold (int, optional): A threshold below which all combinations will be generated.</span>
<span class="sd">        multiple_tors (list): Entries are torsion tuples of non-symmetric torsions.</span>
<span class="sd">        multiple_sampling_points (list): Entries are lists of dihedral angles (sampling points), respectively correspond</span>
<span class="sd">                                         to torsions in multiple_tors.</span>
<span class="sd">        len_conformers (int, optional): The length of the existing conformers list (for consecutive numbering).</span>
<span class="sd">        de_threshold (float, optional): An energy threshold (in kJ/mol) above which wells in a torsion</span>
<span class="sd">                                        will not be considered.</span>
<span class="sd">        force_field (str, optional): The type of force field to use.</span>
<span class="sd">        max_combination_iterations (int, optional): The max num of times to iteratively search for the lowest conformer.</span>
<span class="sd">        torsion_angles (dict, optional): The torsion angles. Keys are torsion tuples, values are lists of all</span>
<span class="sd">                                         corresponding angles from conformers.</span>
<span class="sd">        multiple_sampling_points_dict (dict, optional): Keys are torsion tuples, values are respective sampling points.</span>
<span class="sd">        wells_dict (dict, optional): Keys are torsion tuples, values are well dictionaries.</span>
<span class="sd">        plot_path (str, optional): A folder path in which the plot will be saved.</span>
<span class="sd">                                            If None, the plot will not be shown (nor saved).</span>
<span class="sd">        symmetries (dict, optional): Keys are tuples scan indices (1-indexed), values are internal</span>
<span class="sd">                                     rotation symmetry numbers (sigma).</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: New conformer combinations, entries are conformer dictionaries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">de_threshold</span> <span class="o">=</span> <span class="n">de_threshold</span> <span class="ow">or</span> <span class="n">DE_THRESHOLD</span>
    <span class="k">if</span> <span class="n">hypothetical_num_comb</span> <span class="o">&gt;</span> <span class="n">combination_threshold</span><span class="p">:</span>
        <span class="c1"># Don&#39;t generate all combinations, there are simply too many.</span>
        <span class="c1"># Iteratively modify the lowest conformer until it converges.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;hypothetical_num_comb for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> is &gt; </span><span class="si">{</span><span class="n">combination_threshold</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">new_conformers</span> <span class="o">=</span> <span class="n">conformers_combinations_by_lowest_conformer</span><span class="p">(</span>
            <span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">base_xyz</span><span class="o">=</span><span class="n">base_xyz</span><span class="p">,</span> <span class="n">multiple_tors</span><span class="o">=</span><span class="n">multiple_tors</span><span class="p">,</span>
            <span class="n">multiple_sampling_points</span><span class="o">=</span><span class="n">multiple_sampling_points</span><span class="p">,</span> <span class="n">len_conformers</span><span class="o">=</span><span class="n">len_conformers</span><span class="p">,</span> <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">,</span>
            <span class="n">plot_path</span><span class="o">=</span><span class="n">plot_path</span><span class="p">,</span> <span class="n">de_threshold</span><span class="o">=</span><span class="n">de_threshold</span><span class="p">,</span> <span class="n">max_combination_iterations</span><span class="o">=</span><span class="n">max_combination_iterations</span><span class="p">,</span>
            <span class="n">torsion_angles</span><span class="o">=</span><span class="n">torsion_angles</span><span class="p">,</span> <span class="n">multiple_sampling_points_dict</span><span class="o">=</span><span class="n">multiple_sampling_points_dict</span><span class="p">,</span>
            <span class="n">wells_dict</span><span class="o">=</span><span class="n">wells_dict</span><span class="p">,</span> <span class="n">symmetries</span><span class="o">=</span><span class="n">symmetries</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Just generate all combinations and get their FF energies.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;hypothetical_num_comb for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> is &lt; </span><span class="si">{</span><span class="n">combination_threshold</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">new_conformers</span> <span class="o">=</span> <span class="n">generate_all_combinations</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">base_xyz</span><span class="p">,</span> <span class="n">multiple_tors</span><span class="p">,</span> <span class="n">multiple_sampling_points</span><span class="p">,</span>
                                                   <span class="n">len_conformers</span><span class="o">=</span><span class="n">len_conformers</span><span class="p">,</span> <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">,</span>
                                                   <span class="n">torsions</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">torsion_angles</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">new_conformers</span></div>


<div class="viewcode-block" id="conformers_combinations_by_lowest_conformer"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.conformers_combinations_by_lowest_conformer">[docs]</a><span class="k">def</span> <span class="nf">conformers_combinations_by_lowest_conformer</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">base_xyz</span><span class="p">,</span> <span class="n">multiple_tors</span><span class="p">,</span> <span class="n">multiple_sampling_points</span><span class="p">,</span>
                                                <span class="n">len_conformers</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">force_field</span><span class="o">=</span><span class="s1">&#39;MMFF94s&#39;</span><span class="p">,</span> <span class="n">max_combination_iterations</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                                <span class="n">torsion_angles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multiple_sampling_points_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                <span class="n">wells_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">de_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">symmetries</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Iteratively modify dihedrals in the lowest conformer (each iteration deduces a new lowest conformer),</span>
<span class="sd">    until convergence.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        mol (Molecule): The RMG molecule with the connectivity information.</span>
<span class="sd">        base_xyz (dict): The base 3D geometry to be changed.</span>
<span class="sd">        multiple_tors (list): Entries are torsion tuples of non-symmetric torsions.</span>
<span class="sd">        multiple_sampling_points (list): Entries are lists of dihedral angles (sampling points), respectively correspond</span>
<span class="sd">                                         to torsions in multiple_tors.</span>
<span class="sd">        len_conformers (int, optional): The length of the existing conformers list (for consecutive numbering).</span>
<span class="sd">        de_threshold (float, optional): An energy threshold (in kJ/mol) above which wells in a torsion</span>
<span class="sd">                                        will not be considered.</span>
<span class="sd">        force_field (str, optional): The type of force field to use.</span>
<span class="sd">        max_combination_iterations (int, optional): The max num of times to iteratively search for the lowest conformer.</span>
<span class="sd">        torsion_angles (dict, optional): The torsion angles. Keys are torsion tuples, values are lists of all</span>
<span class="sd">                                         corresponding angles from conformers.</span>
<span class="sd">        multiple_sampling_points_dict (dict, optional): Keys are torsion tuples, values are respective sampling points.</span>
<span class="sd">        wells_dict (dict, optional): Keys are torsion tuples, values are well dictionaries.</span>
<span class="sd">        plot_path (str, optional): A folder path in which the plot will be saved.</span>
<span class="sd">                                            If None, the plot will not be shown (nor saved).</span>
<span class="sd">        symmetries (dict, optional): Keys are tuples scan indices (1-indexed), values are internal</span>
<span class="sd">                                     rotation symmetry numbers (sigma).</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: New conformer combinations, entries are conformer dictionaries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_energy</span> <span class="o">=</span> <span class="n">get_force_field_energies</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">num_confs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">base_xyz</span><span class="p">,</span>
                                           <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">suppress_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_energy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_energy</span> <span class="o">=</span> <span class="n">base_energy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">new_conformers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">new_conformers_no_energy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">lowest_conf_i</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_combination_iterations</span><span class="p">):</span>
        <span class="n">newest_conformers_dict</span><span class="p">,</span> <span class="n">newest_conformer_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># Conformers from the current iteration.</span>
        <span class="k">for</span> <span class="n">tor</span><span class="p">,</span> <span class="n">sampling_points</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">multiple_tors</span><span class="p">,</span> <span class="n">multiple_sampling_points</span><span class="p">):</span>
            <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span> <span class="o">=</span> <span class="n">change_dihedrals_and_force_field_it</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">base_xyz</span><span class="p">,</span> <span class="n">torsions</span><span class="o">=</span><span class="p">[</span><span class="n">tor</span><span class="p">],</span>
                                                                 <span class="n">new_dihedrals</span><span class="o">=</span><span class="p">[[</span><span class="n">sp</span><span class="p">]</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">sampling_points</span><span class="p">],</span>
                                                                 <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">newest_conformers_dict</span><span class="p">[</span><span class="n">tor</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># Keys are torsions for plotting.</span>
            <span class="k">for</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span><span class="p">,</span> <span class="n">sampling_points</span><span class="p">):</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">dmat1</span><span class="p">,</span> <span class="n">fl_distance1</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">new_conformers</span> <span class="o">+</span> <span class="n">newest_conformer_list</span><span class="p">:</span>
                    <span class="n">fl_distance1</span><span class="p">,</span> <span class="n">dmat1</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">similar</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">compare_confs_fl</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">conf</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">similar</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">converter</span><span class="o">.</span><span class="n">compare_confs</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">],</span> <span class="n">skip_conversion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dmat1</span><span class="o">=</span><span class="n">dmat1</span><span class="p">,</span> <span class="n">dmat2</span><span class="o">=</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;dmat&#39;</span><span class="p">]):</span>
                        <span class="n">exists</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">conformer</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">len_conformers</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_conformers</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">newest_conformer_list</span><span class="p">),</span>
                                 <span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="n">xyz</span><span class="p">,</span>
                                 <span class="s1">&#39;FF energy&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                                 <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Changing dihedrals on most stable conformer, iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;torsion&#39;</span><span class="p">:</span> <span class="n">tor</span><span class="p">,</span>
                                 <span class="s1">&#39;dihedral&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">dihedral</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                                 <span class="s1">&#39;dmat&#39;</span><span class="p">:</span> <span class="n">dmat1</span><span class="p">,</span>
                                 <span class="s1">&#39;fl_distance&#39;</span><span class="p">:</span> <span class="n">fl_distance1</span><span class="p">}</span>
                    <span class="n">newest_conformers_dict</span><span class="p">[</span><span class="n">tor</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conformer</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
                        <span class="n">newest_conformer_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conformer</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># If xyz is None, atoms have collided.</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">atoms colliding in </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> for torsion </span><span class="si">{</span><span class="n">tor</span><span class="si">}</span><span class="s1"> and dihedral </span><span class="si">{</span><span class="n">dihedral</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">energy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">new_conformers_no_energy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">len_conformers</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_conformers</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">newest_conformer_list</span><span class="p">),</span>
                         <span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="n">xyz</span><span class="p">,</span>
                         <span class="s1">&#39;FF energy&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Changing dihedrals on most stable conformer, iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">, but FF energy is None&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;torsion&#39;</span><span class="p">:</span> <span class="n">tor</span><span class="p">,</span>
                         <span class="s1">&#39;dihedral&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">dihedral</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                         <span class="s1">&#39;dmat&#39;</span><span class="p">:</span> <span class="n">dmat1</span><span class="p">,</span>
                         <span class="s1">&#39;fl_distance&#39;</span><span class="p">:</span> <span class="n">fl_distance1</span><span class="p">})</span>
        <span class="n">new_conformers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">newest_conformer_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">newest_conformer_list</span><span class="p">:</span>
            <span class="n">newest_conformer_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">lowest_conf_i</span><span class="p">]</span>
        <span class="n">lowest_conf_i</span> <span class="o">=</span> <span class="n">get_lowest_confs</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">newest_conformer_list</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lowest_conf_i</span><span class="p">[</span><span class="s1">&#39;FF energy&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">base_energy</span> \
                <span class="ow">and</span> <span class="n">converter</span><span class="o">.</span><span class="n">compare_confs</span><span class="p">(</span><span class="n">lowest_conf_i</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">],</span> <span class="n">base_xyz</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">lowest_conf_i</span><span class="p">[</span><span class="s1">&#39;FF energy&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">base_energy</span><span class="p">:</span>
            <span class="n">base_energy</span> <span class="o">=</span> <span class="n">lowest_conf_i</span><span class="p">[</span><span class="s1">&#39;FF energy&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">plot_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">converter</span><span class="o">.</span><span class="n">xyz_to_str</span><span class="p">(</span><span class="n">lowest_conf_i</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">]))</span>
        <span class="n">arc</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">lowest_conf_i</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">])</span>
        <span class="n">num_comb</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">plot_torsion_angles</span><span class="p">(</span><span class="n">torsion_angles</span><span class="p">,</span> <span class="n">multiple_sampling_points_dict</span><span class="p">,</span>
                                                   <span class="n">wells_dict</span><span class="o">=</span><span class="n">wells_dict</span><span class="p">,</span> <span class="n">e_conformers</span><span class="o">=</span><span class="n">newest_conformers_dict</span><span class="p">,</span>
                                                   <span class="n">de_threshold</span><span class="o">=</span><span class="n">de_threshold</span><span class="p">,</span> <span class="n">plot_path</span><span class="o">=</span><span class="n">plot_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_comb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_comb</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="n">num_comb_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_comb</span><span class="si">:</span><span class="s1">.2E</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_comb_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_comb</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of conformer combinations for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> after reduction: </span><span class="si">{</span><span class="n">num_comb_str</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">de_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_e</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;FF energy&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">new_conformers</span><span class="p">])</span>
        <span class="n">new_conformers</span> <span class="o">=</span> <span class="p">[</span><span class="n">conf</span> <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">new_conformers</span> <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;FF energy&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">min_e</span> <span class="o">&lt;</span> <span class="n">de_threshold</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_conformers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_conformers_no_energy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_conformers_no_energy</span>
    <span class="k">return</span> <span class="n">new_conformers</span></div>


<div class="viewcode-block" id="generate_all_combinations"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.generate_all_combinations">[docs]</a><span class="k">def</span> <span class="nf">generate_all_combinations</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">base_xyz</span><span class="p">,</span> <span class="n">multiple_tors</span><span class="p">,</span> <span class="n">multiple_sampling_points</span><span class="p">,</span> <span class="n">len_conformers</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">torsions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_field</span><span class="o">=</span><span class="s1">&#39;MMFF94s&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate all combinations of torsion wells from a base conformer.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        mol (Molecule): The RMG molecule with the connectivity information.</span>
<span class="sd">        base_xyz (dict): The base 3D geometry to be changed.</span>
<span class="sd">        multiple_tors (list): Entries are torsion tuples of non-symmetric torsions.</span>
<span class="sd">        multiple_sampling_points (list): Entries are lists of dihedral angles (sampling points), respectively correspond</span>
<span class="sd">                                         to torsions in multiple_tors.</span>
<span class="sd">        len_conformers (int, optional): The length of the existing conformers list (for consecutive numbering).</span>
<span class="sd">        force_field (str, optional): The type of force field to use.</span>
<span class="sd">        torsions (list, optional): A list of all possible torsions in the molecule. Will be determined if not given.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: New conformer combinations, entries are conformer dictionaries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Generate sampling points combinations.</span>
    <span class="n">product_combinations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">multiple_sampling_points</span><span class="p">))</span>
    <span class="n">new_conformers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">multiple_tors</span><span class="p">:</span>
        <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span> <span class="o">=</span> <span class="n">change_dihedrals_and_force_field_it</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">base_xyz</span><span class="p">,</span> <span class="n">torsions</span><span class="o">=</span><span class="n">multiple_tors</span><span class="p">,</span>
                                                             <span class="n">new_dihedrals</span><span class="o">=</span><span class="n">product_combinations</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                             <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">energy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_conformers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">len_conformers</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_conformers</span><span class="p">),</span>
                                       <span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="n">xyz</span><span class="p">,</span>
                                       <span class="s1">&#39;FF energy&#39;</span><span class="p">:</span> <span class="n">energy</span><span class="p">,</span>
                                       <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;Generated all combinations from scan map&#39;</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No multiple torsions (all torsions are symmetric or no torsions in the molecule), this is a trivial case.</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">get_force_field_energies</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">num_confs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">base_xyz</span><span class="p">,</span> <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">,</span>
                                          <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">suppress_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">energy</span><span class="p">):</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">energy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">new_conformers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">len_conformers</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_conformers</span><span class="p">),</span>
                               <span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="n">base_xyz</span><span class="p">,</span>
                               <span class="s1">&#39;FF energy&#39;</span><span class="p">:</span> <span class="n">energy</span><span class="p">,</span>
                               <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;Generated all combinations from scan map (trivial case)&#39;</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">torsions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">torsions</span> <span class="o">=</span> <span class="n">determine_rotors</span><span class="p">([</span><span class="n">mol</span><span class="p">])</span>
    <span class="n">new_conformers</span> <span class="o">=</span> <span class="n">determine_dihedrals</span><span class="p">(</span><span class="n">new_conformers</span><span class="p">,</span> <span class="n">torsions</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_conformers</span></div>


<div class="viewcode-block" id="generate_force_field_conformers"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.generate_force_field_conformers">[docs]</a><span class="k">def</span> <span class="nf">generate_force_field_conformers</span><span class="p">(</span><span class="n">label</span><span class="p">,</span>
                                    <span class="n">mol_list</span><span class="p">,</span>
                                    <span class="n">torsion_num</span><span class="p">,</span>
                                    <span class="n">charge</span><span class="p">,</span>
                                    <span class="n">multiplicity</span><span class="p">,</span>
                                    <span class="n">xyzs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">num_confs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">force_field</span><span class="o">=</span><span class="s1">&#39;MMFF94s&#39;</span><span class="p">,</span>
                                    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate conformers using RDKit and OpenBabel and optimize them using a force field</span>
<span class="sd">    Also consider user guesses in `xyzs`.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        mol_list (list): Entries are Molecule objects representing resonance structures of a chemical species.</span>
<span class="sd">        xyzs (list, optional): Entries are xyz coordinates in dict format, given as initial guesses.</span>
<span class="sd">        torsion_num (int): The number of torsions identified in the molecule.</span>
<span class="sd">        charge (int): The net charge of the species.</span>
<span class="sd">        multiplicity (int): The species spin multiplicity.</span>
<span class="sd">        num_confs (int, optional): The number of conformers to generate.</span>
<span class="sd">        force_field (str, optional): The type of force field to use.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConformerError: If xyzs is given and it is not a list, or its entries are not strings.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: Entries are conformer dictionaries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conformers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">number_of_heavy_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">atom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">is_non_hydrogen</span><span class="p">()])</span>
    <span class="k">if</span> <span class="n">num_confs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">num_confs</span><span class="p">,</span> <span class="n">num_chiral_centers</span> <span class="o">=</span> <span class="n">determine_number_of_conformers_to_generate</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">heavy_atoms</span><span class="o">=</span><span class="n">number_of_heavy_atoms</span><span class="p">,</span> <span class="n">torsion_num</span><span class="o">=</span><span class="n">torsion_num</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">xyz</span><span class="o">=</span><span class="n">xyzs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">xyzs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_chiral_centers</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">chiral_centers</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">num_chiral_centers</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;, </span><span class="si">{</span><span class="n">num_chiral_centers</span><span class="si">}</span><span class="s1"> chiral centers,&#39;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> has </span><span class="si">{</span><span class="n">number_of_heavy_atoms</span><span class="si">}</span><span class="s1"> heavy atoms</span><span class="si">{</span><span class="n">chiral_centers</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">torsion_num</span><span class="si">}</span><span class="s1"> torsions. &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;Using </span><span class="si">{</span><span class="n">num_confs</span><span class="si">}</span><span class="s1"> random conformers.&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">mol_list</span><span class="p">:</span>
        <span class="n">ff_xyzs</span><span class="p">,</span> <span class="n">ff_energies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ff_xyzs</span><span class="p">,</span> <span class="n">ff_energies</span> <span class="o">=</span> <span class="n">get_force_field_energies</span><span class="p">(</span><span class="n">label</span><span class="p">,</span>
                                                            <span class="n">mol</span><span class="p">,</span>
                                                            <span class="n">num_confs</span><span class="o">=</span><span class="n">num_confs</span><span class="p">,</span>
                                                            <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">,</span>
                                                            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not generate conformers for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">, failed with: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ff_xyzs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">energy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ff_xyzs</span><span class="p">,</span> <span class="n">ff_energies</span><span class="p">):</span>
                <span class="n">conformers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="n">xyz</span><span class="p">,</span>
                                   <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">conformers</span><span class="p">),</span>
                                   <span class="s1">&#39;FF energy&#39;</span><span class="p">:</span> <span class="n">energy</span><span class="p">,</span>
                                   <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">force_field</span><span class="p">})</span>
    <span class="c1"># User guesses</span>
    <span class="k">if</span> <span class="n">xyzs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">xyzs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyzs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="s1">&#39;The xyzs argument must be a list, got </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">xyzs</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">xyzs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="s1">&#39;Each entry in xyzs must be a dictionary, got </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">xyz</span><span class="p">)))</span>
            <span class="n">s_mol</span><span class="p">,</span> <span class="n">b_mol</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">molecules_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">multiplicity</span><span class="o">=</span><span class="n">multiplicity</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">)</span>
            <span class="n">conformers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="n">xyz</span><span class="p">,</span>
                               <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">conformers</span><span class="p">),</span>
                               <span class="s1">&#39;FF energy&#39;</span><span class="p">:</span> <span class="n">get_force_field_energies</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">b_mol</span> <span class="ow">or</span> <span class="n">s_mol</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span>
                                                                     <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                               <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;User Guess&#39;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">conformers</span></div>


<div class="viewcode-block" id="change_dihedrals_and_force_field_it"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.change_dihedrals_and_force_field_it">[docs]</a><span class="k">def</span> <span class="nf">change_dihedrals_and_force_field_it</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">torsions</span><span class="p">,</span> <span class="n">new_dihedrals</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_field</span><span class="o">=</span><span class="s1">&#39;MMFF94s&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Change dihedrals of specified torsions according to the new dihedrals specified, and get FF energies.</span>

<span class="sd">    Example::</span>

<span class="sd">        torsions = [(1, 2, 3, 4), (9, 4, 7, 1)]</span>
<span class="sd">        new_dihedrals = [[90, 120], [90, 300], [180, 270], [30, 270]]</span>

<span class="sd">    This will calculate the energy of the original conformer (defined using `xyz`).</span>
<span class="sd">    We iterate through new_dihedrals. The torsions are set accordingly and the energy and xyz of the newly</span>
<span class="sd">    generated conformer are kept.</span>
<span class="sd">    We assume that each list entry in new_dihedrals is of the length of the torsions list (2 in the example).</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        mol (Molecule): The RMG molecule with the connectivity information.</span>
<span class="sd">        xyz (dict): The base 3D geometry to be changed.</span>
<span class="sd">        torsions (list): Entries are torsion tuples for which the dihedral will be changed relative to xyz.</span>
<span class="sd">        new_dihedrals (list): Entries are same size lists of dihedral angles (floats) corresponding to the torsions.</span>
<span class="sd">        optimize (bool, optional): Whether to optimize the coordinates using FF. True to optimize.</span>
<span class="sd">        force_field (str, optional): The type of force field to use.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[list, list]:</span>
<span class="sd">            - The conformer FF energies corresponding to the list of dihedrals.</span>
<span class="sd">            - The conformer xyz geometries corresponding to the list of dihedrals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">str_to_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">torsions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">new_dihedrals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xyz</span><span class="p">,</span> <span class="n">energy</span> <span class="o">=</span> <span class="n">get_force_field_energies</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                               <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">,</span> <span class="n">suppress_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">energy</span>

    <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="c1"># make sure new_dihedrals is a list of lists (or tuples):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_dihedrals</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">new_dihedrals</span> <span class="o">=</span> <span class="p">[[</span><span class="n">new_dihedrals</span><span class="p">]]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_dihedrals</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_dihedrals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">new_dihedrals</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_dihedrals</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">dihedrals</span> <span class="ow">in</span> <span class="n">new_dihedrals</span><span class="p">:</span>
        <span class="n">xyz_dihedrals</span> <span class="o">=</span> <span class="n">xyz</span>
        <span class="k">for</span> <span class="n">torsion</span><span class="p">,</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">torsions</span><span class="p">,</span> <span class="n">dihedrals</span><span class="p">):</span>
            <span class="n">conf</span><span class="p">,</span> <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">rdkit_conf_from_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">xyz_dihedrals</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">torsion_0_indexed</span> <span class="o">=</span> <span class="p">[</span><span class="n">tor</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">tor</span> <span class="ow">in</span> <span class="n">torsion</span><span class="p">]</span>
                <span class="n">xyz_dihedrals</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">set_rdkit_dihedrals</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">rd_mol</span><span class="p">,</span> <span class="n">torsion_0_indexed</span><span class="p">,</span> <span class="n">deg_abs</span><span class="o">=</span><span class="n">dihedral</span><span class="p">)</span>
        <span class="n">xyz_</span><span class="p">,</span> <span class="n">energy</span> <span class="o">=</span> <span class="n">get_force_field_energies</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz_dihedrals</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">,</span> <span class="n">suppress_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">energy</span> <span class="ow">and</span> <span class="n">xyz_</span><span class="p">:</span>
            <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">optimize</span><span class="p">:</span>
                <span class="n">xyzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xyzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz_dihedrals</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">xyzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz_dihedrals</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span></div>


<div class="viewcode-block" id="determine_rotors"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.determine_rotors">[docs]</a><span class="k">def</span> <span class="nf">determine_rotors</span><span class="p">(</span><span class="n">mol_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine possible unique rotors in the species to be treated as hindered rotors.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol_list (list): Localized structures (Molecule objects) by which all rotors will be determined.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[list, list]:</span>
<span class="sd">            - A list of indices of scan pivots.</span>
<span class="sd">            - A list of indices of top atoms (including one of the pivotal atoms) corresponding to the torsions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">torsions</span><span class="p">,</span> <span class="n">tops</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">mol_list</span><span class="p">:</span>
        <span class="n">rotors</span> <span class="o">=</span> <span class="n">find_internal_rotors</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">new_rotor</span> <span class="ow">in</span> <span class="n">rotors</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">existing_torsion</span> <span class="ow">in</span> <span class="n">torsions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">existing_torsion</span> <span class="o">==</span> <span class="n">new_rotor</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">]:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">torsions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_rotor</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">])</span>
                <span class="n">tops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_rotor</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">torsions</span><span class="p">,</span> <span class="n">tops</span></div>


<div class="viewcode-block" id="determine_number_of_conformers_to_generate"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.determine_number_of_conformers_to_generate">[docs]</a><span class="k">def</span> <span class="nf">determine_number_of_conformers_to_generate</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                               <span class="n">heavy_atoms</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                               <span class="n">torsion_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                               <span class="n">mol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Molecule</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                               <span class="n">xyz</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                               <span class="n">minimalist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                               <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the number of conformers to generate using molecular mechanics.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        heavy_atoms (int): The number of heavy atoms in the molecule.</span>
<span class="sd">        torsion_num (int): The number of potential torsions in the molecule.</span>
<span class="sd">        mol (Molecule, optional): The RMG Molecule object.</span>
<span class="sd">        xyz (dict, optional): The xyz coordinates.</span>
<span class="sd">        minimalist (bool, optional): Whether to return a small number of conformers, useful when this is just a guess</span>
<span class="sd">                                     before fitting a force field. True to be minimalistic.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConformerError: If the number of conformers to generate cannot be determined.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[int, int]:</span>
<span class="sd">            - The number of conformers to generate.</span>
<span class="sd">            - The number of chiral centers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">torsion_num</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">torsion_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">torsion_num</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">heavy_range</span><span class="p">,</span> <span class="n">num_confs_1</span> <span class="ow">in</span> <span class="n">CONFS_VS_HEAVY_ATOMS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">heavy_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inf&#39;</span> <span class="ow">and</span> <span class="n">heavy_atoms</span> <span class="o">&gt;=</span> <span class="n">heavy_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">heavy_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">heavy_atoms</span> <span class="o">&gt;=</span> <span class="n">heavy_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine the number of conformers to generate according to the number &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;of heavy atoms (</span><span class="si">{</span><span class="n">heavy_atoms</span><span class="si">}</span><span class="s1">) in </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">. The CONFS_VS_HEAVY_ATOMS dictionary might be &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;corrupt, got:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{</span><span class="n">CONFS_VS_HEAVY_ATOMS</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">torsion_range</span><span class="p">,</span> <span class="n">num_confs_2</span> <span class="ow">in</span> <span class="n">CONFS_VS_TORSIONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">torsion_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inf&#39;</span> <span class="ow">and</span> <span class="n">torsion_num</span> <span class="o">&gt;=</span> <span class="n">torsion_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">torsion_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">torsion_num</span> <span class="o">&gt;=</span> <span class="n">torsion_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine the number of conformers to generate according to the number &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;of torsions (</span><span class="si">{</span><span class="n">torsion_num</span><span class="si">}</span><span class="s1">) in </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">. The CONFS_VS_TORSIONS dictionary might be &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;corrupt, got:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{</span><span class="n">CONFS_VS_TORSIONS</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">minimalist</span><span class="p">:</span>
        <span class="n">num_confs</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_confs_1</span><span class="p">,</span> <span class="n">num_confs_2</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_confs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">num_confs_1</span><span class="p">,</span> <span class="n">num_confs_2</span><span class="p">)</span>

    <span class="c1"># increase the number of conformers if there are more than two chiral centers</span>
    <span class="n">num_chiral_centers</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">molecules_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xyzs</span> <span class="o">=</span> <span class="n">get_force_field_energies</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">num_confs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">suppress_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">xyzs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyzs</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">num_chiral_centers</span> <span class="o">=</span> <span class="n">get_number_of_chiral_centers</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">just_get_the_number</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_chiral_centers</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">num_confs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_confs</span> <span class="o">*</span> <span class="n">num_chiral_centers</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">num_confs</span><span class="p">,</span> <span class="n">num_chiral_centers</span></div>


<div class="viewcode-block" id="determine_dihedrals"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.determine_dihedrals">[docs]</a><span class="k">def</span> <span class="nf">determine_dihedrals</span><span class="p">(</span><span class="n">conformers</span><span class="p">,</span> <span class="n">torsions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each conformer in `conformers` determine the respective dihedrals.</span>

<span class="sd">    Args:</span>
<span class="sd">        conformers (list): Entries are conformer dictionaries.</span>
<span class="sd">        torsions (list): All possible torsions in the molecule.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: Entries are conformer dictionaries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">conformer</span> <span class="ow">in</span> <span class="n">conformers</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">str_to_xyz</span><span class="p">(</span><span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;torsion_dihedrals&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">conformer</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;torsion_dihedrals&#39;</span><span class="p">]:</span>
            <span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;torsion_dihedrals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">torsions</span><span class="p">:</span>
                <span class="n">dihedral</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">calculate_dihedral_angle</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">],</span> <span class="n">torsion</span><span class="o">=</span><span class="n">torsion</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;torsion_dihedrals&#39;</span><span class="p">][</span><span class="nb">tuple</span><span class="p">(</span><span class="n">torsion</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dihedral</span>
    <span class="k">return</span> <span class="n">conformers</span></div>


<div class="viewcode-block" id="determine_torsion_sampling_points"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.determine_torsion_sampling_points">[docs]</a><span class="k">def</span> <span class="nf">determine_torsion_sampling_points</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">torsion_angles</span><span class="p">,</span> <span class="n">smeared_scan_res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">symmetry</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine how many points to consider in each well of a torsion for conformer combinations.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        torsion_angles (list): Well angles in the torsion.</span>
<span class="sd">        smeared_scan_res (float, optional): The resolution (in degrees) for scanning smeared wells.</span>
<span class="sd">        symmetry (int, optional): The torsion symmetry number.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[list, list]:</span>
<span class="sd">            - Sampling points for the torsion.</span>
<span class="sd">            - Each entry is a well dictionary with the keys</span>
<span class="sd">              ``start_idx``, ``end_idx``, ``start_angle``, ``end_angle``, ``angles``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">smeared_scan_res</span> <span class="o">=</span> <span class="n">smeared_scan_res</span> <span class="ow">or</span> <span class="n">SMEARED_SCAN_RESOLUTIONS</span>
    <span class="n">sampling_points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">wells</span> <span class="o">=</span> <span class="n">get_wells</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">torsion_angles</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="n">WELL_GAP</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">symmetry</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">wells</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">symmetry</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wells</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">well</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wells</span><span class="p">):</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">well</span><span class="p">[</span><span class="s1">&#39;end_angle&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">well</span><span class="p">[</span><span class="s1">&#39;start_angle&#39;</span><span class="p">])</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">well</span><span class="p">[</span><span class="s1">&#39;angles&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">well</span><span class="p">[</span><span class="s1">&#39;angles&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">smeared_scan_res</span><span class="p">:</span>
            <span class="n">sampling_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">smeared_scan_res</span><span class="p">)</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mean</span> <span class="o">-</span> <span class="n">well</span><span class="p">[</span><span class="s1">&#39;start_angle&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">smeared_scan_res</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">sampling_points</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">padding</span> <span class="o">+</span> <span class="n">well</span><span class="p">[</span><span class="s1">&#39;angles&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">smeared_scan_res</span> <span class="o">*</span> <span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">))])</span>
        <span class="k">if</span> <span class="n">symmetry</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">wells</span><span class="p">)</span> <span class="o">/</span> <span class="n">symmetry</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">sampling_points</span><span class="p">,</span> <span class="n">wells</span></div>


<div class="viewcode-block" id="determine_torsion_symmetry"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.determine_torsion_symmetry">[docs]</a><span class="k">def</span> <span class="nf">determine_torsion_symmetry</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">top1</span><span class="p">,</span> <span class="n">mol_list</span><span class="p">,</span> <span class="n">torsion_scan</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether a torsion is symmetric.</span>
<span class="sd">    If a torsion well is &quot;well defined&quot; and not smeared, it could be symmetric.</span>
<span class="sd">    Check the groups attached to the rotor pivots to determine whether it is indeed symmetric</span>
<span class="sd">    We don&#39;t care about the actual rotor symmetry number here, since we plan to just use the first well</span>
<span class="sd">    (they&#39;re all the same).</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        top1 (list): A list of atom indices on one side of the torsion, including the pivotal atom.</span>
<span class="sd">        mol_list (list): A list of molecules.</span>
<span class="sd">        torsion_scan (list): The angles corresponding to this torsion from all conformers.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The rotor symmetry number.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">symmetry</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">check_tops</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># flags for checking top1 and top2</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">mol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">top2</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">top1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">top</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">top1</span><span class="p">,</span> <span class="n">top2</span><span class="p">]):</span>
        <span class="c1"># A quick bypass for carbon rotors that have three equal elements with only one bond that is connected to the carbon atom</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_carbon</span><span class="p">()</span> \
                <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> \
                    <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)):</span>
            <span class="n">symmetry</span> <span class="o">*=</span> <span class="mi">3</span>
            <span class="n">check_tops</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># A quick bypass for methylene radicals:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_carbon</span><span class="p">()</span> <span class="ow">and</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">radical_electrons</span> <span class="o">==</span> <span class="mi">1</span> \
                <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_hydrogen</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]):</span>
            <span class="n">symmetry</span> <span class="o">*=</span> <span class="mi">2</span>
            <span class="n">check_tops</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># A quick bypass for benzene rings:</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">top</span><span class="p">)</span> <span class="o">==</span> <span class="mi">11</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_carbon</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">6</span> \
                <span class="ow">and</span> <span class="nb">sum</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_hydrogen</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">symmetry</span> <span class="o">*=</span> <span class="mi">2</span>
            <span class="n">check_tops</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># treat the torsion list as cyclic, search for at least two blank parts of at least 60 degrees each</span>
    <span class="c1"># if the means of all data parts of the scan are uniformly scattered, the torsion might be symmetric</span>
    <span class="n">wells</span> <span class="o">=</span> <span class="n">get_wells</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="n">torsion_scan</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>

    <span class="n">distances</span><span class="p">,</span> <span class="n">well_widths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wells</span><span class="p">)):</span>
        <span class="n">well_widths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">wells</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;end_angle&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">wells</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;start_angle&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">wells</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;start_angle&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">wells</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;end_angle&#39;</span><span class="p">]))</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">mean_well_width</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">well_widths</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">well_widths</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wells</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">distance</span> <span class="o">==</span> <span class="n">distances</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">distance</span> <span class="ow">in</span> <span class="n">distances</span><span class="p">])</span> \
            <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">mean_well_width</span><span class="p">)</span> <span class="o">/</span> <span class="n">mean_well_width</span> <span class="o">&lt;</span> <span class="n">determine_well_width_tolerance</span><span class="p">(</span><span class="n">mean_well_width</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">width</span> <span class="ow">in</span> <span class="n">well_widths</span><span class="p">]):</span>
        <span class="c1"># All well distances and widths are equal. The torsion scan might be symmetric, check the groups</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">top</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">top1</span><span class="p">,</span> <span class="n">top2</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">check_tops</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">groups</span><span class="p">,</span> <span class="n">grp_idx</span><span class="p">,</span> <span class="n">groups_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">sssr_list</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">get_deterministic_sssr</span><span class="p">()</span>
                <span class="n">sssr_index_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">ring</span><span class="p">]</span> <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">sssr_list</span><span class="p">]</span>
                <span class="n">atom_in_ring</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">atom_index</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ring</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sssr_index_list</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">atom_index</span> <span class="ow">in</span> <span class="n">ring</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">atom_index</span> <span class="ow">in</span> <span class="n">atom_in_ring</span><span class="p">:</span>
                                <span class="n">atom_in_ring</span><span class="p">[</span><span class="n">atom_index</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">atom_in_ring</span><span class="p">[</span><span class="n">atom_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">top</span><span class="p">:</span>
                        <span class="n">atom_indices</span> <span class="o">=</span> <span class="n">determine_top_group_indices</span><span class="p">(</span>
                            <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">atom1</span><span class="o">=</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">atom2</span><span class="o">=</span><span class="n">atom</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to_group</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">))</span>
                        <span class="n">grp_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom_indices</span><span class="p">)</span>
                        <span class="n">groups_indices</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">g</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">atom_indices</span><span class="p">])</span>
                <span class="n">flat_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">num</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">atom_in_ring</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)):</span>
                    <span class="k">break</span>
                <span class="c1"># hard-coding for NO2/NS2 groups, since the two O or S atoms have different atom types in each localized</span>
                <span class="c1"># structure, hence are not isomorphic</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">atomtype</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;N5dc&#39;</span> \
                        <span class="ow">and</span> <span class="p">(</span><span class="nb">all</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">atomtype</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;O2d&#39;</span><span class="p">,</span> <span class="s1">&#39;O0sc&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
                             <span class="ow">or</span> <span class="nb">all</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">atomtype</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;S2d&#39;</span><span class="p">,</span> <span class="s1">&#39;S0sc&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])):</span>
                    <span class="n">symmetry</span> <span class="o">*=</span> <span class="mi">2</span>
                <span class="c1"># all other groups:</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lone_pairs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">radical_electrons</span> <span class="o">&gt;</span> <span class="mi">0</span> \
                        <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_isomorphic</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">save_order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]):</span>
                    <span class="n">symmetry</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">symmetry</span></div>


<div class="viewcode-block" id="add_missing_symmetric_torsion_values"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.add_missing_symmetric_torsion_values">[docs]</a><span class="k">def</span> <span class="nf">add_missing_symmetric_torsion_values</span><span class="p">(</span><span class="n">top1</span><span class="p">,</span> <span class="n">mol_list</span><span class="p">,</span> <span class="n">torsion_scan</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add symmetry to a torsion scan in the rotor for efficient conformer generation.</span>

<span class="sd">    Args:</span>
<span class="sd">        top1 (list): A list of atom indices on one side of the torsion, including the pivotal atom.</span>
<span class="sd">        mol_list (list): A list of molecules.</span>
<span class="sd">        torsion_scan (list): The angles corresponding to this torsion from all conformers.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torsion_scan (list): The modified torsion_scan with added symmetric angles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">mol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">top2</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">top1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">top</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">top1</span><span class="p">,</span> <span class="n">top2</span><span class="p">]):</span>
        <span class="c1"># A quick bypass for carbon rotors that have three equal elements (e.g., CH3 or CF3) with only one bond that is connected to the carbon atom</span>
        <span class="c1"># For such rotors, if a torsion angle difference of 60 degrees is found during the sampling, we would like to manually add this gap for the existing symmetries</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_carbon</span><span class="p">()</span> \
                <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> \
                    <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)):</span>

            <span class="n">new_angles</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">torsion_scan</span><span class="p">:</span>
                <span class="n">test_angle</span> <span class="o">=</span> <span class="p">(</span><span class="n">angle</span> <span class="o">+</span> <span class="mi">60</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">test_angle</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span> <span class="o">&lt;=</span> <span class="n">existing_angle</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">test_angle</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span> <span class="k">for</span> <span class="n">existing_angle</span> <span class="ow">in</span> <span class="n">torsion_scan</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">angle_tba</span> <span class="ow">in</span> <span class="n">torsion_scan</span><span class="p">:</span>
                        <span class="n">new_angle</span> <span class="o">=</span> <span class="p">(</span><span class="n">angle_tba</span> <span class="o">+</span> <span class="mi">60</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>  <span class="c1"># Calculate new angle and ensure it wraps around at 360</span>
                        <span class="c1"># Check if the new angle, adjusted by Â±30 degrees, overlaps with any existing angles</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">((</span><span class="n">new_angle</span> <span class="o">-</span> <span class="mi">30</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span> <span class="o">&lt;=</span> <span class="n">existing_angle</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">new_angle</span> <span class="o">+</span> <span class="mi">30</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span> <span class="k">for</span> <span class="n">existing_angle</span> <span class="ow">in</span> <span class="n">torsion_scan</span> <span class="o">+</span> <span class="n">new_angles</span><span class="p">):</span>
                            <span class="n">new_angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_angle</span><span class="p">)</span>
                            <span class="k">break</span>
    
            <span class="c1"># Extend the original list with non-overlapping new angles</span>
            <span class="n">torsion_scan</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_angles</span><span class="p">)</span>
            <span class="n">torsion_scan</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># Sort the list to maintain order</span>

    <span class="k">return</span> <span class="n">torsion_scan</span></div>


<div class="viewcode-block" id="determine_well_width_tolerance"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.determine_well_width_tolerance">[docs]</a><span class="k">def</span> <span class="nf">determine_well_width_tolerance</span><span class="p">(</span><span class="n">mean_width</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the tolerance by which well widths are determined to be nearly equal.</span>

<span class="sd">    Fitted to a polynomial trend line for the following data of (mean, tolerance) pairs::</span>

<span class="sd">        (100, 0.11), (60, 0.13), (50, 0.15), (25, 0.25), (5, 0.50), (1, 0.59)</span>

<span class="sd">    Args:</span>
<span class="sd">        mean_width (float): The mean well width in degrees.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: The tolerance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mean_width</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.1</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.695e-10</span> <span class="o">*</span> <span class="n">mean_width</span> <span class="o">**</span> <span class="mi">5</span> <span class="o">+</span> <span class="mf">6.209e-8</span> <span class="o">*</span> <span class="n">mean_width</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">-</span> <span class="mf">8.855e-6</span> <span class="o">*</span> <span class="n">mean_width</span> <span class="o">**</span> <span class="mi">3</span> \
        <span class="o">+</span> <span class="mf">6.446e-4</span> <span class="o">*</span> <span class="n">mean_width</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">2.610e-2</span> <span class="o">*</span> <span class="n">mean_width</span> <span class="o">+</span> <span class="mf">0.6155</span>
    <span class="k">return</span> <span class="n">tol</span></div>


<div class="viewcode-block" id="get_lowest_confs"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.get_lowest_confs">[docs]</a><span class="k">def</span> <span class="nf">get_lowest_confs</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">confs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
                     <span class="n">n</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                     <span class="n">e</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
                     <span class="n">energy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;FF energy&#39;</span><span class="p">,</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the most stable conformer.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        confs (dict, list): Entries are either conformer dictionaries or a length two list of xyz coordinates and energy</span>
<span class="sd">        n (int, optional): Number of lowest conformers to return.</span>
<span class="sd">        e (float, optional): The energy threshold above the lowest energy conformer in kJ/mol</span>
<span class="sd">                             below which all conformers will be returned.</span>
<span class="sd">        energy (str, optional): The energy attribute to search by. Currently only &#39;FF energy&#39; is supported.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConformerError: If n &lt; 1, e &lt; 0, both n and e are ``None``, or if no conformers are given.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: Conformer dictionaries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;e cannot be negative, got: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;n cannot be lower than 1, got: </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="s1">&#39;Either `n` or `e` must be specified&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">confs</span> <span class="ow">or</span> <span class="n">confs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;get_lowest_confs() got no conformers for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">confs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">conformer_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">confs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">conformer_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">energy</span><span class="p">:</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">confs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">conformer_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">conformer</span> <span class="k">for</span> <span class="n">conformer</span> <span class="ow">in</span> <span class="n">confs</span> <span class="k">if</span> <span class="n">energy</span> <span class="ow">in</span> <span class="n">conformer</span> <span class="ow">and</span> <span class="n">conformer</span><span class="p">[</span><span class="n">energy</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;confs could either be a list of dictionaries or a list of lists. &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;Got a list of </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">confs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1">s for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">conformer_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">conformer</span><span class="p">:</span> <span class="n">conformer</span><span class="p">[</span><span class="n">energy</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_e</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">conf</span><span class="p">[</span><span class="n">energy</span><span class="p">]</span> <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">conformer_list</span><span class="p">])</span>
    <span class="n">lowest_confs</span> <span class="o">=</span> <span class="p">[</span><span class="n">conformer_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conformer_list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">conformer_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">energy</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_e</span> <span class="o">+</span> <span class="n">e</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lowest_confs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">lowest_conf</span> <span class="ow">in</span> <span class="n">lowest_confs</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">dmat1</span><span class="p">,</span> <span class="n">lowest_conf</span><span class="p">,</span> <span class="n">similar</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">compare_confs_fl</span><span class="p">(</span><span class="n">conformer_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;xyz&#39;</span><span class="p">],</span><span class="n">lowest_conf</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">similar</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">converter</span><span class="o">.</span><span class="n">compare_confs</span><span class="p">(</span><span class="n">conformer_list</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;xyz&#39;</span><span class="p">],</span> <span class="n">lowest_conf</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">],</span>
                                                              <span class="n">skip_conversion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                              <span class="n">dmat1</span><span class="o">=</span><span class="n">dmat1</span><span class="p">,</span><span class="n">dmat2</span><span class="o">=</span><span class="n">lowest_conf</span><span class="p">[</span><span class="s1">&#39;dmat&#39;</span><span class="p">]):</span>
                    <span class="n">lowest_confs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conformer_list</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="k">if</span> <span class="n">lowest_conf</span><span class="o">==</span><span class="n">lowest_confs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
    <span class="k">return</span> <span class="n">lowest_confs</span></div>


<div class="viewcode-block" id="get_torsion_angles"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.get_torsion_angles">[docs]</a><span class="k">def</span> <span class="nf">get_torsion_angles</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">conformers</span><span class="p">,</span> <span class="n">torsions</span><span class="p">,</span> <span class="n">mol_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tops</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Populate each torsion pivots with all available angles from the generated conformers.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        conformers (list): The conformers from which to extract the angles.</span>
<span class="sd">        torsions (list): The torsions to consider.</span>
<span class="sd">        mol_list (list, optional): A list of Molecule objects.</span>
<span class="sd">        tops (list, optional): A list of tops corresponding to torsions.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The torsion angles. Keys are torsion tuples, values are lists of all corresponding angles from conformers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">torsion_angles</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conformers</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="s1">&#39;torsion_dihedrals&#39;</span> <span class="ow">in</span> <span class="n">conformer</span> <span class="k">for</span> <span class="n">conformer</span> <span class="ow">in</span> <span class="n">conformers</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine dihedral torsion angles for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">. &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;Consider calling `determine_dihedrals()` first.&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">conformer</span> <span class="ow">in</span> <span class="n">conformers</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;torsion_dihedrals&#39;</span> <span class="ow">in</span> <span class="n">conformer</span> <span class="ow">and</span> <span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;torsion_dihedrals&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">torsions</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">torsion</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">torsion_angles</span><span class="p">:</span>
                    <span class="n">torsion_angles</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">torsion</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">torsion_angles</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">torsion</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;torsion_dihedrals&#39;</span><span class="p">][</span><span class="nb">tuple</span><span class="p">(</span><span class="n">torsion</span><span class="p">)])</span>
    <span class="k">for</span> <span class="n">tor</span> <span class="ow">in</span> <span class="n">torsion_angles</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">torsion_angles</span><span class="p">[</span><span class="n">tor</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">mol_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">torsion</span><span class="p">,</span> <span class="n">top</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">torsions</span><span class="p">,</span> <span class="n">tops</span><span class="p">):</span>
            <span class="n">torsion_angles</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">torsion</span><span class="p">)]</span> <span class="o">=</span> <span class="n">add_missing_symmetric_torsion_values</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">mol_list</span><span class="p">,</span> <span class="n">torsion_angles</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">torsion</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">torsion_angles</span></div>


<div class="viewcode-block" id="get_force_field_energies"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.get_force_field_energies">[docs]</a><span class="k">def</span> <span class="nf">get_force_field_energies</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">mol</span><span class="p">:</span> <span class="n">Molecule</span><span class="p">,</span>
                             <span class="n">num_confs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">xyz</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">force_field</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;MMFF94s&#39;</span><span class="p">,</span>
                             <span class="n">try_uff</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">optimize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">try_ob</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                             <span class="n">suppress_warning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                             <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine force field energies using RDKit.</span>
<span class="sd">    If ``num_confs`` is given, random 3D geometries will be generated. If xyz is given, it will be directly used instead.</span>
<span class="sd">    The coordinates are returned in the order of atoms in mol.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        mol (Molecule): The RMG molecule object with connectivity and bond order information.</span>
<span class="sd">        num_confs (int, optional): The number of random 3D conformations to generate.</span>
<span class="sd">        xyz (dict, optional): The 3D coordinates guess.</span>
<span class="sd">        force_field (str, optional): The type of force field to use.</span>
<span class="sd">        try_uff (bool, optional): Whether to try UFF if MMFF94(s) fails. ``True`` by default.</span>
<span class="sd">        optimize (bool, optional): Whether to first optimize the conformer using FF. True to optimize.</span>
<span class="sd">        try_ob (bool, optional): Whether to try OpenBabel if RDKit fails. ``True`` to try, ``True`` by default.</span>
<span class="sd">        suppress_warning (bool, optional): Whether to suppress OpenBabel warnings. ``False`` by default.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConformerError: If conformers could not be generated.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[list, list]:</span>
<span class="sd">            - Entries are xyz coordinates, each in a dict format.</span>
<span class="sd">            - Entries are the FF energies (in kJ/mol).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">force_field</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mmff94&#39;</span><span class="p">,</span> <span class="s1">&#39;mmff94s&#39;</span><span class="p">,</span> <span class="s1">&#39;uff&#39;</span><span class="p">]:</span>
        <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">embed_rdkit</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">num_confs</span><span class="o">=</span><span class="n">num_confs</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rd_mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span> <span class="o">=</span> <span class="n">rdkit_force_field</span><span class="p">(</span><span class="n">label</span><span class="p">,</span>
                                               <span class="n">rd_mol</span><span class="p">,</span>
                                               <span class="n">mol</span><span class="p">,</span>
                                               <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">,</span>
                                               <span class="n">try_uff</span><span class="o">=</span><span class="n">try_uff</span><span class="p">,</span>
                                               <span class="n">optimize</span><span class="o">=</span><span class="n">optimize</span><span class="p">,</span>
                                               <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyzs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">force_field</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gaff&#39;</span><span class="p">,</span> <span class="s1">&#39;mmff94&#39;</span><span class="p">,</span> <span class="s1">&#39;mmff94s&#39;</span><span class="p">,</span> <span class="s1">&#39;uff&#39;</span><span class="p">,</span> <span class="s1">&#39;ghemical&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">try_ob</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_warning</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using OpenBabel (instead of RDKit) as a fall back method to generate conformers for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">. &#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;This is often slower.&#39;</span><span class="p">)</span>
        <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span> <span class="o">=</span> <span class="n">openbabel_force_field</span><span class="p">(</span><span class="n">label</span><span class="p">,</span>
                                               <span class="n">mol</span><span class="p">,</span>
                                               <span class="n">num_confs</span><span class="p">,</span>
                                               <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span>
                                               <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">,</span>
                                               <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyzs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">force_field</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mmff94&#39;</span><span class="p">,</span> <span class="s1">&#39;mmff94s&#39;</span><span class="p">,</span> <span class="s1">&#39;uff&#39;</span><span class="p">,</span> <span class="s1">&#39;gaff&#39;</span><span class="p">,</span> <span class="s1">&#39;ghemical&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unrecognized force field for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">. Should be either MMFF94, MMFF94s, UFF, &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;Ghemical, or GAFF. Got: </span><span class="si">{</span><span class="n">force_field</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span></div>


<div class="viewcode-block" id="openbabel_force_field_on_rdkit_conformers"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.openbabel_force_field_on_rdkit_conformers">[docs]</a><span class="k">def</span> <span class="nf">openbabel_force_field_on_rdkit_conformers</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">rd_mol</span><span class="p">,</span> <span class="n">force_field</span><span class="o">=</span><span class="s1">&#39;MMFF94s&#39;</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimize RDKit conformers by OpenBabel using a force field (MMFF94 or MMFF94s are recommended).</span>
<span class="sd">    This is a fallback method when RDKit fails to generate force field optimized conformers.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        rd_mol (RDKit RDMol): The RDKit molecule with embedded conformers to optimize.</span>
<span class="sd">        force_field (str, optional): The type of force field to use.</span>
<span class="sd">        optimize (bool, optional): Whether to first optimize the conformer using FF. True to optimize.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[list, list]:</span>
<span class="sd">            - Entries are optimized xyz&#39;s in a dictionary format.</span>
<span class="sd">            - Entries are float numbers representing the energies (in kJ/mol).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rd_mol</span><span class="o">.</span><span class="n">GetNumConformers</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not generate conformers for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> via OpenBabel&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span>
    <span class="c1"># Set up Openbabel input and output format</span>
    <span class="n">obconversion</span> <span class="o">=</span> <span class="n">ob</span><span class="o">.</span><span class="n">OBConversion</span><span class="p">()</span>
    <span class="n">obconversion</span><span class="o">.</span><span class="n">SetInAndOutFormats</span><span class="p">(</span><span class="s1">&#39;xyz&#39;</span><span class="p">,</span> <span class="s1">&#39;xyz&#39;</span><span class="p">)</span>
    <span class="c1"># Set up Openbabel force field</span>
    <span class="n">ff</span> <span class="o">=</span> <span class="n">ob</span><span class="o">.</span><span class="n">OBForceField</span><span class="o">.</span><span class="n">FindForceField</span><span class="p">(</span><span class="n">force_field</span><span class="p">)</span>
    <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">rd_atom</span><span class="o">.</span><span class="n">GetSymbol</span><span class="p">()</span> <span class="k">for</span> <span class="n">rd_atom</span> <span class="ow">in</span> <span class="n">rd_mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rd_mol</span><span class="o">.</span><span class="n">GetNumConformers</span><span class="p">()):</span>
        <span class="c1"># Convert RDKit conformer to xyz string</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">rd_mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">xyz_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">conf</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()):</span>
            <span class="n">xyz_str</span> <span class="o">+=</span> <span class="n">symbols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;      &#39;</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">GetAtomPosition</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">xyz_str</span> <span class="o">+=</span> <span class="s1">&#39;   &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">z</span><span class="p">)])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="c1"># Build OpenBabel molecule from xyz string</span>
        <span class="n">ob_mol</span> <span class="o">=</span> <span class="n">ob</span><span class="o">.</span><span class="n">OBMol</span><span class="p">()</span>
        <span class="n">obconversion</span><span class="o">.</span><span class="n">ReadString</span><span class="p">(</span><span class="n">ob_mol</span><span class="p">,</span> <span class="n">xyz_str</span><span class="p">)</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">ob_mol</span><span class="p">)</span>
        <span class="c1"># Optimize the molecule if needed</span>
        <span class="k">if</span> <span class="n">optimize</span><span class="p">:</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">ConjugateGradients</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
        <span class="c1"># Export xyzs and energies</span>
        <span class="n">ob_mol</span><span class="o">.</span><span class="n">GetCoordinates</span><span class="p">()</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">GetCoordinates</span><span class="p">(</span><span class="n">ob_mol</span><span class="p">)</span>
        <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">Energy</span><span class="p">())</span>
        <span class="n">xyz_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">obconversion</span><span class="o">.</span><span class="n">WriteString</span><span class="p">(</span><span class="n">ob_mol</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="n">xyzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">converter</span><span class="o">.</span><span class="n">str_to_xyz</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span></div>


<div class="viewcode-block" id="mix_rdkit_and_openbabel_force_field"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.mix_rdkit_and_openbabel_force_field">[docs]</a><span class="k">def</span> <span class="nf">mix_rdkit_and_openbabel_force_field</span><span class="p">(</span><span class="n">label</span><span class="p">,</span>
                                        <span class="n">mol</span><span class="p">,</span>
                                        <span class="n">num_confs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">force_field</span><span class="o">=</span><span class="s1">&#39;GAFF&#39;</span><span class="p">,</span>
                                        <span class="n">try_ob</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimize conformers using a force field (GAFF, MMFF94s, MMFF94, UFF, Ghemical)</span>
<span class="sd">    Use RDKit to generate the random conformers (OpenBabel isn&#39;t good enough),</span>
<span class="sd">    but use OpenBabel to optimize them (RDKit doesn&#39;t have GAFF).</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        mol (Molecule, optional): The RMG molecule object with connectivity and bond order information.</span>
<span class="sd">        num_confs (int, optional): The number of random 3D conformations to generate.</span>
<span class="sd">        xyz (string or list, optional): The 3D coordinates in either a string or an array format.</span>
<span class="sd">        force_field (str, optional): The type of force field to use.</span>
<span class="sd">        try_ob (bool, optional): Whether to try OpenBabel if RDKit fails. ``True`` to try, ``False`` by default.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[list, list]:</span>
<span class="sd">            - Entries are optimized xyz&#39;s in a list format.</span>
<span class="sd">            - Entries are float numbers representing the energies in kJ/mol.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">embed_rdkit</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">num_confs</span><span class="o">=</span><span class="n">num_confs</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rd_mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span>
    <span class="n">unoptimized_xyzs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rd_mol</span><span class="o">.</span><span class="n">GetNumConformers</span><span class="p">()):</span>
        <span class="n">conf</span><span class="p">,</span> <span class="n">xyz</span> <span class="o">=</span> <span class="n">rd_mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()):</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">GetAtomPosition</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">xyz</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">z</span><span class="p">])</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyz</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyz</span><span class="p">)]</span>  <span class="c1"># reorder</span>
        <span class="n">unoptimized_xyzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">try_ob</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">unoptimized_xyzs</span><span class="p">):</span>
            <span class="c1"># use OB as the fallback method</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using OpenBabel (instead of RDKit) as a fall back method to generate conformers for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">. &#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;This is often slower, and prohibits ARC from using all features of the conformers module.&#39;</span><span class="p">)</span>
            <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span> <span class="o">=</span> <span class="n">openbabel_force_field</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">num_confs</span><span class="p">,</span> <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">unoptimized_xyzs</span><span class="p">:</span>
                <span class="n">xyzs_</span><span class="p">,</span> <span class="n">energies_</span> <span class="o">=</span> <span class="n">openbabel_force_field</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">num_confs</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">)</span>
                <span class="n">xyzs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">xyzs_</span><span class="p">)</span>
                <span class="n">energies</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">energies_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span></div>


<div class="viewcode-block" id="openbabel_force_field"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.openbabel_force_field">[docs]</a><span class="k">def</span> <span class="nf">openbabel_force_field</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">num_confs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_field</span><span class="o">=</span><span class="s1">&#39;GAFF&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;diverse&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimize conformers using a force field (GAFF, MMFF94s, MMFF94, UFF, Ghemical).</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        mol (Molecule, optional): The RMG molecule object with connectivity and bond order information.</span>
<span class="sd">        num_confs (int, optional): The number of random 3D conformations to generate.</span>
<span class="sd">        xyz (dict, optional): The 3D coordinates.</span>
<span class="sd">        force_field (str, optional): The type of force field to use.</span>
<span class="sd">        method (str, optional): The conformer searching method to use in OpenBabel.</span>
<span class="sd">                                For method description, see https://openbabel.org/dev-api/group__conformer.shtml</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[list, list]:</span>
<span class="sd">            - Entries are optimized xyz&#39;s in a list format.</span>
<span class="sd">            - Entries are float numbers representing the energies in kJ/mol.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">ff</span> <span class="o">=</span> <span class="n">ob</span><span class="o">.</span><span class="n">OBForceField</span><span class="o">.</span><span class="n">FindForceField</span><span class="p">(</span><span class="n">force_field</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">obmol</span> <span class="o">=</span> <span class="n">ob</span><span class="o">.</span><span class="n">OBMol</span><span class="p">()</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">vertices</span>
        <span class="n">ob_atom_ids</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">obmol</span><span class="o">.</span><span class="n">NewAtom</span><span class="p">()</span>
            <span class="n">a</span><span class="o">.</span><span class="n">SetAtomicNum</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">SetVector</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">isotope</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">SetIsotope</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">isotope</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">SetFormalCharge</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>
            <span class="n">ob_atom_ids</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span>
        <span class="n">orders</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">atom1</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">vertices</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">atom1</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">is_hydrogen_bond</span><span class="p">():</span>
                    <span class="k">continue</span>
                <span class="n">index1</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom1</span><span class="p">)</span>
                <span class="n">index2</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">index1</span> <span class="o">&lt;</span> <span class="n">index2</span><span class="p">:</span>
                    <span class="n">obmol</span><span class="o">.</span><span class="n">AddBond</span><span class="p">(</span><span class="n">index1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">index2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">orders</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">order</span><span class="p">])</span>

        <span class="c1"># optimize</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">obmol</span><span class="p">)</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">SetLogLevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">SetVDWCutOff</span><span class="p">(</span><span class="mf">6.0</span><span class="p">)</span>  <span class="c1"># The VDW cut-off distance (default=6.0)</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">SetElectrostaticCutOff</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>  <span class="c1"># The Electrostatic cut-off distance (default=10.0)</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">SetUpdateFrequency</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># The frequency to update the non-bonded pairs (default=10)</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">EnableCutOff</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Use cut-off (default=don&#39;t use cut-off)</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">SteepestDescentInitialize</span><span class="p">()</span>  <span class="c1"># ConjugateGradientsInitialize</span>
        <span class="n">v</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">SteepestDescentTakeNSteps</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># ConjugateGradientsTakeNSteps</span>
            <span class="k">if</span> <span class="n">ff</span><span class="o">.</span><span class="n">DetectExplosion</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Force field </span><span class="si">{</span><span class="n">force_field</span><span class="si">}</span><span class="s1"> exploded with method SteepestDescent for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">GetCoordinates</span><span class="p">(</span><span class="n">obmol</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">num_confs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">obmol</span><span class="p">,</span> <span class="n">ob_atom_ids</span> <span class="o">=</span> <span class="n">to_ob_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">return_mapping</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pybmol</span> <span class="o">=</span> <span class="n">pyb</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="n">obmol</span><span class="p">)</span>
        <span class="n">pybmol</span><span class="o">.</span><span class="n">make3D</span><span class="p">()</span>
        <span class="n">obmol</span> <span class="o">=</span> <span class="n">pybmol</span><span class="o">.</span><span class="n">OBMol</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">obmol</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;weighted&#39;</span><span class="p">:</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">WeightedRotorSearch</span><span class="p">(</span><span class="n">num_confs</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">RandomRotorSearch</span><span class="p">(</span><span class="n">num_confs</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;diverse&#39;</span><span class="p">:</span>
            <span class="n">rmsd_cutoff</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">energy_cutoff</span> <span class="o">=</span> <span class="mf">50.</span>
            <span class="n">confab_verbose</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">DiverseConfGen</span><span class="p">(</span><span class="n">rmsd_cutoff</span><span class="p">,</span> <span class="n">num_confs</span><span class="p">,</span> <span class="n">energy_cutoff</span><span class="p">,</span> <span class="n">confab_verbose</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;systematic&#39;</span><span class="p">:</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">SystematicRotorSearch</span><span class="p">(</span><span class="n">num_confs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not identify method </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Either num_confs or xyz should be given for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">ff</span><span class="o">.</span><span class="n">GetConformers</span><span class="p">(</span><span class="n">obmol</span><span class="p">)</span>
    <span class="n">obconversion</span> <span class="o">=</span> <span class="n">ob</span><span class="o">.</span><span class="n">OBConversion</span><span class="p">()</span>
    <span class="n">obconversion</span><span class="o">.</span><span class="n">SetOutFormat</span><span class="p">(</span><span class="s1">&#39;xyz&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">obmol</span><span class="o">.</span><span class="n">NumConformers</span><span class="p">()):</span>
        <span class="n">obmol</span><span class="o">.</span><span class="n">SetConformer</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">obmol</span><span class="p">)</span>
        <span class="n">xyz_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">obconversion</span><span class="o">.</span><span class="n">WriteString</span><span class="p">(</span><span class="n">obmol</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="n">xyz_dict</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">str_to_xyz</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">)</span>
        <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="n">ob_atom_ids</span><span class="p">[</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="p">]]]</span>
                                   <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">])))</span>
        <span class="n">xyzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">)</span>
        <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">Energy</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span></div>


<div class="viewcode-block" id="embed_rdkit"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.embed_rdkit">[docs]</a><span class="k">def</span> <span class="nf">embed_rdkit</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">num_confs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate unoptimized conformers in RDKit. If ``xyz`` is not given, random conformers will be generated.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        mol (RMG Molecule or RDKit RDMol): The molecule object with connectivity and bond order information.</span>
<span class="sd">        num_confs (int, optional): The number of random 3D conformations to generate.</span>
<span class="sd">        xyz (dict, optional): The 3D coordinates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[RDMol]: An RDKIt molecule with embedded conformers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">num_confs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Either num_confs or xyz must be set when calling embed_rdkit() for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">RDMol</span><span class="p">):</span>
        <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">mol</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
        <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">to_rdkit_mol</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">remove_h</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Argument mol can be either an RMG Molecule or an RDKit RDMol object. &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_confs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Chem</span><span class="o">.</span><span class="n">AllChem</span><span class="o">.</span><span class="n">EmbedMultipleConfs</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">,</span> <span class="n">numConfs</span><span class="o">=</span><span class="n">num_confs</span><span class="p">,</span> <span class="n">randomSeed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">enforceChirality</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not embed conformers using RDKit for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rd_conf</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Conformer</span><span class="p">(</span><span class="n">rd_mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rd_mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()):</span>
            <span class="n">rd_conf</span><span class="o">.</span><span class="n">SetAtomPosition</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">rd_mol</span><span class="o">.</span><span class="n">AddConformer</span><span class="p">(</span><span class="n">rd_conf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rd_mol</span></div>


<div class="viewcode-block" id="read_rdkit_embedded_conformers"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.read_rdkit_embedded_conformers">[docs]</a><span class="k">def</span> <span class="nf">read_rdkit_embedded_conformers</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">rd_mol</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rd_index_map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read coordinates from RDKit conformers.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        rd_mol (RDKit RDMol): The RDKit molecule with embedded conformers to optimize.</span>
<span class="sd">        i (int, optional): The conformer index from rd_mol to read. If None, all will be read,</span>
<span class="sd">        rd_index_map (list, optional): An atom map dictionary to reorder the xyz. Requires mol to not be ``None``.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: Entries are xyz coordinate dicts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xyzs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># read all conformers:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rd_mol</span><span class="o">.</span><span class="n">GetNumConformers</span><span class="p">()):</span>
            <span class="n">xyzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read_rdkit_embedded_conformer_i</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rd_index_map</span><span class="o">=</span><span class="n">rd_index_map</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rd_mol</span><span class="o">.</span><span class="n">GetNumConformers</span><span class="p">():</span>
        <span class="c1"># read only conformer i:</span>
        <span class="n">xyzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read_rdkit_embedded_conformer_i</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rd_index_map</span><span class="o">=</span><span class="n">rd_index_map</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot read conformer number &quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&quot; out of </span><span class="si">{</span><span class="n">rd_mol</span><span class="o">.</span><span class="n">GetNumConformers</span><span class="p">()</span><span class="si">}</span><span class="s1"> RDKit &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;conformers for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyzs</span></div>


<div class="viewcode-block" id="read_rdkit_embedded_conformer_i"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.read_rdkit_embedded_conformer_i">[docs]</a><span class="k">def</span> <span class="nf">read_rdkit_embedded_conformer_i</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rd_index_map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read coordinates from RDKit conformers.</span>

<span class="sd">    Args:</span>
<span class="sd">        rd_mol (RDKit RDMol): The RDKit molecule with embedded conformers to optimize.</span>
<span class="sd">        i (int): The conformer index from rd_mol to read.</span>
<span class="sd">        rd_index_map (list, optional): An atom map dictionary to reorder the xyz.</span>
<span class="sd">                                       Keys are rdkit atom indices, values are RMG mol atom indices.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: xyz coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="n">rd_mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()):</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">GetAtomPosition</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>
    <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">rd_atom</span><span class="o">.</span><span class="n">GetSymbol</span><span class="p">()</span> <span class="k">for</span> <span class="n">rd_atom</span> <span class="ow">in</span> <span class="n">rd_mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">rd_index_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># reorder</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="n">rd_index_map</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">))]</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">symbols</span><span class="p">[</span><span class="n">rd_index_map</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">))]</span>
    <span class="n">xyz_dict</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">xyz_from_data</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">symbols</span><span class="o">=</span><span class="n">symbols</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyz_dict</span></div>


<div class="viewcode-block" id="rdkit_force_field"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.rdkit_force_field">[docs]</a><span class="k">def</span> <span class="nf">rdkit_force_field</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">rd_mol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RDMol</span><span class="p">],</span>
                      <span class="n">mol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Molecule</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">num_confs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">force_field</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;MMFF94s&#39;</span><span class="p">,</span>
                      <span class="n">try_uff</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="n">optimize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="n">try_ob</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                      <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimize RDKit conformers using a force field (MMFF94 or MMFF94s are recommended).</span>
<span class="sd">    For UFF see: https://www.rdkit.org/docs/source/rdkit.Chem.rdForceFieldHelpers.html#rdkit.Chem.rdForceFieldHelpers.UFFOptimizeMoleculeConfs</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        rd_mol (RDKit RDMol): The RDKit molecule with embedded conformers to optimize.</span>
<span class="sd">        mol (Molecule, optional): The RMG molecule object with connectivity and bond order information.</span>
<span class="sd">        num_confs (int, optional): The number of random 3D conformations to generate.</span>
<span class="sd">        force_field (str, optional): The type of force field to use.</span>
<span class="sd">        try_uff (bool, optional): Whether to try UFF if MMFF94(s) fails. ``True`` by default.</span>
<span class="sd">        optimize (bool, optional): Whether to first optimize the conformer using FF. True to optimize.</span>
<span class="sd">        try_ob (bool, optional): Whether to try OpenBabel if RDKit fails. ``True`` to try, ``False`` by default.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[list, list]:</span>
<span class="sd">            - Entries are optimized xyz&#39;s in a dictionary format.</span>
<span class="sd">            - Entries are float numbers representing the energies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rd_mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rd_mol</span><span class="o">.</span><span class="n">GetNumConformers</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">optimize</span><span class="p">:</span>
            <span class="n">v</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>  <span class="c1"># v == 1: continue, v == 0: enough steps, v == -1: unable to set up</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFOptimizeMolecule</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">,</span>
                                                          <span class="n">mmffVariant</span><span class="o">=</span><span class="n">force_field</span><span class="p">,</span>
                                                          <span class="n">confId</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                                                          <span class="n">maxIters</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                                                          <span class="n">ignoreInterfragInteractions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                          <span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">mol_properties</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFGetMoleculeProperties</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">,</span> <span class="n">mmffVariant</span><span class="o">=</span><span class="n">force_field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mol_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ff</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">AllChem</span><span class="o">.</span><span class="n">MMFFGetMoleculeForceField</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">,</span> <span class="n">mol_properties</span><span class="p">,</span> <span class="n">confId</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">optimize</span><span class="p">:</span>
                <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">CalcEnergy</span><span class="p">())</span>
            <span class="n">xyzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read_rdkit_embedded_conformer_i</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyzs</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;MMFF&#39;</span> <span class="ow">in</span> <span class="n">force_field</span> <span class="ow">and</span> <span class="n">try_uff</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">optimize</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">AllChem</span><span class="o">.</span><span class="n">UFFOptimizeMoleculeConfs</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">,</span>
                                                               <span class="n">maxIters</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                                                               <span class="n">ignoreInterfragInteractions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                               <span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">try_ob</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using OpenBabel (instead of RDKit) as a fall back method to generate conformers &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">. This is often slower.&#39;</span><span class="p">)</span>
                    <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span> <span class="o">=</span> <span class="n">openbabel_force_field_on_rdkit_conformers</span><span class="p">(</span><span class="n">label</span><span class="p">,</span>
                                                                               <span class="n">rd_mol</span><span class="p">,</span>
                                                                               <span class="n">force_field</span><span class="o">=</span><span class="n">force_field</span><span class="p">,</span>
                                                                               <span class="n">optimize</span><span class="o">=</span><span class="n">optimize</span><span class="p">,</span>
                                                                               <span class="p">)</span>
                    <span class="k">return</span> <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rd_mol</span><span class="o">.</span><span class="n">GetNumConformers</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># The optimization converged.</span>
                <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">xyzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read_rdkit_embedded_conformer_i</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">xyzs</span><span class="p">,</span> <span class="n">energies</span></div>


<div class="viewcode-block" id="get_wells"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.get_wells">[docs]</a><span class="k">def</span> <span class="nf">get_wells</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="n">WELL_GAP</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the distinct wells from a list of angles.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        angles (list): The angles in the torsion.</span>
<span class="sd">        blank (int, optional): The blank space between wells.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: Entry are well dicts with keys: ``start_idx``, ``end_idx``, ``start_angle``, ``end_angle``, ``angles``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">angles</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot determine wells without angles for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">new_angles</span> <span class="o">=</span> <span class="n">angles</span>
    <span class="k">if</span> <span class="n">angles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">blank</span> <span class="ow">and</span> <span class="n">angles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">360</span> <span class="o">-</span> <span class="n">blank</span><span class="p">:</span>
        <span class="c1"># relocate the first chunk of data at the end, the well seems to include the  +180/-180 degrees point</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">angles</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angle</span> <span class="o">-</span> <span class="n">angles</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">blank</span><span class="p">:</span>
                <span class="n">part2</span> <span class="o">=</span> <span class="n">angles</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">part2</span><span class="p">):</span>
                    <span class="n">part2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">360</span>
                <span class="n">new_angles</span> <span class="o">=</span> <span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="o">+</span> <span class="n">part2</span>
                <span class="k">break</span>
    <span class="n">wells</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">new_well</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_angles</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_well</span><span class="p">:</span>
            <span class="n">wells</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;start_idx&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                          <span class="s1">&#39;end_idx&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="s1">&#39;start_angle&#39;</span><span class="p">:</span> <span class="n">new_angles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                          <span class="s1">&#39;end_angle&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="s1">&#39;angles&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">()})</span>
            <span class="n">new_well</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">wells</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;angles&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_angles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">new_angles</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_angles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">blank</span><span class="p">:</span>
            <span class="c1"># This is the last point in this well</span>
            <span class="n">wells</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;end_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">wells</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;end_angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">new_well</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wells</span><span class="p">):</span>
        <span class="n">wells</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;end_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_angles</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">wells</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;end_angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_angles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">wells</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;angles&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_angles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">wells</span></div>


<div class="viewcode-block" id="check_special_non_rotor_cases"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.check_special_non_rotor_cases">[docs]</a><span class="k">def</span> <span class="nf">check_special_non_rotor_cases</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">top1</span><span class="p">,</span> <span class="n">top2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether one of the tops correspond to a special case which does not have a torsional mode.</span>
<span class="sd">    Checking for ``R-[C,N]#[N,[CH],[C]]`` groups, such as: in cyano groups (`R-C#N``),</span>
<span class="sd">    C#C groups (``R-C#CH`` or ``R-C#[C]``), and azide groups: (``R-N#N``).</span>

<span class="sd">    Args:</span>
<span class="sd">        mol (Molecule): The RMG molecule.</span>
<span class="sd">        top1 (list): Entries are atom indices (1-indexed) on one side of the torsion, inc. one of the pivotal atoms.</span>
<span class="sd">        top2 (list): Entries are atom indices (1-indexed) on the other side of the torsion, inc. the other pivotal atom.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: ``True`` if this is indeed a special case which should **not** be treated as a torsional mode.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">top</span> <span class="ow">in</span> <span class="p">[</span><span class="n">top1</span><span class="p">,</span> <span class="n">top2</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">atomtype</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Ct&#39;</span><span class="p">,</span> <span class="s1">&#39;N3t&#39;</span><span class="p">,</span> <span class="s1">&#39;N5tc&#39;</span><span class="p">]</span> \
                <span class="ow">and</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">atomtype</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Ct&#39;</span><span class="p">,</span> <span class="s1">&#39;N3t&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">top</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_hydrogen</span><span class="p">())):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="find_internal_rotors"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.find_internal_rotors">[docs]</a><span class="k">def</span> <span class="nf">find_internal_rotors</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Locates the sets of indices corresponding to every internal rotor (1-indexed).</span>

<span class="sd">    Args:</span>
<span class="sd">        mol (Molecule): The molecule for which rotors will be determined.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: Entries are rotor dictionaries with the four-atom scan coordinates, the pivots, and the smallest top.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rotors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">atom1</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">vertices</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">is_non_hydrogen</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">atom1</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">atom2</span><span class="o">.</span><span class="n">is_non_hydrogen</span><span class="p">()</span> <span class="ow">and</span> <span class="n">mol</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mol</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom2</span><span class="p">)</span> \
                        <span class="ow">and</span> <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">is_single</span><span class="p">()</span> <span class="ow">or</span> <span class="n">bond</span><span class="o">.</span><span class="n">is_hydrogen_bond</span><span class="p">())</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mol</span><span class="o">.</span><span class="n">is_bond_in_cycle</span><span class="p">(</span><span class="n">bond</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># None of the pivotal atoms are terminal.</span>
                        <span class="n">rotor</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="c1"># pivots:</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="c1"># top:</span>
                        <span class="n">top1</span><span class="p">,</span> <span class="n">top1_has_heavy_atoms</span> <span class="o">=</span> <span class="n">determine_top_group_indices</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">top2</span><span class="p">,</span> <span class="n">top2_has_heavy_atoms</span> <span class="o">=</span> <span class="n">determine_top_group_indices</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">non_rotor</span> <span class="o">=</span> <span class="n">check_special_non_rotor_cases</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">top1</span><span class="p">,</span> <span class="n">top2</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">non_rotor</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">top1_has_heavy_atoms</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">top2_has_heavy_atoms</span><span class="p">:</span>
                            <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">top2</span>
                        <span class="k">elif</span> <span class="n">top2_has_heavy_atoms</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">top1_has_heavy_atoms</span><span class="p">:</span>
                            <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">top1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">top1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">top2</span><span class="p">)</span> <span class="k">else</span> <span class="n">top2</span>
                        <span class="c1"># scan:</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">determine_smallest_atom_index_in_scan</span><span class="p">(</span><span class="n">atom1</span><span class="o">=</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="o">=</span><span class="n">atom2</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">)]</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">determine_smallest_atom_index_in_scan</span><span class="p">(</span><span class="n">atom1</span><span class="o">=</span><span class="n">atom2</span><span class="p">,</span> <span class="n">atom2</span><span class="o">=</span><span class="n">atom1</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">))</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;torsion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_list_index_0_to_1</span><span class="p">(</span><span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">],</span> <span class="n">direction</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

                        <span class="c1"># other keys:</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;number_of_running_jobs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;invalidation_reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;times_dihedral_set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;trsh_counter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;trsh_methods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;directed_scan_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ess&#39;</span>  <span class="c1"># default to &#39;ess&#39;, changed in initialize_directed_rotors()</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;original_dihedrals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;max_e&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">rotors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rotor</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rotors</span></div>


<div class="viewcode-block" id="determine_smallest_atom_index_in_scan"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.determine_smallest_atom_index_in_scan">[docs]</a><span class="k">def</span> <span class="nf">determine_smallest_atom_index_in_scan</span><span class="p">(</span><span class="n">atom1</span><span class="p">:</span> <span class="n">Atom</span><span class="p">,</span>
                                          <span class="n">atom2</span><span class="p">:</span> <span class="n">Atom</span><span class="p">,</span>
                                          <span class="n">mol</span><span class="p">:</span> <span class="n">Molecule</span><span class="p">,</span>
                                          <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the smallest atom index in ``mol`` connected to ``atom1`` which is not ``atom2``.</span>
<span class="sd">    Returns a heavy atom if available, otherwise a hydrogen atom.</span>
<span class="sd">    Useful for deterministically determining the indices of four atom in a scan.</span>
<span class="sd">    This function assumes there ARE additional atoms connected to ``atom1``, and that ``atom2`` is not a hydrogen atom.</span>

<span class="sd">    Args:</span>
<span class="sd">        atom1 (Atom): The atom whose neighbors will be searched.</span>
<span class="sd">        atom2 (Atom): An atom connected to ``atom1`` to exclude (a pivotal atom).</span>
<span class="sd">        mol (Molecule): The molecule to process.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The smallest atom index (1-indexed) connected to ``atom1`` which is not ``atom2``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">heavy_atoms</span><span class="p">,</span> <span class="n">hydrogens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">atom3</span> <span class="ow">in</span> <span class="n">atom1</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">atom3</span><span class="o">.</span><span class="n">is_hydrogen</span><span class="p">():</span>
            <span class="n">hydrogens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom3</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">atom3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">atom2</span><span class="p">:</span>
            <span class="n">heavy_atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom3</span><span class="p">))</span>
    <span class="n">smallest_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">heavy_atoms</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">atom_index</span> <span class="ow">in</span> <span class="n">heavy_atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atom_index</span> <span class="o">&lt;</span> <span class="n">smallest_index</span><span class="p">:</span>
                <span class="n">smallest_index</span> <span class="o">=</span> <span class="n">atom_index</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">atom_index</span> <span class="ow">in</span> <span class="n">hydrogens</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atom_index</span> <span class="o">&lt;</span> <span class="n">smallest_index</span><span class="p">:</span>
                <span class="n">smallest_index</span> <span class="o">=</span> <span class="n">atom_index</span>
    <span class="k">return</span> <span class="n">smallest_index</span> <span class="o">+</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="to_group"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.to_group">[docs]</a><span class="k">def</span> <span class="nf">to_group</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method converts a defined part of a Molecule into a Group.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol (Molecule): The base molecule.</span>
<span class="sd">        atom_indices (list): 0-indexed atom indices corresponding to atoms in mol to be included in the group.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Group: A group consisting of the desired atoms in mol.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create GroupAtom object for each atom in the molecule</span>
    <span class="n">group_atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">index_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># keys are Molecule atom indices, values are Group atom indices</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atom_indices</span><span class="p">):</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom_index</span><span class="p">]</span>
        <span class="n">group_atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gr</span><span class="o">.</span><span class="n">GroupAtom</span><span class="p">(</span><span class="n">atomtype</span><span class="o">=</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">atomtype</span><span class="p">],</span> <span class="n">radical_electrons</span><span class="o">=</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">radical_electrons</span><span class="p">],</span>
                                        <span class="n">charge</span><span class="o">=</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">charge</span><span class="p">],</span> <span class="n">lone_pairs</span><span class="o">=</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">lone_pairs</span><span class="p">]))</span>
        <span class="n">index_map</span><span class="p">[</span><span class="n">atom_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="n">group_atoms</span><span class="p">,</span> <span class="n">multiplicity</span><span class="o">=</span><span class="p">[</span><span class="n">mol</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
        <span class="c1"># Create a GroupBond for each bond between desired atoms in the molecule</span>
        <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span> <span class="ow">in</span> <span class="n">atom_indices</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bonded_atom</span><span class="p">,</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">bonded_atom</span><span class="p">)</span> <span class="ow">in</span> <span class="n">atom_indices</span><span class="p">:</span>
                    <span class="n">group</span><span class="o">.</span><span class="n">add_bond</span><span class="p">(</span><span class="n">gr</span><span class="o">.</span><span class="n">GroupBond</span><span class="p">(</span><span class="n">atom1</span><span class="o">=</span><span class="n">group_atoms</span><span class="p">[</span><span class="n">index_map</span><span class="p">[</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom</span><span class="p">)]],</span>
                                                <span class="n">atom2</span><span class="o">=</span><span class="n">group_atoms</span><span class="p">[</span><span class="n">index_map</span><span class="p">[</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">bonded_atom</span><span class="p">)]],</span>
                                                <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">order</span><span class="p">]))</span>
    <span class="n">group</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">group</span></div>


<div class="viewcode-block" id="update_mol"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.update_mol">[docs]</a><span class="k">def</span> <span class="nf">update_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update atom types, multiplicity, and atom charges in the molecule.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol (Molecule): The molecule to update.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Molecule: the updated molecule.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">update_charge</span><span class="p">()</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">update_atomtypes</span><span class="p">(</span><span class="n">log_species</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">update_multiplicity</span><span class="p">()</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">identify_ring_membership</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">mol</span></div>


<div class="viewcode-block" id="generate_monoatomic_conformer"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.generate_monoatomic_conformer">[docs]</a><span class="k">def</span> <span class="nf">generate_monoatomic_conformer</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a conformer for a monoatomic species.</span>

<span class="sd">    Args:</span>
<span class="sd">        symbol (str): The atomic symbol.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The monoatomic conformer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,),</span>
                    <span class="s1">&#39;isotopes&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">converter</span><span class="o">.</span><span class="n">get_most_common_isotope_for_element</span><span class="p">(</span><span class="n">symbol</span><span class="p">),),</span>
                    <span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),)},</span>
            <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;FF energy&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;chirality&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;monoatomic species&#39;</span><span class="p">,</span>
            <span class="s1">&#39;torsion_dihedrals&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
    <span class="k">return</span> <span class="n">conf</span></div>


<div class="viewcode-block" id="generate_diatomic_conformer"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.generate_diatomic_conformer">[docs]</a><span class="k">def</span> <span class="nf">generate_diatomic_conformer</span><span class="p">(</span><span class="n">symbol_1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                <span class="n">symbol_2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                <span class="n">multiplicity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a conformer for a diatomic species.</span>
<span class="sd">    Data from CCCBDB.</span>

<span class="sd">    Args:</span>
<span class="sd">        symbol_1 (str): The atomic symbol of atom 1.</span>
<span class="sd">        symbol_2 (str): The atomic symbol of atom 2.</span>
<span class="sd">        multiplicity (int, optional): The diatomic species multiplicity</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The diatomic conformer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">multiplicity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">symbol_1</span> <span class="o">==</span> <span class="n">symbol_2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">symbol_1</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.3710</span>
            <span class="k">if</span> <span class="n">symbol_1</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.6029</span>
            <span class="k">elif</span> <span class="n">symbol_1</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.6088</span>
            <span class="k">elif</span> <span class="n">symbol_1</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.9492</span>
            <span class="k">elif</span> <span class="n">symbol_1</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.9655</span>
            <span class="k">elif</span> <span class="n">symbol_1</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.5491</span>
            <span class="k">elif</span> <span class="n">symbol_1</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.6059</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">symbol_1</span><span class="p">,</span> <span class="n">symbol_2</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;O&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="s1">&#39;H&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.6131</span>
            <span class="k">elif</span> <span class="s1">&#39;N&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="s1">&#39;H&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.5197</span>
            <span class="k">elif</span> <span class="s1">&#39;N&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="s1">&#39;H&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.5165</span>
            <span class="k">elif</span> <span class="s1">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="s1">&#39;O&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.5647</span>
            <span class="k">elif</span> <span class="s1">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="s1">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.7752</span>
            <span class="k">elif</span> <span class="s1">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="s1">&#39;H&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.5585</span>
            <span class="k">elif</span> <span class="s1">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="s1">&#39;H&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.5456</span>
            <span class="k">elif</span> <span class="s1">&#39;N&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="s1">&#39;O&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.5740</span>
            <span class="k">elif</span> <span class="s1">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="s1">&#39;O&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.7414</span>
            <span class="k">elif</span> <span class="s1">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="s1">&#39;O&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.7498</span>
            <span class="k">elif</span> <span class="s1">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="s1">&#39;H&#39;</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="ow">and</span> <span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mf">0.6690</span>
    <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">get_single_bond_length</span><span class="p">(</span><span class="n">symbol_1</span><span class="p">,</span> <span class="n">symbol_2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">symbol_1</span><span class="p">,</span> <span class="n">symbol_2</span><span class="p">),</span>
                    <span class="s1">&#39;isotopes&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">converter</span><span class="o">.</span><span class="n">get_most_common_isotope_for_element</span><span class="p">(</span><span class="n">symbol_1</span><span class="p">),</span>
                                 <span class="n">converter</span><span class="o">.</span><span class="n">get_most_common_isotope_for_element</span><span class="p">(</span><span class="n">symbol_2</span><span class="p">)),</span>
                    <span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">r</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">r</span><span class="p">))},</span>
            <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;FF energy&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;chirality&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;diatomic species&#39;</span><span class="p">,</span>
            <span class="s1">&#39;torsion_dihedrals&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
    <span class="k">return</span> <span class="n">conf</span></div>


<div class="viewcode-block" id="translate_groups"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.translate_groups">[docs]</a><span class="k">def</span> <span class="nf">translate_groups</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">pivot</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exchange between two groups in a molecule. The groups cannot share a ring with the pivotal atom.</span>
<span class="sd">    The function does not change the atom order, just the coordinates of atoms.</span>
<span class="sd">    If the pivotal atom has exactly one lone pair, consider it as well as a dummy atom in translations.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        mol (Molecule): The 2D graph representation of the molecule.</span>
<span class="sd">        xyz (dict): A string-format 3d coordinates of the molecule with the same atom order as in mol.</span>
<span class="sd">        pivot (int): The 0-index of the pivotal atom around which groups are to be translated.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The translated coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">identify_ring_membership</span><span class="p">()</span>  <span class="c1"># populates the Atom.props[&#39;inRing&#39;] attribute</span>
    <span class="n">atom1</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">pivot</span><span class="p">]</span>
    <span class="n">lp</span> <span class="o">=</span> <span class="n">atom1</span><span class="o">.</span><span class="n">lone_pairs</span>
    <span class="k">if</span> <span class="n">lp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot translate groups for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> if the pivotal atom has more than one &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;lone electron pair&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xyz</span>
    <span class="n">groups</span><span class="p">,</span> <span class="n">translate</span><span class="p">,</span> <span class="n">dont_translate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">pivot</span><span class="p">]</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">determine_top_group_indices</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;atom&#39;</span><span class="p">:</span> <span class="n">atom2</span><span class="p">,</span> <span class="s1">&#39;protons&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">number</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">top</span><span class="p">])})</span>  <span class="c1"># a dict per top</span>
        <span class="k">if</span> <span class="s1">&#39;inRing&#39;</span> <span class="ow">in</span> <span class="n">atom1</span><span class="o">.</span><span class="n">props</span> <span class="ow">and</span> <span class="n">atom1</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;inRing&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;inRing&#39;</span> <span class="ow">in</span> <span class="n">atom2</span><span class="o">.</span><span class="n">props</span> <span class="ow">and</span> <span class="n">atom2</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;inRing&#39;</span><span class="p">]:</span>
            <span class="c1"># check whether atom1 and atom2 belong to the same ring</span>
            <span class="n">sssr</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">get_deterministic_sssr</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">sssr</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atom1</span> <span class="ow">in</span> <span class="n">ring</span> <span class="ow">and</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">ring</span><span class="p">:</span>
                    <span class="n">dont_translate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom2</span><span class="p">)</span>
                    <span class="k">break</span>
    <span class="n">groups</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;protons&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># sort by the size (sum of atomic numbers)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">translate</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">lp</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;atom&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dont_translate</span><span class="p">:</span>
            <span class="n">translate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">translate</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">lp</span><span class="p">:</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">get_lp_vector</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="n">pivot</span><span class="p">)</span>
        <span class="n">new_xyz</span> <span class="o">=</span> <span class="n">translate_group</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="n">pivot</span><span class="p">,</span>
                                  <span class="n">anchor</span><span class="o">=</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">translate</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;atom&#39;</span><span class="p">]),</span> <span class="n">vector</span><span class="o">=</span><span class="n">vector</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">translate</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lp</span><span class="p">:</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">get_vector</span><span class="p">(</span><span class="n">pivot</span><span class="o">=</span><span class="n">pivot</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;atom&#39;</span><span class="p">]),</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">)</span>
        <span class="n">new_xyz</span> <span class="o">=</span> <span class="n">translate_group</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="n">pivot</span><span class="p">,</span>
                                  <span class="n">anchor</span><span class="o">=</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">translate</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;atom&#39;</span><span class="p">]),</span> <span class="n">vector</span><span class="o">=</span><span class="n">vector</span><span class="p">)</span>
        <span class="c1"># keep original xyz:</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">get_vector</span><span class="p">(</span><span class="n">pivot</span><span class="o">=</span><span class="n">pivot</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">translate</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;atom&#39;</span><span class="p">]),</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">)</span>
        <span class="n">new_xyz</span> <span class="o">=</span> <span class="n">translate_group</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">new_xyz</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="n">pivot</span><span class="p">,</span>
                                  <span class="n">anchor</span><span class="o">=</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;atom&#39;</span><span class="p">]),</span> <span class="n">vector</span><span class="o">=</span><span class="n">vector</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The number of groups to translate is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">translate</span><span class="p">)</span><span class="si">}</span><span class="s1">, expected 1 &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;(with a lone pair) for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The number of groups to translate is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">translate</span><span class="p">)</span><span class="si">}</span><span class="s1">, expected 2 for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_xyz</span></div>


<div class="viewcode-block" id="translate_group"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.translate_group">[docs]</a><span class="k">def</span> <span class="nf">translate_group</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">anchor</span><span class="p">,</span> <span class="n">vector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Translate a group (a set of atoms from the pivot towards the anchor and onwards) by changing its</span>
<span class="sd">    pivot -&gt; anchor vector to the desired new vector. Keep the relative distances between the group&#39;s atoms constant,</span>
<span class="sd">    as well as the distance between the anchor and the vector atoms.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol (Molecule): The 2D graph representation of the molecule.</span>
<span class="sd">        xyz (dict): The 3D coordinates of the molecule with the same atom order as in mol.</span>
<span class="sd">        pivot (int): The 0-index of the pivotal atom around which groups are to be translated.</span>
<span class="sd">        anchor (int): The 0-index of an anchor atom. The group is defined from the pivot atom to the anchor atom,</span>
<span class="sd">                      including all other atoms in the molecule connected to the anchor. The pivot and anchor</span>
<span class="sd">                      atoms should not have another path connecting them such as a ring.</span>
<span class="sd">        vector (list): The new vector by which the group will be translated.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The translated coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># v1 = unit_vector([-vector[0], -vector[1], -vector[2]])  # reverse the direction to get the correct angle</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">unit_vector</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">unit_vector</span><span class="p">(</span><span class="n">vectors</span><span class="o">.</span><span class="n">get_vector</span><span class="p">(</span><span class="n">pivot</span><span class="o">=</span><span class="n">pivot</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="n">anchor</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">))</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">get_normal</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="n">v1</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">get_angle</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>
    <span class="c1"># print(theta * 180 / math.pi)  # print theta in degrees when troubleshooting</span>
    <span class="c1"># All atoms within the group will be rotated around the same normal vector by theta:</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">determine_top_group_indices</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">atom1</span><span class="o">=</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">pivot</span><span class="p">],</span> <span class="n">atom2</span><span class="o">=</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">anchor</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">xyz_to_coords_list</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
        <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">rotate_vector</span><span class="p">(</span><span class="n">point_a</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="n">pivot</span><span class="p">],</span> <span class="n">point_b</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">normal</span><span class="o">=</span><span class="n">normal</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">new_xyz</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">xyz_from_data</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">symbols</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span> <span class="n">isotopes</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">new_xyz</span></div>


<div class="viewcode-block" id="get_number_of_chiral_centers"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.get_number_of_chiral_centers">[docs]</a><span class="k">def</span> <span class="nf">get_number_of_chiral_centers</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">just_get_the_number</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the number of chiral centers by type. Either ``conformer`` or ``xyz`` must be given.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species label.</span>
<span class="sd">        mol (Molecule): The RMG Molecule object.</span>
<span class="sd">        conformer (dict, optional): A conformer dictionary.</span>
<span class="sd">        xyz (dict, optional): The xyz coordinates.</span>
<span class="sd">        just_get_the_number (bool, optional): Return the number of chiral centers regardless of their type.</span>

<span class="sd">    Raises:</span>
<span class="sd">        InputError: If neither ``conformer`` nor ``xyz`` were given.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[dict, int]:</span>
<span class="sd">            Keys are types of chiral sites (&#39;C&#39; for carbon, &#39;N&#39; for nitrogen, &#39;D&#39; for double bond),</span>
<span class="sd">            values are the number of chiral centers of each type. If ``just_get_the_number`` is ``True``,</span>
<span class="sd">            just returns the number of chiral centers (integer).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">conformer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Must get either conformer or xyz.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">conformer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">conformer</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="n">xyz</span><span class="p">}</span>
    <span class="n">conformer</span> <span class="o">=</span> <span class="n">determine_chirality</span><span class="p">(</span><span class="n">conformers</span><span class="o">=</span><span class="p">[</span><span class="n">conformer</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;chirality&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">]:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;NR&#39;</span><span class="p">,</span> <span class="s1">&#39;NS&#39;</span><span class="p">]:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">]:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chiral symbols must be either `R`, `S`, `NR`, `NS`, `E`, `Z`, got: </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">just_get_the_number</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="get_lowest_diastereomers"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.get_lowest_diastereomers">[docs]</a><span class="k">def</span> <span class="nf">get_lowest_diastereomers</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">conformers</span><span class="p">,</span> <span class="n">diastereomers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the 2^(n-1) diastereomers with the lowest energy (where n is the number of chiral centers in the molecule).</span>
<span class="sd">    We exclude enantiomers (mirror images where ALL chiral centers simultaneously invert).</span>
<span class="sd">    If a specific diastereomer is given (in an xyz dict form), then only the lowest conformer with the same chirality</span>
<span class="sd">    will be returned.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        mol (Molecule): The 2D graph representation of the molecule.</span>
<span class="sd">        conformers (list): Entries are conformer dictionaries.</span>
<span class="sd">        diastereomers (list, optional): Entries are xyz&#39;s in a dictionary format or conformer structures</span>
<span class="sd">                                        representing specific diastereomers to keep.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConformerError: If diastereomers is not None and is of wrong type,</span>
<span class="sd">                        or if conformers with the requested chirality combination could not be generated.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: Entries are lowest energy diastereomeric conformer dictionaries to consider.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># assign chirality properties to all conformers</span>
    <span class="n">conformers</span> <span class="o">=</span> <span class="n">determine_chirality</span><span class="p">(</span><span class="n">conformers</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">)</span>
    <span class="c1"># initialize the enantiomeric dictionary (includes enantiomers and diastereomers)</span>
    <span class="c1"># keys are chiral combinations, values are lowest conformers</span>
    <span class="n">enantiomers_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">conformer</span> <span class="ow">in</span> <span class="n">conformers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;FF energy&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chirality_tuple</span> <span class="o">=</span> <span class="n">chirality_dict_to_tuple</span><span class="p">(</span><span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;chirality&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">chirality_tuple</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">enantiomers_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="c1"># this is a new enantiomer, consider it</span>
                <span class="n">enantiomers_dict</span><span class="p">[</span><span class="n">chirality_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="n">conformer</span>
            <span class="k">elif</span> <span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;FF energy&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">enantiomers_dict</span><span class="p">[</span><span class="n">chirality_tuple</span><span class="p">][</span><span class="s1">&#39;FF energy&#39;</span><span class="p">]:</span>
                <span class="c1"># found a lower energy conformer with the same chirality, replace</span>
                <span class="n">enantiomers_dict</span><span class="p">[</span><span class="n">chirality_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="n">conformer</span>
    <span class="k">if</span> <span class="n">diastereomers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># no specific diastereomers were requested</span>
        <span class="n">pruned_enantiomers_dict</span> <span class="o">=</span> <span class="n">prune_enantiomers_dict</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">enantiomers_dict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">diastereomers</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># make sure entries are conformers, convert if needed</span>
            <span class="n">modified_diastereomers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">diastereomer</span> <span class="ow">in</span> <span class="n">diastereomers</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">diastereomer</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">diastereomer</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;coords&#39;</span> <span class="ow">in</span> <span class="n">diastereomer</span><span class="p">:</span>
                    <span class="c1"># we&#39;ll also accept string format xyz</span>
                    <span class="n">modified_diastereomers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="n">converter</span><span class="o">.</span><span class="n">check_xyz_dict</span><span class="p">(</span><span class="n">diastereomer</span><span class="p">)})</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">diastereomer</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;xyz&#39;</span> <span class="ow">in</span> <span class="n">diastereomer</span><span class="p">:</span>
                    <span class="n">modified_diastereomers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diastereomer</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;diastereomers entries must be either xyz or conformer dictionaries, &#39;</span>
                                         <span class="sa">f</span><span class="s1">&#39;got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">diastereomer</span><span class="p">)</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">diastereomer_confs</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="n">converter</span><span class="o">.</span><span class="n">check_xyz_dict</span><span class="p">(</span><span class="n">diastereomer</span><span class="p">)}</span> <span class="k">for</span> <span class="n">diastereomer</span> <span class="ow">in</span> <span class="n">diastereomers</span><span class="p">]</span>
            <span class="n">diastereomer_confs</span> <span class="o">=</span> <span class="n">determine_chirality</span><span class="p">(</span><span class="n">diastereomer_confs</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;diastereomers must be a list of xyz coordinates, got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">diastereomers</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">chirality_tuples</span> <span class="o">=</span> <span class="p">[</span><span class="n">chirality_dict_to_tuple</span><span class="p">(</span><span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;chirality&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">conformer</span> <span class="ow">in</span> <span class="n">diastereomer_confs</span><span class="p">]</span>
        <span class="n">new_enantiomers_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">chirality_tuple</span><span class="p">,</span> <span class="n">conformer</span> <span class="ow">in</span> <span class="n">enantiomers_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">chirality_tuple</span> <span class="ow">in</span> <span class="n">chirality_tuples</span><span class="p">:</span>
                <span class="n">new_enantiomers_dict</span><span class="p">[</span><span class="n">chirality_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="n">conformer</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_enantiomers_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not generate conformers with chirality combination:</span><span class="se">\n</span><span class="si">{</span><span class="n">chirality_tuples</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">pruned_enantiomers_dict</span> <span class="o">=</span> <span class="n">prune_enantiomers_dict</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">new_enantiomers_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pruned_enantiomers_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="ow">and</span> <span class="nb">list</span><span class="p">(</span><span class="n">pruned_enantiomers_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">tuple</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Considering the following enantiomeric combinations for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">pruned_enantiomers_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">pruned_enantiomers_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>


<div class="viewcode-block" id="prune_enantiomers_dict"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.prune_enantiomers_dict">[docs]</a><span class="k">def</span> <span class="nf">prune_enantiomers_dict</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">enantiomers_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper function for screening out enantiomers from the enantiomers_dict, leaving only diastereomers</span>
<span class="sd">    (so removing all exact mirror images). Note that double bond chiralities &#39;E&#39; and &#39;Z&#39; are not mirror images of each</span>
<span class="sd">    other, and are not pruned out.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        enantiomers_dict (dict): Keys are chirality tuples, values are conformer structures.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The pruned enantiomers_dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pruned_enantiomers_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">chirality_tuples</span><span class="p">,</span> <span class="n">conformer</span> <span class="ow">in</span> <span class="n">enantiomers_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">inversed_chirality_tuples</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([(</span><span class="n">chirality_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inverse_chirality_symbol</span><span class="p">(</span><span class="n">chirality_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                           <span class="k">for</span> <span class="n">chirality_tuple</span> <span class="ow">in</span> <span class="n">chirality_tuples</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">chirality_tuples</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pruned_enantiomers_dict</span> <span class="ow">and</span> <span class="n">inversed_chirality_tuples</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pruned_enantiomers_dict</span><span class="p">:</span>
            <span class="c1"># this combination (or its exact mirror image) was not considered yet</span>
            <span class="k">if</span> <span class="n">inversed_chirality_tuples</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">enantiomers_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="c1"># the mirror image exists, check which has a lower energy</span>
                <span class="n">inversed_conformer</span> <span class="o">=</span> <span class="n">enantiomers_dict</span><span class="p">[</span><span class="n">inversed_chirality_tuples</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">inversed_conformer</span><span class="p">[</span><span class="s1">&#39;FF energy&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;FF energy&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not get energies of enantiomers </span><span class="si">{</span><span class="n">chirality_tuples</span><span class="si">}</span><span class="s1"> &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;nor its mirror image </span><span class="si">{</span><span class="n">inversed_chirality_tuples</span><span class="si">}</span><span class="s1"> for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">inversed_conformer</span><span class="p">[</span><span class="s1">&#39;FF energy&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pruned_enantiomers_dict</span><span class="p">[</span><span class="n">chirality_tuples</span><span class="p">]</span> <span class="o">=</span> <span class="n">conformer</span>
                <span class="k">elif</span> <span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;FF energy&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pruned_enantiomers_dict</span><span class="p">[</span><span class="n">inversed_chirality_tuples</span><span class="p">]</span> <span class="o">=</span> <span class="n">inversed_conformer</span>
                <span class="k">elif</span> <span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;FF energy&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">inversed_conformer</span><span class="p">[</span><span class="s1">&#39;FF energy&#39;</span><span class="p">]:</span>
                    <span class="n">pruned_enantiomers_dict</span><span class="p">[</span><span class="n">chirality_tuples</span><span class="p">]</span> <span class="o">=</span> <span class="n">conformer</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pruned_enantiomers_dict</span><span class="p">[</span><span class="n">inversed_chirality_tuples</span><span class="p">]</span> <span class="o">=</span> <span class="n">inversed_conformer</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># the mirror image does not exist</span>
                <span class="n">pruned_enantiomers_dict</span><span class="p">[</span><span class="n">chirality_tuples</span><span class="p">]</span> <span class="o">=</span> <span class="n">conformer</span>
    <span class="k">return</span> <span class="n">pruned_enantiomers_dict</span></div>


<div class="viewcode-block" id="inverse_chirality_symbol"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.inverse_chirality_symbol">[docs]</a><span class="k">def</span> <span class="nf">inverse_chirality_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inverses a chirality symbol, e.g., the &#39;R&#39; character to &#39;S&#39;, or &#39;NS&#39; to &#39;NR&#39;.</span>
<span class="sd">    Note that chiral double bonds (&#39;E&#39; and &#39;Z&#39;) must not be inversed (they are not mirror images of each other).</span>

<span class="sd">    Args:</span>
<span class="sd">        symbol (str): The chirality symbol.</span>

<span class="sd">    Raises:</span>
<span class="sd">        InputError: If ``symbol`` could not be recognized.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The inverse chirality symbol.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inversion_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;NR&#39;</span><span class="p">:</span> <span class="s1">&#39;NS&#39;</span><span class="p">,</span> <span class="s1">&#39;NS&#39;</span><span class="p">:</span> <span class="s1">&#39;NR&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="s1">&#39;Z&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">inversion_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recognized chirality symbols are &#39;R&#39;, &#39;S&#39;, &#39;NR&#39;, &#39;NS&#39;, &#39;E&#39;, and &#39;Z&#39;, got </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inversion_dict</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span></div>


<div class="viewcode-block" id="chirality_dict_to_tuple"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.chirality_dict_to_tuple">[docs]</a><span class="k">def</span> <span class="nf">chirality_dict_to_tuple</span><span class="p">(</span><span class="n">chirality_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper function for using the chirality dictionary of a conformer as a key in the enantiomers_dict</span>
<span class="sd">    by converting it to a tuple deterministically.</span>

<span class="sd">    Args:</span>
<span class="sd">        chirality_dict (dict): The chirality dictionary of a conformer.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConformerError: If the chirality values are wrong.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A deterministic tuple representation of the chirality dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># extract carbon sites (values are either &#39;R&#39; or &#39;S&#39;), nitrogen sites (values are either &#39;NR&#39; or &#39;NS&#39;)</span>
    <span class="c1"># and chiral double bonds (values are either &#39;E&#39; or &#39;Z&#39;)</span>
    <span class="n">c_sites</span><span class="p">,</span> <span class="n">n_sites</span><span class="p">,</span> <span class="n">bonds</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">site</span><span class="p">,</span> <span class="n">chirality</span> <span class="ow">in</span> <span class="n">chirality_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">chirality</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">]:</span>
            <span class="n">c_sites</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">site</span><span class="p">,</span> <span class="n">chirality</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">chirality</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;NR&#39;</span><span class="p">,</span> <span class="s1">&#39;NS&#39;</span><span class="p">]:</span>
            <span class="n">n_sites</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">site</span><span class="p">,</span> <span class="n">chirality</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">chirality</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">]:</span>
            <span class="n">bond_site</span> <span class="o">=</span> <span class="n">site</span> <span class="k">if</span> <span class="n">site</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">site</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="p">(</span><span class="n">site</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">site</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bond_site</span><span class="p">,</span> <span class="n">chirality</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Chiralities could either be R, S, NR, NS, E, or Z. Got: </span><span class="si">{</span><span class="n">chirality</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="c1"># sort the lists</span>
    <span class="n">c_sites</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">entry</span><span class="p">:</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">n_sites</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">entry</span><span class="p">:</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">bonds</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">entry</span><span class="p">:</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># combine by order</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">c_sites</span> <span class="o">+</span> <span class="n">n_sites</span> <span class="o">+</span> <span class="n">bonds</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>


<div class="viewcode-block" id="determine_chirality"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.determine_chirality">[docs]</a><span class="k">def</span> <span class="nf">determine_chirality</span><span class="p">(</span><span class="n">conformers</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines the Cahnâ€“Ingoldâ€“Prelog (CIP) chirality (R or S) of atoms in the conformer,</span>
<span class="sd">    as well as the CIP chirality of double bonds (E or Z).</span>

<span class="sd">    Args:</span>
<span class="sd">        conformers (list): Entries are conformer dictionaries.</span>
<span class="sd">        label (str): The species&#39; label.</span>
<span class="sd">        mol (RMG Molecule or RDKit RDMol): The molecule object with connectivity and bond order information.</span>
<span class="sd">        force (bool, optional): Whether to override data, ``True`` to override, default is ``False``.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: Conformer dictionaries with updated with &#39;chirality&#39;. ``conformer[&#39;chirality&#39;]`` is a dictionary.</span>
<span class="sd">              Keys are either a 1-length tuple of atom indices (for chiral atom centers) or a 2-length tuple of atom</span>
<span class="sd">              indices (for chiral double bonds), values are either &#39;R&#39; or &#39;S&#39; for chiral atom centers</span>
<span class="sd">              (or &#39;NR&#39; or &#39;NS&#39; for chiral nitrogen centers), or &#39;E&#39; or &#39;Z&#39; for chiral double bonds.</span>
<span class="sd">              All atom indices are 0-indexed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chiral_nitrogen_centers</span> <span class="o">=</span> <span class="n">identify_chiral_nitrogen_centers</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="n">new_mol</span><span class="p">,</span> <span class="n">elements_to_insert</span> <span class="o">=</span> <span class="n">replace_n_with_c_in_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">chiral_nitrogen_centers</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">conformer</span> <span class="ow">in</span> <span class="n">conformers</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;chirality&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">conformer</span><span class="p">:</span>
            <span class="c1"># keys are either 1-length atom indices (for chiral atom centers)</span>
            <span class="c1"># or 2-length atom indices (for chiral double bonds)</span>
            <span class="c1"># values are either &#39;R&#39;, &#39;S&#39;, &#39;NR&#39;, &#39;NS&#39;, &#39;E&#39;, or &#39;Z&#39;</span>
            <span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;chirality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;chirality&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="c1"># don&#39;t override data</span>
            <span class="k">continue</span>
        <span class="n">new_xyz</span> <span class="o">=</span> <span class="n">replace_n_with_c_in_xyz</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">],</span> <span class="n">chiral_nitrogen_centers</span><span class="p">,</span> <span class="n">elements_to_insert</span><span class="p">)</span>
        <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">embed_rdkit</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">new_mol</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">new_xyz</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rd_mol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">rd_mol</span><span class="o">.</span><span class="n">GetNumConformers</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">rd_mol</span><span class="o">.</span><span class="n">UpdatePropertyCache</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">Chem</span><span class="o">.</span><span class="n">rdmolops</span><span class="o">.</span><span class="n">AssignStereochemistryFrom3D</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rd_atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rd_mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()):</span>
            <span class="n">rd_atom_props_dict</span> <span class="o">=</span> <span class="n">rd_atom</span><span class="o">.</span><span class="n">GetPropsAsDict</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;_CIPCode&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">rd_atom_props_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">is_nitrogen</span><span class="p">():</span>
                    <span class="c1"># this is a nitrogen site in the original molecule, mark accordingly</span>
                    <span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;chirality&#39;</span><span class="p">][(</span><span class="n">i</span><span class="p">,)]</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span> <span class="o">+</span> <span class="n">rd_atom_props_dict</span><span class="p">[</span><span class="s1">&#39;_CIPCode&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;chirality&#39;</span><span class="p">][(</span><span class="n">i</span><span class="p">,)]</span> <span class="o">=</span> <span class="n">rd_atom_props_dict</span><span class="p">[</span><span class="s1">&#39;_CIPCode&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">rd_bond</span> <span class="ow">in</span> <span class="n">rd_mol</span><span class="o">.</span><span class="n">GetBonds</span><span class="p">():</span>
            <span class="n">stereo</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rd_bond</span><span class="o">.</span><span class="n">GetStereo</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">stereo</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;STEREOE&#39;</span><span class="p">,</span> <span class="s1">&#39;STEREOZ&#39;</span><span class="p">]:</span>
                <span class="c1"># possible values are &#39;STEREOANY&#39;, &#39;STEREOCIS&#39;, &#39;STEREOE&#39;, &#39;STEREONONE&#39;, &#39;STEREOTRANS&#39;, and &#39;STEREOZ&#39;</span>
                <span class="n">rd_atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">rd_bond</span><span class="o">.</span><span class="n">GetBeginAtomIdx</span><span class="p">(),</span> <span class="n">rd_bond</span><span class="o">.</span><span class="n">GetEndAtomIdx</span><span class="p">()]</span>  <span class="c1"># indices of atoms bonded by this bond</span>
                <span class="n">conformer</span><span class="p">[</span><span class="s1">&#39;chirality&#39;</span><span class="p">][</span><span class="nb">tuple</span><span class="p">(</span><span class="n">rd_atom</span> <span class="k">for</span> <span class="n">rd_atom</span> <span class="ow">in</span> <span class="n">rd_atoms</span><span class="p">)]</span> <span class="o">=</span> <span class="n">stereo</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">conformers</span></div>


<div class="viewcode-block" id="identify_chiral_nitrogen_centers"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.identify_chiral_nitrogen_centers">[docs]</a><span class="k">def</span> <span class="nf">identify_chiral_nitrogen_centers</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify the atom indices corresponding to a chiral nitrogen centers in a molecule (umbrella modes).</span>

<span class="sd">    Args:</span>
<span class="sd">        mol (Molecule): The molecule to be analyzed.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If ``mol`` is of wrong type.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: Atom numbers (0-indexed) representing chiral nitrogen centers in the molecule (umbrella modes).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mol must be a Molecule instance, got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">chiral_nitrogen_centers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">atom1</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">is_nitrogen</span><span class="p">()</span> <span class="ow">and</span> <span class="n">atom1</span><span class="o">.</span><span class="n">lone_pairs</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">atom1</span><span class="o">.</span><span class="n">radical_electrons</span> <span class="o">==</span> <span class="mi">0</span> \
                <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">3</span>
                     <span class="ow">or</span> <span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">radical_electrons</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)):</span>
            <span class="n">groups</span><span class="p">,</span> <span class="n">tops</span><span class="p">,</span> <span class="n">top_element_counts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">atom1</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">top</span> <span class="o">=</span> <span class="n">determine_top_group_indices</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">tops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>
                <span class="n">top_element_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_top_element_count</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">top</span><span class="p">))</span>
                <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to_group</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">top</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">top_element_counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">top_element_counts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">top_element_counts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">top_element_counts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> \
                    <span class="ow">or</span> <span class="nb">all</span><span class="p">([</span><span class="ow">not</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_isomorphic</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">save_order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">+</span>
                           <span class="p">[</span><span class="ow">not</span> <span class="n">groups</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_isomorphic</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">save_order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]):</span>
                <span class="c1"># if we can say that TWO groups, each separately considered, isn&#39;t isomorphic to the others,</span>
                <span class="c1"># then this nitrogen has all different groups.</span>
                <span class="n">chiral_nitrogen_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">chiral_nitrogen_centers</span></div>


<div class="viewcode-block" id="replace_n_with_c_in_mol"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.replace_n_with_c_in_mol">[docs]</a><span class="k">def</span> <span class="nf">replace_n_with_c_in_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">chiral_nitrogen_centers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace nitrogen atoms (pre-identified as chiral centers) with carbon atoms, replacing the lone electron pair</span>
<span class="sd">    (assuming just one exists) with a hydrogen or a halogen atom, preserving any radical electrons on the nitrogen atom.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol (Molecule): The molecule to be analyzed.</span>
<span class="sd">        chiral_nitrogen_centers (list): The 0-index of chiral (umbrella mode) nitrogen atoms in the molecule.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConformerError: If any of the atoms indicated by ``chiral_nitrogen_centers`` could not be a chiral nitrogen atom.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[Molecule, list]:</span>
<span class="sd">            - A copy of the molecule with replaced N atoms.</span>
<span class="sd">            - Elements inserted in addition to the C atom, ordered as in ``chiral_nitrogen_centers``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_mol</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">inserted_elements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">n_index</span> <span class="ow">in</span> <span class="n">chiral_nitrogen_centers</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">n_index</span><span class="p">]</span><span class="o">.</span><span class="n">is_nitrogen</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot replace a nitrogen atom index </span><span class="si">{</span><span class="n">n_index</span><span class="si">}</span><span class="s1"> if it is not a nitrogen element.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">n_index</span><span class="p">]</span><span class="o">.</span><span class="n">lone_pairs</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot replace a nitrogen atom index </span><span class="si">{</span><span class="n">n_index</span><span class="si">}</span><span class="s1"> with number of lone pairs &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;different than one (got: </span><span class="si">{</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">n_index</span><span class="p">]</span><span class="o">.</span><span class="n">lone_pairs</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">n_index</span><span class="p">]</span><span class="o">.</span><span class="n">radical_electrons</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot replace a nitrogen atom index </span><span class="si">{</span><span class="n">n_index</span><span class="si">}</span><span class="s1"> if it has more than one radical &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;electrons (got: </span><span class="si">{</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">n_index</span><span class="p">]</span><span class="o">.</span><span class="n">radical_electrons</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">bond</span><span class="o">.</span><span class="n">is_single</span><span class="p">()</span> <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">n_index</span><span class="p">]</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">values</span><span class="p">()]):</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot replace a nitrogen atom index </span><span class="si">{</span><span class="n">n_index</span><span class="si">}</span><span class="s1"> if not all of its bonds are single &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;(got: </span><span class="si">{</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">order</span> <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">n_index</span><span class="p">]</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
        <span class="n">new_c_atom</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">(</span><span class="n">element</span><span class="o">=</span><span class="n">C_ELEMENT</span><span class="p">,</span> <span class="n">radical_electrons</span><span class="o">=</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">n_index</span><span class="p">]</span><span class="o">.</span><span class="n">radical_electrons</span><span class="p">,</span>
                          <span class="n">charge</span><span class="o">=</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">n_index</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">lone_pairs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">n_index</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">new_c_atom</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">n_index</span><span class="p">]</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># delete bonds from all other atoms connected to the atom represented by n_index</span>
            <span class="k">del</span> <span class="n">new_mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom2</span><span class="p">)]</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">new_mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">n_index</span><span class="p">]]</span>
        <span class="n">new_mol</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">n_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_c_atom</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>  <span class="c1"># mark hydrogen, fluorine, and chlorine neighbors of the original atom</span>
        <span class="k">for</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">n_index</span><span class="p">]</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">new_mol</span><span class="o">.</span><span class="n">add_bond</span><span class="p">(</span><span class="n">Bond</span><span class="p">(</span><span class="n">atom1</span><span class="o">=</span><span class="n">new_c_atom</span><span class="p">,</span> <span class="n">atom2</span><span class="o">=</span><span class="n">new_mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom2</span><span class="p">)],</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">atom2</span><span class="o">.</span><span class="n">is_hydrogen</span><span class="p">():</span>
                <span class="n">h</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">atom2</span><span class="o">.</span><span class="n">is_fluorine</span><span class="p">():</span>
                <span class="n">f</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">atom2</span><span class="o">.</span><span class="n">is_chlorine</span><span class="p">():</span>
                <span class="n">cl</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="p">:</span>
            <span class="n">additional_element</span> <span class="o">=</span> <span class="n">H_ELEMENT</span>
            <span class="n">inserted_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">additional_element</span> <span class="o">=</span> <span class="n">F_ELEMENT</span>
            <span class="n">inserted_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">cl</span><span class="p">:</span>
            <span class="n">additional_element</span> <span class="o">=</span> <span class="n">Cl_ELEMENT</span>
            <span class="n">inserted_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Cl&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># this can only happen if the molecule is NHFCl (ammonia substituted with one F and one Cl), use iodine</span>
            <span class="n">additional_element</span> <span class="o">=</span> <span class="n">I_ELEMENT</span>
            <span class="n">inserted_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">)</span>
        <span class="n">new_atom</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">(</span><span class="n">element</span><span class="o">=</span><span class="n">additional_element</span><span class="p">,</span> <span class="n">radical_electrons</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">lone_pairs</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="n">additional_element</span><span class="o">.</span><span class="n">number</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">new_atom</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># new_mol.add_atom(new_atom)</span>

        <span class="n">new_mol</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_atom</span><span class="p">)</span>
        <span class="n">new_bond</span> <span class="o">=</span> <span class="n">Bond</span><span class="p">(</span><span class="n">atom1</span><span class="o">=</span><span class="n">new_c_atom</span><span class="p">,</span> <span class="n">atom2</span><span class="o">=</span><span class="n">new_atom</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">new_mol</span><span class="o">.</span><span class="n">add_bond</span><span class="p">(</span><span class="n">new_bond</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_mol</span><span class="p">,</span> <span class="n">inserted_elements</span></div>


<div class="viewcode-block" id="replace_n_with_c_in_xyz"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.replace_n_with_c_in_xyz">[docs]</a><span class="k">def</span> <span class="nf">replace_n_with_c_in_xyz</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">chiral_nitrogen_centers</span><span class="p">,</span> <span class="n">elements_to_insert</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace nitrogen atoms (pre-identified as chiral centers) with carbon atoms, replacing the lone electron pair</span>
<span class="sd">    (assuming just one exists) with a hydrogen or a halogen atom.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species label.</span>
<span class="sd">        mol (Molecule): The respective molecule object.</span>
<span class="sd">        xyz (dict): The 3D coordinates to process.</span>
<span class="sd">        chiral_nitrogen_centers (list): The 0-index of chiral (umbrella mode) nitrogen atoms in the molecule.</span>
<span class="sd">        elements_to_insert (list): The element (H/F/Cl/I) to insert in addition to C per nitrogen center.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The coordinates with replaced N atoms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">symbols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">]))</span>
    <span class="n">isotopes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">]))</span> <span class="k">if</span> <span class="s1">&#39;isotopes&#39;</span> <span class="ow">in</span> <span class="n">xyz</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">xyz_to_coords_list</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n_index</span><span class="p">,</span> <span class="n">element_to_insert</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chiral_nitrogen_centers</span><span class="p">,</span> <span class="n">elements_to_insert</span><span class="p">):</span>
        <span class="n">symbols</span><span class="p">[</span><span class="n">n_index</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span>
        <span class="k">if</span> <span class="n">isotopes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">isotopes</span><span class="p">[</span><span class="n">n_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="k">if</span> <span class="n">element_to_insert</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
            <span class="n">symbol</span><span class="p">,</span> <span class="n">isotope</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.1</span>
        <span class="k">elif</span> <span class="n">element_to_insert</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span>
            <span class="n">symbol</span><span class="p">,</span> <span class="n">isotope</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mf">2.0</span>
        <span class="k">elif</span> <span class="n">element_to_insert</span> <span class="o">==</span> <span class="s1">&#39;Cl&#39;</span><span class="p">:</span>
            <span class="n">symbol</span><span class="p">,</span> <span class="n">isotope</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="s1">&#39;Cl&#39;</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mf">1.77</span>
        <span class="k">elif</span> <span class="n">element_to_insert</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
            <span class="n">symbol</span><span class="p">,</span> <span class="n">isotope</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mf">2.14</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConformerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Element to insert must be either H, F, Cl, or I. Got: </span><span class="si">{</span><span class="n">element_to_insert</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isotopes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">isotopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">isotope</span><span class="p">)</span>
        <span class="n">lp_vector</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">set_vector_length</span><span class="p">(</span><span class="n">vectors</span><span class="o">.</span><span class="n">get_lp_vector</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">n_index</span><span class="p">),</span> <span class="n">distance</span><span class="p">)</span>
        <span class="n">lp_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">coords</span><span class="p">[</span><span class="n">n_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lp_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">coords</span><span class="p">[</span><span class="n">n_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lp_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">coords</span><span class="p">[</span><span class="n">n_index</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lp_vector</span><span class="p">)</span>
    <span class="n">new_xyz</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">xyz_from_data</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">symbols</span><span class="o">=</span><span class="n">symbols</span><span class="p">,</span> <span class="n">isotopes</span><span class="o">=</span><span class="n">isotopes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_xyz</span></div>


<div class="viewcode-block" id="get_top_element_count"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.get_top_element_count">[docs]</a><span class="k">def</span> <span class="nf">get_top_element_count</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">top</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the element count for the molecule considering only the atom indices in ``top``.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol (Molecule): The molecule to consider.</span>
<span class="sd">        top (list): The atom indices to consider.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The element count, keys are tuples of (element symbol, isotope number), values are counts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">top</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>
    <span class="n">element_count</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">top</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">isotope</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">element_count</span><span class="p">:</span>
                <span class="n">element_count</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">element_count</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">element_count</span></div>


<div class="viewcode-block" id="initialize_log"><a class="viewcode-back" href="../../../api/conformers.html#arc.species.conformers.initialize_log">[docs]</a><span class="k">def</span> <span class="nf">initialize_log</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up a simple logger for stdout printing (not saving into as log file).</span>

<span class="sd">    Args:</span>
<span class="sd">        verbose (int, optional): Specify the amount of log text seen.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Use custom level names for cleaner log output</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">addLevelName</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span> <span class="s1">&#39;Critical: &#39;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">addLevelName</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="s1">&#39;Error: &#39;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">addLevelName</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="s1">&#39;Warning: &#39;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">addLevelName</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">addLevelName</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">addLevelName</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># Create formatter and add to handlers</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(levelname)s%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Remove old handlers before adding ours</span>
    <span class="k">while</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Create console handler; send everything to stdout rather than stderr</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2024, Alon Grinberg Dana

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>