

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>arc.species.converter &mdash; ARC 1.1.0 Documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> ARC
          

          
          </a>

          
            
            
              <div class="version">
                1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../running.html">Running ARC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced.html">Advanced Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../output.html">Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">ARCâ€™s API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools.html">Standalone tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../media.html">Media</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cite.html">How to cite ARC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../licence.html">Licence</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ARC</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>arc.species.converter</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for arc.species.converter</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A module for performing various species-related format conversions.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">qcelemental</span> <span class="k">as</span> <span class="nn">qcel</span>
<span class="kn">from</span> <span class="nn">ase</span> <span class="kn">import</span> <span class="n">Atoms</span>
<span class="kn">from</span> <span class="nn">openbabel</span> <span class="kn">import</span> <span class="n">openbabel</span> <span class="k">as</span> <span class="n">ob</span>
<span class="kn">from</span> <span class="nn">openbabel</span> <span class="kn">import</span> <span class="n">pybel</span>
<span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">rdMolTransforms</span> <span class="k">as</span> <span class="n">rdMT</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">SDWriter</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem.rdchem</span> <span class="kn">import</span> <span class="n">AtomValenceException</span>

<span class="kn">from</span> <span class="nn">arkane.common</span> <span class="kn">import</span> <span class="n">get_element_mass</span><span class="p">,</span> <span class="n">mass_by_symbol</span><span class="p">,</span> <span class="n">symbol_by_number</span>
<span class="kn">import</span> <span class="nn">rmgpy.constants</span> <span class="k">as</span> <span class="nn">constants</span>
<span class="kn">from</span> <span class="nn">rmgpy.exceptions</span> <span class="kn">import</span> <span class="n">AtomTypeError</span>
<span class="kn">from</span> <span class="nn">rmgpy.molecule.molecule</span> <span class="kn">import</span> <span class="n">Atom</span><span class="p">,</span> <span class="n">Bond</span><span class="p">,</span> <span class="n">Molecule</span>
<span class="kn">from</span> <span class="nn">rmgpy.quantity</span> <span class="kn">import</span> <span class="n">ArrayQuantity</span>
<span class="kn">from</span> <span class="nn">rmgpy.species</span> <span class="kn">import</span> <span class="n">Species</span>
<span class="kn">from</span> <span class="nn">rmgpy.statmech</span> <span class="kn">import</span> <span class="n">Conformer</span>

<span class="kn">from</span> <span class="nn">arc.common</span> <span class="kn">import</span> <span class="p">(</span><span class="n">almost_equal_lists</span><span class="p">,</span>
                        <span class="n">calc_rmsd</span><span class="p">,</span>
                        <span class="n">get_atom_radius</span><span class="p">,</span>
                        <span class="n">get_logger</span><span class="p">,</span>
                        <span class="n">generate_resonance_structures</span><span class="p">,</span>
                        <span class="n">is_str_float</span><span class="p">,</span>
                        <span class="p">)</span>
<span class="kn">from</span> <span class="nn">arc.exceptions</span> <span class="kn">import</span> <span class="n">ConverterError</span><span class="p">,</span> <span class="n">InputError</span><span class="p">,</span> <span class="n">SanitizationError</span><span class="p">,</span> <span class="n">SpeciesError</span>
<span class="kn">from</span> <span class="nn">arc.species.xyz_to_2d</span> <span class="kn">import</span> <span class="n">MolGraph</span>
<span class="kn">from</span> <span class="nn">arc.species.xyz_to_smiles</span> <span class="kn">import</span> <span class="n">xyz_to_smiles</span>
<span class="kn">from</span> <span class="nn">arc.species.zmat</span> <span class="kn">import</span> <span class="p">(</span><span class="n">KEY_FROM_LEN</span><span class="p">,</span>
                              <span class="n">_compare_zmats</span><span class="p">,</span>
                              <span class="n">get_all_neighbors</span><span class="p">,</span>
                              <span class="n">get_atom_indices_from_zmat_parameter</span><span class="p">,</span>
                              <span class="n">get_parameter_from_atom_indices</span><span class="p">,</span>
                              <span class="n">zmat_to_coords</span><span class="p">,</span>
                              <span class="n">xyz_to_zmat</span><span class="p">)</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">arc.species.species</span> <span class="kn">import</span> <span class="n">ARCSpecies</span>


<span class="n">ob</span><span class="o">.</span><span class="n">obErrorLog</span><span class="o">.</span><span class="n">SetOutputLevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>


<div class="viewcode-block" id="str_to_xyz"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.str_to_xyz">[docs]</a><span class="k">def</span> <span class="nf">str_to_xyz</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">project_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a string xyz format to the ARC dict xyz style.</span>
<span class="sd">    Note: The ``xyz_str`` argument could also direct to a file path to parse the data from.</span>
<span class="sd">    The xyz string format may have optional Gaussian-style isotope specification, e.g.::</span>

<span class="sd">        C(Iso=13)    0.6616514836    0.4027481525   -0.4847382281</span>
<span class="sd">        N           -0.6039793084    0.6637270105    0.0671637135</span>
<span class="sd">        H           -1.4226865648   -0.4973210697   -0.2238712255</span>
<span class="sd">        H           -0.4993010635    0.6531020442    1.0853092315</span>
<span class="sd">        H           -2.2115796924   -0.4529256762    0.4144516252</span>
<span class="sd">        H           -1.8113671395   -0.3268900681   -1.1468957003</span>

<span class="sd">    which will also be parsed into the ARC xyz dictionary format, e.g.::</span>

<span class="sd">        {&#39;symbols&#39;: (&#39;C&#39;, &#39;N&#39;, &#39;H&#39;, &#39;H&#39;, &#39;H&#39;, &#39;H&#39;),</span>
<span class="sd">         &#39;isotopes&#39;: (13, 14, 1, 1, 1, 1),</span>
<span class="sd">         &#39;coords&#39;: ((0.6616514836, 0.4027481525, -0.4847382281),</span>
<span class="sd">                    (-0.6039793084, 0.6637270105, 0.0671637135),</span>
<span class="sd">                    (-1.4226865648, -0.4973210697, -0.2238712255),</span>
<span class="sd">                    (-0.4993010635, 0.6531020442, 1.0853092315),</span>
<span class="sd">                    (-2.2115796924, -0.4529256762, 0.4144516252),</span>
<span class="sd">                    (-1.8113671395, -0.3268900681, -1.1468957003))}</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz_str (str): The string xyz format to be converted.</span>
<span class="sd">        project_directory (str, optional): The path to the project directory.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConverterError: If xyz_str is not a string or does not have four space-separated entries per non-empty line.</span>

<span class="sd">    Returns: dict</span>
<span class="sd">        The ARC xyz format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">xyz_str</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected a string input, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">project_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_directory</span><span class="p">,</span> <span class="n">xyz_str</span><span class="p">)):</span>
        <span class="n">xyz_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_directory</span><span class="p">,</span> <span class="n">xyz_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">arc.parser</span> <span class="kn">import</span> <span class="n">parse_xyz_from_file</span>
        <span class="k">return</span> <span class="n">parse_xyz_from_file</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">)</span>
    <span class="n">xyz_str</span> <span class="o">=</span> <span class="n">xyz_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># this is a zmat</span>
        <span class="k">return</span> <span class="n">zmat_to_xyz</span><span class="p">(</span><span class="n">zmat</span><span class="o">=</span><span class="n">str_to_zmat</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">),</span> <span class="n">keep_dummy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">xyz_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(),</span> <span class="s1">&#39;isotopes&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(),</span> <span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="mi">6</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">xyz_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]):</span>
        <span class="c1"># Convert Gaussian output format, e.g., &quot;      1          8           0        3.132319    0.769111   -0.080869&quot;</span>
        <span class="c1"># not considering isotopes in this method!</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">xyz_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">splits</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol_by_number</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
                <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,)</span>
                <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">get_most_common_isotope_for_element</span><span class="p">(</span><span class="n">symbol</span><span class="p">),)</span>
                <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">coord</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># this is a &quot;regular&quot; string xyz format, if it has isotope information it will be preserved</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">xyz_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">splits</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;xyz_str has an incorrect format, expected 4 elements in each line, &#39;</span>
                                         <span class="sa">f</span><span class="s1">&#39;got &quot;</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s1">&quot; in:</span><span class="se">\n</span><span class="si">{</span><span class="n">xyz_str</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;(iso=&#39;</span> <span class="ow">in</span> <span class="n">symbol</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">isotope</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">symbol</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">))</span>
                    <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># no specific isotope is specified in str_xyz</span>
                    <span class="n">isotope</span> <span class="o">=</span> <span class="n">get_most_common_isotope_for_element</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">coord</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,)</span>
                <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">isotope</span><span class="p">,)</span>
                <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">coord</span><span class="p">,)</span>
    <span class="k">return</span> <span class="n">xyz_dict</span></div>


<div class="viewcode-block" id="xyz_to_str"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.xyz_to_str">[docs]</a><span class="k">def</span> <span class="nf">xyz_to_str</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
               <span class="n">isotope_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert an ARC xyz dictionary format, e.g.::</span>

<span class="sd">        {&#39;symbols&#39;: (&#39;C&#39;, &#39;N&#39;, &#39;H&#39;, &#39;H&#39;, &#39;H&#39;, &#39;H&#39;),</span>
<span class="sd">         &#39;isotopes&#39;: (13, 14, 1, 1, 1, 1),</span>
<span class="sd">         &#39;coords&#39;: ((0.6616514836, 0.4027481525, -0.4847382281),</span>
<span class="sd">                    (-0.6039793084, 0.6637270105, 0.0671637135),</span>
<span class="sd">                    (-1.4226865648, -0.4973210697, -0.2238712255),</span>
<span class="sd">                    (-0.4993010635, 0.6531020442, 1.0853092315),</span>
<span class="sd">                    (-2.2115796924, -0.4529256762, 0.4144516252),</span>
<span class="sd">                    (-1.8113671395, -0.3268900681, -1.1468957003))}</span>

<span class="sd">    to a string xyz format with optional Gaussian-style isotope specification, e.g.::</span>

<span class="sd">        C(Iso=13)    0.6616514836    0.4027481525   -0.4847382281</span>
<span class="sd">        N           -0.6039793084    0.6637270105    0.0671637135</span>
<span class="sd">        H           -1.4226865648   -0.4973210697   -0.2238712255</span>
<span class="sd">        H           -0.4993010635    0.6531020442    1.0853092315</span>
<span class="sd">        H           -2.2115796924   -0.4529256762    0.4144516252</span>
<span class="sd">        H           -1.8113671395   -0.3268900681   -1.1468957003</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz_dict (dict): The ARC xyz format to be converted.</span>
<span class="sd">        isotope_format (str, optional): The format for specifying the isotope if it is not the most abundant one.</span>
<span class="sd">                                        By default, isotopes will not be specified. Currently the only supported</span>
<span class="sd">                                        option is &#39;gaussian&#39;.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConverterError: If input is not a dict or does not have all attributes.</span>

<span class="sd">    Returns: Optional[str]</span>
<span class="sd">        The string xyz format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">xyz_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">xyz_dict</span> <span class="o">=</span> <span class="n">check_xyz_dict</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">)</span>
    <span class="n">recognized_isotope_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gaussian&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">xyz_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">,</span> <span class="s1">&#39;isotopes&#39;</span><span class="p">,</span> <span class="s1">&#39;coords&#39;</span><span class="p">]]):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Missing keys in the xyz dictionary. Expected to find &quot;symbols&quot;, &quot;isotopes&quot;, and &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;&quot;coords&quot;, but got </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">xyz_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1"> in</span><span class="se">\n</span><span class="si">{</span><span class="n">xyz_dict</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">])]):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Got different lengths for &quot;symbols&quot;, &quot;isotopes&quot;, and &quot;coords&quot;: &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s2">&quot;symbols&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s2">&quot;isotopes&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1">, and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1">, &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;respectively, in xyz:</span><span class="se">\n</span><span class="si">{</span><span class="n">xyz_dict</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">3</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]))]):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected 3 coordinates for each atom (x, y, and z), got:</span><span class="se">\n</span><span class="si">{</span><span class="n">xyz_dict</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">xyz_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">isotope</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span> <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">],</span> <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]):</span>
        <span class="n">common_isotope</span> <span class="o">=</span> <span class="n">get_most_common_isotope_for_element</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isotope_format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">common_isotope</span> <span class="o">!=</span> <span class="n">isotope</span><span class="p">:</span>
            <span class="c1"># consider the isotope number</span>
            <span class="k">if</span> <span class="n">isotope_format</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="n">element_with_isotope</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">(Iso=</span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">isotope</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0:14}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">element_with_isotope</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="s1">&#39;Recognized isotope formats for printing are </span><span class="si">{0}</span><span class="s1">, got: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                      <span class="n">recognized_isotope_formats</span><span class="p">,</span> <span class="n">isotope_format</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># don&#39;t consider the isotope number</span>
            <span class="n">row</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0:4}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{0:14.8f}{1:14.8f}{2:14.8f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">coord</span><span class="p">)</span>
        <span class="n">xyz_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xyz_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="xyz_to_x_y_z"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.xyz_to_x_y_z">[docs]</a><span class="k">def</span> <span class="nf">xyz_to_x_y_z</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the X, Y, and Z coordinates separately from the ARC xyz dictionary format.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz_dict (dict): The ARC xyz format.</span>

<span class="sd">    Returns: Optional[Tuple[tuple, tuple, tuple]]</span>
<span class="sd">        The X coordinates, the Y coordinates, the Z coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">xyz_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">xyz_dict</span> <span class="o">=</span> <span class="n">check_xyz_dict</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(),</span> <span class="nb">tuple</span><span class="p">(),</span> <span class="nb">tuple</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]:</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],)</span>
        <span class="n">z</span> <span class="o">+=</span> <span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">2</span><span class="p">],)</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span></div>


<div class="viewcode-block" id="xyz_to_coords_list"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.xyz_to_coords_list">[docs]</a><span class="k">def</span> <span class="nf">xyz_to_coords_list</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the coords part of an xyz dict as a (mutable) list of lists (rather than a tuple of tuples).</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz_dict (dict): The ARC xyz format.</span>

<span class="sd">    Returns: Optional[List[List[float]]]</span>
<span class="sd">        The coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">xyz_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">xyz_dict</span> <span class="o">=</span> <span class="n">check_xyz_dict</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">)</span>
    <span class="n">coords_tuple</span> <span class="o">=</span> <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span>
    <span class="n">coords_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">coords_tup</span> <span class="ow">in</span> <span class="n">coords_tuple</span><span class="p">:</span>
        <span class="n">coords_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">coords_tup</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords_tup</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords_tup</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">coords_list</span></div>


<div class="viewcode-block" id="xyz_to_np_array"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.xyz_to_np_array">[docs]</a><span class="k">def</span> <span class="nf">xyz_to_np_array</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the coords part of an xyz dict as a numpy array.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz_dict (dict): The ARC xyz format.</span>

<span class="sd">    Returns: Optional[np.ndarray]</span>
<span class="sd">        The coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz_to_coords_list</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="k">if</span> <span class="n">xyz_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="xyz_to_xyz_file_format"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.xyz_to_xyz_file_format">[docs]</a><span class="k">def</span> <span class="nf">xyz_to_xyz_file_format</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                           <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                           <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the `XYZ file format &lt;https://en.wikipedia.org/wiki/XYZ_file_format&gt;`_ representation</span>
<span class="sd">    from the ARC xyz dictionary format.</span>
<span class="sd">    This function does not consider isotopes.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz_dict (dict): The ARC xyz format.</span>
<span class="sd">        comment (str, optional): A comment to be shown in the output&#39;s 2nd line.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConverterError: If ``xyz_dict`` is of wrong format or ``comment`` is a multiline string.</span>

<span class="sd">    Returns: Optional[str]</span>
<span class="sd">        The XYZ file format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">xyz_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">xyz_dict</span> <span class="o">=</span> <span class="n">check_xyz_dict</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comment</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="s1">&#39;The comment attribute cannot be a multiline string, got:</span><span class="se">\n</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">comment</span><span class="p">)))</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">comment</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">xyz_to_str</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="xyz_to_turbomol_format"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.xyz_to_turbomol_format">[docs]</a><span class="k">def</span> <span class="nf">xyz_to_turbomol_format</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                           <span class="n">charge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">unpaired</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the respective Turbomole coordinates format.</span>

<span class="sd">$eht charge=0 unpaired=0</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz_dict (dict): The ARC xyz format.</span>
<span class="sd">        charge (int, optional): The net charge.</span>
<span class="sd">        unpaired (int, optional): The number of unpaired electrons.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The respective Turbomole coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">xyz_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">xyz_dict</span> <span class="o">=</span> <span class="n">check_xyz_dict</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">)</span>
    <span class="n">coords_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;$coord angs&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span> <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0:11.8f}{1:14.8f}{2:14.8f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">coord</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;      </span><span class="si">{</span><span class="n">symbol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">coords_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">charge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">unpaired</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coords_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;$eht charge=</span><span class="si">{</span><span class="n">charge</span><span class="si">}</span><span class="s1"> unpaired=</span><span class="si">{</span><span class="n">unpaired</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">coords_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;$end</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">coords_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="xyz_to_coords_and_element_numbers"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.xyz_to_coords_and_element_numbers">[docs]</a><span class="k">def</span> <span class="nf">xyz_to_coords_and_element_numbers</span><span class="p">(</span><span class="n">xyz</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert xyz to a coords list and an atomic number list.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz (dict): The coordinates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[list, list]: Coords and atomic numbers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">xyz_to_coords_list</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="n">z_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">qcel</span><span class="o">.</span><span class="n">periodictable</span><span class="o">.</span><span class="n">to_Z</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span> <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">coords</span><span class="p">,</span> <span class="n">z_list</span></div>


<div class="viewcode-block" id="xyz_to_kinbot_list"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.xyz_to_kinbot_list">[docs]</a><span class="k">def</span> <span class="nf">xyz_to_kinbot_list</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the KinBot xyz format of a single running list of:</span>
<span class="sd">    [symbol0, x0, y0, z0, symbol1, x1, y1, z1,...]</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz_dict (dict): The ARC xyz format.</span>

<span class="sd">    Returns: List[Union[str, float]]</span>
<span class="sd">        The respective KinBot xyz format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kinbot_xyz</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">coords</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span> <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]):</span>
        <span class="n">kinbot_xyz</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">symbol</span><span class="p">,</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">kinbot_xyz</span></div>


<div class="viewcode-block" id="xyz_to_dmat"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.xyz_to_dmat">[docs]</a><span class="k">def</span> <span class="nf">xyz_to_dmat</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert Cartesian coordinates to a distance matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz_dict (dict): The Cartesian coordinates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[np.array]: The distance matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">xyz_dict</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">xyz_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">xyz_dict</span> <span class="o">=</span> <span class="n">check_xyz_dict</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">)</span>
    <span class="n">dmat</span> <span class="o">=</span> <span class="n">qcel</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">distance_matrix</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz_to_coords_list</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">)),</span>
                                          <span class="n">b</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz_to_coords_list</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">dmat</span></div>


<div class="viewcode-block" id="xyz_file_format_to_xyz"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.xyz_file_format_to_xyz">[docs]</a><span class="k">def</span> <span class="nf">xyz_file_format_to_xyz</span><span class="p">(</span><span class="n">xyz_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the ARC xyz dictionary format from an</span>
<span class="sd">    `XYZ file format &lt;https://en.wikipedia.org/wiki/XYZ_file_format&gt;`_ representation.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz_file (str): The content of an XYZ file</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConverterError: If cannot identify the number of atoms entry, or if it is different that the actual number.</span>

<span class="sd">    Returns: dict</span>
<span class="sd">        The ARC dictionary xyz format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">xyz_file</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="s1">&#39;Cannot identify the number of atoms from the XYZ file format representation. &#39;</span>
                             <span class="s1">&#39;Expected a number, got: </span><span class="si">{0}</span><span class="s1"> of type </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="n">number_of_atoms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">!=</span> <span class="n">number_of_atoms</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="s1">&#39;The actual number of atoms (</span><span class="si">{0}</span><span class="s1">) does not match the expected number parsed (</span><span class="si">{1}</span><span class="s1">).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">number_of_atoms</span><span class="p">))</span>
    <span class="n">xyz_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">str_to_xyz</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">)</span></div>


<div class="viewcode-block" id="xyz_from_data"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.xyz_from_data">[docs]</a><span class="k">def</span> <span class="nf">xyz_from_data</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">numbers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">symbols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">isotopes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the ARC xyz dictionary format from raw data.</span>
<span class="sd">    Either ``numbers`` or ``symbols`` must be specified.</span>
<span class="sd">    If ``isotopes`` isn&#39;t specified, the most common isotopes will be assumed for all elements.</span>

<span class="sd">    Args:</span>
<span class="sd">        coords (tuple, list): The xyz coordinates.</span>
<span class="sd">        numbers (tuple, list, optional): Element nuclear charge numbers.</span>
<span class="sd">        symbols (tuple, list, optional): Element symbols.</span>
<span class="sd">        isotopes (tuple, list, optional): Element isotope numbers.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConverterError: If neither ``numbers`` nor ``symbols`` are specified, if both are specified,</span>
<span class="sd">                        or if the input lengths aren&#39;t consistent.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The ARC dictionary xyz format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">numbers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">numbers</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">numbers</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">numbers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">numbers</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">symbols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">isotopes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">isotopes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">isotopes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">isotopes</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="s1">&#39;Expected coords to be a tuple, got </span><span class="si">{0}</span><span class="s1"> which is a </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">coords</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">numbers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="s1">&#39;Expected numbers to be a tuple, got </span><span class="si">{0}</span><span class="s1"> which is a </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">numbers</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">symbols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="s1">&#39;Expected symbols to be a tuple, got </span><span class="si">{0}</span><span class="s1"> which is a </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">symbols</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">isotopes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">isotopes</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="s1">&#39;Expected isotopes to be a tuple, got </span><span class="si">{0}</span><span class="s1"> which is a </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isotopes</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">isotopes</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">numbers</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">symbols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="s1">&#39;Must set either &quot;numbers&quot; or &quot;symbols&quot;. Got neither.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">numbers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">symbols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="s1">&#39;Must set either &quot;numbers&quot; or &quot;symbols&quot;. Got both.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">numbers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">symbol_by_number</span><span class="p">[</span><span class="n">number</span><span class="p">]</span> <span class="k">for</span> <span class="n">number</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The length of the coordinates (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="si">}</span><span class="s1">) is different than the length of the &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;numbers/symbols (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">isotopes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">isotopes</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The length of the coordinates (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="si">}</span><span class="s1">) is different than the length of isotopes &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">isotopes</span><span class="p">)</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">isotopes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">isotopes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">get_most_common_isotope_for_element</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span> <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">)</span>
    <span class="n">xyz_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="n">symbols</span><span class="p">,</span> <span class="s1">&#39;isotopes&#39;</span><span class="p">:</span> <span class="n">isotopes</span><span class="p">,</span> <span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="n">coords</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">xyz_dict</span></div>


<div class="viewcode-block" id="species_to_sdf_file"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.species_to_sdf_file">[docs]</a><span class="k">def</span> <span class="nf">species_to_sdf_file</span><span class="p">(</span><span class="n">species</span><span class="p">:</span> <span class="s1">&#39;ARCSpecies&#39;</span><span class="p">,</span>
                        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write an SDF file with coordinates and connectivity information.</span>

<span class="sd">    Args:</span>
<span class="sd">        species (ARCSpecies): The ARCSpecies object instance.</span>
<span class="sd">        path (str): The full path to the .sdf file that will be saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">species</span><span class="o">.</span><span class="n">mol_from_xyz</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rdkit_mol</span> <span class="o">=</span> <span class="n">rdkit_conf_from_mol</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">species</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">SDWriter</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rdkit_mol</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="sort_xyz_using_indices"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.sort_xyz_using_indices">[docs]</a><span class="k">def</span> <span class="nf">sort_xyz_using_indices</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                           <span class="n">indices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
                           <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sort the tuples in an xyz dict according to the given indices.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz_dict (dict): The Cartesian coordinates.</span>
<span class="sd">        indices (Optional[List[int]]): Entries are 0-indices of the desired order.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The ordered xyz.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Cannot sort xyz without a map.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xyz_dict</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The number of indices </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="si">}</span><span class="s2"> does not match &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;the number of coordinates </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All indices must be lower than the length of the coordinates tuple. &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> coordinates, and indices of:</span><span class="se">\n</span><span class="si">{</span><span class="n">indices</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">coords</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">isotopes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
        <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">isotopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">xyz_from_data</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">symbols</span><span class="o">=</span><span class="n">symbols</span><span class="p">,</span> <span class="n">isotopes</span><span class="o">=</span><span class="n">isotopes</span><span class="p">)</span></div>


<div class="viewcode-block" id="xyz_to_ase"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.xyz_to_ase">[docs]</a><span class="k">def</span> <span class="nf">xyz_to_ase</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Atoms</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert an xyz dict to an ASE Atoms object.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz_dict (dict): The ARC xyz format.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Type[Atoms]: The corresponding ASE Atom object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Atoms</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span> <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="translate_xyz"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.translate_xyz">[docs]</a><span class="k">def</span> <span class="nf">translate_xyz</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                  <span class="n">translation</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Translate xyz.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz_dict (dict): The ARC xyz format.</span>
<span class="sd">        translation (Tuple[float, float, float]): The x, y, z translation vector.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The translated xyz.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">translation</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">xyz_dict</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]:</span>
        <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">translation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
    <span class="n">new_xyz</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span>
               <span class="s1">&#39;isotopes&#39;</span><span class="p">:</span> <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">],</span>
               <span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">coords</span><span class="p">),</span>
               <span class="p">}</span>
    <span class="k">return</span> <span class="n">new_xyz</span></div>


<div class="viewcode-block" id="displace_xyz"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.displace_xyz">[docs]</a><span class="k">def</span> <span class="nf">displace_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                 <span class="n">displacement</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">amplitude</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
                 <span class="n">use_weights</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Displace the coordinates using the ``displacement`` by the requested ``amplitude`` using atom mass weights.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz (dict): The coordinates.</span>
<span class="sd">        displacement (list): The corresponding xyz displacement for each atom.</span>
<span class="sd">        amplitude (float, optional): The factor multiplication for the displacement.</span>
<span class="sd">        use_weights( bool, optional): Whether to scale displacements by the square root of the respective element mass.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[dict, dict]:</span>
<span class="sd">            The two displaced xyz&#39;s, one for each direction (+/-) of the weighted ``displacement``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">xyz_to_coords_list</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">mass</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">mass</span> <span class="ow">in</span> <span class="n">get_element_mass_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">)]</span> <span class="k">if</span> <span class="n">use_weights</span> <span class="k">else</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">])</span>
    <span class="n">coords_1</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">displacement</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                 <span class="nb">float</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">displacement</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                 <span class="nb">float</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">displacement</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coords</span><span class="p">)]</span>
    <span class="n">coords_2</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">displacement</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                 <span class="nb">float</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">displacement</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                 <span class="nb">float</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">displacement</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coords</span><span class="p">)]</span>
    <span class="n">xyz_1</span> <span class="o">=</span> <span class="n">xyz_from_data</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords_1</span><span class="p">,</span> <span class="n">symbols</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span> <span class="n">isotopes</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">])</span>
    <span class="n">xyz_2</span> <span class="o">=</span> <span class="n">xyz_from_data</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords_2</span><span class="p">,</span> <span class="n">symbols</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span> <span class="n">isotopes</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">xyz_1</span><span class="p">,</span> <span class="n">xyz_2</span></div>


<div class="viewcode-block" id="get_element_mass_from_xyz"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.get_element_mass_from_xyz">[docs]</a><span class="k">def</span> <span class="nf">get_element_mass_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a list of element masses corresponding to the given ``xyz`` considering isotopes.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz (dict): The coordinates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[float]: The corresponding list of mass in amu.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">get_element_mass</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">isotope</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">isotope</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span> <span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">])]</span></div>


<div class="viewcode-block" id="hartree_to_si"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.hartree_to_si">[docs]</a><span class="k">def</span> <span class="nf">hartree_to_si</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">kilo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert Hartree units into J/mol or into kJ/mol.</span>

<span class="sd">    Args:</span>
<span class="sd">        e (float): Energy in Hartree.</span>
<span class="sd">        kilo (bool, optional): Whether to return kJ/mol units. ``True`` by default.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected a float, got </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1"> which is a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="k">if</span> <span class="n">kilo</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">e</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">E_h</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">Na</span> <span class="o">*</span> <span class="n">factor</span></div>


<div class="viewcode-block" id="rmg_conformer_to_xyz"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.rmg_conformer_to_xyz">[docs]</a><span class="k">def</span> <span class="nf">rmg_conformer_to_xyz</span><span class="p">(</span><span class="n">conformer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert xyz coordinates from an rmgpy.statmech.Conformer object into the ARC dict xyz style.</span>

<span class="sd">    Notes:</span>
<span class="sd">        Only the xyz information (symbols and coordinates) will be taken from the Conformer object. Other properties</span>
<span class="sd">        such as electronic energy will not be converted.</span>

<span class="sd">        We also assume that we can get the isotope number by rounding the mass</span>

<span class="sd">    Args:</span>
<span class="sd">        conformer (Conformer): An rmgpy.statmech.Conformer object containing the desired xyz coordinates</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If conformer is not an rmgpy.statmech.Conformer object</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The ARC xyz format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conformer</span><span class="p">,</span> <span class="n">Conformer</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected conformer to be an rmgpy.statmech.Conformer object but instead got </span><span class="si">{</span><span class="n">conformer</span><span class="si">}</span><span class="s1">, &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;which is a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">conformer</span><span class="p">)</span><span class="si">}</span><span class="s1"> object.&#39;</span><span class="p">)</span>

    <span class="n">symbols</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">symbol_by_number</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">conformer</span><span class="o">.</span><span class="n">number</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">isotopes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">m</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">conformer</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">conformer</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="n">xyz_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="n">symbols</span><span class="p">,</span> <span class="s1">&#39;isotopes&#39;</span><span class="p">:</span> <span class="n">isotopes</span><span class="p">,</span> <span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="n">coords</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">xyz_dict</span></div>


<div class="viewcode-block" id="xyz_to_rmg_conformer"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.xyz_to_rmg_conformer">[docs]</a><span class="k">def</span> <span class="nf">xyz_to_rmg_conformer</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Conformer</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the Arc dict xyz style into an rmgpy.statmech.Conformer object containing these coordinates.</span>

<span class="sd">    Notes:</span>
<span class="sd">        Only the xyz information will be supplied to the newly created Conformer object</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz_dict (dict): The ARC dict xyz style coordinates</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[Conformer]: An rmgpy.statmech.Conformer object containing the desired xyz coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">xyz_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">xyz_dict</span> <span class="o">=</span> <span class="n">check_xyz_dict</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">)</span>
    <span class="n">mass_and_number</span> <span class="o">=</span> <span class="p">(</span><span class="n">get_element_mass</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span> <span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">]))</span>
    <span class="n">mass</span><span class="p">,</span> <span class="n">number</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">mass_and_number</span><span class="p">)</span>
    <span class="n">mass</span> <span class="o">=</span> <span class="n">ArrayQuantity</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="s1">&#39;amu&#39;</span><span class="p">)</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">ArrayQuantity</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">coordinates</span> <span class="o">=</span> <span class="n">ArrayQuantity</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">],</span> <span class="s1">&#39;angstroms&#39;</span><span class="p">)</span>
    <span class="n">conformer</span> <span class="o">=</span> <span class="n">Conformer</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conformer</span></div>


<div class="viewcode-block" id="standardize_xyz_string"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.standardize_xyz_string">[docs]</a><span class="k">def</span> <span class="nf">standardize_xyz_string</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">,</span> <span class="n">isotope_format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper function to correct xyz string format input (string to string).</span>
<span class="sd">    Usually empty lines are added by the user either in the beginning or the end,</span>
<span class="sd">    here we remove them along with other common issues.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz_str (str): The string xyz format, or a Gaussian output format.</span>
<span class="sd">        isotope_format (str, optional): The format for specifying the isotope if it is not the most abundant one.</span>
<span class="sd">                                        By default, isotopes will not be specified. Currently the only supported</span>
<span class="sd">                                        option is &#39;gaussian&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The string xyz format in standardized format.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConverterError: If ``xyz_str`` is of wrong type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="s1">&#39;Expected a string format, got </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">)))</span>
    <span class="n">xyz_dict</span> <span class="o">=</span> <span class="n">str_to_xyz</span><span class="p">(</span><span class="n">xyz_str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyz_to_str</span><span class="p">(</span><span class="n">xyz_dict</span><span class="o">=</span><span class="n">xyz_dict</span><span class="p">,</span> <span class="n">isotope_format</span><span class="o">=</span><span class="n">isotope_format</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_xyz_dict"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.check_xyz_dict">[docs]</a><span class="k">def</span> <span class="nf">check_xyz_dict</span><span class="p">(</span><span class="n">xyz</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                   <span class="n">project_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that the xyz dictionary entered is valid.</span>
<span class="sd">    If it is a string, convert it.</span>
<span class="sd">    If it is a Z matrix, convert it to cartesian coordinates,</span>
<span class="sd">    If isotopes are not in xyz_dict, common values will be added.</span>
<span class="sd">    If a part of the xyz structure is a np.ndarray type, convert it by always calling xyz_from_data().</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz (Union[dict, str]): The xyz dictionary.</span>
<span class="sd">        project_directory (str, optional): The path to the project directory.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConverterError: If ``xyz`` is of wrong type or is missing symbols or coords.</span>

<span class="sd">    Returns: Optional[dict]</span>
<span class="sd">        The cartesian coordinates in a dictionary format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">xyz_dict</span> <span class="o">=</span> <span class="n">str_to_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">project_directory</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">xyz</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected a dictionary, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;vars&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">xyz_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="c1"># this is a zmat, convert to cartesian</span>
        <span class="n">xyz_dict</span> <span class="o">=</span> <span class="n">zmat_to_xyz</span><span class="p">(</span><span class="n">zmat</span><span class="o">=</span><span class="n">xyz_dict</span><span class="p">,</span> <span class="n">keep_dummy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;symbols&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">xyz_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;XYZ dictionary is missing symbols. Got:</span><span class="se">\n</span><span class="si">{</span><span class="n">xyz_dict</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;coords&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">xyz_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;XYZ dictionary is missing coords. Got:</span><span class="se">\n</span><span class="si">{</span><span class="n">xyz_dict</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s2">&quot;symbols&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1"> symbols and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1"> &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;coordinates:</span><span class="se">\n</span><span class="si">{</span><span class="n">xyz_dict</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">xyz_dict</span> <span class="o">=</span> <span class="n">xyz_from_data</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">],</span>
                             <span class="n">symbols</span><span class="o">=</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span>
                             <span class="n">isotopes</span><span class="o">=</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;isotopes&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">xyz_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s2">&quot;symbols&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1"> symbols and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz_dict</span><span class="p">[</span><span class="s2">&quot;isotopes&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1"> &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;isotopes:</span><span class="se">\n</span><span class="si">{</span><span class="n">xyz_dict</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyz_dict</span></div>


<div class="viewcode-block" id="check_zmat_dict"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.check_zmat_dict">[docs]</a><span class="k">def</span> <span class="nf">check_zmat_dict</span><span class="p">(</span><span class="n">zmat</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that the zmat dictionary entered is valid.</span>
<span class="sd">    If it is a string, convert it.</span>
<span class="sd">    If it represents cartesian coordinates, convert it to internal coordinates.</span>
<span class="sd">    If a map isn&#39;t given, a trivial one will be added.</span>

<span class="sd">    Args:</span>
<span class="sd">        zmat (dict, str): The zmat dictionary.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConverterError: If ``zmat`` is of wrong type or is missing vars or coords.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zmat_dict</span> <span class="o">=</span> <span class="n">str_to_zmat</span><span class="p">(</span><span class="n">zmat</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">zmat</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">zmat</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">zmat_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected a dictionary, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">zmat_dict</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;vars&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">zmat_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="c1"># this is probably a representation of cartesian coordinates, convert to zmat</span>
        <span class="n">zmat_dict</span> <span class="o">=</span> <span class="n">zmat_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">check_xyz_dict</span><span class="p">(</span><span class="n">zmat_dict</span><span class="p">),</span> <span class="n">consolidate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;symbols&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">zmat_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;zmat dictionary is missing symbols. Got:</span><span class="se">\n</span><span class="si">{</span><span class="n">zmat_dict</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;coords&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">zmat_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;zmat dictionary is missing coords. Got:</span><span class="se">\n</span><span class="si">{</span><span class="n">zmat_dict</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zmat_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zmat_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">zmat_dict</span><span class="p">[</span><span class="s2">&quot;symbols&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1"> symbols and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">zmat_dict</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1"> &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;coordinates:</span><span class="se">\n</span><span class="si">{</span><span class="n">zmat_dict</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;map&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">zmat_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="c1"># add a trivial map</span>
        <span class="n">zmat_dict</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zmat_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">]))}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zmat_dict</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zmat_dict</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">zmat_dict</span><span class="p">[</span><span class="s2">&quot;symbols&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1"> symbols and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">zmat_dict</span><span class="p">[</span><span class="s2">&quot;isotopes&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1"> &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;isotopes:</span><span class="se">\n</span><span class="si">{</span><span class="n">zmat_dict</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">zmat_dict</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coord</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">get_atom_indices_from_zmat_parameter</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">index_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">index_tuple</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s1"> parameter in the zmat is ill-defined:</span><span class="se">\n</span><span class="si">{</span><span class="n">zmat_dict</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="n">param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The zmat is ill-defined:</span><span class="se">\n</span><span class="si">{</span><span class="n">zmat_dict</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">zmat_dict</span></div>


<div class="viewcode-block" id="remove_dummies"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.remove_dummies">[docs]</a><span class="k">def</span> <span class="nf">remove_dummies</span><span class="p">(</span><span class="n">xyz</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove dummy (&#39;X&#39;) atoms from cartesian coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz (dict, str): The cartesian coordinate, either in a dict or str format.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The coordinates w/o dummy atoms.</span>

<span class="sd">    Raises:</span>
<span class="sd">        InputError: If ``xyz`` if of wrong type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">str_to_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;xyz must be a dictionary, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">symbols</span><span class="p">,</span> <span class="n">isotopes</span><span class="p">,</span> <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">isotope</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span> <span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">],</span> <span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="o">!=</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span>
            <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">isotopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">isotope</span><span class="p">)</span>
            <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyz_from_data</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">symbols</span><span class="o">=</span><span class="n">symbols</span><span class="p">,</span> <span class="n">isotopes</span><span class="o">=</span><span class="n">isotopes</span><span class="p">)</span></div>


<div class="viewcode-block" id="zmat_from_xyz"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.zmat_from_xyz">[docs]</a><span class="k">def</span> <span class="nf">zmat_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                  <span class="n">mol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Molecule</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">constraints</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">consolidate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">consolidation_tols</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">is_ts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a Z matrix from xyz.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz (Union[dict, str]): The cartesian coordinate, either in a dict or str format.</span>
<span class="sd">        mol (Molecule, optional): The corresponding RMG Molecule with connectivity information.</span>
<span class="sd">        constraints (dict, optional): Accepted keys are:</span>
<span class="sd">                                      &#39;R_atom&#39;, &#39;R_group&#39;, &#39;A_atom&#39;, &#39;A_group&#39;, &#39;D_atom&#39;, &#39;D_group&#39;, or &#39;D_groups&#39;.</span>
<span class="sd">                                      &#39;R&#39;, &#39;A&#39;, and &#39;D&#39; constrain distances, angles, and dihedrals, respectively.</span>
<span class="sd">                                      Values are lists of atom indices (0-indexed) tuples.</span>
<span class="sd">                                      The atom indices order matters.</span>
<span class="sd">                                      Specifying &#39;_atom&#39; will cause only the last atom in the specified list values</span>
<span class="sd">                                      to translate/rotate if the corresponding zmat parameter is changed.</span>
<span class="sd">                                      Specifying &#39;_group&#39; will cause the entire group connected to the last atom</span>
<span class="sd">                                      to translate/rotate if the corresponding zmat parameter is changed.</span>
<span class="sd">                                      Specifying &#39;_groups&#39; (only valid for D) will cause the groups connected to</span>
<span class="sd">                                      the last two atoms to translate/rotate if the corresponding parameter is changed.</span>
<span class="sd">        consolidate (bool, optional): Whether to consolidate the zmat after generation, ``True`` to consolidate.</span>
<span class="sd">        consolidation_tols (dict, optional): Keys are &#39;R&#39;, &#39;A&#39;, &#39;D&#39;, values are floats representing absolute tolerance</span>
<span class="sd">                                             for consolidating almost equal internal coordinates.</span>
<span class="sd">        is_ts (bool, optional): Whether this is a representation of a TS.</span>
<span class="sd">                                If it is not, a ``mol`` object will be generated if not given.</span>

<span class="sd">    Raises:</span>
<span class="sd">        InputError: If ``xyz`` if of a wrong type.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The Z matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">str_to_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">xyz</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;xyz must be a dictionary, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">remove_dummies</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_ts</span><span class="p">:</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">molecules_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">xyz_to_zmat</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span>
                       <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span>
                       <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
                       <span class="n">consolidate</span><span class="o">=</span><span class="n">consolidate</span><span class="p">,</span>
                       <span class="n">consolidation_tols</span><span class="o">=</span><span class="n">consolidation_tols</span><span class="p">,</span>
                       <span class="p">)</span></div>


<div class="viewcode-block" id="zmat_to_xyz"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.zmat_to_xyz">[docs]</a><span class="k">def</span> <span class="nf">zmat_to_xyz</span><span class="p">(</span><span class="n">zmat</span><span class="p">,</span> <span class="n">keep_dummy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xyz_isotopes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the xyz dict coordinates from a zmat dict.</span>
<span class="sd">    Most common isotopes assumed, unless a reference xyz dict is given.</span>

<span class="sd">    Args:</span>
<span class="sd">        zmat (dict): The zmat.</span>
<span class="sd">        keep_dummy (bool): Whether to keep dummy atoms (&#39;X&#39;), ``True`` to keep, default is ``False``.</span>
<span class="sd">        xyz_isotopes (dict): A reference xyz dictionary to take isotope information from.</span>
<span class="sd">                             Must be ordered as the original mol/xyz used to create ``zmat``.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The xyz cartesian coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coords</span><span class="p">,</span> <span class="n">symbols</span> <span class="o">=</span> <span class="n">zmat_to_coords</span><span class="p">(</span><span class="n">zmat</span><span class="p">,</span> <span class="n">keep_dummy</span><span class="o">=</span><span class="n">keep_dummy</span><span class="p">)</span>
    <span class="n">isotopes</span> <span class="o">=</span> <span class="n">xyz_isotopes</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">xyz_isotopes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">xyz_dict</span> <span class="o">=</span> <span class="n">translate_to_center_of_mass</span><span class="p">(</span><span class="n">xyz_from_data</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">symbols</span><span class="o">=</span><span class="n">symbols</span><span class="p">,</span> <span class="n">isotopes</span><span class="o">=</span><span class="n">isotopes</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">xyz_dict</span></div>


<div class="viewcode-block" id="zmat_to_str"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.zmat_to_str">[docs]</a><span class="k">def</span> <span class="nf">zmat_to_str</span><span class="p">(</span><span class="n">zmat</span><span class="p">,</span> <span class="n">zmat_format</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">consolidate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a zmat to a string format.</span>

<span class="sd">    Args:</span>
<span class="sd">        zmat (dict): The Z Matrix to convert.</span>
<span class="sd">        zmat_format (str, optional): The requested format to output (varies by ESS).</span>
<span class="sd">                                     Allowed values are: &#39;gaussian&#39;, &#39;qchem&#39;, &#39;molpro&#39;, &#39;orca&#39;, &#39;cfour&#39;, or &#39;psi4&#39;.</span>
<span class="sd">                                     The default format is &#39;gaussian&#39;.</span>
<span class="sd">        consolidate (bool): Whether to return a consolidated zmat (geometry optimization will be more efficient).</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The string representation of the zmat in the requested format.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConverterError: If ``zmat`` is of wrong type or missing keys, or if ``zmat_format`` is not recognized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">zmat</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;zmat has to be a dict, got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">zmat</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;symbols&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">zmat</span> <span class="ow">or</span> <span class="s1">&#39;coords&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">zmat</span> <span class="ow">or</span> <span class="s1">&#39;vars&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">zmat</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;zmat must contain the &quot;symbols&quot;, &quot;coords&quot;, and &quot;vars&quot; keys, got: &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">zmat</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">zmat_format</span> <span class="o">==</span> <span class="s1">&#39;terachem&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="s1">&#39;TeraChem does not accept a zmat as input (it has its own internal conversions).&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">zmat_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="s1">&#39;qchem&#39;</span><span class="p">,</span> <span class="s1">&#39;molpro&#39;</span><span class="p">,</span> <span class="s1">&#39;orca&#39;</span><span class="p">,</span> <span class="s1">&#39;psi4&#39;</span><span class="p">,</span> <span class="s1">&#39;cfour&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;zmat_format must be either gaussian, qchem, molpro, orca, cfour, or psi4, &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;got: </span><span class="si">{</span><span class="n">zmat_format</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">zmat_format</span> <span class="o">==</span> <span class="s1">&#39;orca&#39;</span><span class="p">:</span>
        <span class="c1"># replace dummy atom symbols</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">zmat</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">]:</span>
            <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">symbol</span> <span class="k">if</span> <span class="n">symbol</span> <span class="o">!=</span> <span class="s1">&#39;X&#39;</span> <span class="k">else</span> <span class="s1">&#39;DA&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="n">zmat</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">zmat_format</span> <span class="o">==</span> <span class="s1">&#39;orca&#39;</span><span class="p">:</span>
        <span class="c1"># Redundant internal coordinates are automatically used by Orca,</span>
        <span class="c1"># parametarized internal coordinates are hence not supported</span>
        <span class="n">consolidate</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span> <span class="k">if</span> <span class="n">zmat_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;molpro&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="n">var_separator</span> <span class="o">=</span> <span class="s1">&#39;=&#39;</span> <span class="k">if</span> <span class="n">zmat_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="s1">&#39;molpro&#39;</span><span class="p">,</span> <span class="s1">&#39;qchem&#39;</span><span class="p">,</span> <span class="s1">&#39;psi4&#39;</span><span class="p">,</span> <span class="s1">&#39;cfour&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span>
    <span class="n">zmat_str</span><span class="p">,</span> <span class="n">variables_str</span><span class="p">,</span> <span class="n">variables</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">type_indices</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>  <span class="c1"># consolidation counters</span>
    <span class="n">variables_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># keys are coord (e.g., &#39;R_2|4_0|0&#39;), values are vars (e.g., &#39;R1&#39;)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">zmat</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">])):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">:</span><span class="s1">&gt;3</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">index_tuples</span> <span class="o">=</span> <span class="n">get_atom_indices_from_zmat_parameter</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">index_tuples</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">consolidate</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">variables_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">var_str</span> <span class="o">=</span> <span class="n">variables_dict</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">var_type</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># &#39;R&#39;, &#39;A&#39;, or &#39;D&#39;</span>
                        <span class="n">var_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_type</span><span class="si">}{</span><span class="n">type_indices</span><span class="p">[</span><span class="n">var_type</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="n">type_indices</span><span class="p">[</span><span class="n">var_type</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">variables_dict</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_str</span>
                        <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var_str</span><span class="si">}{</span><span class="n">var_separator</span><span class="si">}{</span><span class="n">zmat</span><span class="p">[</span><span class="s2">&quot;vars&quot;</span><span class="p">][</span><span class="n">coord</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">separator</span><span class="si">}{</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="si">:</span><span class="s1">8d</span><span class="si">}{</span><span class="n">separator</span><span class="si">}{</span><span class="n">var_str</span><span class="si">:</span><span class="s1">&gt;8</span><span class="si">}</span><span class="s1">&#39;</span>  <span class="c1"># convert to 1-indexed</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">separator</span><span class="si">}{</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="si">:</span><span class="s1">8d</span><span class="si">}{</span><span class="n">separator</span><span class="si">}{</span><span class="n">zmat</span><span class="p">[</span><span class="s2">&quot;vars&quot;</span><span class="p">][</span><span class="n">coord</span><span class="p">]</span><span class="si">:</span><span class="s1">10.4f</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">zmat_format</span> <span class="o">==</span> <span class="s1">&#39;orca&#39;</span> <span class="ow">and</span> <span class="n">consolidate</span><span class="p">:</span>
            <span class="n">symbol</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">coordinates</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">symbol</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                <span class="k">elif</span> <span class="n">j</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">coordinates</span> <span class="o">+=</span> <span class="n">entry</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">indices</span> <span class="o">+=</span> <span class="n">entry</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">indices</span> <span class="o">+=</span> <span class="s1">&#39;0 &#39;</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">coordinates</span> <span class="o">+=</span> <span class="s1">&#39;0.0 &#39;</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">symbol</span> <span class="o">+</span> <span class="n">indices</span> <span class="o">+</span> <span class="n">coordinates</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">zmat_str</span> <span class="o">+=</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">if</span> <span class="n">zmat_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gaussian&#39;</span><span class="p">]:</span>
        <span class="n">variables_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">variables</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">zmat_str</span><span class="si">}</span><span class="s1">Variables:</span><span class="se">\n</span><span class="si">{</span><span class="n">variables_str</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">consolidate</span> <span class="k">else</span> <span class="n">zmat_str</span>
    <span class="k">elif</span> <span class="n">zmat_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;qchem&#39;</span><span class="p">,</span> <span class="s1">&#39;psi4&#39;</span><span class="p">,</span> <span class="s1">&#39;orca&#39;</span><span class="p">,</span> <span class="s1">&#39;cfour&#39;</span><span class="p">]:</span>
        <span class="n">variables_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">variables</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">zmat_str</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">variables_str</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">consolidate</span> <span class="k">else</span> <span class="n">zmat_str</span>
    <span class="k">elif</span> <span class="n">zmat_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;molpro&#39;</span><span class="p">]:</span>
        <span class="n">variables_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">variables</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">variables_str</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">zmat_str</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">consolidate</span> <span class="k">else</span> <span class="n">zmat_str</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">zmat_str</span> <span class="o">+</span> <span class="n">variables_str</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="str_to_zmat"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.str_to_zmat">[docs]</a><span class="k">def</span> <span class="nf">str_to_zmat</span><span class="p">(</span><span class="n">zmat_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a string Z Matrix format to the ARC dict zmat style.</span>
<span class="sd">    Note: The ``zmat_str`` argument could also direct to a file path to parse the data from.</span>
<span class="sd">    A typical zmat string format may look like this::</span>

<span class="sd">          C</span>
<span class="sd">          H       1      R1</span>
<span class="sd">          H       1      R1       2      A1</span>
<span class="sd">          H       1      R1       2      A1       3      D1</span>
<span class="sd">          H       1      R1       2      A1       3      D2</span>
<span class="sd">          A1=109.4712</span>
<span class="sd">          D1=120.0000</span>
<span class="sd">          D2=240.0000</span>
<span class="sd">          R1=1.0912</span>

<span class="sd">    The resulting zmat for the above example is::</span>

<span class="sd">        {&#39;symbols&#39;: (&#39;C&#39;, &#39;H&#39;, &#39;H&#39;, &#39;H&#39;, &#39;H&#39;),</span>
<span class="sd">         &#39;coords&#39;: ((None, None, None),</span>
<span class="sd">                    (&#39;R_1_0&#39;, None, None),</span>
<span class="sd">                    (&#39;R_2_1&#39;, &#39;A_2_1_0&#39;, None),</span>
<span class="sd">                    (&#39;R_3_2&#39;, &#39;A_3_2_0&#39;, &#39;D_3_2_0_1&#39;), (&#39;R_4_3&#39;, &#39;A_4_3_0&#39;, &#39;D_4_3_0_2&#39;)),</span>
<span class="sd">         &#39;vars&#39;: {&#39;R_1_0&#39;: 1.0912, &#39;R_2_1&#39;: 1.782, &#39;A_2_1_0&#39;: 35.2644, &#39;R_3_2&#39;: 1.782, &#39;A_3_2_0&#39;: 35.2644,</span>
<span class="sd">                  &#39;D_3_2_0_1&#39;: 120.0, &#39;R_4_3&#39;: 1.782, &#39;A_4_3_0&#39;: 35.2644, &#39;D_4_3_0_2&#39;: 240.0},</span>
<span class="sd">         &#39;map&#39;: {0: 0, 1: 1, 2: 2, 3: 3, 4: 4}}</span>

<span class="sd">    Args:</span>
<span class="sd">        zmat_str (str): The string zmat format to be converted.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The ARC zmat format.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConverterError: If zmat_str is not a string or does not have enough values per line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">zmat_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected a string input, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">zmat_str</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">zmat_str</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">zmat_str</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">zmat_str</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">symbols</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">coords_str</span> <span class="o">=</span> <span class="n">split_str_zmat</span><span class="p">(</span><span class="n">zmat_str</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coords_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()):</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># the atom index in this line must point to the first atom in the zmat,</span>
            <span class="c1"># deduce whether this zmat is in a 0-index or a 1-index format</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not interpret the zmat line </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">r_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;R_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="kc">None</span>  <span class="c1"># convert to 0-index</span>
        <span class="n">a_key</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span> <span class="o">+</span> <span class="n">r_key</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">d_key</span> <span class="o">=</span> <span class="s1">&#39;D&#39;</span> <span class="o">+</span> <span class="n">a_key</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">-</span> <span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">r_key</span><span class="p">,</span> <span class="n">a_key</span><span class="p">,</span> <span class="n">d_key</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">r_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">variables</span><span class="p">[</span><span class="n">r_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="n">is_str_float</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> \
                <span class="k">else</span> <span class="n">get_zmat_str_var_value</span><span class="p">(</span><span class="n">zmat_str</span><span class="p">,</span> <span class="n">splits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">a_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">variables</span><span class="p">[</span><span class="n">a_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="k">if</span> <span class="n">is_str_float</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> \
                <span class="k">else</span> <span class="n">get_zmat_str_var_value</span><span class="p">(</span><span class="n">zmat_str</span><span class="p">,</span> <span class="n">splits</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">d_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">variables</span><span class="p">[</span><span class="n">d_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="k">if</span> <span class="n">is_str_float</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> \
                <span class="k">else</span> <span class="n">get_zmat_str_var_value</span><span class="p">(</span><span class="n">zmat_str</span><span class="p">,</span> <span class="n">splits</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
    <span class="n">map_</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">))}</span>  <span class="c1"># trivial map</span>
    <span class="n">zmat_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">symbols</span><span class="p">),</span> <span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">coords</span><span class="p">),</span> <span class="s1">&#39;vars&#39;</span><span class="p">:</span> <span class="n">variables</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">:</span> <span class="n">map_</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">zmat_dict</span></div>


<div class="viewcode-block" id="split_str_zmat"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.split_str_zmat">[docs]</a><span class="k">def</span> <span class="nf">split_str_zmat</span><span class="p">(</span><span class="n">zmat_str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split a string zmat into its coordinates and variables sections.</span>

<span class="sd">    Args:</span>
<span class="sd">        zmat_str (str): The zmat.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[str, Optional[str]]: The coords section and the variables section if it exists, else ``None``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coords</span><span class="p">,</span> <span class="n">variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;variables&#39;</span> <span class="ow">in</span> <span class="n">zmat_str</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">zmat_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;variables&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">flag</span> <span class="ow">and</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="n">zmat_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="c1"># this string starts with the variables section</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">flag</span> <span class="ow">and</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">flag</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="ow">and</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="c1"># this string starts with the coordinates section</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">flag</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="ow">and</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">flag</span> <span class="ow">and</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="k">else</span> <span class="n">zmat_str</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">coords</span><span class="p">,</span> <span class="n">variables</span></div>


<div class="viewcode-block" id="get_zmat_str_var_value"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.get_zmat_str_var_value">[docs]</a><span class="k">def</span> <span class="nf">get_zmat_str_var_value</span><span class="p">(</span><span class="n">zmat_str</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the value of a zmat variable from a string-represented zmat.</span>

<span class="sd">    Args:</span>
<span class="sd">        zmat_str (str): The string representation of the zmat.</span>
<span class="sd">        var (str): The variable to look for.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: The value corresponding to the ``var``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">zmat_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not find var &quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">&quot; in zmat:</span><span class="se">\n</span><span class="si">{</span><span class="n">zmat_str</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_zmat_param_value"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.get_zmat_param_value">[docs]</a><span class="k">def</span> <span class="nf">get_zmat_param_value</span><span class="p">(</span><span class="n">coords</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">],</span>
                         <span class="n">indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                         <span class="n">mol</span><span class="p">:</span> <span class="n">Molecule</span><span class="p">,</span>
                         <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a zmat similarly to modify_coords(),</span>
<span class="sd">    but instead of modifying it, only reports on the value of a requested parameter.</span>

<span class="sd">    Args:</span>
<span class="sd">        coords (dict): Either cartesian (xyz) or internal (zmat) coordinates.</span>
<span class="sd">        indices (list): The indices to change. Specifying a list of length 2, 3, or 4 will result in a</span>
<span class="sd">                        bond length, angle, or a dihedral angle parameter, respectively.</span>
<span class="sd">        mol (Molecule, optional): The corresponding RMG molecule with the connectivity information.</span>
<span class="sd">        index (bool, optional): Whether the specified atoms are 0- or 1-indexed.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: The parameter value in Angstrom or degrees.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The index argument must be either 0 or 1, got </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">index</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>  <span class="c1"># make sure indices are 0-indexed</span>
    <span class="n">modification_type</span> <span class="o">=</span> <span class="n">KEY_FROM_LEN</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;atom&#39;</span>  <span class="c1"># e.g., R_atom</span>
    <span class="k">if</span> <span class="s1">&#39;map&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="c1"># a zmat was given, we actually need xyz to recreate a specific zmat for the parameter modification.</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">zmat_to_xyz</span><span class="p">(</span><span class="n">zmat</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># coords represents xyz</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">coords</span>

    <span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span><span class="n">modification_type</span><span class="p">:</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">indices</span><span class="p">)]}</span>
    <span class="n">zmat</span> <span class="o">=</span> <span class="n">xyz_to_zmat</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">consolidate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">get_parameter_from_atom_indices</span><span class="p">(</span><span class="n">zmat</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">xyz_indexed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">zmat</span><span class="p">[</span><span class="s2">&quot;vars&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">zmat</span><span class="p">[</span><span class="s2">&quot;vars&quot;</span><span class="p">][</span><span class="n">par</span><span class="p">]</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span></div>


<div class="viewcode-block" id="relocate_zmat_dummy_atoms_to_the_end"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.relocate_zmat_dummy_atoms_to_the_end">[docs]</a><span class="k">def</span> <span class="nf">relocate_zmat_dummy_atoms_to_the_end</span><span class="p">(</span><span class="n">zmat_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Relocate all dummy atoms in a ZMat to the end of the corresponding Cartesian coordinates atom list.</span>
<span class="sd">    Only modifies the values of the ZMat map.</span>

<span class="sd">    Args:</span>
<span class="sd">        zmat_map (dict): The ZMat map.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The updated ZMat map.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">no_x_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">zmat_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">int</span><span class="p">)}</span>
    <span class="n">x_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">zmat_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;X&#39;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">x_atom_number_in_zmat</span><span class="p">,</span> <span class="n">x_atom_val</span> <span class="ow">in</span> <span class="n">x_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">x_atom_number_in_cartesian</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x_atom_val</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x_atom_number_in_cartesian</span> <span class="o">&lt;</span> <span class="n">number_in_cartesian</span> <span class="k">for</span> <span class="n">number_in_cartesian</span> <span class="ow">in</span> <span class="n">no_x_map</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">no_x_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x_atom_number_in_cartesian</span> <span class="o">&lt;</span> <span class="n">val</span> <span class="k">else</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">no_x_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">num_no_x_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">no_x_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">x_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;X</span><span class="si">{</span><span class="n">num_no_x_atoms</span> <span class="o">+</span> <span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_map</span><span class="o">.</span><span class="n">items</span><span class="p">())}</span>
    <span class="n">no_x_map</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x_map</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">no_x_map</span></div>


<div class="viewcode-block" id="modify_coords"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.modify_coords">[docs]</a><span class="k">def</span> <span class="nf">modify_coords</span><span class="p">(</span><span class="n">coords</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">],</span>
                  <span class="n">indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                  <span class="n">new_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">modification_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">mol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Molecule</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                  <span class="n">fragments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify either a bond length, angle, or dihedral angle in the given coordinates.</span>
<span class="sd">    The coordinates input could either be cartesian (preferred) or internal</span>
<span class="sd">    (will be first converter to cartesian, then to internal back again</span>
<span class="sd">    since a specific zmat must be created).</span>
<span class="sd">    Internal coordinates will be used for the modification (using folding and unfolding).</span>

<span class="sd">    Specifying an &#39;atom&#39; modification type will only translate/rotate the atom represented by the first index</span>
<span class="sd">    if the corresponding zmat parameter is changed.</span>
<span class="sd">    Specifying a &#39;group&#39; modification type will cause the entire group connected to the first atom to translate/rotate</span>
<span class="sd">    if the corresponding zmat parameter is changed.</span>
<span class="sd">    Specifying a &#39;groups&#39; modification type (only valid for dihedral angles) will cause the groups connected to</span>
<span class="sd">    the first two atoms to translate/rotate if the corresponding zmat parameter is changed.</span>

<span class="sd">    Args:</span>
<span class="sd">        coords (dict): Either cartesian (xyz) or internal (zmat) coordinates.</span>
<span class="sd">        indices (list): The indices to change. Specifying a list of length 2, 3, or 4 will result in changing</span>
<span class="sd">                        a bond length, angle, or a dihedral angle, respectively.</span>
<span class="sd">        new_value (float): The new value to set (in Angstrom or degrees).</span>
<span class="sd">        modification_type (str): Either &#39;atom&#39;, &#39;group&#39;, or &#39;groups&#39; (&#39;groups&#39; is only allowed for dihedral angles).</span>
<span class="sd">                                 Note that D &#39;groups&#39; is a composite constraint, equivalent to calling D &#39;group&#39;</span>
<span class="sd">                                 for each 1st neighboring  atom in a torsion top.</span>
<span class="sd">        mol (Molecule, optional): The corresponding RMG molecule with the connectivity information.</span>
<span class="sd">                                  Mandatory if the modification type is &#39;group&#39; or &#39;groups&#39;.</span>
<span class="sd">        index (bool, optional): Whether the specified atoms in ``indices`` and ``fragments`` are 0- or 1-indexed.</span>
<span class="sd">        fragments (List[List[int]], optional):</span>
<span class="sd">            Fragments represented by the species, i.e., as in a VdW well or a TS.</span>
<span class="sd">            Entries are atom index lists of all atoms in a fragment, each list represents a different fragment.</span>
<span class="sd">            indices are 0-indexed.</span>

<span class="sd">    Raises:</span>
<span class="sd">        InputError: If ``coords`` is not give,</span>
<span class="sd">                    or if a group/s modification type is requested but ``mol`` is ``None``,</span>
<span class="sd">                    or if a &#39;groups&#39; modification type was specified for &#39;R&#39; or &#39;A&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The respective cartesian (xyz) coordinates reflecting the desired modification.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;coords must be given.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">modification_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;atom&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;groups&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Allowed modification types are atom, group, or groups, got: </span><span class="si">{</span><span class="n">modification_type</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;group&#39;</span> <span class="ow">in</span> <span class="n">modification_type</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A molecule must be given for a </span><span class="si">{</span><span class="n">modification_type</span><span class="si">}</span><span class="s1"> modification type.&#39;</span><span class="p">)</span>
    <span class="n">modification_type</span> <span class="o">=</span> <span class="n">KEY_FROM_LEN</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">modification_type</span>  <span class="c1"># e.g., R_group</span>
    <span class="k">if</span> <span class="n">modification_type</span> <span class="o">==</span> <span class="s1">&#39;groups&#39;</span> <span class="ow">and</span> <span class="n">modification_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The &quot;groups&quot; modification type is only supported for dihedrals (D), &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;not for an </span><span class="si">{</span><span class="n">modification_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> parameter.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The index argument must be either 0 or 1, got </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;map&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="c1"># a zmat was given, we actually need xyz to recreate a specific zmat for the parameter modification.</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">zmat_to_xyz</span><span class="p">(</span><span class="n">zmat</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># coords represents xyz</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">coords</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">index</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>  <span class="c1"># make sure indices are 0-indexed</span>
    <span class="k">if</span> <span class="n">fragments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fragments</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">])))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_fragments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fragment</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">:</span>
            <span class="n">new_fragments</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">f</span> <span class="o">-</span> <span class="n">index</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fragment</span><span class="p">])</span>  <span class="c1"># make sure indices are 0-indexed</span>
        <span class="n">fragments</span> <span class="o">=</span> <span class="n">new_fragments</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;indices cannot be negative, got </span><span class="si">{</span><span class="n">indices</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fragment</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">f</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fragment</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fragment indices cannot be negative, got </span><span class="si">{</span><span class="n">fragments</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">constraints_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">indices</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">modification_type</span> <span class="o">==</span> <span class="s1">&#39;D_groups&#39;</span><span class="p">:</span>
        <span class="c1"># this is a special constraint for which neighbor dihedrals must be considered as well.</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="n">get_all_neighbors</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">atom_index</span><span class="o">=</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">neighbor</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">neighbor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                <span class="n">constraints_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="n">neighbor</span><span class="p">]</span> <span class="o">+</span> <span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="n">modification_type</span> <span class="o">=</span> <span class="s1">&#39;D_group&#39;</span>

    <span class="n">new_xyz</span> <span class="o">=</span> <span class="n">xyz</span>
    <span class="n">increment</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints_list</span><span class="p">:</span>
        <span class="n">constraint_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">modification_type</span><span class="p">:</span> <span class="p">[</span><span class="n">constraint</span><span class="p">]}</span>
        <span class="n">zmat</span> <span class="o">=</span> <span class="n">xyz_to_zmat</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">new_xyz</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">consolidate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraint_dict</span><span class="p">,</span> <span class="n">fragments</span><span class="o">=</span><span class="n">fragments</span><span class="p">)</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">get_parameter_from_atom_indices</span><span class="p">(</span><span class="n">zmat</span><span class="p">,</span> <span class="n">constraint</span><span class="p">,</span> <span class="n">xyz_indexed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">modification_type</span> <span class="o">==</span> <span class="s1">&#39;D_group&#39;</span> <span class="ow">and</span> <span class="n">increment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># determine the dihedral increment, will be used for all other D-group modifications</span>
            <span class="n">increment</span> <span class="o">=</span> <span class="n">new_value</span> <span class="o">-</span> <span class="n">zmat</span><span class="p">[</span><span class="s2">&quot;vars&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">increment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">zmat</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">zmat</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">+=</span> <span class="n">increment</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># The requested parameter represents an angle split by a dummy atom,</span>
            <span class="c1"># a list of the two corresponding parameters was returned.</span>
            <span class="n">zmat</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">][</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">new_value</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">zmat</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">][</span><span class="n">par</span><span class="p">]</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">new_xyz</span> <span class="o">=</span> <span class="n">zmat_to_xyz</span><span class="p">(</span><span class="n">zmat</span><span class="o">=</span><span class="n">zmat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_xyz</span></div>


<div class="viewcode-block" id="get_most_common_isotope_for_element"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.get_most_common_isotope_for_element">[docs]</a><span class="k">def</span> <span class="nf">get_most_common_isotope_for_element</span><span class="p">(</span><span class="n">element_symbol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the most common isotope for a given element symbol.</span>

<span class="sd">    Args:</span>
<span class="sd">        element_symbol (str): The element symbol.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The most common isotope number for the element.</span>
<span class="sd">             Returns ``None`` for dummy atoms (&#39;X&#39;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">element_symbol</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span>
        <span class="c1"># this is a dummy atom (such as in a zmat)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">mass_list</span> <span class="o">=</span> <span class="n">mass_by_symbol</span><span class="p">[</span><span class="n">element_symbol</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mass_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># isotope contribution is unavailable, just get the first entry</span>
        <span class="n">isotope</span> <span class="o">=</span> <span class="n">mass_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># isotope contribution is unavailable, get the most common isotope</span>
        <span class="n">isotope</span><span class="p">,</span> <span class="n">isotope_contribution</span> <span class="o">=</span> <span class="n">mass_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">mass_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">mass_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">iso</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">isotope_contribution</span><span class="p">:</span>
                <span class="n">isotope_contribution</span> <span class="o">=</span> <span class="n">iso</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">isotope</span> <span class="o">=</span> <span class="n">iso</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">isotope</span></div>


<div class="viewcode-block" id="xyz_to_pybel_mol"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.xyz_to_pybel_mol">[docs]</a><span class="k">def</span> <span class="nf">xyz_to_pybel_mol</span><span class="p">(</span><span class="n">xyz</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert xyz into an Open Babel molecule object.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz (dict): ARC&#39;s xyz dictionary format.</span>

<span class="sd">    Returns: Optional[OBmol]</span>
<span class="sd">        An Open Babel molecule.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">check_xyz_dict</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pybel_mol</span> <span class="o">=</span> <span class="n">pybel</span><span class="o">.</span><span class="n">readstring</span><span class="p">(</span><span class="s1">&#39;xyz&#39;</span><span class="p">,</span> <span class="n">xyz_to_xyz_file_format</span><span class="p">(</span><span class="n">xyz</span><span class="p">))</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="n">InputError</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">pybel_mol</span></div>


<div class="viewcode-block" id="pybel_to_inchi"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.pybel_to_inchi">[docs]</a><span class="k">def</span> <span class="nf">pybel_to_inchi</span><span class="p">(</span><span class="n">pybel_mol</span><span class="p">,</span> <span class="n">has_h</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert an Open Babel molecule object to InChI</span>

<span class="sd">    Args:</span>
<span class="sd">        pybel_mol (OBmol): An Open Babel molecule.</span>
<span class="sd">        has_h (bool): Whether the molecule has hydrogen atoms. ``True`` if it does.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The respective InChI representation of the molecule.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">has_h</span><span class="p">:</span>
        <span class="n">inchi</span> <span class="o">=</span> <span class="n">pybel_mol</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;inchi&#39;</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># Add fixed H layer</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inchi</span> <span class="o">=</span> <span class="n">pybel_mol</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;inchi&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">inchi</span></div>


<div class="viewcode-block" id="rmg_mol_from_inchi"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.rmg_mol_from_inchi">[docs]</a><span class="k">def</span> <span class="nf">rmg_mol_from_inchi</span><span class="p">(</span><span class="n">inchi</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate an RMG Molecule object from InChI.</span>

<span class="sd">    Args:</span>
<span class="sd">        inchi (str): The InChI string.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Molecule: The respective RMG Molecule object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rmg_mol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">()</span><span class="o">.</span><span class="n">from_inchi</span><span class="p">(</span><span class="n">inchi</span><span class="p">,</span> <span class="n">raise_atomtype_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">AtomTypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Got an Error when trying to create an RMG Molecule object from InChI &quot;</span><span class="si">{</span><span class="n">inchi</span><span class="si">}</span><span class="s1">&quot;:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;got an unexpected keyword argument&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="s1">&#39;Make sure RMG-Py is up to date and compiled!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">rmg_mol</span></div>


<div class="viewcode-block" id="elementize"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.elementize">[docs]</a><span class="k">def</span> <span class="nf">elementize</span><span class="p">(</span><span class="n">atom</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the atom type of an RMG ``Atom`` object into its general parent element atom type (e.g., &#39;S4d&#39; into &#39;S&#39;).</span>

<span class="sd">    Args:</span>
<span class="sd">        atom (Atom): The atom to process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atom_type</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomtype</span>
    <span class="n">atom_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">at</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">atom_type</span><span class="o">.</span><span class="n">generic</span> <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="s1">&#39;R&#39;</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="s1">&#39;R!H&#39;</span> <span class="ow">and</span> <span class="s1">&#39;Val&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">atom_type</span><span class="p">:</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">atomtype</span> <span class="o">=</span> <span class="n">atom_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="molecules_from_xyz"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.molecules_from_xyz">[docs]</a><span class="k">def</span> <span class="nf">molecules_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
                       <span class="n">multiplicity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">charge</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                       <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Molecule</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Molecule</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creating RMG:Molecule objects from xyz with correct atom labeling.</span>
<span class="sd">    Based on the MolGraph.perceive_smiles method.</span>
<span class="sd">    If `multiplicity` is given, the returned species multiplicity will be set to it.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz (dict): The ARC dict format xyz coordinates of the species.</span>
<span class="sd">        multiplicity (int, optional): The species spin multiplicity.</span>
<span class="sd">        charge (int, optional): The species net charge.</span>

<span class="sd">    Returns: Tuple[Optional[Molecule], Optional[Molecule]]</span>
<span class="sd">        - The respective Molecule object with only single bonds.</span>
<span class="sd">        - The respective Molecule object with perceived bond orders.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">check_xyz_dict</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>

    <span class="c1"># 1. Generate a molecule with no bond order information with atoms ordered as in xyz.</span>
    <span class="n">mol_graph</span> <span class="o">=</span> <span class="n">MolGraph</span><span class="p">(</span><span class="n">symbols</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span> <span class="n">coords</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">])</span>
    <span class="n">inferred_connections</span> <span class="o">=</span> <span class="n">mol_graph</span><span class="o">.</span><span class="n">infer_connections</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">inferred_connections</span><span class="p">:</span>
        <span class="n">mol_s1</span> <span class="o">=</span> <span class="n">mol_graph</span><span class="o">.</span><span class="n">to_rmg_mol</span><span class="p">()</span>  <span class="c1"># An RMG Molecule with single bonds, atom order corresponds to xyz.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mol_s1</span> <span class="o">=</span> <span class="n">s_bonds_mol_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>  <span class="c1"># An RMG Molecule with single bonds, atom order corresponds to xyz.</span>
    <span class="k">if</span> <span class="n">mol_s1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not create a 2D graph representation from xyz:</span><span class="se">\n</span><span class="si">{</span><span class="n">xyz_to_str</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">multiplicity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mol_s1</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span>
    <span class="n">mol_s1_updated</span> <span class="o">=</span> <span class="n">update_molecule</span><span class="p">(</span><span class="n">mol_s1</span><span class="p">,</span> <span class="n">to_single_bonds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 2. Generate a molecule with bond order information using pybel:</span>
    <span class="n">mol_bo</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pybel_mol</span> <span class="o">=</span> <span class="n">xyz_to_pybel_mol</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pybel_mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">inchi</span> <span class="o">=</span> <span class="n">pybel_to_inchi</span><span class="p">(</span><span class="n">pybel_mol</span><span class="p">,</span> <span class="n">has_h</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">is_hydrogen</span><span class="p">()</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol_s1_updated</span><span class="o">.</span><span class="n">atoms</span><span class="p">])))</span>
        <span class="n">mol_bo</span> <span class="o">=</span> <span class="n">rmg_mol_from_inchi</span><span class="p">(</span><span class="n">inchi</span><span class="p">)</span>  <span class="c1"># An RMG Molecule with bond orders, but without preserved atom order.</span>

    <span class="c1"># 3. Generate a molecule with bond order information using xyz_to_smiles.</span>
    <span class="k">if</span> <span class="n">mol_bo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">smiles_list</span> <span class="o">=</span> <span class="n">xyz_to_smiles</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">smiles_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mol_bo</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">(</span><span class="n">smiles</span><span class="o">=</span><span class="n">smiles_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">mol_bo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">multiplicity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">set_multiplicity</span><span class="p">(</span><span class="n">mol_bo</span><span class="p">,</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">charge</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">SpeciesError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot infer 2D graph connectivity, failed to set species multiplicity with the &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;following error:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">mol_s1_updated</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">mol_s1_updated</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">=</span> <span class="n">mol_bo</span><span class="o">.</span><span class="n">multiplicity</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">order_atoms</span><span class="p">(</span><span class="n">ref_mol</span><span class="o">=</span><span class="n">mol_s1_updated</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol_bo</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">SanitizationError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not order atoms for </span><span class="si">{</span><span class="n">mol_s1_updated</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">()</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">set_multiplicity</span><span class="p">(</span><span class="n">mol_s1_updated</span><span class="p">,</span> <span class="n">mol_bo</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">radical_map</span><span class="o">=</span><span class="n">mol_bo</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ConverterError</span><span class="p">,</span> <span class="n">SpeciesError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot infer 2D graph connectivity, failed to set species multiplicity with the &#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;following error:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="p">[</span><span class="n">mol_s1_updated</span><span class="p">,</span> <span class="n">mol_bo</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mol</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">radical_electrons</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">mol_s1_updated</span><span class="p">,</span> <span class="n">mol_bo</span></div>


<div class="viewcode-block" id="set_multiplicity"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.set_multiplicity">[docs]</a><span class="k">def</span> <span class="nf">set_multiplicity</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">multiplicity</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">radical_map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the multiplicity and charge of a molecule.</span>
<span class="sd">    If a `radical_map`, which is an RMG Molecule object with the same atom order, is given,</span>
<span class="sd">    it&#39;ll be used to set radicals (useful if bond orders aren&#39;t known for a molecule).</span>

<span class="sd">    Args:</span>
<span class="sd">        mol (Molecule): The RMG Molecule object.</span>
<span class="sd">        multiplicity (int) The spin multiplicity.</span>
<span class="sd">        charge (int): The species net charge.</span>
<span class="sd">        radical_map (Molecule, optional): An RMG Molecule object with the same atom order to be used as a radical map.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConverterError: If ``radical_map`` is of wrong type.</span>
<span class="sd">        SpeciesError: If number of radicals and multiplicity do not match or if connectivity cannot be inferred.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span>
    <span class="k">if</span> <span class="n">radical_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">radical_map</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;radical_map sent to set_multiplicity() has to be a Molecule object. &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">radical_map</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">set_radicals_by_map</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">radical_map</span><span class="p">)</span>
    <span class="n">radicals</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">get_radical_count</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">!=</span> <span class="n">radicals</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># this is not the trivial &quot;multiplicity = number of radicals + 1&quot; case</span>
        <span class="c1"># either the number of radicals was not identified correctly from the 3D structure (i.e., should be lone pairs),</span>
        <span class="c1"># or their spin isn&#39;t determined correctly</span>
        <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">&gt;</span> <span class="n">radicals</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># there are sites that should have radicals, but weren&#39;t identified as such.</span>
            <span class="c1"># try adding radicals according to missing valances</span>
            <span class="n">add_rads_by_atom_valance</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">&gt;</span> <span class="n">radicals</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># still problematic, currently there&#39;s no automated solution to this case, raise an error</span>
                <span class="k">raise</span> <span class="n">SpeciesError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A multiplicity of </span><span class="si">{</span><span class="n">mol</span><span class="o">.</span><span class="n">multiplicity</span><span class="si">}</span><span class="s1"> was given, but only </span><span class="si">{</span><span class="n">radicals</span><span class="si">}</span><span class="s1"> radicals &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;were identified. Cannot infer 2D graph representation for this species.</span><span class="se">\n</span><span class="s1">More &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;info:</span><span class="si">{</span><span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_adjacency_list</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">add_lone_pairs_by_atom_valance</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="c1"># final check: an even number of radicals results in an odd multiplicity, and vice versa</span>
    <span class="k">if</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">radicals</span><span class="p">,</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">charge</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SpeciesError</span><span class="p">(</span><span class="s1">&#39;Number of radicals (</span><span class="si">{0}</span><span class="s1">) and multiplicity (</span><span class="si">{1}</span><span class="s1">) for </span><span class="si">{2}</span><span class="s1"> do not match.</span><span class="se">\n</span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">radicals</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">(),</span> <span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_adjacency_list</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Number of radicals (</span><span class="si">{0}</span><span class="s1">) and multiplicity (</span><span class="si">{1}</span><span class="s1">) for </span><span class="si">{2}</span><span class="s1"> do not match. It might be OK since &#39;</span>
                           <span class="s1">&#39;this species is charged and charged molecules are currently not perceived well in ARC.&#39;</span>
                           <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">radicals</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">(),</span>
                                          <span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_adjacency_list</span><span class="p">()))</span></div>


<div class="viewcode-block" id="add_rads_by_atom_valance"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.add_rads_by_atom_valance">[docs]</a><span class="k">def</span> <span class="nf">add_rads_by_atom_valance</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper function for assigning radicals if not identified automatically,</span>
<span class="sd">    and they are missing according to the given multiplicity.</span>
<span class="sd">    We assume here that all partial charges were already set, but this assumption could be wrong.</span>
<span class="sd">    Note: This implementation might also be problematic for aromatic species with undefined bond orders.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol (Molecule): The Molecule object to process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">is_non_hydrogen</span><span class="p">():</span>
            <span class="n">atomic_orbitals</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">lone_pairs</span> <span class="o">+</span> <span class="n">atom</span><span class="o">.</span><span class="n">radical_electrons</span> <span class="o">+</span> <span class="n">atom</span><span class="o">.</span><span class="n">get_total_bond_order</span><span class="p">()</span>
            <span class="n">missing_electrons</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">atomic_orbitals</span>
            <span class="k">if</span> <span class="n">missing_electrons</span><span class="p">:</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">radical_electrons</span> <span class="o">=</span> <span class="n">missing_electrons</span></div>


<div class="viewcode-block" id="add_lone_pairs_by_atom_valance"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.add_lone_pairs_by_atom_valance">[docs]</a><span class="k">def</span> <span class="nf">add_lone_pairs_by_atom_valance</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper function for assigning lone pairs instead of carbenes/nitrenes if not identified automatically,</span>
<span class="sd">    and they are missing according to the given multiplicity.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol (Molecule): The Molecule object to process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">radicals</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">get_radical_count</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">&lt;</span> <span class="n">radicals</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">carbenes</span><span class="p">,</span> <span class="n">nitrenes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">is_carbon</span><span class="p">()</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">radical_electrons</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">carbenes</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">is_nitrogen</span><span class="p">()</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">radical_electrons</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">nitrenes</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">carbenes</span> <span class="o">+</span> <span class="n">nitrenes</span><span class="p">)</span> <span class="o">+</span> <span class="n">mol</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">==</span> <span class="n">radicals</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># this issue can be solved by converting carbenes/nitrenes to lone pairs:</span>
            <span class="k">if</span> <span class="n">carbenes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">)):</span>
                    <span class="n">atom</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">is_carbon</span><span class="p">()</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">radical_electrons</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">atom</span><span class="o">.</span><span class="n">lone_pairs</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">atom</span><span class="o">.</span><span class="n">radical_electrons</span> <span class="o">-=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">nitrenes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">)):</span>
                    <span class="n">atom</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">is_nitrogen</span><span class="p">()</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">radical_electrons</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">bond12</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">atom2</span><span class="o">.</span><span class="n">is_sulfur</span><span class="p">()</span> <span class="ow">and</span> <span class="n">atom2</span><span class="o">.</span><span class="n">lone_pairs</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">bond12</span><span class="o">.</span><span class="n">is_single</span><span class="p">():</span>
                                <span class="n">bond12</span><span class="o">.</span><span class="n">set_order_num</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                                <span class="n">atom2</span><span class="o">.</span><span class="n">lone_pairs</span> <span class="o">-=</span> <span class="mi">1</span>
                                <span class="k">break</span>
                            <span class="k">elif</span> <span class="n">atom2</span><span class="o">.</span><span class="n">is_sulfur</span><span class="p">()</span> <span class="ow">and</span> <span class="n">atom2</span><span class="o">.</span><span class="n">lone_pairs</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">bond12</span><span class="o">.</span><span class="n">is_single</span><span class="p">():</span>
                                <span class="n">bond12</span><span class="o">.</span><span class="n">set_order_num</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                                <span class="n">atom2</span><span class="o">.</span><span class="n">lone_pairs</span> <span class="o">-=</span> <span class="mi">1</span>
                                <span class="n">atom2</span><span class="o">.</span><span class="n">charge</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">atom</span><span class="o">.</span><span class="n">charge</span> <span class="o">-=</span> <span class="mi">1</span>
                                <span class="k">break</span>
                            <span class="k">elif</span> <span class="n">atom2</span><span class="o">.</span><span class="n">is_nitrogen</span><span class="p">()</span> <span class="ow">and</span> <span class="n">atom2</span><span class="o">.</span><span class="n">lone_pairs</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">bond12</span><span class="o">.</span><span class="n">is_single</span><span class="p">():</span>
                                <span class="n">bond12</span><span class="o">.</span><span class="n">set_order_num</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                                <span class="n">atom2</span><span class="o">.</span><span class="n">lone_pairs</span> <span class="o">-=</span> <span class="mi">1</span>
                                <span class="n">atom</span><span class="o">.</span><span class="n">lone_pairs</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">atom2</span><span class="o">.</span><span class="n">charge</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">atom</span><span class="o">.</span><span class="n">charge</span> <span class="o">-=</span> <span class="mi">1</span>
                                <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">atom</span><span class="o">.</span><span class="n">lone_pairs</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">atom</span><span class="o">.</span><span class="n">radical_electrons</span> <span class="o">-=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">mol</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">radical_electrons</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># This is a singlet atomic C or Si, convert all radicals to lone pairs</span>
        <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">radical_electrons</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lone_pairs</span> <span class="o">=</span> <span class="mi">2</span></div>


<div class="viewcode-block" id="set_radicals_by_map"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.set_radicals_by_map">[docs]</a><span class="k">def</span> <span class="nf">set_radicals_by_map</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">radical_map</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set radicals in ``mol`` by ``radical_map``.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol (Molecule): The RMG Molecule object to process.</span>
<span class="sd">        radical_map (Molecule): An RMG Molecule object with the same atom order to be used as a radical map.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConverterError: If atom order does not match.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">number</span> <span class="o">!=</span> <span class="n">radical_map</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="s1">&#39;Atom order in mol and radical_map in set_radicals_by_map() do not match. &#39;</span>
                                 <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> is not </span><span class="si">{1}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">radical_map</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">symbol</span><span class="p">))</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">radical_electrons</span> <span class="o">=</span> <span class="n">radical_map</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">radical_electrons</span></div>


<div class="viewcode-block" id="order_atoms_in_mol_list"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.order_atoms_in_mol_list">[docs]</a><span class="k">def</span> <span class="nf">order_atoms_in_mol_list</span><span class="p">(</span><span class="n">ref_mol</span><span class="p">,</span> <span class="n">mol_list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Order the atoms in all molecules of ``mol_list`` by the atom order in ``ref_mol``.</span>

<span class="sd">    Args:</span>
<span class="sd">        ref_mol (Molecule): The reference Molecule object.</span>
<span class="sd">        mol_list (list): Entries are Molecule objects whose atoms will be reordered according to the reference.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If ``ref_mol`` or the entries in ``mol_list`` have a wrong type.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: Whether the reordering was successful, ``True`` if it was.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref_mol</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;expected mol to be a Molecule instance, got </span><span class="si">{</span><span class="n">ref_mol</span><span class="si">}</span><span class="s1"> which is a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ref_mol</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mol_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">mol_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;expected enrties of mol_list to be Molecule instances, got </span><span class="si">{</span><span class="n">mol</span><span class="si">}</span><span class="s1"> &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;which is a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>  <span class="c1"># TODO: flag as unordered (or solve)</span>
                <span class="n">order_atoms</span><span class="p">(</span><span class="n">ref_mol</span><span class="p">,</span> <span class="n">mol</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">SanitizationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not order atoms in</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_adjacency_list</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;Got the following error:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not order atoms&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="order_atoms"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.order_atoms">[docs]</a><span class="k">def</span> <span class="nf">order_atoms</span><span class="p">(</span><span class="n">ref_mol</span><span class="p">,</span> <span class="n">mol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Order the atoms in ``mol`` by the atom order in ``ref_mol``.</span>

<span class="sd">    Args:</span>
<span class="sd">        ref_mol (Molecule): The reference Molecule object.</span>
<span class="sd">        mol (Molecule): The Molecule object to process.</span>

<span class="sd">    Raises:</span>
<span class="sd">        SanitizationError: If atoms could not be re-ordered.</span>
<span class="sd">        TypeError: If ``mol`` has a wrong type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">Molecule</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;expected mol to be a Molecule instance, got </span><span class="si">{</span><span class="n">mol</span><span class="si">}</span><span class="s1"> which is a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ref_mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ref_mol_is_iso_copy</span> <span class="o">=</span> <span class="n">ref_mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mol_is_iso_copy</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ref_mol_find_iso_copy</span> <span class="o">=</span> <span class="n">ref_mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mol_find_iso_copy</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">ref_mol_is_iso_copy</span> <span class="o">=</span> <span class="n">update_molecule</span><span class="p">(</span><span class="n">ref_mol_is_iso_copy</span><span class="p">,</span> <span class="n">to_single_bonds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mol_is_iso_copy</span> <span class="o">=</span> <span class="n">update_molecule</span><span class="p">(</span><span class="n">mol_is_iso_copy</span><span class="p">,</span> <span class="n">to_single_bonds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ref_mol_find_iso_copy</span> <span class="o">=</span> <span class="n">update_molecule</span><span class="p">(</span><span class="n">ref_mol_find_iso_copy</span><span class="p">,</span> <span class="n">to_single_bonds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mol_find_iso_copy</span> <span class="o">=</span> <span class="n">update_molecule</span><span class="p">(</span><span class="n">mol_find_iso_copy</span><span class="p">,</span> <span class="n">to_single_bonds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mol_is_iso_copy</span><span class="o">.</span><span class="n">is_isomorphic</span><span class="p">(</span><span class="n">ref_mol_is_iso_copy</span><span class="p">,</span> <span class="n">save_order</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="n">mol_find_iso_copy</span><span class="o">.</span><span class="n">find_isomorphism</span><span class="p">(</span><span class="n">ref_mol_find_iso_copy</span><span class="p">,</span> <span class="n">save_order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">index_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">ref_mol_find_iso_copy</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">val</span><span class="p">):</span> <span class="n">mol_find_iso_copy</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">index_map</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># logger.debug(&#39;Could not map molecules {0}, {1}:\n\n{2}\n\n{3}&#39;.format(</span>
                <span class="c1">#     ref_mol.copy(deep=True).to_smiles(), mol.copy(deep=True).to_smiles(),</span>
                <span class="c1">#     ref_mol.copy(deep=True).to_adjacency_list(), mol.copy(deep=True).to_adjacency_list()))</span>
                <span class="k">raise</span> <span class="n">SanitizationError</span><span class="p">(</span><span class="s1">&#39;Could not map molecules&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># logger.debug(&#39;Could not map non isomorphic molecules {0}, {1}:\n\n{2}\n\n{3}&#39;.format(</span>
            <span class="c1">#     ref_mol.copy(deep=True).to_smiles(), mol.copy(deep=True).to_smiles(),</span>
            <span class="c1">#     ref_mol.copy(deep=True).to_adjacency_list(), mol.copy(deep=True).to_adjacency_list()))</span>
            <span class="k">raise</span> <span class="n">SanitizationError</span><span class="p">(</span><span class="s1">&#39;Could not map non isomorphic molecules&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_molecule"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.update_molecule">[docs]</a><span class="k">def</span> <span class="nf">update_molecule</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">to_single_bonds</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the molecule, useful for isomorphism comparison.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol (Molecule): The RMG Molecule object to process.</span>
<span class="sd">        to_single_bonds (bool, optional): Whether to convert all bonds to single bonds. ``True`` to convert.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Molecule: The updated molecule.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_mol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">atoms</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">atom_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
        <span class="n">new_atom</span> <span class="o">=</span> <span class="n">new_mol</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">Atom</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">))</span>
        <span class="n">atom_mapping</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_atom</span>
    <span class="k">for</span> <span class="n">atom1</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">atom1</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">bond_order</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">to_single_bonds</span> <span class="k">else</span> <span class="n">atom1</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">atom2</span><span class="p">]</span><span class="o">.</span><span class="n">get_order_num</span><span class="p">()</span>
            <span class="n">bond</span> <span class="o">=</span> <span class="n">Bond</span><span class="p">(</span><span class="n">atom_mapping</span><span class="p">[</span><span class="n">atom1</span><span class="p">],</span> <span class="n">atom_mapping</span><span class="p">[</span><span class="n">atom2</span><span class="p">],</span> <span class="n">bond_order</span><span class="p">)</span>
            <span class="n">new_mol</span><span class="o">.</span><span class="n">add_bond</span><span class="p">(</span><span class="n">bond</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">new_mol</span><span class="o">.</span><span class="n">update_atomtypes</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">new_mol</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">multiplicity</span>
    <span class="k">return</span> <span class="n">new_mol</span></div>


<div class="viewcode-block" id="s_bonds_mol_from_xyz"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.s_bonds_mol_from_xyz">[docs]</a><span class="k">def</span> <span class="nf">s_bonds_mol_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Molecule</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a single bonded molecule from xyz using RMG&#39;s connect_the_dots() method.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz (dict): The xyz coordinates.</span>

<span class="sd">    Returns: Optional[Molecule]</span>
<span class="sd">        The respective molecule with only single bonds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">check_xyz_dict</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span> <span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]):</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">(</span><span class="n">element</span><span class="o">=</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">mol</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">connect_the_dots</span><span class="p">(</span><span class="n">raise_atomtype_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># only adds single bonds, but we don&#39;t care</span>
    <span class="k">return</span> <span class="n">mol</span></div>


<div class="viewcode-block" id="to_rdkit_mol"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.to_rdkit_mol">[docs]</a><span class="k">def</span> <span class="nf">to_rdkit_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">remove_h</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a molecular structure to an RDKit RDMol object. Uses</span>
<span class="sd">    `RDKit &lt;https://rdkit.org/&gt;`_ to perform the conversion.</span>
<span class="sd">    Perceives aromaticity.</span>
<span class="sd">    Adopted from rmgpy/molecule/converter.py</span>

<span class="sd">    Args:</span>
<span class="sd">        mol (Molecule): An RMG Molecule object for the conversion.</span>
<span class="sd">        remove_h (bool, optional): Whether to remove hydrogen atoms from the molecule, ``True`` to remove.</span>
<span class="sd">        sanitize (bool, optional): Whether to sanitize the RDKit molecule, ``True`` to sanitize.</span>

<span class="sd">    Returns:</span>
<span class="sd">        RDMol: An RDKit molecule object corresponding to the input RMG Molecule object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atom_id_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="c1"># only manipulate a copy of ``mol``</span>
    <span class="n">mol_copy</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mol_copy</span><span class="o">.</span><span class="n">atom_ids_valid</span><span class="p">():</span>
        <span class="n">mol_copy</span><span class="o">.</span><span class="n">assign_atom_ids</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_copy</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
        <span class="n">atom_id_map</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>  <span class="c1"># keeps the original atom order before sorting</span>
    <span class="c1"># mol_copy.sort_atoms()  # Sort the atoms before converting to ensure output is consistent between different runs</span>
    <span class="n">atoms_copy</span> <span class="o">=</span> <span class="n">mol_copy</span><span class="o">.</span><span class="n">vertices</span>

    <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">EditableMol</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">Mol</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">rmg_atom</span> <span class="ow">in</span> <span class="n">atoms_copy</span><span class="p">:</span>
        <span class="n">rd_atom</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">Atom</span><span class="p">(</span><span class="n">rmg_atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rmg_atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">isotope</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">rd_atom</span><span class="o">.</span><span class="n">SetIsotope</span><span class="p">(</span><span class="n">rmg_atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">isotope</span><span class="p">)</span>
        <span class="n">rd_atom</span><span class="o">.</span><span class="n">SetNumRadicalElectrons</span><span class="p">(</span><span class="n">rmg_atom</span><span class="o">.</span><span class="n">radical_electrons</span><span class="p">)</span>
        <span class="n">rd_atom</span><span class="o">.</span><span class="n">SetFormalCharge</span><span class="p">(</span><span class="n">rmg_atom</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rmg_atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span> <span class="ow">and</span> <span class="n">rmg_atom</span><span class="o">.</span><span class="n">lone_pairs</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">mol_copy</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># hard coding for carbenes</span>
            <span class="n">rd_atom</span><span class="o">.</span><span class="n">SetNumRadicalElectrons</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">remove_h</span> <span class="ow">and</span> <span class="n">rmg_atom</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">):</span>
            <span class="n">rd_mol</span><span class="o">.</span><span class="n">AddAtom</span><span class="p">(</span><span class="n">rd_atom</span><span class="p">)</span>

    <span class="n">rd_bonds</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">BondType</span>
    <span class="n">orders</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="n">rd_bonds</span><span class="o">.</span><span class="n">SINGLE</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="n">rd_bonds</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">rd_bonds</span><span class="o">.</span><span class="n">TRIPLE</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="n">rd_bonds</span><span class="o">.</span><span class="n">AROMATIC</span><span class="p">,</span>
              <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="n">rd_bonds</span><span class="o">.</span><span class="n">QUADRUPLE</span><span class="p">}</span>
    <span class="c1"># Add the bonds</span>
    <span class="k">for</span> <span class="n">atom1</span> <span class="ow">in</span> <span class="n">atoms_copy</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">bond12</span> <span class="ow">in</span> <span class="n">atom1</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">bond12</span><span class="o">.</span><span class="n">is_hydrogen_bond</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">atoms_copy</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">atoms_copy</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom2</span><span class="p">):</span>
                <span class="n">rd_mol</span><span class="o">.</span><span class="n">AddBond</span><span class="p">(</span><span class="n">atom_id_map</span><span class="p">[</span><span class="n">atom1</span><span class="o">.</span><span class="n">id</span><span class="p">],</span> <span class="n">atom_id_map</span><span class="p">[</span><span class="n">atom2</span><span class="o">.</span><span class="n">id</span><span class="p">],</span> <span class="n">orders</span><span class="p">[</span><span class="n">bond12</span><span class="o">.</span><span class="n">get_order_str</span><span class="p">()])</span>

    <span class="c1"># Make editable mol and rectify the molecule</span>
    <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">rd_mol</span><span class="o">.</span><span class="n">GetMol</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">sanitize</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Chem</span><span class="o">.</span><span class="n">SanitizeMol</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">AtomValenceException</span><span class="p">:</span>
            <span class="c1"># [C-]#[O+] raises this</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="n">remove_h</span><span class="p">:</span>
        <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">RemoveHs</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="n">sanitize</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rd_mol</span></div>


<div class="viewcode-block" id="rdkit_conf_from_mol"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.rdkit_conf_from_mol">[docs]</a><span class="k">def</span> <span class="nf">rdkit_conf_from_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">:</span> <span class="n">Molecule</span><span class="p">,</span>
                        <span class="n">xyz</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     Generate an RDKit Conformer object from an RMG Molecule object.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol (Molecule): The RMG Molecule object.</span>
<span class="sd">        xyz (dict): The xyz coordinates of the conformer, atoms must be ordered as in ``mol``.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConverterError: if ``xyz`` is of wrong type.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple:</span>
<span class="sd">            - Conformer: An RDKit Conformer object.</span>
<span class="sd">            - RDMol: An RDKit Molecule object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A mol argument must be given, got None.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="s1">&#39;The xyz argument seem to be of wrong type. Expected a dictionary, &#39;</span>
                             <span class="s1">&#39;got</span><span class="se">\n</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">which is a </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">xyz</span><span class="p">)))</span>
    <span class="n">rd_mol</span> <span class="o">=</span> <span class="n">to_rdkit_mol</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">remove_h</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">Chem</span><span class="o">.</span><span class="n">AllChem</span><span class="o">.</span><span class="n">EmbedMolecule</span><span class="p">(</span><span class="n">rd_mol</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">rd_mol</span><span class="o">.</span><span class="n">GetNumConformers</span><span class="p">():</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">rd_mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rd_mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()):</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">SetAtomPosition</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># reset atom coordinates</span>
    <span class="k">return</span> <span class="n">conf</span><span class="p">,</span> <span class="n">rd_mol</span></div>


<div class="viewcode-block" id="set_rdkit_dihedrals"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.set_rdkit_dihedrals">[docs]</a><span class="k">def</span> <span class="nf">set_rdkit_dihedrals</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">rd_mol</span><span class="p">,</span> <span class="n">torsion</span><span class="p">,</span> <span class="n">deg_increment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deg_abs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper function for setting dihedral angles using RDKit.</span>
<span class="sd">    Either ``deg_increment`` or ``deg_abs`` must be specified.</span>

<span class="sd">    Args:</span>
<span class="sd">        conf: The RDKit conformer with the current xyz information.</span>
<span class="sd">        rd_mol: The respective RDKit molecule.</span>
<span class="sd">        torsion (list, tuple): The 0-indexed atom indices of the four atoms defining the torsion.</span>
<span class="sd">        deg_increment (float, optional): The required dihedral increment in degrees.</span>
<span class="sd">        deg_abs (float, optional): The required dihedral in degrees.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The xyz with the new dihedral, ordered according to the map.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConverterError: If the dihedral cannot be set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">deg_increment</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">deg_abs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConverterError</span><span class="p">(</span><span class="s1">&#39;Cannot set dihedral without either a degree increment or an absolute degree&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">deg_increment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deg0</span> <span class="o">=</span> <span class="n">rdMT</span><span class="o">.</span><span class="n">GetDihedralDeg</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># get original dihedral</span>
        <span class="n">deg</span> <span class="o">=</span> <span class="n">deg0</span> <span class="o">+</span> <span class="n">deg_increment</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">deg</span> <span class="o">=</span> <span class="n">deg_abs</span>
    <span class="n">rdMT</span><span class="o">.</span><span class="n">SetDihedralDeg</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">deg</span><span class="p">)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">symbols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rd_mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">())):</span>
        <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">conf</span><span class="o">.</span><span class="n">GetAtomPosition</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">GetAtomPosition</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">GetAtomPosition</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">z</span><span class="p">])</span>
        <span class="n">symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetSymbol</span><span class="p">())</span>
    <span class="n">new_xyz</span> <span class="o">=</span> <span class="n">xyz_from_data</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">symbols</span><span class="o">=</span><span class="n">symbols</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_xyz</span></div>


<div class="viewcode-block" id="check_isomorphism"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.check_isomorphism">[docs]</a><span class="k">def</span> <span class="nf">check_isomorphism</span><span class="p">(</span><span class="n">mol1</span><span class="p">,</span> <span class="n">mol2</span><span class="p">,</span> <span class="n">filter_structures</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">convert_to_single_bonds</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert ``mol1`` and ``mol2`` to RMG Species objects, and generate resonance structures.</span>
<span class="sd">    Then check Species isomorphism.</span>
<span class="sd">    This function first makes copies of the molecules, since isIsomorphic() changes atom orders.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol1 (Molecule): An RMG Molecule object.</span>
<span class="sd">        mol2 (Molecule): An RMG Molecule object.</span>
<span class="sd">        filter_structures (bool, optional): Whether to apply the filtration algorithm when generating</span>
<span class="sd">                                            resonance structures. ``True`` to apply.</span>
<span class="sd">        convert_to_single_bonds (bool, optional): Whether to convert both molecules to single bonds,</span>
<span class="sd">                                                  avoiding a bond order comparison (only compares connectivity).</span>
<span class="sd">                                                  Resonance structures will not be generated.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: Whether one of the molecules in the Species derived from ``mol1``</span>
<span class="sd">              is isomorphic to one of the molecules in the Species derived from ``mol2``. ``True`` if it is.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">mol1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">mol2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Cannot check isomorphism without the molecule objects.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">mol1</span><span class="o">.</span><span class="n">reactive</span><span class="p">,</span> <span class="n">mol2</span><span class="o">.</span><span class="n">reactive</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">convert_to_single_bonds</span><span class="p">:</span>
        <span class="n">mol1_copy</span> <span class="o">=</span> <span class="n">mol1</span><span class="o">.</span><span class="n">to_single_bonds</span><span class="p">(</span><span class="n">raise_atomtype_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mol2_copy</span> <span class="o">=</span> <span class="n">mol2</span><span class="o">.</span><span class="n">to_single_bonds</span><span class="p">(</span><span class="n">raise_atomtype_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mol1_copy</span> <span class="o">=</span> <span class="n">mol1</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mol2_copy</span> <span class="o">=</span> <span class="n">mol2</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">spc1</span> <span class="o">=</span> <span class="n">Species</span><span class="p">(</span><span class="n">molecule</span><span class="o">=</span><span class="p">[</span><span class="n">mol1_copy</span><span class="p">])</span>
    <span class="n">spc2</span> <span class="o">=</span> <span class="n">Species</span><span class="p">(</span><span class="n">molecule</span><span class="o">=</span><span class="p">[</span><span class="n">mol2_copy</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">convert_to_single_bonds</span><span class="p">:</span>
        <span class="n">generate_resonance_structures</span><span class="p">(</span><span class="n">spc1</span><span class="p">,</span> <span class="n">filter_structures</span><span class="o">=</span><span class="n">filter_structures</span><span class="p">)</span>
        <span class="n">generate_resonance_structures</span><span class="p">(</span><span class="n">spc2</span><span class="p">,</span> <span class="n">filter_structures</span><span class="o">=</span><span class="n">filter_structures</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">molecule1</span> <span class="ow">in</span> <span class="n">spc1</span><span class="o">.</span><span class="n">molecule</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">molecule2</span> <span class="ow">in</span> <span class="n">spc2</span><span class="o">.</span><span class="n">molecule</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">molecule1</span><span class="o">.</span><span class="n">is_isomorphic</span><span class="p">(</span><span class="n">molecule2</span><span class="p">,</span> <span class="n">save_order</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="get_center_of_mass"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.get_center_of_mass">[docs]</a><span class="k">def</span> <span class="nf">get_center_of_mass</span><span class="p">(</span><span class="n">xyz</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the center of mass of xyz coordinates.</span>
<span class="sd">    Assumes arc.converter.standardize_xyz_string() was already called for xyz.</span>
<span class="sd">    Note that xyz from ESS output is usually already centered at the center of mass (to some precision).</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz (dict): The xyz coordinates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: The center of mass coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">masses</span> <span class="o">=</span> <span class="n">get_element_mass_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="n">cm_x</span><span class="p">,</span> <span class="n">cm_y</span><span class="p">,</span> <span class="n">cm_z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">mass</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">],</span> <span class="n">masses</span><span class="p">):</span>
        <span class="n">cm_x</span> <span class="o">+=</span> <span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mass</span>
        <span class="n">cm_y</span> <span class="o">+=</span> <span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mass</span>
        <span class="n">cm_z</span> <span class="o">+=</span> <span class="n">coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">mass</span>
    <span class="n">cm_x</span> <span class="o">/=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>
    <span class="n">cm_y</span> <span class="o">/=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>
    <span class="n">cm_z</span> <span class="o">/=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">cm_x</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">cm_y</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">cm_z</span><span class="p">)</span></div>


<div class="viewcode-block" id="translate_to_center_of_mass"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.translate_to_center_of_mass">[docs]</a><span class="k">def</span> <span class="nf">translate_to_center_of_mass</span><span class="p">(</span><span class="n">xyz</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Translate coordinates to their center of mass.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz (dict): The 3D coordinates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The translated coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># identify and remove dummy atoms for center of mass determination (but then do translate dummy atoms as well)</span>
    <span class="n">dummies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span>
            <span class="n">dummies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">no_dummies_xyz</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dummies</span><span class="p">],</span>
                      <span class="s1">&#39;isotopes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">isotope</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">isotope</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dummies</span><span class="p">],</span>
                      <span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">coord</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dummies</span><span class="p">]}</span>
    <span class="n">cm_x</span><span class="p">,</span> <span class="n">cm_y</span><span class="p">,</span> <span class="n">cm_z</span> <span class="o">=</span> <span class="n">get_center_of_mass</span><span class="p">(</span><span class="n">no_dummies_xyz</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cm_x</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cm_y</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">cm_z</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1e-10</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1e-10</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1e-10</span> <span class="k">else</span> <span class="mf">0.0</span>
    <span class="n">translated_coords</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">zi</span><span class="p">)</span> <span class="k">for</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">zi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">xyz_from_data</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">translated_coords</span><span class="p">,</span> <span class="n">symbols</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span> <span class="n">isotopes</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;isotopes&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="get_xyz_radius"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.get_xyz_radius">[docs]</a><span class="k">def</span> <span class="nf">get_xyz_radius</span><span class="p">(</span><span class="n">xyz</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the largest distance from the coordinate system origin attributed to one of the atoms in 3D space.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: The radius in Angstrom.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">translated_xyz</span> <span class="o">=</span> <span class="n">translate_to_center_of_mass</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="n">border_elements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># a list of the farthest element/s</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">xyz_to_x_y_z</span><span class="p">(</span><span class="n">translated_xyz</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">si</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">zi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">translated_xyz</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">yi</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">zi</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">ri</span> <span class="o">==</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">border_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ri</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">ri</span>
            <span class="n">border_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">si</span><span class="p">]</span>
    <span class="c1"># also consider the atom&#39;s radius:</span>
    <span class="n">atom_r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">get_atom_radius</span><span class="p">(</span><span class="n">si</span><span class="p">)</span> <span class="k">if</span> <span class="n">get_atom_radius</span><span class="p">(</span><span class="n">si</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">1.50</span> <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">border_elements</span><span class="p">])</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">r</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">atom_r</span>
    <span class="k">return</span> <span class="n">radius</span></div>


<div class="viewcode-block" id="compare_zmats"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.compare_zmats">[docs]</a><span class="k">def</span> <span class="nf">compare_zmats</span><span class="p">(</span><span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">,</span> <span class="n">r_tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">a_tol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">d_tol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">symmetric_torsions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare internal coordinates of two conformers of the same species.</span>
<span class="sd">    The comparison could principally be done using all dihedrals, which is information this module readily has,</span>
<span class="sd">    but this function uses Z matrices instead for better robustness (this way rings are considered as well).</span>

<span class="sd">    Args:</span>
<span class="sd">        z1 (dict): Z matrix of conformer 1.</span>
<span class="sd">        z2 (dict): Z matrix of conformer 2.</span>
<span class="sd">        r_tol (float, optional): A tolerance for comparing distances (in Angstrom).</span>
<span class="sd">        a_tol (float, optional): A tolerance for comparing angles (in degrees).</span>
<span class="sd">        d_tol (float, optional): A tolerance for comparing dihedral angles (in degrees).</span>
<span class="sd">        verbose (bool, optional): Whether to print a reason for determining the zmats are different if they are,</span>
<span class="sd">                                  ``True`` to print.</span>
<span class="sd">        symmetric_torsions (dict, optional): Keys are tuples scan indices (0- or 1-indexed), values are internal</span>
<span class="sd">                                             rotation symmetry numbers (sigma). Conformers which only differ by an</span>
<span class="sd">                                             integer number of 360 degrees / sigma are considered identical.</span>
<span class="sd">        index (int, optional): Either ``0`` or ``1`` to specify the starting index in the keys of ``symmetric_torsions``</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: Whether the coordinates represent the same conformer within the given tolerance, ``True`` if they do.</span>

<span class="sd">    Raises:</span>
<span class="sd">        InputError: If ``xyz1`` and ``xyz2`` are of wrong type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># convert the keys of symmetric_torsions to 0-indexed torsion tuples</span>
    <span class="n">symmetric_torsions</span> <span class="o">=</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">([</span><span class="n">torsion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">index</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]):</span> <span class="n">sigma</span>
                          <span class="k">for</span> <span class="n">torsion</span><span class="p">,</span> <span class="n">sigma</span> <span class="ow">in</span> <span class="n">symmetric_torsions</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">if</span> <span class="n">symmetric_torsions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">[</span><span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;xyz1 and xyz2 must be dictionaries, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span><span class="si">}</span><span class="s1">, respectively&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">z1</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">z2</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">_compare_zmats</span><span class="p">(</span><span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">,</span> <span class="n">r_tol</span><span class="o">=</span><span class="n">r_tol</span><span class="p">,</span> <span class="n">a_tol</span><span class="o">=</span><span class="n">a_tol</span><span class="p">,</span> <span class="n">d_tol</span><span class="o">=</span><span class="n">d_tol</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                          <span class="n">symmetric_torsions</span><span class="o">=</span><span class="n">symmetric_torsions</span><span class="p">)</span></div>


<div class="viewcode-block" id="compare_confs"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.compare_confs">[docs]</a><span class="k">def</span> <span class="nf">compare_confs</span><span class="p">(</span><span class="n">xyz1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                  <span class="n">xyz2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                  <span class="n">rtol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                  <span class="n">atol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                  <span class="n">rmsd_score</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare two Cartesian coordinates representing conformers using distance matrices.</span>

<span class="sd">    The relative difference (``rtol`` * abs(value in xyz2)) and the absolute difference ``atol``</span>
<span class="sd">    are added together to compare against the absolute difference between (value in xyz1) and (value in xyz2).</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz1 (dict): Conformer 1.</span>
<span class="sd">        xyz2 (dict): Conformer 2.</span>
<span class="sd">        rtol (float): The relative tolerance parameter (see Notes).</span>
<span class="sd">        atol (float): The absolute tolerance parameter (see Notes).</span>
<span class="sd">        rmsd_score (bool): Whether to output a root-mean-square deviation score of the two distance matrices.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Union[float, bool]:</span>
<span class="sd">            - If ``rmsd_score`` is ``False`` (default): Whether the two conformers have almost equal atom distances.</span>
<span class="sd">              ``True`` if they do.</span>
<span class="sd">            - If ``rmsd_score`` is ``True``: The RMSD score of two distance matrices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xyz1</span><span class="p">,</span> <span class="n">xyz2</span> <span class="o">=</span> <span class="n">check_xyz_dict</span><span class="p">(</span><span class="n">xyz1</span><span class="p">),</span> <span class="n">check_xyz_dict</span><span class="p">(</span><span class="n">xyz2</span><span class="p">)</span>
    <span class="n">dmat1</span><span class="p">,</span> <span class="n">dmat2</span> <span class="o">=</span> <span class="n">xyz_to_dmat</span><span class="p">(</span><span class="n">xyz1</span><span class="p">),</span> <span class="n">xyz_to_dmat</span><span class="p">(</span><span class="n">xyz2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rmsd_score</span><span class="p">:</span>
        <span class="c1"># Distance matrix is symmetric, only need the upper triangular part to compute rmsd.</span>
        <span class="n">rmsd</span> <span class="o">=</span> <span class="n">calc_rmsd</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">dmat1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">dmat2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rmsd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">almost_equal_lists</span><span class="p">(</span><span class="n">dmat1</span><span class="p">,</span> <span class="n">dmat2</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">)</span></div>


<div class="viewcode-block" id="cluster_confs_by_rmsd"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.cluster_confs_by_rmsd">[docs]</a><span class="k">def</span> <span class="nf">cluster_confs_by_rmsd</span><span class="p">(</span><span class="n">xyzs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]],</span>
                          <span class="n">rmsd_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-2</span><span class="p">,</span>
                          <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cluster conformers with the same atom orders using RMSD of distance matrices.</span>
<span class="sd">    Works for both TS and non-TS conformers.</span>
<span class="sd">    Intended for finding structurally distinct conformers from a pool of conformers.</span>
<span class="sd">    Suitable scenario: Filter a pool of conformers with their geometry optimized at some level.</span>
<span class="sd">    Not suitable for clustering conformers (not optimized) that are sampling of a well or a saddle point</span>
<span class="sd">    (these conformers may have large difference in RMSE,</span>
<span class="sd">    but they really should be representing the same well or saddle point).</span>

<span class="sd">    Args:</span>
<span class="sd">        xyzs (Iterable): Conformers with the same atom orders.</span>
<span class="sd">        rmsd_threshold (float): The minimum RMSD to consider two conformers as distinct</span>
<span class="sd">                                (i.e., if rmsd &gt; rmsd_threshold, then two conformers are considered distinctive).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[Dict[str, tuple]]: Conformers with distinctive geometries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xyzs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">xyzs</span><span class="p">)</span>
    <span class="n">distinct_xyzs</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyzs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">xyzs</span><span class="p">:</span>
        <span class="n">rmsd_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">compare_confs</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">distinct_xyz</span><span class="p">,</span> <span class="n">rmsd_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">distinct_xyz</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">distinct_xyzs</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">rmsd</span> <span class="o">&gt;</span> <span class="n">rmsd_threshold</span> <span class="k">for</span> <span class="n">rmsd</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rmsd_list</span><span class="p">)]):</span>
            <span class="n">distinct_xyzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">distinct_xyzs</span><span class="p">)</span></div>


<div class="viewcode-block" id="ics_to_scan_constraints"><a class="viewcode-back" href="../../../api/converter.html#arc.species.converter.ics_to_scan_constraints">[docs]</a><span class="k">def</span> <span class="nf">ics_to_scan_constraints</span><span class="p">(</span><span class="n">ics</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                            <span class="n">software</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">,</span>
                            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper function for converting internal coordinate (ic) info</span>
<span class="sd">    into a str block which can be read as scan constraints by ESS.</span>

<span class="sd">    Args:</span>
<span class="sd">        ics (list): A list of internal coordinates (ic, stored as lists of atom indices).</span>
<span class="sd">        software (str, optional): The electronic structure software.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: A str block can be read as scan constraints by ESS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scan_trsh</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">ics</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">scan_trsh</span> <span class="o">+=</span> <span class="s1">&#39;B &#39;</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">scan_trsh</span> <span class="o">+=</span> <span class="s1">&#39;A &#39;</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">scan_trsh</span> <span class="o">+=</span> <span class="s1">&#39;D &#39;</span>
            <span class="n">scan_trsh</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">ic</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;F</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Given software </span><span class="si">{</span><span class="n">software</span><span class="si">}</span><span class="s1"> is not implemented &#39;</span>
                                  <span class="sa">f</span><span class="s1">&#39;for ics_to_scan_constraints().&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scan_trsh</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2024, Alon Grinberg Dana

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>