

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>arc.scheduler &mdash; ARC 1.1.0 Documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> ARC
          

          
          </a>

          
            
            
              <div class="version">
                1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running.html">Running ARC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced.html">Advanced Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../output.html">Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">ARCâ€™s API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools.html">Standalone tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../media.html">Media</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cite.html">How to cite ARC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../licence.html">Licence</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ARC</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>arc.scheduler</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for arc.scheduler</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A module for scheduling ARC jobs</span>
<span class="sd">Includes spawning, terminating, checking, and troubleshooting various jobs</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">arc.rmgdb</span> <span class="k">as</span> <span class="nn">rmgdb</span>
<span class="kn">from</span> <span class="nn">arc</span> <span class="kn">import</span> <span class="n">parser</span><span class="p">,</span> <span class="n">plotter</span>
<span class="kn">from</span> <span class="nn">arc.checks.common</span> <span class="kn">import</span> <span class="n">get_i_from_job_name</span><span class="p">,</span> <span class="n">sum_time_delta</span>
<span class="kn">from</span> <span class="nn">arc.checks.ts</span> <span class="kn">import</span> <span class="n">check_imaginary_frequencies</span><span class="p">,</span> <span class="n">check_ts</span><span class="p">,</span> <span class="n">check_irc_species_and_rxn</span>
<span class="kn">from</span> <span class="nn">arc.common</span> <span class="kn">import</span> <span class="p">(</span><span class="n">extremum_list</span><span class="p">,</span>
                        <span class="n">get_angle_in_180_range</span><span class="p">,</span>
                        <span class="n">get_logger</span><span class="p">,</span>
                        <span class="n">get_number_with_ordinal_indicator</span><span class="p">,</span>
                        <span class="n">is_angle_linear</span><span class="p">,</span>
                        <span class="n">read_yaml_file</span><span class="p">,</span>
                        <span class="n">safe_copy_file</span><span class="p">,</span>
                        <span class="n">save_yaml_file</span><span class="p">,</span>
                        <span class="n">sort_two_lists_by_the_first</span><span class="p">,</span>
                        <span class="n">torsions_to_scans</span><span class="p">,</span>
                        <span class="p">)</span>
<span class="kn">from</span> <span class="nn">arc.exceptions</span> <span class="kn">import</span> <span class="p">(</span><span class="n">InputError</span><span class="p">,</span>
                            <span class="n">SanitizationError</span><span class="p">,</span>
                            <span class="n">SchedulerError</span><span class="p">,</span>
                            <span class="n">SpeciesError</span><span class="p">,</span>
                            <span class="n">TrshError</span><span class="p">,</span>
                            <span class="p">)</span>
<span class="kn">from</span> <span class="nn">arc.imports</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">arc.job.adapters.common</span> <span class="kn">import</span> <span class="n">all_families_ts_adapters</span><span class="p">,</span> <span class="n">default_incore_adapters</span><span class="p">,</span> <span class="n">ts_adapters_by_rmg_family</span>
<span class="kn">from</span> <span class="nn">arc.job.factory</span> <span class="kn">import</span> <span class="n">job_factory</span>
<span class="kn">from</span> <span class="nn">arc.job.local</span> <span class="kn">import</span> <span class="n">check_running_jobs_ids</span>
<span class="kn">from</span> <span class="nn">arc.job.ssh</span> <span class="kn">import</span> <span class="n">SSHClient</span>
<span class="kn">from</span> <span class="nn">arc.job.trsh</span> <span class="kn">import</span> <span class="p">(</span><span class="n">scan_quality_check</span><span class="p">,</span>
                          <span class="n">trsh_conformer_isomorphism</span><span class="p">,</span>
                          <span class="n">trsh_ess_job</span><span class="p">,</span>
                          <span class="n">trsh_negative_freq</span><span class="p">,</span>
                          <span class="n">trsh_scan_job</span><span class="p">,</span>
                          <span class="p">)</span>
<span class="kn">from</span> <span class="nn">arc.level</span> <span class="kn">import</span> <span class="n">Level</span>
<span class="kn">from</span> <span class="nn">arc.species.species</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ARCSpecies</span><span class="p">,</span>
                                 <span class="n">are_coords_compliant_with_graph</span><span class="p">,</span>
                                 <span class="n">determine_rotor_symmetry</span><span class="p">,</span>
                                 <span class="n">TSGuess</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">arc.species.converter</span> <span class="kn">import</span> <span class="p">(</span><span class="n">check_isomorphism</span><span class="p">,</span>
                                   <span class="n">compare_confs</span><span class="p">,</span>
                                   <span class="n">molecules_from_xyz</span><span class="p">,</span>
                                   <span class="n">xyz_to_coords_list</span><span class="p">,</span>
                                   <span class="n">xyz_to_str</span><span class="p">,</span>
                                   <span class="p">)</span>
<span class="kn">from</span> <span class="nn">arc.species.vectors</span> <span class="kn">import</span> <span class="n">get_angle</span><span class="p">,</span> <span class="n">calculate_dihedral_angle</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">arc.job.adapter</span> <span class="kn">import</span> <span class="n">JobAdapter</span>
    <span class="kn">from</span> <span class="nn">arc.reaction</span> <span class="kn">import</span> <span class="n">ARCReaction</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>

<span class="n">LOWEST_MAJOR_TS_FREQ</span><span class="p">,</span> <span class="n">HIGHEST_MAJOR_TS_FREQ</span><span class="p">,</span> <span class="n">default_job_settings</span><span class="p">,</span> \
    <span class="n">default_job_types</span><span class="p">,</span> <span class="n">rotor_scan_resolution</span><span class="p">,</span> <span class="n">default_ts_adapters</span><span class="p">,</span> <span class="n">max_rotor_trsh</span> <span class="o">=</span> \
    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;LOWEST_MAJOR_TS_FREQ&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;HIGHEST_MAJOR_TS_FREQ&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;default_job_settings&#39;</span><span class="p">],</span> \
    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;default_job_types&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;rotor_scan_resolution&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ts_adapters&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;max_rotor_trsh&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="Scheduler"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler">[docs]</a><span class="k">class</span> <span class="nc">Scheduler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ARC&#39;s Scheduler class. Creates jobs, submits, checks status, troubleshoots.</span>
<span class="sd">    Each species in `species_list` has to have a unique label.</span>

<span class="sd">    Dictionary structures::</span>

<span class="sd">        job_dict = {label_1: {&#39;conformers&#39;: {0: Job1,</span>
<span class="sd">                                             1: Job2, ...},</span>
<span class="sd">                              &#39;tsg&#39;:        {0: Job1,</span>
<span class="sd">                                             1: Job2, ...},  # TS guesses</span>
<span class="sd">                              &#39;opt&#39;:        {job_name1: Job1,</span>
<span class="sd">                                             job_name2: Job2, ...},</span>
<span class="sd">                              &#39;sp&#39;:         {job_name1: Job1,</span>
<span class="sd">                                             job_name2: Job2, ...},</span>
<span class="sd">                              &#39;freq&#39;:       {job_name1: Job1,</span>
<span class="sd">                                             job_name2: Job2, ...},</span>
<span class="sd">                              &#39;composite&#39;:  {job_name1: Job1,</span>
<span class="sd">                                             job_name2: Job2, ...},</span>
<span class="sd">                              &#39;scan&#39;:       {job_name1: Job1,</span>
<span class="sd">                                             job_name2: Job2, ...},</span>
<span class="sd">                              &lt;job_type&gt;:   {job_name1: Job1,</span>
<span class="sd">                                             job_name2: Job2, ...},</span>
<span class="sd">                              ...</span>
<span class="sd">                              }</span>
<span class="sd">                    label_2: {...},</span>
<span class="sd">                    }</span>

<span class="sd">        output = {label_1: {&#39;job_types&#39;: {job_type1: &lt;status1&gt;,  # boolean</span>
<span class="sd">                                          job_type2: &lt;status2&gt;,</span>
<span class="sd">                                         },</span>
<span class="sd">                            &#39;paths&#39;: {&#39;geo&#39;: &lt;path to geometry optimization output file&gt;,</span>
<span class="sd">                                      &#39;freq&#39;: &lt;path to freq output file&gt;,</span>
<span class="sd">                                      &#39;sp&#39;: &lt;path to sp output file&gt;,</span>
<span class="sd">                                      &#39;composite&#39;: &lt;path to composite output file&gt;,</span>
<span class="sd">                                      &#39;irc&#39;: [list of two IRC paths],</span>
<span class="sd">                                     },</span>
<span class="sd">                            &#39;conformers&#39;: &lt;comments&gt;,</span>
<span class="sd">                            &#39;isomorphism&#39;: &lt;comments&gt;,</span>
<span class="sd">                            &#39;convergence&#39;: &lt;status&gt;,  # Optional[bool]</span>
<span class="sd">                            &#39;restart&#39;: &lt;comments&gt;,</span>
<span class="sd">                            &#39;info&#39;: &lt;comments&gt;,</span>
<span class="sd">                            &#39;warnings&#39;: &lt;comments&gt;,</span>
<span class="sd">                            &#39;errors&#39;: &lt;comments&gt;,</span>
<span class="sd">                           },</span>
<span class="sd">                 label_2: {...},</span>
<span class="sd">                 }</span>

<span class="sd">    Note:</span>
<span class="sd">        The rotor scan dicts are located under Species.rotors_dict</span>

<span class="sd">    Args:</span>
<span class="sd">        project (str): The project&#39;s name. Used for naming the working directory.</span>
<span class="sd">        ess_settings (dict): A dictionary of available ESS and a corresponding server list.</span>
<span class="sd">        species_list (list): Contains input :ref:`ARCSpecies &lt;species&gt;` objects (both wells and TSs).</span>
<span class="sd">        rxn_list (list): Contains input :ref:`ARCReaction &lt;reaction&gt;` objects.</span>
<span class="sd">        project_directory (str): Folder path for the project: the input file path or ARC/Projects/project-name.</span>
<span class="sd">        composite_method (str, optional): A composite method to use.</span>
<span class="sd">        conformer_level (Union[str, dict], optional): The level of theory to use for conformer comparisons.</span>
<span class="sd">        opt_level (Union[str, dict], optional): The level of theory to use for geometry optimizations.</span>
<span class="sd">        freq_level (Union[str, dict], optional): The level of theory to use for frequency calculations.</span>
<span class="sd">        sp_level (Union[str, dict], optional): The level of theory to use for single point energy calculations.</span>
<span class="sd">        scan_level (Union[str, dict], optional): The level of theory to use for torsion scans.</span>
<span class="sd">        ts_guess_level (Union[str, dict], optional): The level of theory to use for TS guess comparisons.</span>
<span class="sd">        irc_level (Union[str, dict], optional): The level of theory to use for IRC calculations.</span>
<span class="sd">        orbitals_level (Union[str, dict], optional): The level of theory to use for calculating MOs (for plotting).</span>
<span class="sd">        adaptive_levels (dict, optional): A dictionary of levels of theory for ranges of the number of heavy atoms</span>
<span class="sd">                                          in the species. Keys are tuples of (min_num_atoms, max_num_atoms),</span>
<span class="sd">                                          values are dictionaries with job type tuples as keys and levels of theory</span>
<span class="sd">                                          as values. &#39;inf&#39; is accepted in max_num_atoms</span>
<span class="sd">        rmg_database (RMGDatabase, optional): The RMG database object.</span>
<span class="sd">        job_types (dict, optional): A dictionary of job types to execute. Keys are job types, values are boolean.</span>
<span class="sd">        bath_gas (str, optional): A bath gas. Currently used in OneDMin to calc L-J parameters.</span>
<span class="sd">                                  Allowed values are He, Ne, Ar, Kr, H2, N2, O2.</span>
<span class="sd">        restart_dict (dict, optional): A restart dictionary parsed from a YAML restart file.</span>
<span class="sd">        max_job_time (float, optional): The maximal allowed job time on the server in hours (can be fractional).</span>
<span class="sd">        allow_nonisomorphic_2d (bool, optional): Whether to optimize species even if they do not have a 3D conformer</span>
<span class="sd">                                                 that is isomorphic to the 2D graph representation.</span>
<span class="sd">        memory (float, optional): The total allocated job memory in GB (14 by default).</span>
<span class="sd">        testing (bool, optional): Used for internal ARC testing (generating the object w/o executing it).</span>
<span class="sd">        dont_gen_confs (list, optional): A list of species labels for which conformer jobs were loaded from a restart</span>
<span class="sd">                                         file, or user-requested. Additional conformer generation should be avoided.</span>
<span class="sd">        n_confs (int, optional): The number of lowest force field conformers to consider.</span>
<span class="sd">        e_confs (float, optional): The energy threshold in kJ/mol above the lowest energy conformer below which</span>
<span class="sd">                                   force field conformers are considered.</span>
<span class="sd">        fine_only (bool): If ``True`` ARC will not run optimization jobs without ``fine=True``.</span>
<span class="sd">        kinetics_adapter (str, optional): The statmech software to use for kinetic rate coefficient calculations.</span>
<span class="sd">        freq_scale_factor (float, optional): The harmonic frequencies scaling factor.</span>
<span class="sd">        trsh_ess_jobs (bool, optional): Whether to attempt troubleshooting failed ESS jobs. Default is ``True``.</span>
<span class="sd">        ts_adapters (list, optional): Entries represent different TS adapters.</span>
<span class="sd">        report_e_elect (bool, optional): Whether to report electronic energy. Default is ``False``.</span>
<span class="sd">        skip_nmd (bool, optional): Whether to skip normal mode displacement check. Default is ``False``.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        project (str): The project&#39;s name. Used for naming the working directory.</span>
<span class="sd">        servers (list): A list of servers used for the present project.</span>
<span class="sd">        species_list (list): Contains input :ref:`ARCSpecies &lt;species&gt;` objects (both species and TSs).</span>
<span class="sd">        species_dict (dict): Keys are labels, values are :ref:`ARCSpecies &lt;species&gt;` objects.</span>
<span class="sd">        rxn_list (list): Contains input :ref:`ARCReaction &lt;reaction&gt;` objects.</span>
<span class="sd">        unique_species_labels (list): A list of species labels (checked for duplicates).</span>
<span class="sd">        job_dict (dict): A dictionary of all scheduled jobs. Keys are species / TS labels,</span>
<span class="sd">                         values are dictionaries where keys are job names (corresponding to</span>
<span class="sd">                         &#39;running_jobs&#39; if job is running) and values are the Job objects.</span>
<span class="sd">        running_jobs (dict): A dictionary of currently running jobs (a subset of `job_dict`).</span>
<span class="sd">                             Keys are species/TS label, values are lists of job names (e.g. &#39;conformer3&#39;, &#39;opt_a123&#39;).</span>
<span class="sd">        server_job_ids (list): A list of relevant job IDs currently running on the server.</span>
<span class="sd">        output (dict): Output dictionary with status per job type and final QM file paths for all species.</span>
<span class="sd">        output_multi_spc (dict): Output dictionary with status per job type of multi-species clusters.</span>
<span class="sd">        ess_settings (dict): A dictionary of available ESS and a corresponding server list.</span>
<span class="sd">        restart_dict (dict): A restart dictionary parsed from a YAML restart file.</span>
<span class="sd">        project_directory (str): Folder path for the project: the input file path or ARC/Projects/project-name.</span>
<span class="sd">        save_restart (bool): Whether to start saving a restart file. ``True`` only after all species are loaded</span>
<span class="sd">                             (otherwise saves a partial file and may cause loss of information).</span>
<span class="sd">        restart_path (str): Path to the `restart.yml` file to be saved.</span>
<span class="sd">        max_job_time (float): The maximal allowed job time on the server in hours (can be fractional).</span>
<span class="sd">        testing (bool): Used for internal ARC testing (generating the object w/o executing it).</span>
<span class="sd">        rmg_database (RMGDatabase): The RMG database object.</span>
<span class="sd">        allow_nonisomorphic_2d (bool): Whether to optimize species even if they do not have a 3D conformer that is</span>
<span class="sd">                                       isomorphic to the 2D graph representation.</span>
<span class="sd">        dont_gen_confs (list): A list of species labels for which conformer jobs were loaded from a restart file,</span>
<span class="sd">                               or user-requested. Additional conformer generation should be avoided for them.</span>
<span class="sd">        memory (float): The total allocated job memory in GB (14 by default).</span>
<span class="sd">        n_confs (int): The number of lowest force field conformers to consider.</span>
<span class="sd">        e_confs (float): The energy threshold in kJ/mol above the lowest energy conformer below which</span>
<span class="sd">                         force field conformers are considered.</span>
<span class="sd">        job_types (dict): A dictionary of job types to execute. Keys are job types, values are boolean.</span>
<span class="sd">        bath_gas (str): A bath gas. Currently used in OneDMin to calc L-J parameters.</span>
<span class="sd">                        Allowed values are He, Ne, Ar, Kr, H2, N2, O2.</span>
<span class="sd">        composite_method (str): A composite method to use.</span>
<span class="sd">        conformer_level (dict): The level of theory to use for conformer comparisons.</span>
<span class="sd">        opt_level (dict): The level of theory to use for geometry optimizations.</span>
<span class="sd">        freq_level (dict): The level of theory to use for frequency calculations.</span>
<span class="sd">        sp_level (dict): The level of theory to use for single point energy calculations.</span>
<span class="sd">        scan_level (dict): The level of theory to use for torsion scans.</span>
<span class="sd">        ts_guess_level (dict): The level of theory to use for TS guess comparisons.</span>
<span class="sd">        irc_level (dict): The level of theory to use for IRC calculations.</span>
<span class="sd">        orbitals_level (dict): The level of theory to use for calculating MOs (for plotting).</span>
<span class="sd">        adaptive_levels (dict): A dictionary of levels of theory for ranges of the number of heavy atoms</span>
<span class="sd">                                in the species. Keys are tuples of (min_num_atoms, max_num_atoms),</span>
<span class="sd">                                values are dictionaries with job type tuples as keys and levels of theory</span>
<span class="sd">                                as values. &#39;inf&#39; is accepted in max_num_atoms</span>
<span class="sd">        rmg_database (RMGDatabase, optional): The RMG database object.</span>
<span class="sd">        fine_only (bool): If ``True`` ARC will not run optimization jobs without ``fine=True``.</span>
<span class="sd">        kinetics_adapter (str): The statmech software to use for kinetic rate coefficient calculations.</span>
<span class="sd">        freq_scale_factor (float): The harmonic frequencies scaling factor.</span>
<span class="sd">        trsh_ess_jobs (bool): Whether to attempt troubleshooting failed ESS jobs. Default is ``True``.</span>
<span class="sd">        ts_adapters (list): Entries represent different TS adapters.</span>
<span class="sd">        report_e_elect (bool): Whether to report electronic energy.</span>
<span class="sd">        skip_nmd (bool): Whether to skip normal mode displacement check.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">project</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">ess_settings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                 <span class="n">species_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                 <span class="n">project_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">composite_method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Level</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">conformer_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Level</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">opt_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Level</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">freq_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Level</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">sp_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Level</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">scan_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Level</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">ts_guess_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Level</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">irc_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Level</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">orbitals_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Level</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">adaptive_levels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">rmg_database</span><span class="p">:</span> <span class="n">Optional</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">job_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">rxn_list</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">bath_gas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">restart_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">max_job_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">allow_nonisomorphic_2d</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">testing</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">dont_gen_confs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">n_confs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                 <span class="n">e_confs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                 <span class="n">fine_only</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">trsh_ess_jobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">kinetics_adapter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;arkane&#39;</span><span class="p">,</span>
                 <span class="n">freq_scale_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">ts_adapters</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">report_e_elect</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">skip_nmd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span> <span class="o">=</span> <span class="n">ess_settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span> <span class="o">=</span> <span class="n">species_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span> <span class="o">=</span> <span class="n">project_directory</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rmg_database</span> <span class="o">=</span> <span class="n">rmg_database</span> <span class="ow">or</span> <span class="n">rmgdb</span><span class="o">.</span><span class="n">make_rmg_database_object</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span> <span class="o">=</span> <span class="n">restart_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rxn_list</span> <span class="o">=</span> <span class="n">rxn_list</span> <span class="k">if</span> <span class="n">rxn_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">=</span> <span class="n">max_job_time</span> <span class="ow">or</span> <span class="n">default_job_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;job_time_limit_hrs&#39;</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_job_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completed_incore_jobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span> <span class="o">=</span> <span class="n">allow_nonisomorphic_2d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testing</span> <span class="o">=</span> <span class="n">testing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span> <span class="ow">or</span> <span class="n">default_job_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;job_total_memory_gb&#39;</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span> <span class="o">=</span> <span class="n">bath_gas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span> <span class="o">=</span> <span class="n">adaptive_levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_confs</span> <span class="o">=</span> <span class="n">n_confs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_confs</span> <span class="o">=</span> <span class="n">e_confs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dont_gen_confs</span> <span class="o">=</span> <span class="n">dont_gen_confs</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span> <span class="o">=</span> <span class="n">job_types</span> <span class="k">if</span> <span class="n">job_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">default_job_types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fine_only</span> <span class="o">=</span> <span class="n">fine_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trsh_ess_jobs</span> <span class="o">=</span> <span class="n">trsh_ess_jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kinetics_adapter</span> <span class="o">=</span> <span class="n">kinetics_adapter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_scale_factor</span> <span class="o">=</span> <span class="n">freq_scale_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts_adapters</span> <span class="o">=</span> <span class="n">ts_adapters</span> <span class="k">if</span> <span class="n">ts_adapters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">default_ts_adapters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts_adapters</span> <span class="o">=</span> <span class="p">[</span><span class="n">ts_adapter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">ts_adapter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_adapters</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_multi_spc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_e_elect</span> <span class="o">=</span> <span class="n">report_e_elect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_nmd</span> <span class="o">=</span> <span class="n">skip_nmd</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span>
        <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rxn_dict</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">rxn</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_multi_spc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;output_multi_spc&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;output_multi_spc&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;running_jobs&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restore_running_jobs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_output_dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">restart_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;restart.yml&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># init time for reporting status every 1 hr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span> <span class="o">=</span> <span class="n">composite_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span> <span class="o">=</span> <span class="n">conformer_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts_guess_level</span> <span class="o">=</span> <span class="n">ts_guess_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span> <span class="o">=</span> <span class="n">opt_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_level</span> <span class="o">=</span> <span class="n">freq_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span> <span class="o">=</span> <span class="n">sp_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span> <span class="o">=</span> <span class="n">scan_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">irc_level</span> <span class="o">=</span> <span class="n">irc_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbitals_level</span> <span class="o">=</span> <span class="n">orbitals_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_restart</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rxn_list</span><span class="p">):</span>
            <span class="n">rxn_info_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_reaction_labels_info_file</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Loading RMG&#39;s families...&quot;</span><span class="p">)</span>
            <span class="n">rmgdb</span><span class="o">.</span><span class="n">load_families_only</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmg_database</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_list</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># 1. Update the ARCReaction object and generate an ARCSpecies object for its TS.</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">r_species</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">p_species</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reactants</span><span class="p">:</span>
                        <span class="n">rxn</span><span class="o">.</span><span class="n">r_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spc</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">products</span><span class="p">:</span>
                        <span class="n">rxn</span><span class="o">.</span><span class="n">p_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spc</span><span class="p">)</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction_from_arc_species</span><span class="p">()</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">check_attributes</span><span class="p">()</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">determine_family</span><span class="p">(</span><span class="n">rmg_database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rmg_database</span><span class="p">)</span>
                <span class="n">family_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">family</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">family_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;identified as belonging to RMG family </span><span class="si">{</span><span class="n">rxn</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Considering reaction: </span><span class="si">{</span><span class="n">rxn</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">family_text</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">family_text</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">display</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;TS</span><span class="si">{</span><span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">rxn</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">family_text</span><span class="p">:</span>
                        <span class="n">family_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">(</span><span class="si">{</span><span class="n">family_text</span><span class="si">}</span><span class="s1">)&#39;</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">family_text</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">))</span>
                <span class="c1"># 2. Create the TS Species object if needed.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span> <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">]):</span>
                    <span class="n">ts_species</span> <span class="o">=</span> <span class="n">ARCSpecies</span><span class="p">(</span>
                        <span class="n">is_ts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span><span class="p">,</span>
                        <span class="n">rxn_label</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                        <span class="n">rxn_index</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                        <span class="n">multiplicity</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                        <span class="n">charge</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
                        <span class="n">compute_thermo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">ts_number</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                        <span class="n">preserve_param_in_scan</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">preserve_param_in_scan</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">ts_species</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">reactant</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="k">for</span> <span class="n">reactant</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">r_species</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts_species</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">ts_species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts_species</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initialize_output_dict</span><span class="p">(</span><span class="n">ts_species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># The TS species was already loaded from a restart dict or an Arkane YAML file.</span>
                    <span class="n">ts_species</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span><span class="p">:</span>
                            <span class="n">ts_species</span> <span class="o">=</span> <span class="n">spc</span>
                            <span class="k">if</span> <span class="n">ts_species</span><span class="o">.</span><span class="n">rxn_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">ts_species</span><span class="o">.</span><span class="n">rxn_label</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">label</span>
                            <span class="k">if</span> <span class="n">ts_species</span><span class="o">.</span><span class="n">rxn_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">ts_species</span><span class="o">.</span><span class="n">rxn_index</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">index</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="n">ts_species</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not identify a TS species for </span><span class="si">{</span><span class="n">rxn</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">ts_species</span> <span class="o">=</span> <span class="n">ts_species</span>
                <span class="c1"># 3. Generate TSGuess objects for all methods, start with the user guesses</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">user_guess</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_xyz_guess</span><span class="p">):</span>  <span class="c1"># This is a list of user guesses, could be empty.</span>
                    <span class="n">ts_species</span><span class="o">.</span><span class="n">ts_guesses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">TSGuess</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;user guess </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">xyz</span><span class="o">=</span><span class="n">user_guess</span><span class="p">,</span>
                                <span class="n">rmg_reaction</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction</span><span class="p">,</span>
                                <span class="n">index</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_species</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">),</span>
                                <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span>
                                <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">check_atom_balance</span><span class="p">()</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">check_done_opt_r_n_p</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">ARCSpecies</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SpeciesError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Each species in &#39;species_list&#39; must be an ARCSpecies object. &quot;</span>
                                   <span class="sa">f</span><span class="s2">&quot;Got type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">species</span><span class="p">)</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SpeciesError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Each species in &#39;species_list&#39; has to have a unique label. &quot;</span>
                                   <span class="sa">f</span><span class="s2">&quot;Label of species </span><span class="si">{</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2"> is not unique.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">species</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="c1"># we&#39;ll attempt to infer .mol for a TS after we attain xyz for it</span>
                <span class="c1"># for a non-TS, this attribute should already be set by this point</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Could not infer a 2D graph (a .mol species attribute); &#39;</span>
            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">multi_species</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">species</span><span class="o">.</span><span class="n">multi_species</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">multi_species</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_does_output_dict_contain_info</span><span class="p">()</span> <span class="ow">and</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;restart&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;Restarted ARC at </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s1">; &#39;</span>
            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">yml_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;rotors&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">species</span><span class="o">.</span><span class="n">number_of_rotors</span> <span class="ow">and</span> <span class="n">species</span><span class="o">.</span><span class="n">rotors_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># if species.rotors_dict is None, it means the species is marked to not spawn rotor scans</span>
                    <span class="n">species</span><span class="o">.</span><span class="n">determine_rotors</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">species</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># opt wasn&#39;t asked for, and it&#39;s not needed, declare it as converged</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">conformers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># conformers weren&#39;t asked for, assign initial_xyz</span>
                    <span class="n">species</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">conformers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">species</span><span class="o">.</span><span class="n">multi_species</span> <span class="k">else</span> <span class="n">species</span><span class="o">.</span><span class="n">multi_species</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;convergence&#39;</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">is_monoatomic</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> \
                            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]</span> \
                            <span class="ow">and</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> \
                            <span class="ow">and</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="c1"># No need to run opt/freq jobs for a monoatomic species, only run sp (or composite if relevant)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;onedmin&#39;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_onedmin_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">species</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_freq_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;rotors&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_scan_jobs</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

                <span class="k">elif</span> <span class="p">((</span><span class="n">species</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">species</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">species</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="n">species</span><span class="o">.</span><span class="n">rxn_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
                    <span class="c1"># For restarting purposes: check before running jobs whether they were already terminated</span>
                    <span class="c1"># (check self.output) or whether they are &quot;currently running&quot; (check self.job_dict)</span>
                    <span class="c1"># This section takes care of restarting a Species (including a TS), but does not</span>
                    <span class="c1"># deal with conformers nor with ts_guesses</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                        <span class="c1"># composite-related restart</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]</span> \
                                <span class="ow">and</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>\
                                <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]):</span>
                            <span class="c1"># doing composite; composite hasn&#39;t finished and is not running; spawn composite</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> \
                                <span class="ow">and</span> <span class="n">species</span><span class="o">.</span><span class="n">irc_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># composite is done; do other jobs</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> \
                                    <span class="ow">and</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> \
                                    <span class="ow">and</span> <span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">or</span> <span class="n">species</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_freq_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;rotors&#39;</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_scan_jobs</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># non-composite-related restart</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;opt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;fine&#39;</span><span class="p">])</span> <span class="ow">or</span> \
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;fine&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                                 <span class="ow">and</span> <span class="s1">&#39;fine&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                            <span class="c1"># opt/fine isn&#39;t running</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]:</span>
                                <span class="c1"># opt/fine hasn&#39;t finished (and isn&#39;t running), so run it</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_only</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> \
                                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> \
                                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span>\
                                <span class="ow">and</span> <span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">or</span> <span class="n">species</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_freq_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;rotors&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                                <span class="nb">any</span><span class="p">(</span><span class="n">spc</span><span class="o">.</span><span class="n">rotors_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                                    <span class="nb">any</span><span class="p">(</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;invalidation_reason&#39;</span><span class="p">]</span>
                                        <span class="k">for</span> <span class="n">rotor_dict</span> <span class="ow">in</span> <span class="n">spc</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                                    <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">):</span>
                            <span class="c1"># Additional restart-related checks are performed within run_scan_jobs().</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_scan_jobs</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Species is loaded from an Arkane YAML file (no need to execute any job)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;convergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;info&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;Loaded from an Arkane YAML file; &#39;</span>
                <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="c1"># This is a TS loaded from a YAML file</span>
                    <span class="n">species</span><span class="o">.</span><span class="n">ts_conf_spawned</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_restart</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schedule_jobs</span><span class="p">()</span>

<div class="viewcode-block" id="Scheduler.schedule_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.schedule_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The main job scheduling block</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">species</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">species</span><span class="o">.</span><span class="n">conformers</span> \
                    <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">species</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">]):</span>
                <span class="c1"># The species has no xyz, but has conformers and at least one of the conformers has energy.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">determine_most_stable_conformer</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_only</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_conformer_jobs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spawn_ts_jobs</span><span class="p">()</span>  <span class="c1"># If all reactants/products are already known (Arkane yml or restart), spawn TS searches.</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span> <span class="o">!=</span> <span class="p">{}:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;convergence&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="c1"># Skip unconverged species.</span>
                    <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                    <span class="k">continue</span>
                <span class="c1"># Look for completed jobs and decide what jobs to run next.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_server_job_ids</span><span class="p">()</span>  <span class="c1"># updates ``self.server_job_ids``</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_completed_incore_jobs</span><span class="p">()</span>  <span class="c1"># updates ``self.completed_incore_jobs``</span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">continue</span>
                <span class="n">job_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="n">job_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">get_i_from_job_name</span><span class="p">(</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_job_ids</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_incore_jobs</span><span class="p">):</span>
                            <span class="c1"># this is a completed conformer job</span>
                            <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                                <span class="n">troubleshooting_conformer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_conformer</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">troubleshooting_conformer</span><span class="p">:</span>
                                    <span class="k">break</span>
                            <span class="c1"># Just terminated a conformer job.</span>
                            <span class="c1"># Are there additional conformer jobs currently running for this species?</span>
                            <span class="k">for</span> <span class="n">spec_jobs</span> <span class="ow">in</span> <span class="n">job_list</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">in</span> <span class="n">spec_jobs</span> <span class="ow">and</span> <span class="n">spec_jobs</span> <span class="o">!=</span> <span class="n">job_name</span><span class="p">:</span>
                                    <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># All conformer jobs terminated.</span>
                                <span class="c1"># Check isomorphism and run opt on most stable conformer geometry.</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Conformer jobs for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> successfully terminated.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">determine_most_likely_ts_conformer</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">determine_most_stable_conformer</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>  <span class="c1"># also checks isomorphism</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="c1"># if initial_xyz is None, then we&#39;re probably troubleshooting conformers, don&#39;t opt</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_only</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="s1">&#39;tsg&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;tsg&#39;</span><span class="p">][</span><span class="n">get_i_from_job_name</span><span class="p">(</span><span class="n">job_name</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_job_ids</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_incore_jobs</span><span class="p">):</span>
                            <span class="c1"># This is a successfully completed tsg job. It may have resulted in several TSGuesses.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.yml&#39;</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
                                    <span class="n">rxn</span><span class="o">.</span><span class="n">ts_species</span><span class="o">.</span><span class="n">process_completed_tsg_queue_jobs</span><span class="p">(</span><span class="n">yml_path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
                            <span class="c1"># Just terminated a tsg job.</span>
                            <span class="c1"># Are there additional tsg jobs currently running for this species?</span>
                            <span class="k">for</span> <span class="n">spec_jobs</span> <span class="ow">in</span> <span class="n">job_list</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;tsg&#39;</span> <span class="ow">in</span> <span class="n">spec_jobs</span> <span class="ow">and</span> <span class="n">spec_jobs</span> <span class="o">!=</span> <span class="n">job_name</span><span class="p">:</span>
                                    <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># All tsg jobs terminated. Spawn confs.</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">TS guess jobs for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> successfully terminated.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_conformer_jobs</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                        <span class="c1"># val is &#39;opt1&#39;, &#39;opt2&#39;, etc., or &#39;optfreq1&#39;, optfreq2&#39;, etc.</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_job_ids</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_incore_jobs</span><span class="p">):</span>
                            <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                                <span class="n">multi_species</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">spc</span><span class="o">.</span><span class="n">multi_species</span> <span class="o">==</span> <span class="n">label</span> <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">multi_species</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">multi_species_path_dict</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">make_multi_species_output_file</span><span class="p">(</span><span class="n">species_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">,</span>
                                                                                                          <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> 
                                                                                                          <span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_xyz</span> <span class="ow">or</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_opt_geo</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">]:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">parse_opt_e_elect</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">spawn_post_opt_jobs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">multi_species</span><span class="p">:</span>
                                    <span class="n">plotter</span><span class="o">.</span><span class="n">delete_multi_species_output_file</span><span class="p">(</span><span class="n">species_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">,</span>
                                                                             <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> 
                                                                             <span class="n">multi_species_path_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_species_path_dict</span>
                                                                             <span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                        <span class="c1"># this is NOT an &#39;optfreq&#39; job</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_job_ids</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_incore_jobs</span><span class="p">):</span>
                            <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">check_freq_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_job_ids</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_incore_jobs</span><span class="p">):</span>
                            <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">check_sp_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_job_ids</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_incore_jobs</span><span class="p">):</span>
                            <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_composite_geo</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">spawn_post_opt_jobs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;directed_scan&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_job_ids</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_incore_jobs</span><span class="p">):</span>
                            <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">check_directed_scan_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                                <span class="k">if</span> <span class="s1">&#39;cont&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">directed_scan_type</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
                                    <span class="c1"># This is a continuous restricted optimization, spawn the next job in the scan.</span>
                                    <span class="n">xyz</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_xyz_from_file</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span> \
                                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s1">&#39;opt_xyz&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">job</span><span class="o">.</span><span class="n">opt_xyz</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">spawn_directed_scan_jobs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">rotor_index</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">)</span>
                            <span class="k">if</span> <span class="s1">&#39;brute_force&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">directed_scan_type</span><span class="p">:</span>
                                <span class="c1"># Just terminated a brute_force directed scan job.</span>
                                <span class="c1"># Are there additional jobs of the same type currently running for this species?</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;number_of_running_jobs&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;number_of_running_jobs&#39;</span><span class="p">]:</span>
                                    <span class="c1"># All brute force scan jobs for these pivots terminated.</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">All brute force directed scan jobs for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> between &#39;</span>
                                                <span class="sa">f</span><span class="s1">&#39;pivots </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="si">}</span><span class="s1"> successfully terminated.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">process_directed_scans</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">)</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;scan&#39;</span> <span class="ow">in</span> <span class="n">job_name</span> <span class="ow">and</span> <span class="s1">&#39;directed&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_job_ids</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_incore_jobs</span><span class="p">):</span>
                            <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">successful_server_termination</span> \
                                    <span class="ow">and</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">directed_scan_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">job</span><span class="o">.</span><span class="n">directed_scan_type</span> <span class="o">==</span> <span class="s1">&#39;ess&#39;</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">check_scan_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">successful_server_termination</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;errored&#39;</span><span class="p">:</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;irc&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;irc&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_job_ids</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_incore_jobs</span><span class="p">):</span>
                            <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">spawn_post_irc_jobs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;orbitals&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;orbitals&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_job_ids</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_incore_jobs</span><span class="p">):</span>
                            <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                                <span class="c1"># copy the orbitals file to the species / TS output folder</span>
                                <span class="n">folder_name</span> <span class="o">=</span> <span class="s1">&#39;rxns&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="k">else</span> <span class="s1">&#39;Species&#39;</span>
                                <span class="n">orbitals_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                                             <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;orbitals.fchk&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_orbitals_file</span><span class="p">):</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_orbitals_file</span><span class="p">,</span> <span class="n">orbitals_path</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="n">shutil</span><span class="o">.</span><span class="n">SameFileError</span><span class="p">:</span>
                                        <span class="k">pass</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;onedmin&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;onedmin&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_job_ids</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_incore_jobs</span><span class="p">):</span>
                            <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                                <span class="c1"># Copy the lennard_jones file to the species output folder (TS&#39;s don&#39;t have L-J data).</span>
                                <span class="n">lj_output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                                              <span class="s1">&#39;lennard_jones.dat&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_lj_file</span><span class="p">):</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_lj_file</span><span class="p">,</span> <span class="n">lj_output_path</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="n">shutil</span><span class="o">.</span><span class="n">SameFileError</span><span class="p">:</span>
                                        <span class="k">pass</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;onedmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">set_transport_data</span><span class="p">(</span>
                                        <span class="n">lj_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                                             <span class="s1">&#39;lennard_jones.dat&#39;</span><span class="p">),</span>
                                        <span class="n">opt_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">],</span> <span class="n">bath_gas</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">bath_gas</span><span class="p">,</span>
                                        <span class="n">opt_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_list</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_all_done</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                        <span class="c1"># Delete the label only if it represents an empty entry.</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_list</span><span class="p">):</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>  <span class="c1"># wait 30 sec before bugging the servers again.</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_time</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">3600</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Currently running jobs:</span><span class="se">\n</span><span class="si">{</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Generate a TS report:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_final_ts_guess_report</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.run_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">job_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">conformer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">cpu_cores</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">dihedral_increment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">dihedrals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">directed_scan_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">ess_trsh_methods</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">fine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">irc_direction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">job_adapter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">level_of_theory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Level</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">memory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">max_job_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">rotor_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">reactions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="s1">&#39;ARCReaction&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">queue</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">attempted_queues</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">scan_trsh</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">shift</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">trsh</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">torsions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">times_rerun</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">tsg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">xyz</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]]</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function for running (all) jobs.</span>

<span class="sd">        Args:</span>
<span class="sd">            job_type (str): The type of job to run.</span>
<span class="sd">            conformer (int, optional): Conformer number if optimizing conformers.</span>
<span class="sd">            cpu_cores (int, optional): The total number of cpu cores requested for a job.</span>
<span class="sd">            dihedral_increment (float, optional): The degrees increment to use when scanning dihedrals of TS guesses.</span>
<span class="sd">            dihedrals (list, optional): The dihedral angles of a directed scan job corresponding to ``torsions``.</span>
<span class="sd">            directed_scan_type (str, optional): The type of the directed scan.</span>
<span class="sd">            ess_trsh_methods (list, optional): A list of troubleshooting methods already tried out for ESS convergence.</span>
<span class="sd">            fine (bool, optional): Whether to run an optimization job with a fine grid. `True` to use fine.</span>
<span class="sd">            irc_direction (str, optional): The direction to run the IRC computation.</span>
<span class="sd">            job_adapter (str, optional): An ESS software to use.</span>
<span class="sd">            label (Union[str, List[str]], optional): The species label, or a list of labels in case of multispecies.</span>
<span class="sd">            level_of_theory (Level, optional): The level of theory to use.</span>
<span class="sd">            memory (int, optional): The total job allocated memory in GB.</span>
<span class="sd">            max_job_time (int, optional): The maximal allowed job time on the server in hours.</span>
<span class="sd">            rotor_index (int, optional): The 0-indexed rotor number (key) in the species.rotors_dict dictionary.</span>
<span class="sd">            reactions (List[ARCReaction], optional): Entries are ARCReaction instances, used for TS search methods.</span>
<span class="sd">            scan_trsh (str, optional): A troubleshooting method for rotor scans.</span>
<span class="sd">            shift (str, optional): A string representation alpha- and beta-spin orbitals shifts (molpro only).</span>
<span class="sd">            times_rerun (int, optional): Number of times this job was re-run with the same arguments (no trsh methods).</span>
<span class="sd">            torsions (List[List[int]], optional): The 0-indexed atom indices of the torsion(s).</span>
<span class="sd">            trsh (str, optional): A troubleshooting keyword to be used in input files.</span>
<span class="sd">            tsg (int, optional): TSGuess number if optimizing TS guesses.</span>
<span class="sd">            xyz (Union[dict, List[dict]], optional): The 3D coordinates for the species.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_job_time</span> <span class="o">=</span> <span class="n">max_job_time</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span>  <span class="c1"># if it&#39;s None, set to default</span>
        <span class="n">ess_trsh_methods</span> <span class="o">=</span> <span class="n">ess_trsh_methods</span> <span class="k">if</span> <span class="n">ess_trsh_methods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">species</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">species</span> <span class="o">=</span> <span class="p">[</span><span class="n">spc</span> <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span> <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">label</span><span class="p">]</span>
        <span class="n">run_multi_species</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">spc</span><span class="o">.</span><span class="n">multi_species</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="n">species</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span> <span class="k">if</span> <span class="n">memory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span>
        <span class="n">checkfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">checkfile</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">torsions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rotor_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">torsions</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;torsion&#39;</span><span class="p">]</span>
            <span class="n">torsions</span> <span class="o">=</span> <span class="p">[</span><span class="n">torsions</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">torsions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">torsions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">level_of_theory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_adaptive_level</span><span class="p">(</span><span class="n">original_level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span>
                                                            <span class="n">heavy_atoms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_heavy_atoms</span><span class="p">)</span>
        <span class="n">job_adapter</span> <span class="o">=</span> <span class="n">job_adapter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">job_adapter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">deduce_job_adapter</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">Level</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">),</span> <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;keyword&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;block&#39;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">if</span> <span class="n">trsh</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trsh</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;trsh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;trsh&#39;</span><span class="p">:</span> <span class="n">trsh</span><span class="p">}</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trsh</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;trsh&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">trsh</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;trsh&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;trsh&#39;</span><span class="p">]:</span>
                        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;trsh&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;trsh&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;trsh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trsh</span>
        <span class="k">if</span> <span class="n">shift</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span>
        <span class="k">if</span> <span class="n">scan_trsh</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">][</span><span class="s1">&#39;scan_trsh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan_trsh</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">Level</span><span class="p">)</span> <span class="ow">and</span> <span class="n">level_of_theory</span><span class="o">.</span><span class="n">args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">level_of_theory</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

        <span class="n">job</span> <span class="o">=</span> <span class="n">job_factory</span><span class="p">(</span><span class="n">job_adapter</span><span class="o">=</span><span class="n">job_adapter</span><span class="p">,</span>
                          <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                          <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span>
                          <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span>
                          <span class="n">level</span><span class="o">=</span><span class="n">Level</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">)</span> <span class="k">if</span> <span class="n">level_of_theory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                          <span class="n">bath_gas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span><span class="p">,</span>
                          <span class="n">checkfile</span><span class="o">=</span><span class="n">checkfile</span><span class="p">,</span>
                          <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">,</span>
                          <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">cpu_cores</span><span class="o">=</span><span class="n">cpu_cores</span><span class="p">,</span>
                          <span class="n">dihedral_increment</span><span class="o">=</span><span class="n">dihedral_increment</span><span class="p">,</span>
                          <span class="n">dihedrals</span><span class="o">=</span><span class="n">dihedrals</span><span class="p">,</span>
                          <span class="n">directed_scan_type</span><span class="o">=</span><span class="n">directed_scan_type</span><span class="p">,</span>
                          <span class="n">ess_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">,</span>
                          <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                          <span class="n">execution_type</span><span class="o">=</span><span class="s1">&#39;incore&#39;</span> <span class="k">if</span> <span class="n">job_adapter</span> <span class="ow">in</span> <span class="n">default_incore_adapters</span> <span class="k">else</span> <span class="s1">&#39;queue&#39;</span><span class="p">,</span>
                          <span class="n">fine</span><span class="o">=</span><span class="n">fine</span><span class="p">,</span>
                          <span class="n">irc_direction</span><span class="o">=</span><span class="n">irc_direction</span><span class="p">,</span>
                          <span class="n">job_memory_gb</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
                          <span class="n">max_job_time</span><span class="o">=</span><span class="n">max_job_time</span><span class="p">,</span>
                          <span class="n">reactions</span><span class="o">=</span><span class="p">[</span><span class="n">reactions</span><span class="p">]</span> <span class="k">if</span> <span class="n">reactions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reactions</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">reactions</span><span class="p">,</span>
                          <span class="n">rotor_index</span><span class="o">=</span><span class="n">rotor_index</span><span class="p">,</span>
                          <span class="n">server_nodes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span> <span class="k">if</span> <span class="n">queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="n">attempted_queues</span><span class="o">=</span><span class="n">attempted_queues</span> <span class="k">if</span> <span class="n">attempted_queues</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(),</span>
                          <span class="n">species</span><span class="o">=</span><span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="k">if</span> <span class="n">species</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">species</span><span class="p">,</span>
                          <span class="n">times_rerun</span><span class="o">=</span><span class="n">times_rerun</span><span class="p">,</span>
                          <span class="n">torsions</span><span class="o">=</span><span class="n">torsions</span><span class="p">,</span>
                          <span class="n">tsg</span><span class="o">=</span><span class="n">tsg</span><span class="p">,</span>
                          <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span>
                          <span class="n">run_multi_species</span><span class="o">=</span><span class="n">run_multi_species</span><span class="p">,</span>
                          <span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">label</span> <span class="ow">or</span> <span class="n">reactions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ts_species</span><span class="o">.</span><span class="n">label</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span> <span class="k">if</span> <span class="n">run_multi_species</span> <span class="k">else</span> <span class="n">label</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">conformer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tsg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># this is NOT a conformer DFT job nor a TS guess job</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>  <span class="c1"># mark as a running job</span>
            <span class="k">if</span> <span class="n">job_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># Jobs of this type haven&#39;t been spawned for label</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">job_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">job_type</span><span class="p">][</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span>
        <span class="k">elif</span> <span class="n">conformer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Running a conformer DFT job. Append differently to job_dict.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;conformer</span><span class="si">{</span><span class="n">conformer</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># mark as a running job</span>
            <span class="k">if</span> <span class="s1">&#39;conformers&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="n">conformer</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span>  <span class="c1"># save job object</span>
        <span class="k">elif</span> <span class="n">tsg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Running a TS guess job. Append differently to job_dict.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tsg</span><span class="si">{</span><span class="n">tsg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># mark as a running job</span>
            <span class="k">if</span> <span class="s1">&#39;tsg&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;tsg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;tsg&#39;</span><span class="p">][</span><span class="n">tsg</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span>  <span class="c1"># save job object</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">server</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">server</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.deduce_job_adapter"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.deduce_job_adapter">[docs]</a>    <span class="k">def</span> <span class="nf">deduce_job_adapter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="n">Level</span><span class="p">,</span> <span class="n">job_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deduce the job adapter (the software) to be used for jobs other than TS searches.</span>

<span class="sd">        Args:</span>
<span class="sd">            level (Level): The level of theory that will be used for the job.</span>
<span class="sd">            job_type (str): The job&#39;s type.</span>

<span class="sd">        Returns: str</span>
<span class="sd">            The deduced job adapter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">level</span><span class="o">.</span><span class="n">deduce_software</span><span class="p">(</span><span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">level</span><span class="o">.</span><span class="n">software</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_adapter</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">software</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine software for job type </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using level_of_theory: </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">available_ess</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">in</span> <span class="n">available_ess</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Setting it to Gaussian&#39;</span><span class="p">)</span>
                <span class="n">level</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;qchem&#39;</span> <span class="ow">in</span> <span class="n">available_ess</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Setting it to QChem&#39;</span><span class="p">)</span>
                <span class="n">level</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;qchem&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;orca&#39;</span> <span class="ow">in</span> <span class="n">available_ess</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Setting it to Orca&#39;</span><span class="p">)</span>
                <span class="n">level</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;orca&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;molpro&#39;</span> <span class="ow">in</span> <span class="n">available_ess</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Setting it to Molpro&#39;</span><span class="p">)</span>
                <span class="n">level</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;molpro&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;terachem&#39;</span> <span class="ow">in</span> <span class="n">available_ess</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Setting it to TeraChem&#39;</span><span class="p">)</span>
                <span class="n">level</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;terachem&#39;</span>
            <span class="n">job_adapter</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">software</span>
        <span class="k">return</span> <span class="n">job_adapter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.end_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.end_job">[docs]</a>    <span class="k">def</span> <span class="nf">end_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;JobAdapter&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">job_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function for checking job status, saving in csv file, and downloading output files if needed.</span>

<span class="sd">        Args:</span>
<span class="sd">            job (JobAdapter): The job object.</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job_name (str): The job name from the running_jobs dict.</span>

<span class="sd">        Returns:</span>
<span class="sd">             bool: ``True`` if job terminated successfully on the server, ``False`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;done&#39;</span> <span class="ow">or</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">determine_job_status</span><span class="p">()</span>  <span class="c1"># Also downloads the output file.</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;orbitals&#39;</span><span class="p">]:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Tried to determine status of job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1">, &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;but it seems like the job never ran. Re-running job.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_run_a_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">job_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;errored&#39;</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;memory&#39;</span><span class="p">]:</span>
            <span class="n">original_mem</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">job_memory_gb</span>
            <span class="k">if</span> <span class="s1">&#39;insufficient job memory&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">job</span><span class="o">.</span><span class="n">job_memory_gb</span> <span class="o">*=</span> <span class="mi">3</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> errored because of insufficient memory. &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;Was </span><span class="si">{</span><span class="n">original_mem</span><span class="si">}</span><span class="s1"> GB, rerunning job with </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_memory_gb</span><span class="si">}</span><span class="s1"> GB.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_a_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;memory requested is too high&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">used_mem</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="s1">&#39;used only&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">]:</span>
                    <span class="n">used_mem</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> errored because the requested memory is too high. &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;Was </span><span class="si">{</span><span class="n">original_mem</span><span class="si">}</span><span class="s1"> GB, rerunning job with </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_memory_gb</span><span class="si">}</span><span class="s1"> GB.&#39;</span><span class="p">)</span>
                <span class="n">job</span><span class="o">.</span><span class="n">job_memory_gb</span> <span class="o">=</span> <span class="n">used_mem</span> <span class="o">*</span> <span class="mf">4.5</span> <span class="k">if</span> <span class="n">used_mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">job</span><span class="o">.</span><span class="n">job_memory_gb</span> <span class="o">*</span> <span class="mf">0.5</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_a_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;errored&#39;</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;ServerTimeLimit&#39;</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> errored because of a server time limit. &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;Rerunning job with </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">*</span> <span class="mi">2</span><span class="si">}</span><span class="s1"> hours.&#39;</span><span class="p">)</span>
                <span class="n">job</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">*=</span> <span class="mi">2</span>
                <span class="n">run_again</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">troubleshoot_queue</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">run_again</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_run_a_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">job_name</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">execution_type</span> <span class="o">==</span> <span class="s1">&#39;incore&#39;</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">rename_output_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">execution_type</span> <span class="o">==</span> <span class="s1">&#39;incore&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;restart_due_to_file_not_found&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;errored&#39;</span>
                <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;errored&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> errored because for the second time ARC did not find the output &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;file path </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;orbitals&#39;</span><span class="p">]:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;restart_due_to_file_not_found&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Did not find the output file of job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> with path &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="si">}</span><span class="s1">. Maybe the job never ran. Re-running job.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_a_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">job_name</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;running&#39;</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;running&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">job_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">job</span><span class="o">.</span><span class="n">write_completed_job_to_csv_file</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Ending job </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> (run time: </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">run_time</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_adapter</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="s1">&#39;terachem&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;check.chk&#39;</span><span class="p">))</span> \
                    <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;optfreq&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">]:</span>
                <span class="n">check_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;check.chk&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">check_path</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s1">&#39;directed_scan&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_name</span> <span class="ow">and</span> <span class="s1">&#39;cont&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">directed_scan_type</span><span class="p">:</span>
                        <span class="n">folder_name</span> <span class="o">=</span> <span class="s1">&#39;rxns&#39;</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_ts</span> <span class="k">else</span> <span class="s1">&#39;Species&#39;</span>
                        <span class="n">r_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">species_label</span><span class="p">,</span> <span class="s1">&#39;rotors&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">r_path</span><span class="p">):</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">r_path</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">check_path</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r_path</span><span class="p">,</span> <span class="s1">&#39;directed_rotor_check.chk&#39;</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">checkfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r_path</span><span class="p">,</span> <span class="s1">&#39;directed_rotor_check.chk&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">checkfile</span> <span class="o">=</span> <span class="n">check_path</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;scan&#39;</span> <span class="ow">or</span> <span class="n">job</span><span class="o">.</span><span class="n">directed_scan_type</span> <span class="o">==</span> <span class="s1">&#39;ess&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">rotors_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">rotors_dict</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                        <span class="n">rotors_dict</span><span class="p">[</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_run_a_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;JobAdapter&#39;</span><span class="p">,</span>
                   <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">rerun</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                   <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function to run an ARC job (used internally).</span>

<span class="sd">        Args:</span>
<span class="sd">            job (JobAdapter): The job object.</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            rerun (bool optional): Whether this job is being re-run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">job_type</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_type</span><span class="p">,</span>
                     <span class="n">conformer</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">conformer</span><span class="p">,</span>
                     <span class="n">cpu_cores</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">cpu_cores</span><span class="p">,</span>
                     <span class="n">dihedrals</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">,</span>
                     <span class="n">directed_scan_type</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">directed_scan_type</span><span class="p">,</span>
                     <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                     <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span>
                     <span class="n">irc_direction</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">irc_direction</span><span class="p">,</span>
                     <span class="n">job_adapter</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_adapter</span><span class="p">,</span>
                     <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                     <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level</span><span class="p">,</span>
                     <span class="n">memory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_memory_gb</span><span class="p">,</span>
                     <span class="n">max_job_time</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">max_job_time</span><span class="p">,</span>
                     <span class="n">rotor_index</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">,</span>
                     <span class="n">reactions</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">reactions</span><span class="p">,</span>
                     <span class="n">queue</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">queue</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">attempted_queues</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">attempted_queues</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">attempted_queues</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(),</span>
                     <span class="n">trsh</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;trsh&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;trsh&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">args</span> <span class="k">else</span> <span class="p">{},</span>
                     <span class="n">torsions</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">torsions</span><span class="p">,</span>
                     <span class="n">times_rerun</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">times_rerun</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">rerun</span><span class="p">),</span>
                     <span class="n">tsg</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">tsg</span><span class="p">,</span>
                     <span class="n">xyz</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span>
                     <span class="p">)</span>

<div class="viewcode-block" id="Scheduler.run_conformer_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_conformer_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">run_conformer_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select the most stable conformer for each species using molecular dynamics (force fields) and subsequently</span>
<span class="sd">        spawning opt jobs at the conformer level of theory, usually a reasonable yet cheap DFT, e.g., b97d3/6-31+g(d,p).</span>
<span class="sd">        The resulting conformer is saved in a string format xyz in the Species initial_xyz attribute.</span>

<span class="sd">        Args:</span>
<span class="sd">            labels (list): Labels of specific species to run conformer jobs for.</span>
<span class="sd">                           If ``None``, conformer jobs will be spawned for all species in self.species_list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labels_to_consider</span> <span class="o">=</span> <span class="n">labels</span> <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">]</span>
        <span class="n">log_info_printed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels_to_consider</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">])</span> \
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">yml_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;convergence&#39;</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dont_gen_confs</span>
                         <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># This is not a TS, opt (/composite) did not converge nor is it running, and conformer energies were</span>
                <span class="c1"># not set. Also, either &#39;conformers&#39; are set to True in job_types (and it&#39;s not in dont_gen_confs),</span>
                <span class="c1"># or they are set to False (or it&#39;s in dont_gen_confs), but the species has no 3D information.</span>
                <span class="c1"># Generate conformers.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">log_info_printed</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Starting (non-TS) species conformational analysis...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">log_info_printed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">force_field</span> <span class="o">==</span> <span class="s1">&#39;cheap&#39;</span><span class="p">:</span>
                    <span class="c1"># Just embed in RDKit and use MMFF94s for opt and energies.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Run the combinatorial method w/o fitting a force field.</span>
                    <span class="n">n_confs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_confs</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">generate_conformers</span><span class="p">(</span>
                        <span class="n">n_confs</span><span class="o">=</span><span class="n">n_confs</span><span class="p">,</span>
                        <span class="n">e_confs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">e_confs</span><span class="p">,</span>
                        <span class="n">plot_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span>
                                               <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;conformers&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_conformers</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="c1"># TSs:</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> \
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">tsg_spawned</span> \
                    <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_conf_spawned</span> \
                    <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">tsg</span><span class="o">.</span><span class="n">success</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">])</span> \
                    <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="n">tsg</span><span class="o">.</span><span class="n">success</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">]):</span>
                <span class="c1"># This is a TS Species for which all TSGs were spawned, but conformers haven&#39;t been spawned,</span>
                <span class="c1"># and all tsg.success flags contain a values (either ``True`` or ``False``), so they are done.</span>
                <span class="c1"># We&#39;re ready to spawn conformer jobs for this TS Species</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_ts_conformer_jobs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_conf_spawned</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dont_gen_confs</span> \
                    <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                         <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                         <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">))</span> \
                    <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="c1"># The species was defined with xyzs.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_conformers</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_ts_conformer_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_ts_conformer_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">run_ts_conformer_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn opt jobs at the ts_guesses level of theory for the TS guesses.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The TS species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">cluster_tsgs</span><span class="p">()</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">save_conformers_file</span><span class="p">(</span>
            <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
            <span class="n">xyzs</span><span class="o">=</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">],</span>
            <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_guess_level</span><span class="p">,</span>
            <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
            <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
            <span class="n">is_ts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ts_methods</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tsg</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s1"> &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tsg</span><span class="o">.</span><span class="n">method_direction</span> <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">method_direction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1"> &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tsg</span><span class="o">.</span><span class="n">method_index</span> <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">method_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1"> &#39;</span>
                        <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">successful_tsgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tsg</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span> <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">success</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful_tsgs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">successful_tsgs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                             <span class="n">xyz</span><span class="o">=</span><span class="n">tsg</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">,</span>
                             <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_guess_level</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;conformers&#39;</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                             <span class="p">)</span>
                <span class="n">tsg</span><span class="o">.</span><span class="n">conformer_index</span> <span class="o">=</span> <span class="n">i</span>  <span class="c1"># Store the conformer index in the TSGuess object to match them later.</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful_tsgs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># proceed only if opt (/composite) not already spawned</span>
                <span class="n">rxn</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rxn</span> <span class="o">=</span> <span class="s1">&#39; of reaction &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Only one TS guess is available for species </span><span class="si">{</span><span class="n">label</span><span class="si">}{</span><span class="n">rxn</span><span class="si">}</span><span class="s1">, &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;using it for geometry optimization&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Set relative energy to 0, no other guesses.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">successful_tsgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol_from_xyz</span><span class="p">(</span><span class="n">get_cheap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_only</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">method</span></div>

<div class="viewcode-block" id="Scheduler.run_opt_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_opt_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_opt_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fine</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a geometry optimization job. The initial guess is taken from the `initial_xyz` attribute.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            fine (bool): Whether a fine grid should be used during optimization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># Check whether opt jobs have been spawned yet.</span>
            <span class="c1"># we&#39;re spawning the first opt job for this species</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> \
                                               <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SpeciesError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot execute opt job for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> without xyz (got None for Species.initial_xyz)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;fine&#39;</span> <span class="k">if</span> <span class="n">fine</span> <span class="k">else</span> <span class="s1">&#39;opt&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_multi_spc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_multi_spc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span>
                     <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">multi_species</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> 
                     <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span><span class="p">,</span>
                     <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;opt&#39;</span><span class="p">,</span> 
                     <span class="n">fine</span><span class="o">=</span><span class="n">fine</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_composite_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_composite_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_composite_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a composite job (e.g., CBS-QB3) using &#39;final_xyz&#39; for species ot TS &#39;label&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot run </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> as a composite method without specifying a method.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># Check whether composite jobs have been spawned yet.</span>
            <span class="c1"># We&#39;re spawning the first composite job for this species.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_multi_spc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;composite&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_multi_spc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span>
                     <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">multi_species</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;composite&#39;</span><span class="p">,</span>
                     <span class="n">fine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;fine&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Scheduler.run_freq_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_freq_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_freq_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a freq job using &#39;final_xyz&#39; for species ot TS &#39;label&#39;.</span>
<span class="sd">        If this was originally a composite job, run an appropriate separate freq job outputting the Hessian.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># Check whether freq jobs have been spawned yet.</span>
            <span class="c1"># We&#39;re spawning the first freq job for this species.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_multi_spc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_multi_spc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span>
                     <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">multi_species</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                         <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_level</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;freq&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_sp_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_sp_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_sp_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Level</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a single point job using &#39;final_xyz&#39; for species ot TS &#39;label&#39;.</span>
<span class="sd">        If the method is MRCI, first spawn a simple CCSD job, and use orbital determination to run the MRCI job.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            level (Level): An alternative level of theory to run at. If ``None``, self.sp_level will be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">level</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span>

        <span class="c1"># determine_occ(xyz=self.xyz, charge=self.charge)</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span> \
                <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">level</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;xtb&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="s1">&#39;paths&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;geo&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span> \
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not running an sp job for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> at </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s1"> since the optimization was done at the &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;same level of theory. Using the optimization output to parse the sp energy.&#39;</span><span class="p">)</span>
            <span class="n">recent_opt_job_name</span><span class="p">,</span> <span class="n">recent_opt_job</span> <span class="o">=</span> <span class="s1">&#39;opt_a0&#39;</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">opt_job_name</span><span class="p">,</span> <span class="n">opt_job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">opt_job_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_a&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">recent_opt_job_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_a&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">recent_opt_job_name</span><span class="p">,</span> <span class="n">recent_opt_job</span> <span class="o">=</span> <span class="n">opt_job_name</span><span class="p">,</span> <span class="n">opt_job</span>
                <span class="k">if</span> <span class="n">recent_opt_job</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">recent_opt_job</span><span class="o">.</span><span class="n">rename_output_file</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_sp_actions</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                     <span class="n">sp_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">recent_opt_job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">),</span>
                                     <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                                     <span class="p">)</span>

            <span class="c1"># If opt is not in the job dictionary, the likely explanation is this job has been restarted</span>
            <span class="k">elif</span> <span class="s1">&#39;geo&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">]:</span>  <span class="c1"># Then just use this path directly</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_sp_actions</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                     <span class="n">sp_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">],</span>
                                     <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                                     <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unable to set the path for the sp job for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">return</span>
        <span class="k">if</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># Check whether single-point energy jobs have been spawned yet.</span>
            <span class="c1"># We&#39;re spawning the first sp job for this species.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;run_sp_job() was called for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> which has a composite method level of theory&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;mrci&#39;</span> <span class="ow">in</span> <span class="n">level</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]:</span>
                <span class="c1"># Parse orbital information from the CCSD job, then run MRCI</span>
                <span class="n">job0</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">job_name_0</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_a&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">job_name_0</span><span class="p">:</span>
                        <span class="n">job_name_0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_a&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">job0</span> <span class="o">=</span> <span class="n">job</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">job0</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                    <span class="n">core</span> <span class="o">=</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;NUMBER OF CORE ORBITALS&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">core</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="s1">&#39;NUMBER OF VALENCE ORBITALS&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">val</span> <span class="o">*</span> <span class="n">core</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine number of core and valence orbitals from CCSD &#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39;sp calculation for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">occ</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="n">core</span>  <span class="c1"># the occupied orbitals are the core and valence orbitals</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                             <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                             <span class="n">level_of_theory</span><span class="o">=</span><span class="s1">&#39;ccsd/vdz&#39;</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;sp&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># MRCI was requested but no sp job ran for this species, run CCSD first</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;running a CCSD job for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> before MRCI&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                             <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                             <span class="n">level_of_theory</span><span class="o">=</span><span class="s1">&#39;ccsd/vdz&#39;</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;sp&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_multi_spc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sp&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="k">return</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_multi_spc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span>
                         <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">multi_species</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                         <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                         <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                         <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;sp&#39;</span><span class="p">,</span>
                         <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_scan_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_scan_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">run_scan_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn rotor scan jobs using &#39;final_xyz&#39; for species (or TS).</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;rotors&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rotor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="c1"># Since this function is relevant for in multiple cases, all cases are listed for debugging</span>
                <span class="c1"># [have not started] success = None, and scan_path = &#39;&#39;</span>
                <span class="c1"># [first time calculating] success = None, and scan_path = &#39;&#39;</span>
                <span class="c1"># [converged, good] success = True, and scan_path is file</span>
                <span class="c1"># [converged, invalidated] success = False, and scan_path is file</span>
                <span class="c1"># [previous converged, troubleshooting] success = None, and scan_path (previous scan) is file</span>
                <span class="c1"># [previous converged, lower conformer] success = None, and scan_path (previous scan) is file</span>
                <span class="c1"># [not a torsion] success = False, and scan_path = &#39;&#39;</span>
                <span class="k">if</span> <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]):</span>
                        <span class="c1"># For some reason the output file does not exist.</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="n">torsions</span> <span class="o">=</span> <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;torsion&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">torsions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="c1"># Check that a 1D rotor is not linear.</span>
                    <span class="n">coords</span> <span class="o">=</span> <span class="n">xyz_to_coords_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">())</span>
                    <span class="n">v1</span> <span class="o">=</span> <span class="p">[</span><span class="n">c1</span> <span class="o">-</span> <span class="n">c2</span> <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">torsions</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">coords</span><span class="p">[</span><span class="n">torsions</span><span class="p">[</span><span class="mi">1</span><span class="p">]])]</span>
                    <span class="n">v2</span> <span class="o">=</span> <span class="p">[</span><span class="n">c2</span> <span class="o">-</span> <span class="n">c1</span> <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">torsions</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">coords</span><span class="p">[</span><span class="n">torsions</span><span class="p">[</span><span class="mi">2</span><span class="p">]])]</span>
                    <span class="n">v3</span> <span class="o">=</span> <span class="p">[</span><span class="n">c1</span> <span class="o">-</span> <span class="n">c2</span> <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">torsions</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">coords</span><span class="p">[</span><span class="n">torsions</span><span class="p">[</span><span class="mi">3</span><span class="p">]])]</span>
                    <span class="n">angle1</span><span class="p">,</span> <span class="n">angle2</span> <span class="o">=</span> <span class="n">get_angle</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;degs&#39;</span><span class="p">),</span> <span class="n">get_angle</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;degs&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">is_angle_linear</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span> <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="p">[</span><span class="n">angle1</span><span class="p">,</span> <span class="n">angle2</span><span class="p">]]):</span>
                        <span class="c1"># This is not a torsional mode, invalidate rotor.</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;invalidation_reason&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="sa">f</span><span class="s1">&#39;not a torsional mode (angles = </span><span class="si">{</span><span class="n">angle1</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">angle2</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> degrees)&#39;</span>
                        <span class="k">continue</span>
                <span class="n">directed_scan_type</span> <span class="o">=</span> <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;directed_scan_type&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;directed_scan_type&#39;</span> <span class="ow">in</span> <span class="n">rotor</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

                <span class="k">if</span> <span class="n">directed_scan_type</span> <span class="o">!=</span> <span class="s1">&#39;ess&#39;</span><span class="p">:</span>
                    <span class="c1"># This is a directed scan.</span>
                    <span class="c1"># Check that this job isn&#39;t already running on the server (from a restarted project).</span>
                    <span class="k">if</span> <span class="s1">&#39;directed_scan&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="c1"># We&#39;re spawning the first brute force scan jobs for this species.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="c1"># Check that this job isn&#39;t already running on the server (from a restarted project).</span>
                    <span class="k">for</span> <span class="n">directed_scan_job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">directed_scan_job</span><span class="o">.</span><span class="n">torsions</span> <span class="o">==</span> <span class="n">torsions</span> \
                                <span class="ow">and</span> <span class="n">directed_scan_job</span><span class="o">.</span><span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;cont&#39;</span> <span class="ow">in</span> <span class="n">directed_scan_type</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">directed_pivots</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">directed_pivots</span> <span class="o">==</span> <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span> \
                                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">][</span><span class="n">directed_pivots</span><span class="p">]:</span>
                                    <span class="c1"># The previous job hasn&#39;t finished.</span>
                                    <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">spawn_directed_scan_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">rotor_index</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">spawn_directed_scan_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">rotor_index</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># This is a &quot;normal&quot; scan (not directed).</span>
                    <span class="c1"># Check that this job isn&#39;t already running on the server (from a restarted project).</span>
                    <span class="k">if</span> <span class="s1">&#39;scan&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="c1"># We&#39;re spawning the first scan job for this species.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="c1"># Check that this job isn&#39;t already running on the server (from a restarted project).</span>
                    <span class="k">for</span> <span class="n">scan_job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">torsions</span> <span class="o">==</span> <span class="n">scan_job</span><span class="o">.</span><span class="n">torsions</span> <span class="ow">and</span> <span class="n">scan_job</span><span class="o">.</span><span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_multi_spc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scan&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                                <span class="k">return</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">output_multi_spc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span>
                                     <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">multi_species</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                     <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                     <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span><span class="p">,</span>
                                     <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;scan&#39;</span><span class="p">,</span>
                                     <span class="n">torsions</span><span class="o">=</span><span class="n">torsions</span><span class="p">,</span>
                                     <span class="n">rotor_index</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                                     <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_irc_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_irc_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_irc_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">irc_direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn an IRC job.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            irc_direction (str): The IRC job direction, either &#39;forward&#39; or &#39;reverse&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                     <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                     <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">irc_level</span><span class="p">,</span>
                     <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;irc&#39;</span><span class="p">,</span>
                     <span class="n">irc_direction</span><span class="o">=</span><span class="n">irc_direction</span><span class="p">,</span>
                     <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_orbitals_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_orbitals_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_orbitals_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn orbitals job used for molecular orbital visualization.</span>
<span class="sd">        Currently supporting QChem for printing the orbitals, the output could be visualized using IQMol.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                     <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                     <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitals_level</span><span class="p">,</span>
                     <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;orbitals&#39;</span><span class="p">,</span>
                     <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_onedmin_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_onedmin_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_onedmin_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a lennard-jones calculation using OneDMin.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;onedmin&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Cannot execute a Lennard Jones job without the OneDMin software&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;onedmin&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                         <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                         <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;onedmin&#39;</span><span class="p">,</span>
                         <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.spawn_post_opt_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.spawn_post_opt_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">spawn_post_opt_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">job_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn additional jobs after opt has converged.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job_name (str): The opt job name (used for differentiating between ``opt`` and ``optfreq`` jobs).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">composite</span> <span class="o">=</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">in</span> <span class="n">job_name</span>  <span class="c1"># Whether this was a composite job</span>

        <span class="c1"># Check whether this was originally a composite method that was troubleshooted as &#39;opt&#39;.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">composite</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Check whether this is a composite job but wasn&#39;t originally so (probably troubleshooted as such).</span>
        <span class="k">if</span> <span class="n">composite</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_only</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Spawn IRC if requested and if relevant.</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;irc&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_irc_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">irc_direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_irc_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">irc_direction</span><span class="o">=</span><span class="s1">&#39;reverse&#39;</span><span class="p">)</span>

        <span class="c1"># Spawn freq (or check it if this is a composite job) for polyatomic molecules.</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]:</span>
                <span class="c1"># This is either an opt or a composite job (not an optfreq job), spawn freq.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_freq_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;optfreq&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                <span class="c1"># This is an &#39;optfreq&#39; job type, don&#39;t spawn freq (but do check it).</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_freq_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;optfreq&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">])</span>

        <span class="c1"># Spawn sp after an opt (non-composite) job.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">composite</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="c1"># Perceive the Molecule from xyz.</span>
        <span class="c1"># Useful for TS species where xyz might not be given at the outset to perceive a .mol attribute.</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol_from_xyz</span><span class="p">()</span>

        <span class="c1"># Spawn scan jobs.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;rotors&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">determine_rotors</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_scan_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="c1"># Spawn post sp actions if this is a composite job.</span>
        <span class="k">if</span> <span class="n">composite</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_sp_actions</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                 <span class="n">sp_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>

        <span class="c1"># Spawn orbitals job.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;orbitals&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;orbitals&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_orbitals_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="c1"># Spawn onedmin job.</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;onedmin&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_onedmin_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="c1"># Spawn bde jobs.</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;bde&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">bdes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bde_species_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">scissors</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">bde_species</span> <span class="ow">in</span> <span class="n">bde_species_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bde_species</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
                    <span class="c1"># H was added in main.</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Creating the BDE species </span><span class="si">{</span><span class="n">bde_species</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1"> from the original species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bde_species</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">bde_species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">bde_species</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bde_species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initialize_output_dict</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">bde_species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">bde_species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">bde_species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">bde_species</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{</span><span class="n">bde_species</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1"> is monoatomic&#39;</span><span class="p">)</span>
                        <span class="c1"># No need to run opt/freq jobs for a monoatomic species, only run sp (or composite if relevant)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">bde_species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">bde_species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="c1"># determine the lowest energy conformation of radicals generated in BDE calculations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_conformer_jobs</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">bde_species_list</span>
                                            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Check whether any reaction was waiting for this species to spawn TS search jobs.</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spawn_ts_jobs</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.spawn_ts_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.spawn_ts_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">spawn_ts_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if any new reaction has all of its reactants and products optimized,</span>
<span class="sd">        and if so spawn the respective TSG jobs.</span>
<span class="sd">        Don&#39;t spawn TS jobs if the multiplicity of the reaction could not be determined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_list</span><span class="p">:</span>
            <span class="n">rxn</span><span class="o">.</span><span class="n">check_done_opt_r_n_p</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">done_opt_r_n_p</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_species</span><span class="o">.</span><span class="n">tsg_spawned</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">multiplicity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not spawning TS search jobs for reaction </span><span class="si">{</span><span class="n">rxn</span><span class="si">}</span><span class="s1"> for which the multiplicity is unknown.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rxn</span><span class="o">.</span><span class="n">ts_species</span><span class="o">.</span><span class="n">tsg_spawned</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tsg_index</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_adapters</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">all_families_ts_adapters</span> <span class="ow">or</span> \
                                <span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">family</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                 <span class="ow">and</span> <span class="n">rxn</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ts_adapters_by_rmg_family</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                                 <span class="ow">and</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">ts_adapters_by_rmg_family</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">label</span><span class="p">]):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;tsg&#39;</span><span class="p">,</span>
                                         <span class="n">job_adapter</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                         <span class="n">reactions</span><span class="o">=</span><span class="p">[</span><span class="n">rxn</span><span class="p">],</span>
                                         <span class="n">tsg</span><span class="o">=</span><span class="n">tsg_index</span><span class="p">,</span>
                                         <span class="p">)</span>
                            <span class="n">tsg_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="s1">&#39;user guess&#39;</span> <span class="ow">in</span> <span class="n">tsg</span><span class="o">.</span><span class="n">method</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_species</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">):</span>
                    <span class="n">rxn</span><span class="o">.</span><span class="n">ts_species</span><span class="o">.</span><span class="n">tsg_spawned</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_conformer_jobs</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span><span class="p">])</span></div>

<div class="viewcode-block" id="Scheduler.spawn_directed_scan_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.spawn_directed_scan_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">spawn_directed_scan_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                 <span class="n">rotor_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                 <span class="n">xyz</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn directed scan jobs.</span>
<span class="sd">        Directed scan types could be one of the following: &#39;brute_force_sp&#39;, &#39;brute_force_opt&#39;, &#39;cont_opt&#39;,</span>
<span class="sd">        &#39;brute_force_sp_diagonal&#39;, &#39;brute_force_opt_diagonal&#39;, or &#39;cont_opt_diagonal&#39;.</span>
<span class="sd">        Here we treat ``cont`` and ``brute_force`` separately, and also consider the ``diagonal`` keyword.</span>
<span class="sd">        The differentiation between ``sp`` and ``opt`` is done in the Job module.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            rotor_index (int): The 0-indexed rotor number (key) in the species.rotors_dict dictionary.</span>
<span class="sd">            xyz (str, optional): The 3D coordinates for a continuous directed scan.</span>

<span class="sd">        Raises:</span>
<span class="sd">            InputError: If the species directed scan type has an unexpected value,</span>
<span class="sd">                        or if ``xyz`` wasn&#39;t given for a cont_opt job.</span>
<span class="sd">            SchedulerError: If the rotor scan resolution as defined in settings.py is illegal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">increment</span> <span class="o">=</span> <span class="n">rotor_scan_resolution</span>
        <span class="k">if</span> <span class="nb">divmod</span><span class="p">(</span><span class="mi">360</span><span class="p">,</span> <span class="n">increment</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The directed scan got an illegal scan resolution of </span><span class="si">{</span><span class="n">increment</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">torsions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;torsion&#39;</span><span class="p">]</span>
        <span class="n">directed_scan_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;directed_scan_type&#39;</span><span class="p">]</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">xyz</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">generate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;cont&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">directed_scan_type</span> <span class="ow">and</span> <span class="s1">&#39;brute&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">directed_scan_type</span> <span class="ow">and</span> <span class="s1">&#39;ess&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">directed_scan_type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;directed_scan_type must be either continuous or brute force, got: </span><span class="si">{</span><span class="n">directed_scan_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;ess&#39;</span> <span class="ow">in</span> <span class="n">directed_scan_type</span><span class="p">:</span>
            <span class="c1"># Allow the ESS to control the scan.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                         <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span>
                         <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span><span class="p">,</span>
                         <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;scan&#39;</span><span class="p">,</span>
                         <span class="n">directed_scan_type</span><span class="o">=</span><span class="n">directed_scan_type</span><span class="p">,</span>
                         <span class="n">torsions</span><span class="o">=</span><span class="n">torsions</span><span class="p">,</span>
                         <span class="n">rotor_index</span><span class="o">=</span><span class="n">rotor_index</span><span class="p">,</span>
                         <span class="p">)</span>

        <span class="k">elif</span> <span class="s1">&#39;brute&#39;</span> <span class="ow">in</span> <span class="n">directed_scan_type</span><span class="p">:</span>
            <span class="c1"># spawn jobs all at once</span>
            <span class="n">dihedrals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">torsions</span><span class="p">:</span>
                <span class="n">original_dihedral</span> <span class="o">=</span> <span class="n">get_angle_in_180_range</span><span class="p">(</span><span class="n">calculate_dihedral_angle</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">],</span>
                                                                                    <span class="n">torsion</span><span class="o">=</span><span class="n">torsion</span><span class="p">,</span>
                                                                                    <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">dihedrals</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">torsion</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_angle_in_180_range</span><span class="p">(</span><span class="n">original_dihedral</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">increment</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                                             <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">360</span> <span class="o">/</span> <span class="n">increment</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">modified_xyz</span> <span class="o">=</span> <span class="n">xyz</span>
            <span class="k">if</span> <span class="s1">&#39;diagonal&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">directed_scan_type</span><span class="p">:</span>
                <span class="c1"># increment dihedrals one by one (resulting in an ND scan)</span>
                <span class="n">all_dihedral_combinations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">dihedrals</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">torsion</span><span class="p">)]</span> <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">torsions</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">dihedral_tuple</span> <span class="ow">in</span> <span class="n">all_dihedral_combinations</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">torsion</span><span class="p">,</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">torsions</span><span class="p">,</span> <span class="n">dihedral_tuple</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">set_dihedral</span><span class="p">(</span><span class="n">scan</span><span class="o">=</span><span class="n">torsion</span><span class="p">,</span>
                                                              <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                              <span class="n">deg_abs</span><span class="o">=</span><span class="n">dihedral</span><span class="p">,</span>
                                                              <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                              <span class="n">xyz</span><span class="o">=</span><span class="n">modified_xyz</span><span class="p">)</span>
                        <span class="n">modified_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;number_of_running_jobs&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                 <span class="n">xyz</span><span class="o">=</span><span class="n">modified_xyz</span><span class="p">,</span>
                                 <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span><span class="p">,</span>
                                 <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">,</span>
                                 <span class="n">directed_scan_type</span><span class="o">=</span><span class="n">directed_scan_type</span><span class="p">,</span>
                                 <span class="n">torsions</span><span class="o">=</span><span class="n">torsions</span><span class="p">,</span>
                                 <span class="n">dihedrals</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">dihedral_tuple</span><span class="p">),</span>
                                 <span class="n">rotor_index</span><span class="o">=</span><span class="n">rotor_index</span><span class="p">,</span>
                                 <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># increment all dihedrals at once (resulting in a unique 1D scan along several changing dimensions)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dihedrals</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">torsions</span><span class="p">[</span><span class="mi">0</span><span class="p">])])):</span>
                    <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">torsions</span><span class="p">:</span>
                        <span class="n">dihedral</span> <span class="o">=</span> <span class="n">dihedrals</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">torsion</span><span class="p">)][</span><span class="n">i</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">set_dihedral</span><span class="p">(</span><span class="n">scan</span><span class="o">=</span><span class="n">torsion</span><span class="p">,</span>
                                                              <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                              <span class="n">deg_abs</span><span class="o">=</span><span class="n">dihedral</span><span class="p">,</span>
                                                              <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                              <span class="n">xyz</span><span class="o">=</span><span class="n">modified_xyz</span><span class="p">)</span>
                        <span class="n">modified_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span>
                    <span class="n">dihedrals</span> <span class="o">=</span> <span class="p">[</span><span class="n">dihedrals</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">torsion</span><span class="p">)][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">torsions</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;number_of_running_jobs&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                 <span class="n">xyz</span><span class="o">=</span><span class="n">modified_xyz</span><span class="p">,</span>
                                 <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span><span class="p">,</span>
                                 <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">,</span>
                                 <span class="n">directed_scan_type</span><span class="o">=</span><span class="n">directed_scan_type</span><span class="p">,</span>
                                 <span class="n">torsions</span><span class="o">=</span><span class="n">torsions</span><span class="p">,</span>
                                 <span class="n">dihedrals</span><span class="o">=</span><span class="n">dihedrals</span><span class="p">,</span>
                                 <span class="n">rotor_index</span><span class="o">=</span><span class="n">rotor_index</span><span class="p">,</span>
                                 <span class="p">)</span>

        <span class="k">elif</span> <span class="s1">&#39;cont&#39;</span> <span class="ow">in</span> <span class="n">directed_scan_type</span><span class="p">:</span>
            <span class="c1"># spawn jobs one by one</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">torsions</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;original_dihedrals&#39;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;original_dihedrals&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">calculate_dihedral_angle</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">xyz</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">],</span> <span class="n">torsion</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span>
                     <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">]]</span>  <span class="c1"># stores as str for YAML</span>
            <span class="n">rotor_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">]</span>
            <span class="n">torsions</span> <span class="o">=</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;torsion&#39;</span><span class="p">]</span>
            <span class="n">max_num</span> <span class="o">=</span> <span class="mi">360</span> <span class="o">/</span> <span class="n">increment</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># dihedral angles per scan</span>
            <span class="n">original_dihedrals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;original_dihedrals&#39;</span><span class="p">]:</span>
                <span class="n">original_dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_angle_in_180_range</span><span class="p">(</span><span class="n">dihedral</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">]):</span>
                <span class="c1"># This is the first call for this cont_opt directed rotor, spawn the first job w/o changing dihedrals.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                             <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">,</span>
                             <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">,</span>
                             <span class="n">directed_scan_type</span><span class="o">=</span><span class="n">directed_scan_type</span><span class="p">,</span>
                             <span class="n">torsions</span><span class="o">=</span><span class="n">torsions</span><span class="p">,</span>
                             <span class="n">dihedrals</span><span class="o">=</span><span class="n">original_dihedrals</span><span class="p">,</span>
                             <span class="n">rotor_index</span><span class="o">=</span><span class="n">rotor_index</span><span class="p">,</span>
                             <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># this is NOT the first call for this cont_opt directed rotor, check that ``xyz`` was given.</span>
                <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># xyz is None only at the first time cont opt is spawned, where cont_index is [0, 0,... 0].</span>
                    <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;xyz argument must be given for a continuous scan job&#39;</span><span class="p">)</span>
                <span class="c1"># check whether this rotor is done</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># 0-indexed</span>
                    <span class="c1"># no more counters to increment, all done!</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Completed all jobs for the continuous directed rotor scan for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;between pivots </span><span class="si">{</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s2">&quot;pivots&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process_directed_scans</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">])</span>
                    <span class="k">return</span>

            <span class="n">modified_xyz</span> <span class="o">=</span> <span class="n">xyz</span>
            <span class="n">dihedrals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">original_dihedral</span><span class="p">,</span> <span class="n">torsion</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">original_dihedrals</span><span class="p">,</span> <span class="n">torsions</span><span class="p">)):</span>
                <span class="n">dihedral</span> <span class="o">=</span> <span class="n">original_dihedral</span> <span class="o">+</span> \
                           <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="n">increment</span>
                <span class="c1"># Change the original dihedral so we won&#39;t end up with two calcs for 180.0, but none for -180.0</span>
                <span class="c1"># (it only matters for plotting, the geometry is of course the same)</span>
                <span class="n">dihedral</span> <span class="o">=</span> <span class="n">get_angle_in_180_range</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)</span>
                <span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)</span>
                <span class="c1"># Only change the dihedrals in the xyz if this torsion corresponds to the current index,</span>
                <span class="c1"># or if this is a diagonal scan.</span>
                <span class="c1"># Species.set_dihedral() uses .final_xyz or the given xyz to modify the .initial_xyz</span>
                <span class="c1"># attribute to the desired dihedral.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">set_dihedral</span><span class="p">(</span><span class="n">scan</span><span class="o">=</span><span class="n">torsion</span><span class="p">,</span>
                                                      <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                      <span class="n">deg_abs</span><span class="o">=</span><span class="n">dihedral</span><span class="p">,</span>
                                                      <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                      <span class="n">xyz</span><span class="o">=</span><span class="n">modified_xyz</span><span class="p">)</span>
                <span class="n">modified_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                         <span class="n">xyz</span><span class="o">=</span><span class="n">modified_xyz</span><span class="p">,</span>
                         <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span><span class="p">,</span>
                         <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">,</span>
                         <span class="n">directed_scan_type</span><span class="o">=</span><span class="n">directed_scan_type</span><span class="p">,</span>
                         <span class="n">torsions</span><span class="o">=</span><span class="n">torsions</span><span class="p">,</span>
                         <span class="n">dihedrals</span><span class="o">=</span><span class="n">dihedrals</span><span class="p">,</span>
                         <span class="n">rotor_index</span><span class="o">=</span><span class="n">rotor_index</span><span class="p">,</span>
                         <span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;diagonal&#39;</span> <span class="ow">in</span> <span class="n">directed_scan_type</span><span class="p">:</span>
                <span class="c1"># increment ALL counters for a diagonal scan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">torsions</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># increment the counter sequentially (non-diagonal scan)</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">torsions</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_num</span> <span class="o">-</span> <span class="mi">1</span>
                          <span class="ow">and</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">torsions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;cont_indices&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Scheduler.process_directed_scans"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.process_directed_scans">[docs]</a>    <span class="k">def</span> <span class="nf">process_directed_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pivots</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process all directed rotors for a species and check the quality of the scan.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            pivots (Union[List[int], List[List[int]]]): The rotor pivots.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">rotor_dict_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">rotor_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_dict_index</span><span class="p">]</span>  <span class="c1"># avoid modifying the iterator</span>
            <span class="k">if</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pivots</span><span class="p">:</span>
                <span class="c1"># identified a directed scan (either continuous or brute force, they&#39;re treated the same here)</span>
                <span class="n">dihedrals</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)</span> <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="n">dihedral_string_tuple</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">dihedral_string_tuple</span> <span class="ow">in</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                <span class="n">sorted_dihedrals</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dihedrals</span><span class="p">)</span>
                <span class="n">min_energy</span> <span class="o">=</span> <span class="n">extremum_list</span><span class="p">([</span><span class="n">directed_scan_dihedral</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span>
                                            <span class="k">for</span> <span class="n">directed_scan_dihedral</span> <span class="ow">in</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
                                           <span class="n">return_min</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">trshed_points</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;directed_scan_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ess&#39;</span><span class="p">:</span>
                    <span class="c1"># parse the single output file</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_nd_scan_energies</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;scan_path&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;directed_scan_type&#39;</span><span class="p">:</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;directed_scan_type&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;scans&#39;</span><span class="p">:</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;directed_scan&#39;</span><span class="p">:</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">]}</span>
                    <span class="k">for</span> <span class="n">dihedral_list</span> <span class="ow">in</span> <span class="n">sorted_dihedrals</span><span class="p">:</span>
                        <span class="n">dihedrals_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dihedral</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="n">dihedral_list</span><span class="p">)</span>
                        <span class="n">dihedral_dict</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">][</span><span class="n">dihedrals_key</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">dihedral_dict</span><span class="p">[</span><span class="s1">&#39;trsh&#39;</span><span class="p">]:</span>
                            <span class="n">trshed_points</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">dihedral_dict</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">dihedral_dict</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">min_energy</span>  <span class="c1"># set 0 at the minimal energy</span>
                <span class="n">folder_name</span> <span class="o">=</span> <span class="s1">&#39;rxns&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="k">else</span> <span class="s1">&#39;Species&#39;</span>
                <span class="n">rotor_yaml_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;rotors&#39;</span><span class="p">,</span>
                                                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pivots</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s2">&quot;directed_scan_type&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">.yml&#39;</span><span class="p">)</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">save_nd_rotor_yaml</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">rotor_yaml_file_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_dict_index</span><span class="p">][</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotor_yaml_file_path</span>
                <span class="k">if</span> <span class="n">trshed_points</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Directed rotor scan for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> between pivots </span><span class="si">{</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s2">&quot;pivots&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;had </span><span class="si">{</span><span class="n">trshed_points</span><span class="si">}</span><span class="s1"> points that required optimization troubleshooting.&#39;</span><span class="p">)</span>
                <span class="n">rotor_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;rotors&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;scans&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">plotter</span><span class="o">.</span><span class="n">plot_1d_rotor_scan</span><span class="p">(</span>
                        <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">rotor_path</span><span class="p">,</span>
                        <span class="n">scan</span><span class="o">=</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                        <span class="n">original_dihedral</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">rotor_dict_index</span><span class="p">][</span><span class="s1">&#39;original_dihedrals&#39;</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;scans&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">plotter</span><span class="o">.</span><span class="n">plot_2d_rotor_scan</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">rotor_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not plotting ND rotors with N &gt; 2&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.process_conformers"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.process_conformers">[docs]</a>    <span class="k">def</span> <span class="nf">process_conformers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the generated conformers and spawn DFT jobs at the conformer_level.</span>
<span class="sd">        If more than one conformer is available, they will be optimized at the DFT conformer_level.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">save_conformers_file</span><span class="p">(</span><span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span>
                                     <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                     <span class="n">xyzs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">,</span>
                                     <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span><span class="p">,</span>
                                     <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                     <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
                                     <span class="n">is_ts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="p">)</span>  <span class="c1"># before optimization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers_before_opt</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="kc">None</span> \
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                 <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span>
                                 <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span><span class="p">,</span>
                                 <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;conformers&#39;</span><span class="p">,</span>
                                 <span class="n">conformer</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                                 <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Only one conformer is available for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">, using it as initial xyz.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># check whether this conformer is isomorphic to the species 2D graph representation</span>
                <span class="c1"># (since this won&#39;t be checked in determine_most_stable_conformer, as there&#39;s only one)</span>
                <span class="n">is_isomorphic</span><span class="p">,</span> <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b_mol</span> <span class="o">=</span> <span class="n">molecules_from_xyz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">,</span>
                                               <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                               <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">SanitizationError</span><span class="p">:</span>
                    <span class="n">b_mol</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">:</span>
                        <span class="c1"># we&#39;ll optimize the single conformer even if it is not isomorphic with the 2D graph</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The single conformer </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> could not be checked for isomorphism with the 2D &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;graph representation </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">()</span><span class="si">}</span><span class="s1">.&#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39; Optimizing this conformer anyway.&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Isomorphism check cannot be done for charged species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;Single conformer could not be checked for isomorphism; &#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span><span class="p">,</span> <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The only conformer for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> could not be checked for isomorphism &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;with the 2D graph representation &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">()</span><span class="si">}</span><span class="s1">. NOT calculating &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;this species. To change this behaviour, pass `allow_nonisomorphic_2d = True`.&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span><span class="p">,</span> <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">b_mol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">b_mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="n">check_isomorphism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">b_mol</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine isomorphism for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">. &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;Got the following error:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">are_coords_compliant_with_graph</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">b_mol</span><span class="p">):</span>
                            <span class="c1"># this is still considered isomorphic</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span><span class="p">,</span> <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span><span class="p">,</span> <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span>
                    <span class="k">if</span> <span class="n">is_isomorphic</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The only conformer for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> was found to be isomorphic &#39;</span>
                                    <span class="sa">f</span><span class="s1">&#39;with the 2D graph representation </span><span class="si">{</span><span class="n">b_mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;single conformer passed isomorphism check; &#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The only conformer for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> is not isomorphic &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;with the 2D graph representation </span><span class="si">{</span><span class="n">b_mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">are_coords_compliant_with_graph</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">b_mol</span><span class="p">):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using this conformer anyway (it is compliant with the 2D graph)&#39;</span><span class="p">)</span>
                            <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using this conformer anyway (allow_nonisomorphic_2d was set to True)&#39;</span><span class="p">)</span>
                            <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Not using this conformer (to change this behavior, set allow_nonisomorphic_2d &#39;</span>
                                        <span class="s1">&#39;to True)&#39;</span><span class="p">)</span>
                            <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">spawn_jobs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> \
                            <span class="nb">all</span><span class="p">([</span><span class="n">species</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span>
                                 <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">multi_species</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multi_species</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_only</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># opt wasn&#39;t requested, skip directly to additional relevant job types</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">run_freq_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">]:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;rotors&#39;</span><span class="p">]:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">run_scan_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;onedmin&#39;</span><span class="p">]:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">run_onedmin_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;orbitals&#39;</span><span class="p">]:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">run_orbitals_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.parse_conformer"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.parse_conformer">[docs]</a>    <span class="k">def</span> <span class="nf">parse_conformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;JobAdapter&#39;</span><span class="p">,</span>
                        <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse E0 (kJ/mol) from the conformer opt output file.</span>
<span class="sd">        For species, save it in the Species.conformer_energies attribute.</span>
<span class="sd">        Fot TSs, save it in the TSGuess.energy attribute, and also parse the geometry.</span>

<span class="sd">        Args:</span>
<span class="sd">            job (JobAdapter): The conformer job object.</span>
<span class="sd">            label (str): The TS species label.</span>
<span class="sd">            i (int): The conformer index.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether the conformer job is being troubleshooted by running a new job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_geometry</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_e_elect</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">energy</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">opt_xyz</span> <span class="o">=</span> <span class="n">xyz</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Energy for TSGuess </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> of </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> is </span><span class="si">{</span><span class="n">energy</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Energy for TSGuess </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> of </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> is None&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz</span>
                <span class="k">if</span> <span class="n">energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Energy for conformer </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> of </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> is </span><span class="si">{</span><span class="n">energy</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Energy for conformer </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> of </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> is None&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Conformer </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> did not converge.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;errored&#39;</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">times_rerun</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">times_rerun</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">conformer</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">conformer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> 
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">times_rerun</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">trsh_ess_jobs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_a_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">rerun</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Scheduler.determine_most_stable_conformer"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.determine_most_stable_conformer">[docs]</a>    <span class="k">def</span> <span class="nf">determine_most_stable_conformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the most stable conformer for a species (which is not a TS).</span>
<span class="sd">        Also run an isomorphism check.</span>
<span class="sd">        Save the resulting xyz as `initial_xyz`.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;The determine_most_stable_conformer() method does not deal with transition &#39;</span>
                                 <span class="s1">&#39;state guesses.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;conformers&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No conformer converged for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">! Trying to troubleshoot conformer jobs...&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">conformer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">xyzs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">:</span>
                <span class="n">xyzs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">xyzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_xyz_from_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">))</span>
            <span class="n">xyzs_in_original_order</span> <span class="o">=</span> <span class="n">xyzs</span>
            <span class="n">energies</span><span class="p">,</span> <span class="n">xyzs</span> <span class="o">=</span> <span class="n">sort_two_lists_by_the_first</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">,</span> <span class="n">xyzs</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">save_conformers_file</span><span class="p">(</span><span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span>
                                         <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                         <span class="n">xyzs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">,</span>
                                         <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span><span class="p">,</span>
                                         <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                         <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
                                         <span class="n">is_ts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">energies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">,</span>  <span class="c1"># after optimization</span>
                                         <span class="p">)</span>
            <span class="c1"># Run isomorphism checks if a 2D representation is available</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyzs</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">b_mol</span> <span class="o">=</span> <span class="n">molecules_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span>
                                                   <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                                   <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">except</span> <span class="n">SanitizationError</span><span class="p">:</span>
                        <span class="n">b_mol</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">b_mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="n">check_isomorphism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">b_mol</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span> <span class="ow">or</span> \
                                    <span class="n">are_coords_compliant_with_graph</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="p">):</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine isomorphism for charged species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">. &#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39;Optimizing the most stable conformer anyway. Got the &#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39;following error:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="n">xyz</span>
                                <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine isomorphism for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">. Got the &#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39;following error:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="n">is_isomorphic</span> <span class="ow">or</span> <span class="n">are_coords_compliant_with_graph</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">b_mol_smiles</span> <span class="o">=</span> <span class="n">b_mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">()</span> \
                                    <span class="k">if</span> <span class="n">b_mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&lt;no 2D structure available&gt;&#39;</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Most stable conformer for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> was found to be isomorphic &#39;</span>
                                            <span class="sa">f</span><span class="s1">&#39;with the 2D graph representation </span><span class="si">{</span><span class="n">b_mol_smiles</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="n">xyz</span>
                                <span class="k">if</span> <span class="s1">&#39;passed isomorphism check&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;most stable conformer (</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">) passed &#39;</span> \
                                                                        <span class="sa">f</span><span class="s1">&#39;isomorphism check; &#39;</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">mol</span> <span class="o">=</span> <span class="n">molecules_from_xyz</span><span class="p">(</span><span class="n">xyzs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                             <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                                             <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="n">smiles_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">()</span> \
                                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&lt;no 2D structure available&gt;&#39;</span>
                                    <span class="n">smiles_2</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">()</span> \
                                        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&lt;no 2D structure available&gt;&#39;</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A conformer for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> was found to be isomorphic with the &#39;</span>
                                                <span class="sa">f</span><span class="s1">&#39;2D graph representation </span><span class="si">{</span><span class="n">smiles_1</span><span class="si">}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                                <span class="sa">f</span><span class="s1">&#39;This conformer is </span><span class="si">{</span><span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> kJ/mol above the &#39;</span>
                                                <span class="sa">f</span><span class="s1">&#39;most stable one corresponding to </span><span class="si">{</span><span class="n">smiles_2</span><span class="si">}</span><span class="s1"> (and is not isomorphic). &#39;</span>
                                                <span class="sa">f</span><span class="s1">&#39;Using the isomorphic conformer for further geometry optimization.&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;Conformer </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> was found to be the lowest &#39;</span> \
                                                                        <span class="sa">f</span><span class="s1">&#39;energy isomorphic conformer; &#39;</span>
                                <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="n">xyz</span>
                            <span class="k">if</span> <span class="s1">&#39;Conformers optimized and compared&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> \
                                    <span class="sa">f</span><span class="s1">&#39;Conformers optimized and compared at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span><span class="o">.</span><span class="n">simple</span><span class="p">()</span><span class="si">}</span><span class="s1">; &#39;</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;most stable conformer (</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">) did not &#39;</span> \
                                                                    <span class="sa">f</span><span class="s1">&#39;pass isomorphism check; &#39;</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">smiles_1</span> <span class="o">=</span> <span class="n">b_mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">()</span> \
                                    <span class="k">if</span> <span class="n">b_mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&lt;no 2D structure available&gt;&#39;</span>
                                <span class="n">smiles_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">()</span> \
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&lt;no 2D structure available&gt;&#39;</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Most stable conformer for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> with structure &#39;</span>
                                               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">smiles_1</span><span class="si">}</span><span class="s1"> was found to be NON-isomorphic &#39;</span>
                                               <span class="sa">f</span><span class="s1">&#39;with the 2D graph representation </span><span class="si">{</span><span class="n">smiles_2</span><span class="si">}</span><span class="s1">. &#39;</span>
                                               <span class="sa">f</span><span class="s1">&#39;Searching for a different conformer that is isomorphic...&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># all conformers for the species failed isomorphism test</span>
                    <span class="n">smiles_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">xyzs</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">b_mol</span> <span class="o">=</span> <span class="n">molecules_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span>
                                                       <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                                       <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">smiles_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b_mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">())</span>
                        <span class="k">except</span> <span class="p">(</span><span class="n">SanitizationError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                            <span class="n">smiles_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Could not perceive molecule&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">:</span>
                        <span class="c1"># we&#39;ll optimize the most stable conformer even if it is not isomorphic to the 2D graph</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No conformer for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> was found to be isomorphic with the 2D graph &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;representation </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">()</span><span class="si">}</span><span class="s1"> &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;(got: </span><span class="si">{</span><span class="n">smiles_list</span><span class="si">}</span><span class="s1">).  Optimizing the most stable conformer anyway.&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;No conformer was found to be isomorphic with &#39;</span> \
                                                            <span class="s1">&#39;the 2D graph representation; &#39;</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Isomorphism check cannot be done for charged species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="n">xyzs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># troubleshoot when all conformers of a species failed isomorphic test</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Isomorphism check for all conformers of species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> failed at &#39;</span>
                                       <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span><span class="o">.</span><span class="n">simple</span><span class="p">()</span><span class="si">}</span><span class="s1">. &#39;</span>
                                       <span class="sa">f</span><span class="s1">&#39;Attempting to troubleshoot using a different level.&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> \
                            <span class="sa">f</span><span class="s1">&#39;Error: No conformer was found to be isomorphic with the 2D graph representation at &#39;</span> \
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span><span class="o">.</span><span class="n">simple</span><span class="p">()</span><span class="si">}</span><span class="s1">; &#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_conformer_isomorphism</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not run isomorphism check for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> due to missing 2D graph &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;representation. Using the most stable conformer for further geometry optimization.&#39;</span><span class="p">)</span>
                <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="n">xyzs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">conformer_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">conformer_xyz</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">most_stable_conformer</span> <span class="o">=</span> <span class="n">xyzs_in_original_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">conformer_xyz</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Conformer number </span><span class="si">{</span><span class="n">xyzs_in_original_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">conformer_xyz</span><span class="p">)</span><span class="si">}</span><span class="s1"> for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> is &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;used for geometry optimization.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Scheduler.determine_most_likely_ts_conformer"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.determine_most_likely_ts_conformer">[docs]</a>    <span class="k">def</span> <span class="nf">determine_most_likely_ts_conformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the most likely TS conformer.</span>
<span class="sd">        Save the resulting xyz as the ``.initial_xyz`` attribute of the TS Species.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The TS species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">cluster_tsgs</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;determine_most_likely_ts_conformer() method only processes transition state guesses.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">successful_methods</span><span class="p">:</span>
            <span class="c1"># Only run this block once, not every time a TS is selecting a different guess.</span>
            <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">successful_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tsg</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">successful_methods</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">unsuccessful_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tsg</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">All TS guesses for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> terminated.&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">successful_methods</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">unsuccessful_methods</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> All methods were successful in generating guesses: &#39;</span> \
                           <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">successful_methods</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">successful_methods</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Successful methods: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">successful_methods</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">yml_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39; Geometry parsed from YAML file.&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39; No method has converged!&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No TS methods for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> have converged!&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">unsuccessful_methods</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Unsuccessful methods: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">unsuccessful_methods</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">]):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No guess converged for TS </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">!</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;Cannot compute a rate coefficient for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Select the TSG with the lowest energy given that it has only one significant imaginary frequency.</span>
            <span class="c1"># Todo: consider IRC well isomorphism</span>
            <span class="n">e_min</span><span class="p">,</span> <span class="n">selected_i</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses_exhausted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">e_min</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="o">&lt;</span> <span class="n">e_min</span><span class="p">)</span> \
                        <span class="ow">and</span> <span class="p">(</span><span class="n">tsg</span><span class="o">.</span><span class="n">imaginary_freqs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">check_imaginary_frequencies</span><span class="p">(</span><span class="n">tsg</span><span class="o">.</span><span class="n">imaginary_freqs</span><span class="p">))</span> \
                        <span class="ow">and</span> <span class="n">tsg</span><span class="o">.</span><span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts_list</span><span class="p">:</span>
                    <span class="n">e_min</span> <span class="o">=</span> <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span>
                    <span class="n">selected_i</span> <span class="o">=</span> <span class="n">tsg</span><span class="o">.</span><span class="n">index</span>
            <span class="n">e_min</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">selected_i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine a likely TS conformer for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">populate_ts_checks</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rxn_txt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span> <span class="ow">is</span> <span class="kc">None</span> \
                    <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39; of reaction </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Geometry *guesses* of successful TS guesses for </span><span class="si">{</span><span class="n">label</span><span class="si">}{</span><span class="n">rxn_txt</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">:</span>
                <span class="c1"># Reset e_min to the lowest value regardless of other criteria (imaginary frequencies, IRC, normal modes).</span>
                <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">e_min</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="o">&lt;</span> <span class="n">e_min</span><span class="p">):</span>
                    <span class="n">e_min</span> <span class="o">=</span> <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span>
            <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">selected_i</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts</span> <span class="o">=</span> <span class="n">selected_i</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">selected_i</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts_method</span> <span class="o">=</span> <span class="n">tsg</span><span class="o">.</span><span class="n">method</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">tsg</span><span class="o">.</span><span class="n">opt_xyz</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses_exhausted</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># guess method and ts_level opt were both successful</span>
                    <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="o">-=</span> <span class="n">e_min</span>
                    <span class="n">im_freqs</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;, imaginary frequencies </span><span class="si">{</span><span class="n">tsg</span><span class="o">.</span><span class="n">imaginary_freqs</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">imaginary_freqs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">execution_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tsg</span><span class="o">.</span><span class="n">execution_time</span><span class="p">)</span>
                    <span class="n">execution_time</span> <span class="o">=</span> <span class="n">execution_time</span><span class="p">[:</span><span class="n">execution_time</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> \
                        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">execution_time</span> <span class="k">else</span> <span class="n">execution_time</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">tsg</span><span class="o">.</span><span class="n">errors</span><span class="si">}</span><span class="s1">.&#39;</span> <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">errors</span> <span class="k">else</span> <span class="s1">&#39;.&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TS guess </span><span class="si">{</span><span class="n">tsg</span><span class="o">.</span><span class="n">index</span><span class="si">:</span><span class="s1">2</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">. &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;Method: </span><span class="si">{</span><span class="n">tsg</span><span class="o">.</span><span class="n">method</span><span class="si">:</span><span class="s1">10</span><span class="si">}</span><span class="s1">, &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;relative energy: </span><span class="si">{</span><span class="n">tsg</span><span class="o">.</span><span class="n">energy</span><span class="si">:</span><span class="s1">8.2f</span><span class="si">}</span><span class="s1"> kJ/mol, &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;guess ex time: </span><span class="si">{</span><span class="n">execution_time</span><span class="si">}{</span><span class="n">im_freqs</span><span class="si">}</span><span class="s1">&#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">aux</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="c1"># for TSs, only use `draw_3d()`, not `show_sticks()` which gets connectivity wrong:</span>
                    <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">tsg</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;draw_3d&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SpeciesError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not pair most stable conformer </span><span class="si">{</span><span class="n">selected_i</span><span class="si">}</span><span class="s1"> of </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> to a respective &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;TS guess&#39;</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">save_conformers_file</span><span class="p">(</span>
                <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                <span class="n">xyzs</span><span class="o">=</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">opt_xyz</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">],</span>
                <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_guess_level</span><span class="p">,</span>
                <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
                <span class="n">is_ts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">energies</span><span class="o">=</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">],</span>
                <span class="n">ts_methods</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tsg</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s1"> &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tsg</span><span class="o">.</span><span class="n">method_direction</span> <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">method_direction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1"> &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tsg</span><span class="o">.</span><span class="n">method_index</span> <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">method_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1"> &#39;</span>
                            <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">],</span>
                <span class="n">im_freqs</span><span class="o">=</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">imaginary_freqs</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">tsg</span><span class="o">.</span><span class="n">imaginary_freqs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.parse_composite_geo"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.parse_composite_geo">[docs]</a>    <span class="k">def</span> <span class="nf">parse_composite_geo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;JobAdapter&#39;</span><span class="p">,</span>
                            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that a &#39;composite&#39; job converged successfully, and parse the geometry into `final_xyz`.</span>
<span class="sd">        Also checks (QA) that no imaginary frequencies were assigned for stable species,</span>
<span class="sd">        and that exactly one imaginary frequency was assigned for a TS.</span>
<span class="sd">        Returns ``True`` if the job converged successfully, ``False`` otherwise and troubleshoots.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (JobAdapter): The composite job object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether the job converged successfully.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;parsing composite geo for </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">freq_ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_xyz_from_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;fine&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;fine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># all composite jobs are fine if fine was asked for</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">opt_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="o">.</span><span class="n">simple</span><span class="p">()</span>
            <span class="n">rxn_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="n">rxn_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; of reaction </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span><span class="si">}</span><span class="s1">&#39;</span> \
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Optimized geometry for </span><span class="si">{</span><span class="n">label</span><span class="si">}{</span><span class="n">rxn_str</span><span class="si">}</span><span class="s1"> at </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">simple</span><span class="p">()</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">xyz_to_str</span><span class="p">(</span><span class="n">xyz_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">save_geo</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span>
                                       <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># for TSs, only use `draw_3d()`, not `show_sticks()` which gets connectivity wrong:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span>
                                       <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span>
                                       <span class="n">method</span><span class="o">=</span><span class="s1">&#39;draw_3d&#39;</span><span class="p">)</span>
            <span class="n">frequencies</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_frequencies</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">job_adapter</span><span class="p">)</span>
            <span class="n">freq_ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_negative_freq</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">vibfreqs</span><span class="o">=</span><span class="n">frequencies</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">freq_ok</span><span class="p">:</span>
                <span class="c1"># Update restart dictionary and save a restart file:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># run freq / scan jobs on this optimized geometry</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">check_xyz_isomorphism</span><span class="p">(</span>
                        <span class="n">allow_nonisomorphic_2d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">is_isomorphic</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;isomorphism&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;composite passed isomorphism check; &#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;isomorphism&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;composite did not pass isomorphism check; &#39;</span>
                    <span class="n">success</span> <span class="o">&amp;=</span> <span class="n">is_isomorphic</span>
                <span class="k">return</span> <span class="n">success</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">trsh_ess_jobs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_negative_freq</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;done&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">freq_ok</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># return ``False``, so no freq / scan jobs are initiated for this unoptimized geometry</span></div>

<div class="viewcode-block" id="Scheduler.parse_opt_e_elect"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.parse_opt_e_elect">[docs]</a>    <span class="k">def</span> <span class="nf">parse_opt_e_elect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                          <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;JobAdapter&#39;</span><span class="p">,</span>
                          <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse electronic energy for &#39;opt&#39; or &#39;optfreq&#39; job if it converged successfully.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (JobAdapter): The optimization job object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">multi_species</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">spc</span><span class="o">.</span><span class="n">multi_species</span> <span class="o">==</span> <span class="n">label</span> <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">multi_species</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">multi_species</span> <span class="o">==</span> <span class="n">label</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">e_elect</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_e_elect</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_species_path_dict</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_e_elect</span><span class="p">(</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e_elect_value</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_e_elect</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_xyz</span> <span class="ow">or</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span> \
                <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">e_elect</span> <span class="o">=</span> <span class="n">e_elect_value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_e_elect</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.parse_opt_geo"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.parse_opt_geo">[docs]</a>    <span class="k">def</span> <span class="nf">parse_opt_geo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;JobAdapter&#39;</span><span class="p">,</span>
                      <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that an &#39;opt&#39; or &#39;optfreq&#39; job converged successfully, and parse the geometry into `final_xyz`.</span>
<span class="sd">        If the job is &#39;optfreq&#39;, also checks (QA) that no imaginary frequencies were assigned for stable species,</span>
<span class="sd">        and that exactly one imaginary frequency was assigned for a TS.</span>
<span class="sd">        Returns ``True`` if the job (or both jobs) converged successfully, ``False`` otherwise and troubleshoots opt.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (JobAdapter): The optimization job object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether the job converged successfully.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">multi_species_opt_xyzs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;parsing opt geo for </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="n">multi_species</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">spc</span><span class="o">.</span><span class="n">multi_species</span> <span class="o">==</span> <span class="n">label</span> <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">)</span>
            <span class="n">species_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span> <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">multi_species</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span>\
                <span class="k">if</span> <span class="n">multi_species</span> <span class="k">else</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">opt_xyz</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_xyz_from_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_xyz</span> <span class="ow">or</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span> \
                <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">multi_species</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">multi_species</span> <span class="o">==</span> <span class="n">label</span><span class="p">:</span>
                        <span class="n">multi_species_opt_xyzs</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_xyz_from_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_species_path_dict</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">fine</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;fine&#39;</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method_type</span> <span class="o">==</span> <span class="s1">&#39;wavefunction&#39;</span> \
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">irc_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Run opt again using a finer grid.</span>
                <span class="c1"># Save the optimized geometry as ``initial_xyz``, since trsh looks there.</span>
                <span class="k">if</span> <span class="n">multi_species</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">multi_species</span> <span class="o">==</span> <span class="n">label</span><span class="p">:</span>
                            <span class="n">spc</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">multi_species_opt_xyzs</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">opt_xyz</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">species_labels</span> <span class="k">if</span> <span class="n">multi_species</span> <span class="k">else</span> <span class="n">label</span><span class="p">,</span>
                             <span class="n">xyz</span><span class="o">=</span><span class="n">opt_xyz</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">multi_species</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;opt&#39;</span><span class="p">,</span>
                             <span class="n">fine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">multi_species</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">multi_species</span> <span class="o">==</span> <span class="n">label</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="o">=</span> <span class="n">multi_species_opt_xyzs</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">post_opt_geo_work</span><span class="p">(</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="o">=</span> <span class="n">opt_xyz</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">post_opt_geo_work</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;optfreq&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_freq_job</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">multi_species</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                        <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">irc_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">check_irc_species</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                            <span class="k">return</span> <span class="kc">False</span>
                        <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">check_xyz_isomorphism</span><span class="p">(</span>
                            <span class="n">allow_nonisomorphic_2d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">is_isomorphic</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;opt passed isomorphism check&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;isomorphism&#39;</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;isomorphism&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;opt passed isomorphism check; &#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;isomorphism&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;opt did not pass isomorphism check; &#39;</span>
                        <span class="n">success</span> <span class="o">&amp;=</span> <span class="n">is_isomorphic</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># for TSs, only use `draw_3d()`, not `show_sticks()` which gets connectivity wrong:</span>
                        <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span>
                                               <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span>
                                               <span class="n">method</span><span class="o">=</span><span class="s1">&#39;draw_3d&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trsh_ess_jobs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_opt_jobs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">success</span></div>

<div class="viewcode-block" id="Scheduler.post_opt_geo_work"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.post_opt_geo_work">[docs]</a>    <span class="k">def</span> <span class="nf">post_opt_geo_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                          <span class="n">spc_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                          <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;JobAdapter&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Few steps to finish after running the opt job.</span>

<span class="sd">        Args:</span>
<span class="sd">            spc_label (str): The species label.</span>
<span class="sd">            job (JobAdapter): The optimization job object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;fine&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;fine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">opt_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span><span class="o">.</span><span class="n">simple</span><span class="p">()</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">save_geo</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">],</span> <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
            <span class="n">rxn_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; of reaction </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span><span class="si">}</span><span class="s1">&#39;</span> \
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rxn_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Optimized geometry for </span><span class="si">{</span><span class="n">spc_label</span><span class="si">}{</span><span class="n">rxn_str</span><span class="si">}</span><span class="s1"> at </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">simple</span><span class="p">()</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">xyz_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>  <span class="c1"># will be overwritten with freq</span></div>

<div class="viewcode-block" id="Scheduler.check_freq_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_freq_job">[docs]</a>    <span class="k">def</span> <span class="nf">check_freq_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;JobAdapter&#39;</span><span class="p">,</span>
                       <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that a freq job converged successfully. Also checks (QA) that no imaginary frequencies were assigned for</span>
<span class="sd">        stable species, and that exactly one imaginary frequency was assigned for a TS.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (JobAdapter): The frequency job object instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">freq_ok</span><span class="p">,</span> <span class="n">switch_ts</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
        <span class="n">wrong_freq_message</span> <span class="o">=</span> <span class="s1">&#39;wrong number of negative frequencies; &#39;</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;Called check_freq_job with no output file&#39;</span><span class="p">)</span>
            <span class="n">vibfreqs</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_frequencies</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">),</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_adapter</span><span class="p">)</span>
            <span class="n">freq_ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_negative_freq</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">vibfreqs</span><span class="o">=</span><span class="n">vibfreqs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">freq_ok</span><span class="p">:</span>
                <span class="c1"># Copy the frequency file to the species / TS output folder.</span>
                <span class="n">folder_name</span> <span class="o">=</span> <span class="s1">&#39;rxns&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="k">else</span> <span class="s1">&#39;Species&#39;</span>
                <span class="n">freq_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;freq.out&#39;</span><span class="p">)</span>
                <span class="n">safe_copy_file</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="n">freq_path</span><span class="p">)</span>
                <span class="c1"># Set species.polarizability.</span>
                <span class="n">polarizability</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_polarizability</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">polarizability</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">transport_data</span><span class="o">.</span><span class="n">polarizability</span> <span class="o">=</span> <span class="p">(</span><span class="n">polarizability</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;angstroms^3&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">transport_data</span><span class="o">.</span><span class="n">comment</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">transport_data</span><span class="o">.</span><span class="n">comment</span> <span class="o">+=</span> \
                            <span class="nb">str</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Polarizability calculated at the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_level</span><span class="o">.</span><span class="n">simple</span><span class="p">()</span><span class="si">}</span><span class="s1"> level of theory&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">transport_data</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> \
                            <span class="nb">str</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Polarizability calculated at the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_level</span><span class="o">.</span><span class="n">simple</span><span class="p">()</span><span class="si">}</span><span class="s1"> level of theory&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">check_ts</span><span class="p">(</span><span class="n">reaction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rxn_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_index</span><span class="p">],</span>
                                 <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                                 <span class="n">checks</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">],</span>
                                 <span class="n">skip_nmd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_nmd</span><span class="p">,</span>
                                 <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_checks</span><span class="p">[</span><span class="s1">&#39;NMD&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TS </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> did not pass the normal mode displacement check. &#39;</span>
                                    <span class="sa">f</span><span class="s1">&#39;Status is:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_checks</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                                    <span class="sa">f</span><span class="s1">&#39;Searching for a better TS conformer...&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">switch_ts</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                        <span class="n">switch_ts</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">wrong_freq_message</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">wrong_freq_message</span><span class="p">))</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">trsh_ess_jobs</span><span class="p">:</span>
                <span class="c1"># Only trsh neg freq here for non TS species, trsh TS species is done in check_negative_freq().</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_negative_freq</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">freq_ok</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">wrong_freq_message</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;done&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">freq_ok</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span> <span class="ow">and</span> <span class="n">freq_ok</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">switch_ts</span>
                <span class="ow">and</span> <span class="n">species_has_sp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">yml_path</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_rxn_e0_by_spc</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.check_negative_freq"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_negative_freq">[docs]</a>    <span class="k">def</span> <span class="nf">check_negative_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;JobAdapter&#39;</span><span class="p">,</span>
                            <span class="n">vibfreqs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
                            <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function for determining the number of negative frequencies. Also logs appropriate errors.</span>
<span class="sd">        Returns ``True`` if the number of negative frequencies is as excepted, ``False`` otherwise.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (JobAdapter): The optimization job object.</span>
<span class="sd">            vibfreqs (list): The vibrational frequencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">neg_freqs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">vibfreqs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">neg_freqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs</span><span class="p">)</span><span class="si">}</span><span class="s1"> imaginary frequencies (</span><span class="si">{</span><span class="n">neg_freqs</span><span class="si">}</span><span class="s1">), &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;should have exactly 0.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs</span><span class="p">)</span><span class="si">}</span><span class="s1"> imaginary freq for&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;Warning: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs</span><span class="p">)</span><span class="si">}</span><span class="s1"> imaginary freq for stable species &#39;</span> \
                                                      <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">neg_freqs</span><span class="si">}</span><span class="s1">); &#39;</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
                    <span class="c1"># Update restart dictionary and save the yaml restart file:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is a TS. Assign the imaginary frequencies to the respective TSGuess.</span>
            <span class="n">tsg</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">conformer_index</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts</span><span class="p">:</span>
                    <span class="n">tsg</span><span class="o">.</span><span class="n">imaginary_freqs</span> <span class="o">=</span> <span class="n">neg_freqs</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">tsg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check_imaginary_frequencies</span><span class="p">(</span><span class="n">tsg</span><span class="o">.</span><span class="n">imaginary_freqs</span><span class="p">):</span>
                <span class="c1"># Imaginary frequencies are problematic, try choosing a different TSGuess, and optimize it.</span>
                <span class="n">add_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; major imaginary frequency between </span><span class="si">{</span><span class="n">LOWEST_MAJOR_TS_FREQ</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">HIGHEST_MAJOR_TS_FREQ</span><span class="si">}</span><span class="s1">.&#39;</span> \
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">neg_freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">LOWEST_MAJOR_TS_FREQ</span>
                                                <span class="ow">or</span> <span class="n">neg_freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">HIGHEST_MAJOR_TS_FREQ</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TS </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs</span><span class="p">)</span><span class="si">}</span><span class="s1"> imaginary frequencies (</span><span class="si">{</span><span class="n">neg_freqs</span><span class="si">}</span><span class="s1">), &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;should have exactly 1</span><span class="si">{</span><span class="n">add_text</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs</span><span class="p">)</span><span class="si">}</span><span class="s1"> imaginary freqs for&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;Warning: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs</span><span class="p">)</span><span class="si">}</span><span class="s1"> imaginary freqs for TS (</span><span class="si">{</span><span class="n">neg_freqs</span><span class="si">}</span><span class="s1">); &#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TS </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> did not pass the negative frequency check. &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;Status is:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_checks</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;Searching for a better TS conformer...&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">switch_ts</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TS </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> has exactly one imaginary frequency: </span><span class="si">{</span><span class="n">neg_freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;info&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;Imaginary frequency: </span><span class="si">{</span><span class="n">neg_freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">neg_freqs</span><span class="si">}</span><span class="s1">; &#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">save_conformers_file</span><span class="p">(</span>
                    <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                    <span class="n">xyzs</span><span class="o">=</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">opt_xyz</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">],</span>
                    <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_guess_level</span><span class="p">,</span>
                    <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                    <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
                    <span class="n">is_ts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">energies</span><span class="o">=</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">],</span>
                    <span class="n">ts_methods</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tsg</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s1"> &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tsg</span><span class="o">.</span><span class="n">method_direction</span> <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">method_direction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1"> &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tsg</span><span class="o">.</span><span class="n">method_index</span> <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">method_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1"> &#39;</span>
                                <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">],</span>
                    <span class="n">im_freqs</span><span class="o">=</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">imaginary_freqs</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">tsg</span><span class="o">.</span><span class="n">imaginary_freqs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
                    <span class="c1"># Update restart dictionary and save the yaml restart file:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
                <span class="c1"># Set the ts_checks attribute of the TS species:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_checks</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Scheduler.check_rxn_e0_by_spc"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_rxn_e0_by_spc">[docs]</a>    <span class="k">def</span> <span class="nf">check_rxn_e0_by_spc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the E0 (electronic energy + ZPE) of reactions related to a specific species.</span>
<span class="sd">        Requires all opt + freq computations to be converged for all species (and TS) participating in each reaction.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): A label representing a species.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_list</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reactants</span> <span class="o">+</span> <span class="n">rxn</span><span class="o">.</span><span class="n">products</span> <span class="o">+</span> <span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span> <span class="ow">and</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_species</span><span class="o">.</span><span class="n">ts_checks</span><span class="p">[</span><span class="s1">&#39;E0&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> \
                    <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">species_has_sp_and_freq</span><span class="p">(</span><span class="n">output_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">yml_path</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">spc_label</span><span class="p">,</span> <span class="n">output_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">spc_label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]):</span>
                <span class="n">check_ts</span><span class="p">(</span><span class="n">reaction</span><span class="o">=</span><span class="n">rxn</span><span class="p">,</span>
                         <span class="n">checks</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">],</span>
                         <span class="n">species_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">,</span>
                         <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span>
                         <span class="n">kinetics_adapter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kinetics_adapter</span><span class="p">,</span>
                         <span class="n">output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span>
                         <span class="n">sp_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">,</span>
                         <span class="n">freq_scale_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_scale_factor</span><span class="p">,</span>
                         <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="p">)</span>
                <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_species</span><span class="o">.</span><span class="n">ts_checks</span><span class="p">[</span><span class="s1">&#39;E0&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TS </span><span class="si">{</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_species</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1"> of reaction </span><span class="si">{</span><span class="n">rxn</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1"> did not pass the E0 check.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;Searching for a better TS conformer...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">switch_ts</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.switch_ts"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.switch_ts">[docs]</a>    <span class="k">def</span> <span class="nf">switch_ts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try the next optimized TS guess in line if a previous TS guess was found to be wrong.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The TS species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Switching a TS guess for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">determine_most_likely_ts_conformer</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>  <span class="c1"># Look for a different TS guess.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_all_species_jobs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>  <span class="c1"># Delete other currently running jobs for this TS.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">freq_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;rxns&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;freq.out&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">freq_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">freq_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">populate_ts_checks</span><span class="p">()</span>  <span class="c1"># Restart the TS checks dict.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses_exhausted</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Optimizing species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> again using a different TS guess: &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;conformer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_only</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.check_sp_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_sp_job">[docs]</a>    <span class="k">def</span> <span class="nf">check_sp_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;JobAdapter&#39;</span><span class="p">,</span>
                     <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that a single point job converged successfully.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (JobAdapter): The single point job object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;mrci&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span><span class="o">.</span><span class="n">method</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;mrci&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
            <span class="c1"># This is a CCSD job ran before MRCI. Spawn MRCI</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_sp_actions</span><span class="p">(</span><span class="n">label</span><span class="p">,</span>
                                 <span class="n">sp_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">),</span>
                                 <span class="n">level</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level</span><span class="p">,</span>
                                 <span class="p">)</span>
            <span class="c1"># Update restart dictionary and save the yaml restart file:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># save the geometry from the sp job for monoatomic species for which no opt/freq jobs will be spawned</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                  <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                                  <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level</span><span class="p">,</span>
                                  <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.post_sp_actions"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.post_sp_actions">[docs]</a>    <span class="k">def</span> <span class="nf">post_sp_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">sp_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Level</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform post-sp actions.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            sp_path (str): The path to &#39;output.out&#39; for the single point job.</span>
<span class="sd">            level (Level, optional): The level of theory used for the sp job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">original_sp_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp_path</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;ccsd&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">t1</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_t1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">])</span>
        <span class="n">zpe_scale_factor</span> <span class="o">=</span> <span class="mf">0.99</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;cbs-qb3&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="o">.</span><span class="n">method</span><span class="p">)</span> \
            <span class="k">else</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">e_elect</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_e_elect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span>
                                                                <span class="n">zpe_scale_factor</span><span class="o">=</span><span class="n">zpe_scale_factor</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">t1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">t1</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;. Looks like it should be treated using a multireference single-point energy method.&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">t1</span> <span class="o">&gt;</span> <span class="mf">0.015</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;. It might have multireference characteristic.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> has a T1 diagnostic parameter of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">t1</span><span class="si">}{</span><span class="n">txt</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;info&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;T1 = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">t1</span><span class="si">}</span><span class="s1">; &#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span><span class="o">.</span><span class="n">solvation_scheme_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># a complex solvation correction behavior was requested for the single-point energy value</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]:</span>
                <span class="c1"># this is the first &quot;original&quot; sp job, spawn two more at the sp_level.solvation_scheme_level level,</span>
                <span class="c1"># with and without solvation corrections</span>
                <span class="n">solvation_sp_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span><span class="o">.</span><span class="n">solvation_scheme_level</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">solvation_sp_level</span><span class="o">.</span><span class="n">solvation_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span><span class="o">.</span><span class="n">solvation_method</span>
                <span class="n">solvation_sp_level</span><span class="o">.</span><span class="n">solvent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span><span class="o">.</span><span class="n">solvent</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">solvation_sp_level</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span><span class="o">.</span><span class="n">solvation_scheme_level</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># this is one of the additional sp jobs spawned by the above previously</span>
                <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">level</span><span class="o">.</span><span class="n">solvation_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;sp_sol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp_path</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;sp_no_sol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp_path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_sp_path</span>  <span class="c1"># restore the original path</span>

        <span class="k">if</span> <span class="n">species_has_freq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">yml_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_rxn_e0_by_spc</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_e_elect</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_e_elect</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="c1"># set *at the end* to differentiate between sp jobs when using complex solvation corrections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Scheduler.spawn_post_irc_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.spawn_post_irc_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">spawn_post_irc_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;JobAdapter&#39;</span><span class="p">,</span>
                            <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn additional jobs after IRC has converged.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (JobAdapter): The IRC job object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;irc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;irc&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="s1">&#39;irc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">save_irc_traj_animation</span><span class="p">(</span><span class="n">irc_f_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;irc&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="n">irc_r_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;irc&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                            <span class="n">out_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span>
                                                                  <span class="s1">&#39;rxns&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;irc_traj.gjf&#39;</span><span class="p">))</span>
        <span class="n">irc_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_label_to_unique_species_labels</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;IRC_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">irc_spc</span> <span class="o">=</span> <span class="n">ARCSpecies</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">irc_label</span><span class="p">,</span>
                             <span class="n">xyz</span><span class="o">=</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_xyz_from_file</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">),</span>
                             <span class="n">irc_label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                             <span class="n">compute_thermo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">multiplicity</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                             <span class="n">charge</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
                             <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">irc_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">irc_label</span> <span class="o">=</span> <span class="n">irc_spc</span><span class="o">.</span><span class="n">label</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">irc_label</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">irc_spc</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">irc_spc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">irc_spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">irc_spc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_output_dict</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">irc_spc</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">irc_spc</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                     <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">irc_spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(),</span>
                     <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_level</span><span class="p">,</span>
                     <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;opt&#39;</span><span class="p">,</span>
                     <span class="n">fine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.add_label_to_unique_species_labels"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.add_label_to_unique_species_labels">[docs]</a>    <span class="k">def</span> <span class="nf">add_label_to_unique_species_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a label to self.unique_species_labels.</span>
<span class="sd">        Modifies the label if it is not unique.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): A species label.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The modified species label</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unique_label</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">label</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">unique_label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span><span class="p">:</span>
            <span class="n">unique_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unique_label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">unique_label</span></div>

<div class="viewcode-block" id="Scheduler.check_irc_species"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_irc_species">[docs]</a>    <span class="k">def</span> <span class="nf">check_irc_species</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that the optimized geometry of the two species created from a TS IRC runs makes sense</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The label of one of the optimized IRC-resulting species.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ts_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">irc_label</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">ts_label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;irc&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">irc_species_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">ts_label</span><span class="p">]</span><span class="o">.</span><span class="n">irc_label</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">irc_label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">irc_label</span> <span class="ow">in</span> <span class="n">irc_species_labels</span><span class="p">):</span>
                <span class="n">check_irc_species_and_rxn</span><span class="p">(</span><span class="n">xyz_1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">irc_species_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">],</span>
                                          <span class="n">xyz_2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">irc_species_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">],</span>
                                          <span class="n">rxn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rxn_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">ts_label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_index</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                                          <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.check_scan_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_scan_job">[docs]</a>    <span class="k">def</span> <span class="nf">check_scan_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;JobAdapter&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that a rotor scan job converged successfully. Also checks (QA) whether the scan is relatively &quot;smooth&quot;,</span>
<span class="sd">        and whether the optimized geometry indeed represents the minimum energy conformer.</span>
<span class="sd">        Recommends whether to use this rotor using the &#39;successful_rotors&#39; and &#39;unsuccessful_rotors&#39; attributes.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (JobAdapter): The rotor scan job object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># An &#39;Internal coordinate error&#39; cannot be handled by troubleshooting, so we don&#39;t even try.</span>
        <span class="c1"># It is usually related to bond or angle changes which mess up the internal coordinates during the scan.</span>
        <span class="n">invalidate</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">energies</span><span class="p">,</span> <span class="n">angles</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">invalidation_reason</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Internal coordinate error&#39;</span><span class="p">:</span>
                <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="s1">&#39;Internal coordinate error; &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                      <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                                      <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not match rotor </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="si">}</span><span class="s1"> of species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;with pivots </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s2">&quot;pivots&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;to any of the existing rotors in the species.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;The rotors dict of </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> is:</span><span class="se">\n</span><span class="si">{</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># This is a 1D scan.</span>
            <span class="c1"># Read energy profile (in kJ/mol), it may be used in the troubleshooting.</span>
            <span class="n">energies</span><span class="p">,</span> <span class="n">angles</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_1d_scan_energies</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span>
                <span class="n">initial_angle</span><span class="o">=</span><span class="n">calculate_dihedral_angle</span><span class="p">(</span>
                    <span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(),</span>
                    <span class="n">torsion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;torsion&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;original_dihedrals&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">[</span><span class="n">calculate_dihedral_angle</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">torsion</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">torsions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;degs&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">energies</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="s1">&#39;Could not read energies&#39;</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Energies from rotor scan of </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> of pivots &#39;</span> \
                          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s2">&quot;pivots&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> could not &#39;</span> \
                          <span class="sa">f</span><span class="s1">&#39;be read. Invalidating rotor.&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">trajectory</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_1d_scan_coords</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span> \
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">invalidate</span><span class="p">,</span> <span class="n">invalidation_reason</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">actions</span> <span class="o">=</span> <span class="n">scan_quality_check</span><span class="p">(</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                    <span class="n">pivots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;pivots&#39;</span><span class="p">],</span>
                    <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
                    <span class="n">used_methods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;trsh_methods&#39;</span><span class="p">],</span>
                    <span class="n">log_file</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span>
                    <span class="n">preserve_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">preserve_param_in_scan</span><span class="p">,</span>
                    <span class="n">trajectory</span><span class="o">=</span><span class="n">trajectory</span><span class="p">,</span>
                    <span class="n">original_xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">actions</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> \
                        <span class="ow">and</span> <span class="s1">&#39;pivTS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;invalidation_reason&#39;</span><span class="p">]</span> \
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">trsh_ess_jobs</span><span class="p">:</span>
                    <span class="c1"># The rotor scan is problematic (and does not block a TS reaction zone), troubleshooting is required.</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trying to troubleshoot rotor &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s2">&quot;pivots&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;of species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> ...&#39;</span><span class="p">)</span>
                    <span class="c1"># Try to troubleshoot the rotor. sometimes, troubleshooting cannot yield solutions</span>
                    <span class="c1"># actions from scan_quality_check() is not the actual actions applied,</span>
                    <span class="c1"># they will be post-processed by trsh_scan_job. If troubleshooting fails,</span>
                    <span class="c1"># The actual actions will be an empty list, indicating invalid rotor.</span>
                    <span class="n">trsh_success</span><span class="p">,</span> <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_scan_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">actions</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">trsh_success</span><span class="p">:</span>
                        <span class="c1"># Detailed reasons are logged in the troubleshoot_scan_job().</span>
                        <span class="n">invalidation_reason</span> <span class="o">+=</span> <span class="s1">&#39; But unable to propose troubleshooting methods.&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Record actions, only if the method is valid.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;trsh_methods&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">invalidate</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;invalidation_reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">invalidation_reason</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">determine_rotor_symmetry</span><span class="p">(</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                    <span class="n">pivots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;pivots&#39;</span><span class="p">],</span>
                    <span class="n">rotor_path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Rotor scan </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s2">&quot;scan&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> between pivots &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s2">&quot;pivots&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;has symmetry </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s2">&quot;symmetry&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is an ND scan, pass for now as it is currently not used for computing Q.</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">invalidate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>

        <span class="c1"># Save the path and invalidation reason for debugging and tracking the file.</span>
        <span class="c1"># If ``success`` is None, it means that the job is being troubleshooted.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;invalidation_reason&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">invalidation_reason</span>

        <span class="c1"># If energies were obtained, draw the scan curve.</span>
        <span class="k">if</span> <span class="n">energies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span> <span class="ow">and</span> <span class="n">angles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">):</span>
            <span class="n">folder_name</span> <span class="o">=</span> <span class="s1">&#39;rxns&#39;</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_ts</span> <span class="k">else</span> <span class="s1">&#39;Species&#39;</span>
            <span class="n">rotor_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">species_label</span><span class="p">,</span> <span class="s1">&#39;rotors&#39;</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">plot_1d_rotor_scan</span><span class="p">(</span><span class="n">angles</span><span class="o">=</span><span class="n">angles</span><span class="p">,</span>
                                       <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
                                       <span class="n">path</span><span class="o">=</span><span class="n">rotor_path</span><span class="p">,</span>
                                       <span class="n">scan</span><span class="o">=</span><span class="n">torsions_to_scans</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">torsions</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                       <span class="n">comment</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                                       <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                       <span class="n">original_dihedral</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span>
                                           <span class="s1">&#39;original_dihedrals&#39;</span><span class="p">],</span>
                                       <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.check_directed_scan"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_directed_scan">[docs]</a>    <span class="k">def</span> <span class="nf">check_directed_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">pivots</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">energies</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks (QA) whether the directed scan is relatively &quot;smooth&quot;,</span>
<span class="sd">        and whether the optimized geometry indeed represents the minimum energy conformer.</span>
<span class="sd">        Recommends whether or not to use this rotor using the &#39;successful_rotors&#39; and &#39;unsuccessful_rotors&#39; attributes.</span>
<span class="sd">        This method differs from check_directed_scan_job(), since here we consider the entire scan.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            pivots (List[List[int]]): The rotor pivots.</span>
<span class="sd">            scan (List[int]): The four atoms defining the dihedral.</span>
<span class="sd">            energies (List[float]): The rotor scan energies in kJ/mol.</span>

<span class="sd">        Todo:</span>
<span class="sd">            - Not used!!</span>
<span class="sd">            - adjust to ND, merge with check_directed_scan_job (this one isn&#39;t being called)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the job has not converged, troubleshoot</span>
        <span class="n">invalidate</span><span class="p">,</span> <span class="n">invalidation_reason</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">actions</span> <span class="o">=</span> <span class="n">scan_quality_check</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                                                               <span class="n">pivots</span><span class="o">=</span><span class="n">pivots</span><span class="p">,</span>
                                                                               <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">actions</span><span class="p">:</span>
            <span class="c1"># the rotor scan is problematic, troubleshooting is required</span>
            <span class="k">if</span> <span class="s1">&#39;change conformer&#39;</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
                <span class="c1"># a lower conformation was found</span>
                <span class="n">deg_increment</span> <span class="o">=</span> <span class="n">actions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">set_dihedral</span><span class="p">(</span><span class="n">scan</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">deg_increment</span><span class="o">=</span><span class="n">deg_increment</span><span class="p">)</span>
                <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">check_xyz_isomorphism</span><span class="p">(</span>
                    <span class="n">allow_nonisomorphic_2d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span><span class="p">,</span>
                    <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_isomorphic</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete_all_species_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                    <span class="c1"># Remove all completed rotor calculation information</span>
                    <span class="k">for</span> <span class="n">rotor_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="c1"># don&#39;t initialize all parameters, e.g., `times_dihedral_set` needs to remain as is</span>
                        <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;invalidation_reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">rotor_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;symmetry&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="c1"># re-run opt (or composite) on the new initial_xyz with the desired dihedral</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fine_only</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># The conformer is wrong, and changing the dihedral resulted in a non-isomorphic species.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;A lower conformer was found for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> via a torsion mode, &#39;</span> \
                                                    <span class="sa">f</span><span class="s1">&#39;but it is not isomorphic with the 2D graph representation &#39;</span> \
                                                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">()</span><span class="si">}</span><span class="s1">. &#39;</span> \
                                                    <span class="sa">f</span><span class="s1">&#39;Not calculating this species.&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;Unconverged&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;convergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Directed scan for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> for pivots </span><span class="si">{</span><span class="n">pivots</span><span class="si">}</span><span class="s1"> failed with: &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">invalidation_reason</span><span class="si">}</span><span class="s1">. Currently rotor troubleshooting methods do not apply for &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;directed scans. Not troubleshooting rotor.&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">rotor_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pivots</span><span class="p">:</span>
                        <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;invalidation_reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">invalidation_reason</span>
                        <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># the rotor scan is good, calculate the symmetry number</span>
            <span class="k">for</span> <span class="n">rotor_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pivots</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">invalidate</span><span class="p">:</span>
                        <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">determine_rotor_symmetry</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                                                          <span class="n">pivots</span><span class="o">=</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">],</span>
                                                                          <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rotor scan </span><span class="si">{</span><span class="n">scan</span><span class="si">}</span><span class="s1"> between pivots </span><span class="si">{</span><span class="n">pivots</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> has symmetry &#39;</span>
                                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s2">&quot;symmetry&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Save the restart dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.check_directed_scan_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_directed_scan_job">[docs]</a>    <span class="k">def</span> <span class="nf">check_directed_scan_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;JobAdapter&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that a directed scan job for a specific dihedral angle converged successfully, otherwise troubleshoot.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (JobAdapter): The rotor scan job object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_geometry</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
            <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">check_xyz_isomorphism</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rotor_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dihedral</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">)</span>
                    <span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;directed_scan&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_e_elect</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">),</span>
                        <span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="n">xyz</span><span class="p">,</span>
                        <span class="s1">&#39;is_isomorphic&#39;</span><span class="p">:</span> <span class="n">is_isomorphic</span><span class="p">,</span>
                        <span class="s1">&#39;trsh&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                    <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                  <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                                  <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.check_all_done"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_all_done">[docs]</a>    <span class="k">def</span> <span class="nf">check_all_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that we have all required data for the species/TS.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_converged</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;convergence&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">spawn_job_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">spawn_job_type</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="n">job_type</span><span class="p">]</span> \
                        <span class="ow">and</span> <span class="ow">not</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">,</span> <span class="s1">&#39;conformers&#39;</span><span class="p">])</span>
                                 <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">==</span> <span class="mi">1</span>
                                     <span class="ow">and</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">,</span> <span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;fine&#39;</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="s1">&#39;rotors&#39;</span><span class="p">,</span> <span class="s1">&#39;bde&#39;</span><span class="p">])</span>
                                 <span class="ow">or</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;bde&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">bdes</span> <span class="ow">is</span> <span class="kc">None</span>
                                 <span class="ow">or</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;conformers&#39;</span>
                                 <span class="ow">or</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;irc&#39;</span>
                                 <span class="ow">or</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;tsg&#39;</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> did not converge.&#39;</span><span class="p">)</span>
                    <span class="n">all_converged</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="n">all_converged</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;convergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">make_ts_report</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_report</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">zero_delta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">conf_time</span> <span class="o">=</span> <span class="n">extremum_list</span><span class="p">([</span><span class="n">job</span><span class="o">.</span><span class="n">run_time</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
                                      <span class="n">return_min</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> \
                <span class="k">if</span> <span class="s1">&#39;conformers&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">zero_delta</span>
            <span class="n">tsg_time</span> <span class="o">=</span> <span class="n">extremum_list</span><span class="p">([</span><span class="n">job</span><span class="o">.</span><span class="n">run_time</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;tsg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="n">return_min</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> \
                <span class="k">if</span> <span class="s1">&#39;tsg&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">zero_delta</span>
            <span class="n">opt_time</span> <span class="o">=</span> <span class="n">sum_time_delta</span><span class="p">([</span><span class="n">job</span><span class="o">.</span><span class="n">run_time</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span> \
                <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">zero_delta</span>
            <span class="n">comp_time</span> <span class="o">=</span> <span class="n">sum_time_delta</span><span class="p">([</span><span class="n">job</span><span class="o">.</span><span class="n">run_time</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span> \
                <span class="k">if</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">zero_delta</span>
            <span class="n">other_time</span> <span class="o">=</span> <span class="n">extremum_list</span><span class="p">([</span><span class="n">sum_time_delta</span><span class="p">([</span><span class="n">job</span><span class="o">.</span><span class="n">run_time</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">job_dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
                                        <span class="k">for</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">job_dictionary</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                        <span class="k">if</span> <span class="n">job_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">,</span> <span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">]],</span> <span class="n">return_min</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> \
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">job_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">,</span> <span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span> <span class="k">else</span> <span class="n">zero_delta</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">run_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">run_time</span> \
                                                <span class="ow">or</span> <span class="p">(</span><span class="n">conf_time</span> <span class="ow">or</span> <span class="n">zero_delta</span><span class="p">)</span> <span class="o">+</span> \
                                                <span class="p">(</span><span class="n">tsg_time</span> <span class="ow">or</span> <span class="n">zero_delta</span><span class="p">)</span> <span class="o">+</span> \
                                                <span class="p">(</span><span class="n">opt_time</span> <span class="ow">or</span> <span class="n">zero_delta</span><span class="p">)</span> <span class="o">+</span> \
                                                <span class="p">(</span><span class="n">comp_time</span> <span class="ow">or</span> <span class="n">zero_delta</span><span class="p">)</span> <span class="o">+</span> \
                                                <span class="p">(</span><span class="n">other_time</span> <span class="ow">or</span> <span class="n">zero_delta</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">All jobs for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> successfully converged. &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;Run time: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">run_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># Todo: any TS which did not converged (any rxn not calculated) should be reported here with full status: Was the family identified? Were TS guesses found? IF so, what&#39;s wrong?</span>
        <span class="k">elif</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses_exhausted</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;IRC_&#39;</span><span class="p">):</span>
            <span class="n">job_type_status</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                               <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                               <span class="ow">and</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;irc&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">)}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> did not converge. Job type status is: </span><span class="si">{</span><span class="n">job_type_status</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Update restart dictionary and save the yaml restart file:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.get_server_job_ids"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.get_server_job_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_server_job_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check job status on all active servers, get a list of relevant running job IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_job_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">SSHClient</span><span class="p">(</span><span class="n">server</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssh</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">server_job_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ssh</span><span class="o">.</span><span class="n">check_running_jobs_ids</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">server_job_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">check_running_jobs_ids</span><span class="p">())</span></div>

<div class="viewcode-block" id="Scheduler.get_completed_incore_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.get_completed_incore_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">get_completed_incore_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check job status of all incore jobs, get a list of relevant completed job IDs.</span>

<span class="sd">        Todo: Add tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completed_incore_jobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">job_names</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="n">job_names</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">get_i_from_job_name</span><span class="p">(</span><span class="n">job_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">job_type</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Consider job types such as &#39;directed_scan&#39;.</span>
                    <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">job_type</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                    <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s1">&#39;tsg&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                    <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;tsg&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Did not recognize job </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> of species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">execution_type</span> <span class="o">==</span> <span class="s1">&#39;incore&#39;</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">completed_incore_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.troubleshoot_negative_freq"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.troubleshoot_negative_freq">[docs]</a>    <span class="k">def</span> <span class="nf">troubleshoot_negative_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                   <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                   <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;JobAdapter&#39;</span><span class="p">,</span>
                                   <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Troubleshooting cases where non-TS species have negative frequencies.</span>
<span class="sd">        Run newly generated conformers.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (JobAdapter): The frequency job object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trsh_ess_jobs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not troubleshooting negative freq for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> and job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1">. &#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;To enable troubleshooting, set the &quot;trsh_ess_jobs&quot; to &quot;True&quot;.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">current_neg_freqs_trshed</span><span class="p">,</span> <span class="n">confs</span><span class="p">,</span> <span class="n">output_errors</span><span class="p">,</span> <span class="n">output_warnings</span> <span class="o">=</span> <span class="n">trsh_negative_freq</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span>
            <span class="n">neg_freqs_trshed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">neg_freqs_trshed</span><span class="p">,</span> <span class="n">job_types</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">neg_freqs_trshed</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">current_neg_freqs_trshed</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">output_error</span> <span class="ow">in</span> <span class="n">output_errors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output_error</span>
            <span class="k">if</span> <span class="s1">&#39;Invalidating species&#39;</span> <span class="ow">in</span> <span class="n">output_error</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Deleting all currently running jobs for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete_all_species_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;convergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">output_warning</span> <span class="ow">in</span> <span class="n">output_warnings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output_warning</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Deleting all currently running jobs for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> before troubleshooting for &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;negative frequency with perturbed conformers...&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;conformers:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_all_species_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span> <span class="o">=</span> <span class="n">confs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># initialize the conformer job dictionary</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                             <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span>
                             <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;conformers&#39;</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                             <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.troubleshoot_scan_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.troubleshoot_scan_job">[docs]</a>    <span class="k">def</span> <span class="nf">troubleshoot_scan_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;JobAdapter&#39;</span><span class="p">,</span>
                              <span class="n">methods</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Troubleshooting rotor scans</span>
<span class="sd">        Using the following methods:</span>
<span class="sd">        1. freeze: freezing specific internal coordinates or all torsions other than the scan&#39;s pivots</span>
<span class="sd">        2. inc_res: increasing the scan resolution.</span>
<span class="sd">        3. change conformer: changing to a conformer with a lower energy</span>

<span class="sd">        Args:</span>
<span class="sd">            job (JobAdapter): The scan Job object.</span>
<span class="sd">            methods (dict): The troubleshooting method/s to try::</span>

<span class="sd">                {&#39;freeze&#39;: &lt;a list of problematic internal coordinates&gt;,</span>
<span class="sd">                 &#39;inc_res&#39;: ``None``,</span>
<span class="sd">                 &#39;change conformer&#39;: &lt;a xyz dict&gt;}</span>

<span class="sd">        Returns: Tuple[bool, dict]:</span>
<span class="sd">            - ``True`` if the troubleshooting is valid.</span>
<span class="sd">            - The actions are applied in the troubleshooting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trsh_ess_jobs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not troubleshooting failed scan job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1">. To enable troubleshooting, &#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;set the &quot;trsh_ess_jobs&quot; to &quot;True&quot;.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">label</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">species_label</span>
        <span class="n">trsh_success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">actual_actions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># If troubleshooting fails, there will be no action.</span>
        <span class="n">used_trsh_methods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;trsh_methods&#39;</span><span class="p">]</span> \
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span> <span class="k">else</span> <span class="nb">list</span><span class="p">()</span>

        <span class="c1"># Check trsh_counter to avoid infinite rotor trsh looping.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;trsh_counter&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">max_rotor_trsh</span><span class="p">:</span>
            <span class="n">next_with_ordinal</span> <span class="o">=</span> <span class="n">get_number_with_ordinal_indicator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;trsh_counter&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The rotor </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> of species &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> was troubleshooted for &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;trsh_counter&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> times, &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;will not troubleshoot for the </span><span class="si">{</span><span class="n">next_with_ordinal</span><span class="si">}</span><span class="s2"> time.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">trsh_success</span><span class="p">,</span> <span class="n">actual_actions</span>
        <span class="c1"># Increase the trsh_counter.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s1">&#39;trsh_counter&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># A lower conformation was found.</span>
        <span class="k">if</span> <span class="s1">&#39;change conformer&#39;</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
            <span class="c1"># We will delete all of the jobs no matter we can successfully change to the conformer.</span>
            <span class="c1"># If success, we have to cancel jobs to avoid conflicts</span>
            <span class="c1"># If not succeed, we are in a situation that we find a lower conformer, but either</span>
            <span class="c1"># this is an incorrect conformer or we have applied this troubleshooting before, but it</span>
            <span class="c1"># didn&#39;t yield a good result.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_all_species_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

            <span class="n">new_xyz</span> <span class="o">=</span> <span class="n">methods</span><span class="p">[</span><span class="s1">&#39;change conformer&#39;</span><span class="p">]</span>
            <span class="c1"># Check if the same conformer is used in previous troubleshooting</span>
            <span class="k">for</span> <span class="n">used_trsh_method</span> <span class="ow">in</span> <span class="n">used_trsh_methods</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;change conformer&#39;</span> <span class="ow">in</span> <span class="n">used_trsh_method</span> \
                        <span class="ow">and</span> <span class="n">compare_confs</span><span class="p">(</span><span class="n">new_xyz</span><span class="p">,</span> <span class="n">used_trsh_method</span><span class="p">[</span><span class="s1">&#39;change conformer&#39;</span><span class="p">]):</span>
                    <span class="c1"># Find we have used this conformer for troubleshooting. Invalid the troubleshooting.</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The change conformer method for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> is invalid. &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;ARC will not change to the same conformer twice.&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If &#39;change conformer&#39; is not used, check for isomorphism.</span>
                <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">check_xyz_isomorphism</span><span class="p">(</span>
                    <span class="n">allow_nonisomorphic_2d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span><span class="p">,</span>
                    <span class="n">xyz</span><span class="o">=</span><span class="n">new_xyz</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_isomorphic</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="o">=</span> <span class="n">new_xyz</span>
                    <span class="c1"># Remove all completed rotor calculation information.</span>
                    <span class="k">for</span> <span class="n">rotor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="c1"># Don&#39;t initialize all parameters, e.g., `times_dihedral_set` needs to remain as is.</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;invalidation_reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">torsions_to_scans</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">torsions</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;times_dihedral_set&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="c1"># We can save the change conformer trsh info, but other trsh methods like</span>
                        <span class="c1"># freezing or increasing scan resolution can be cleaned, otherwise, they may</span>
                        <span class="c1"># not be troubleshot.</span>
                        <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;trsh_methods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">trsh_method</span> <span class="k">for</span> <span class="n">trsh_method</span> <span class="ow">in</span> <span class="n">rotor</span><span class="p">[</span><span class="s1">&#39;trsh_methods&#39;</span><span class="p">]</span>
                                                 <span class="k">if</span> <span class="s1">&#39;change conformer&#39;</span> <span class="ow">in</span> <span class="n">trsh_method</span><span class="p">]</span>
                    <span class="c1"># Re-run opt (or composite) on the new initial_xyz with the desired dihedral.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                    <span class="n">trsh_success</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">actual_actions</span> <span class="o">=</span> <span class="n">methods</span>
                    <span class="k">return</span> <span class="n">trsh_success</span><span class="p">,</span> <span class="n">actual_actions</span>

            <span class="c1"># The conformer is wrong, or we are in a loop changing to the same conformers again.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">+=</span> \
                <span class="sa">f</span><span class="s1">&#39;A lower conformer was found for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> via a torsion mode, &#39;</span> \
                <span class="sa">f</span><span class="s1">&#39;but it is not isomorphic with the 2D graph representation &#39;</span> \
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">()</span><span class="si">}</span><span class="s1">. &#39;</span> \
                <span class="sa">f</span><span class="s1">&#39;Not calculating this species.&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;Unconverged&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;convergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get the scan_list, useful for freezing or increasing the scan resolution.</span>
            <span class="n">scan_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">rotor_dict</span> <span class="ow">in</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">scan_trsh</span><span class="p">,</span> <span class="n">scan_res</span> <span class="o">=</span> <span class="n">trsh_scan_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                                    <span class="n">scan_res</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">scan_res</span><span class="p">,</span>
                                                    <span class="n">scan</span><span class="o">=</span><span class="n">torsions_to_scans</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">torsions</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                                    <span class="n">scan_list</span><span class="o">=</span><span class="n">scan_list</span><span class="p">,</span>
                                                    <span class="n">methods</span><span class="o">=</span><span class="n">methods</span><span class="p">,</span>
                                                    <span class="n">log_file</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span>
                                                    <span class="p">)</span>
            <span class="k">except</span> <span class="n">TrshError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting of the rotor scan of pivots &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">][</span><span class="s2">&quot;pivots&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> for &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> failed. Got:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s1">Job info:</span><span class="se">\n</span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">InputError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Got invalid input for trsh_scan_job: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s1">Job info:</span><span class="se">\n</span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scan_trsh</span> <span class="ow">or</span> <span class="n">job</span><span class="o">.</span><span class="n">scan_res</span> <span class="o">!=</span> <span class="n">scan_res</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">used_trsh_methods</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;scan_trsh&#39;</span> <span class="ow">in</span> <span class="n">action</span> <span class="ow">and</span> <span class="s1">&#39;scan_res&#39;</span> <span class="ow">in</span> <span class="n">action</span>  \
                                <span class="ow">and</span> <span class="n">action</span><span class="p">[</span><span class="s1">&#39;scan_trsh&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">scan_trsh</span> <span class="ow">and</span> <span class="n">action</span><span class="p">[</span><span class="s1">&#39;scan_res&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">scan_res</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Valid troubleshooting method for freezing or increasing resolution.</span>
                        <span class="n">trsh_success</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">actual_actions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scan_trsh&#39;</span><span class="p">:</span> <span class="n">scan_trsh</span><span class="p">,</span> <span class="s1">&#39;scan_res&#39;</span><span class="p">:</span> <span class="n">scan_res</span><span class="p">}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                     <span class="n">xyz</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span>
                                     <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level</span><span class="p">,</span>
                                     <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;scan&#39;</span><span class="p">,</span>
                                     <span class="n">torsions</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">torsions</span><span class="p">,</span>
                                     <span class="n">scan_trsh</span><span class="o">=</span><span class="n">scan_trsh</span><span class="p">,</span>
                                     <span class="n">trsh</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;scan_res&#39;</span><span class="p">:</span> <span class="n">scan_res</span><span class="p">}</span> <span class="k">if</span> <span class="n">scan_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">rotor_index</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">,</span>
                                     <span class="p">)</span>
        <span class="k">return</span> <span class="n">trsh_success</span><span class="p">,</span> <span class="n">actual_actions</span></div>

<div class="viewcode-block" id="Scheduler.troubleshoot_opt_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.troubleshoot_opt_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">troubleshoot_opt_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We&#39;re troubleshooting for opt jobs.</span>
<span class="sd">        First check for server status and troubleshoot if needed. Then check for ESS status and troubleshoot</span>
<span class="sd">        if needed. Finally, check whether the last job had fine=True, add if it didn&#39;t run with fine.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trsh_ess_jobs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not troubleshooting failed opt job for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">. To enable troubleshooting, set the &#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;&quot;trsh_ess_jobs&quot; to &quot;True&quot;.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">previous_job_num</span><span class="p">,</span> <span class="n">latest_job_num</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">job</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># get the latest Job object for the species / TS</span>
            <span class="n">job_name_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_name</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">job_name_int</span> <span class="o">&gt;</span> <span class="n">latest_job_num</span><span class="p">:</span>
                <span class="n">previous_job_num</span> <span class="o">=</span> <span class="n">latest_job_num</span>
                <span class="n">latest_job_num</span> <span class="o">=</span> <span class="n">job_name_int</span>
                <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="c1"># run_opt_job should not be called if all looks good...</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;opt job for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> seems right, yet &quot;run_opt_job&quot; was called.&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;opt job for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> seems right, yet &quot;run_opt_job&quot; was called.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Run opt again using a finer grid.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parse_opt_geo</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                    <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">xyz</span>  <span class="c1"># save for troubleshooting, since trsh goes by initial</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                 <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span>
                                 <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span><span class="p">,</span>
                                 <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;opt&#39;</span><span class="p">,</span>
                                 <span class="n">fine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trsh_opt</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># job passed on the server, but failed in ESS calculation</span>
                <span class="k">if</span> <span class="n">previous_job_num</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="n">previous_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">][</span><span class="s1">&#39;opt_a&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">previous_job_num</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">previous_job</span><span class="o">.</span><span class="n">fine</span> <span class="ow">and</span> <span class="n">previous_job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span> \
                            <span class="ow">and</span> <span class="n">previous_job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
                        <span class="c1"># The present job with a fine grid failed in the ESS calculation.</span>
                        <span class="c1"># A *previous* job without a fine grid terminated successfully on the server and ESS.</span>
                        <span class="c1"># So use the xyz determined w/o the fine grid, and output an error message to alert users.</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Optimization job for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> with a fine grid terminated successfully &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;on the server, but crashed during calculation. NOT running with fine &#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;grid again.&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parse_opt_geo</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">previous_job</span><span class="p">)</span>
                        <span class="n">trsh_opt</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">trsh_opt</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                          <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                                          <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">troubleshoot_server</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.troubleshoot_ess"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.troubleshoot_ess">[docs]</a>    <span class="k">def</span> <span class="nf">troubleshoot_ess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">job</span><span class="p">:</span> <span class="s1">&#39;JobAdapter&#39;</span><span class="p">,</span>
                         <span class="n">level_of_theory</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Level</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                         <span class="n">conformer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Troubleshoot issues related to the electronic structure software, such as conversion.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            job (JobAdapter): The job object to troubleshoot.</span>
<span class="sd">            level_of_theory (Level, dict, str): The level of theory to use.</span>
<span class="sd">            conformer (int, optional): The conformer index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trsh_ess_jobs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not troubleshooting failed </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1">. &#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;To enable troubleshooting, set the &quot;trsh_ess_jobs&quot; argument to &quot;True&quot;.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">level_of_theory</span> <span class="o">=</span> <span class="n">Level</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">warning_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Troubleshooting </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> which failed&#39;</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="n">warning_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; with status: &quot;</span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">,&quot;&#39;</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;keywords&quot;</span><span class="p">]:</span>
            <span class="n">warning_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">with keywords: </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;keywords&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">warning_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; in </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_adapter</span><span class="si">}</span><span class="s1">. &#39;</span>
        <span class="k">if</span> <span class="p">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;error&quot;</span><span class="p">]}</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;line&quot;</span><span class="p">]:</span>
            <span class="n">warning_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;The error &quot;</span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;error&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot; was derived from the following line in the &#39;</span> \
                               <span class="sa">f</span><span class="s1">&#39;log file:</span><span class="se">\n</span><span class="s1">&quot;</span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;line&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;.&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning_message</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="n">conformer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">[</span><span class="n">conformer</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">conformer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">[</span><span class="n">conformer</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span>

        <span class="k">if</span> <span class="s1">&#39;Unknown&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;change_node&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;change_node&#39;</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">troubleshoot_server</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>  <span class="c1"># mark as a running job</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_adapter</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">checkfile</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">checkfile</span>
        <span class="c1"># Determine if the species is a hydrogen atom (or its isotope).</span>
        <span class="n">is_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">]</span>

        <span class="n">output_errors</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">remove_checkfile</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="p">,</span> \
            <span class="n">software</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">memory</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">cpu_cores</span><span class="p">,</span> <span class="n">couldnt_trsh</span> <span class="o">=</span> \
            <span class="n">trsh_ess_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                         <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span>
                         <span class="n">server</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">server</span><span class="p">,</span>
                         <span class="n">job_status</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                         <span class="n">is_h</span><span class="o">=</span><span class="n">is_h</span><span class="p">,</span>
                         <span class="n">job_type</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_type</span><span class="p">,</span>
                         <span class="n">num_heavy_atoms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_heavy_atoms</span><span class="p">,</span>
                         <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_adapter</span><span class="p">,</span>
                         <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span>
                         <span class="n">memory_gb</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_memory_gb</span><span class="p">,</span>
                         <span class="n">cpu_cores</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">cpu_cores</span><span class="p">,</span>
                         <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                         <span class="p">)</span>
        <span class="k">for</span> <span class="n">output_error</span> <span class="ow">in</span> <span class="n">output_errors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">output_error</span>
            <span class="k">if</span> <span class="s1">&#39;Could not troubleshoot&#39;</span> <span class="ow">in</span> <span class="n">output_error</span> <span class="ow">and</span> <span class="s1">&#39;tsg&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">[</span><span class="n">get_i_from_job_name</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">)]</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;; </span><span class="si">{</span><span class="n">output_error</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">remove_checkfile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">checkfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span> <span class="o">=</span> <span class="n">ess_trsh_methods</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">couldnt_trsh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                         <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span>
                         <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span>
                         <span class="n">job_adapter</span><span class="o">=</span><span class="n">software</span><span class="p">,</span>
                         <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
                         <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span>
                         <span class="n">fine</span><span class="o">=</span><span class="n">fine</span><span class="p">,</span>
                         <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                         <span class="n">trsh</span><span class="o">=</span><span class="n">trsh_keyword</span><span class="p">,</span>
                         <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">,</span>
                         <span class="n">torsions</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">torsions</span><span class="p">,</span>
                         <span class="n">dihedrals</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">,</span>
                         <span class="n">directed_scan_type</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">directed_scan_type</span><span class="p">,</span>
                         <span class="n">rotor_index</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">rotor_index</span><span class="p">,</span>
                         <span class="n">cpu_cores</span><span class="o">=</span><span class="n">cpu_cores</span><span class="p">,</span>
                         <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span>
                         <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses_exhausted</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TS </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> did not converge. &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;Status is:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_checks</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;Searching for a better TS conformer...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">switch_ts</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.troubleshoot_conformer_isomorphism"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.troubleshoot_conformer_isomorphism">[docs]</a>    <span class="k">def</span> <span class="nf">troubleshoot_conformer_isomorphism</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Troubleshoot conformer optimization for a species that failed isomorphic test in</span>
<span class="sd">        ``determine_most_stable_conformer``.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trsh_ess_jobs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not troubleshooting failed conformer job for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">. To enable troubleshooting, set the &#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;&quot;trsh_ess_jobs&quot; to &quot;True&quot;.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;The troubleshoot_conformer_isomorphism() method does not yet deal with TSs.&#39;</span><span class="p">)</span>

        <span class="n">num_of_conformers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">num_of_conformers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;The troubleshoot_conformer_isomorphism() method got zero conformers.&#39;</span><span class="p">)</span>

        <span class="c1"># use the first conformer of a species to determine applicable troubleshooting method</span>
        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">level_of_theory</span> <span class="o">=</span> <span class="n">trsh_conformer_isomorphism</span><span class="p">(</span><span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_adapter</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">level_of_theory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ARC has attempted all built-in conformer isomorphism troubleshoot methods for species &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">. No conformer for this species was found to be isomorphic with the 2D graph &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;representation </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_smiles</span><span class="p">()</span><span class="si">}</span><span class="s1">. &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;NOT optimizing this species.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;Error: No conformer was found to be isomorphic with the 2D &#39;</span> \
                                                <span class="s1">&#39;graph representation!; &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting conformer job in </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_adapter</span><span class="si">}</span><span class="s1"> using </span><span class="si">{</span><span class="n">level_of_theory</span><span class="si">}</span><span class="s1"> for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># rerun conformer job at higher level for all conformers</span>
            <span class="k">for</span> <span class="n">conformer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_of_conformers</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">conformer</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers_before_opt</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="c1"># initial xyz before troubleshooting</span>
                <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers_before_opt</span><span class="p">[</span><span class="n">conformer</span><span class="p">]</span>

                <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="n">conformer</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;Conformers: &#39;</span> <span class="o">+</span> <span class="n">level_of_theory</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Conformers: &#39;</span> <span class="o">+</span> <span class="n">level_of_theory</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                             <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span>
                             <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span>
                             <span class="n">job_adapter</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_adapter</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;conformers&#39;</span><span class="p">,</span>
                             <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">,</span>
                             <span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.delete_all_species_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.delete_all_species_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">delete_all_species_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete all jobs of a species/TS.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Deleting all jobs for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">,</span> <span class="s1">&#39;tsg&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> \
                            <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">execution_type</span> <span class="o">!=</span> <span class="s1">&#39;incore&#39;</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Deleted job </span><span class="si">{</span><span class="n">value</span><span class="si">}{</span><span class="n">job_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> \
                        <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">execution_type</span> <span class="o">!=</span> <span class="s1">&#39;incore&#39;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Deleted job </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;irc&#39;</span> <span class="k">else</span> <span class="nb">list</span><span class="p">()</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span></div>

<div class="viewcode-block" id="Scheduler.restore_running_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.restore_running_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">restore_running_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make Job objects for jobs which were running in the previous session.</span>
<span class="sd">        Important for the restart feature so long jobs won&#39;t run twice.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;running_jobs&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">jobs</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="o">.</span><span class="n">values</span><span class="p">()]):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;running_jobs&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;It seems that there are no running jobs specified in the ARC restart file. &#39;</span>
                         <span class="s1">&#39;Assuming all jobs have finished.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spc_label</span> <span class="ow">in</span> <span class="n">jobs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">spc_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">job_description</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;conformer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_description</span> <span class="ow">or</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> \
                            <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;tsg&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_description</span> <span class="ow">or</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;tsg&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_name&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">in</span> <span class="n">job_description</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;conformer</span><span class="si">{</span><span class="n">job_description</span><span class="p">[</span><span class="s2">&quot;conformer&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s1">&#39;tsg&#39;</span> <span class="ow">in</span> <span class="n">job_description</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tsg</span><span class="si">{</span><span class="n">job_description</span><span class="p">[</span><span class="s2">&quot;tsg&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">spc_label</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not find species </span><span class="si">{</span><span class="n">spc_label</span><span class="si">}</span><span class="s1"> in the restart file&#39;</span><span class="p">)</span>
                    <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;species_labels&#39;</span><span class="p">]]</span> \
                        <span class="k">if</span> <span class="s1">&#39;species_labels&#39;</span> <span class="ow">in</span> <span class="n">job_description</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="s1">&#39;species_labels&#39;</span> <span class="ow">in</span> <span class="n">job_description</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;species_labels&#39;</span><span class="p">]</span>
                    <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;reactions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rxn_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;reaction_indices&#39;</span><span class="p">]]</span> \
                        <span class="k">if</span> <span class="s1">&#39;reaction_indices&#39;</span> <span class="ow">in</span> <span class="n">job_description</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="s1">&#39;reaction_indices&#39;</span> <span class="ow">in</span> <span class="n">job_description</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;reaction_indices&#39;</span><span class="p">]</span>
                    <span class="n">job</span> <span class="o">=</span> <span class="n">job_factory</span><span class="p">(</span><span class="o">**</span><span class="n">job_description</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">spc_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_type&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;conformer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_description</span> <span class="ow">or</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> \
                                <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;tsg&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_description</span> <span class="ow">or</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;tsg&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_type&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="s1">&#39;conformers&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="s1">&#39;tsg&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="s1">&#39;tsg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;conformer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_description</span> <span class="ow">or</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> \
                            <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;tsg&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_description</span> <span class="ow">or</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;tsg&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_type&#39;</span><span class="p">]][</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">job</span>
                    <span class="k">elif</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">in</span> <span class="n">job_description</span> <span class="ow">and</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;conformers&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="n">job</span>
                        <span class="c1"># don&#39;t generate additional conformers for this species</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dont_gen_confs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spc_label</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s1">&#39;tsg&#39;</span> <span class="ow">in</span> <span class="n">job_description</span> <span class="ow">and</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;tsg&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;tsg&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="s1">&#39;tsg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="s1">&#39;tsg&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;tsg&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="n">job</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">server_job_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;Restarting ARC, tracking the following jobs spawned in a previous session:&#39;</span>
                <span class="k">for</span> <span class="n">spc_label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">spc_label</span><span class="si">}</span><span class="s1">: &#39;</span>
                    <span class="k">for</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="n">job_type</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">job_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">,</span> <span class="s1">&#39;tsg&#39;</span><span class="p">]:</span>
                                <span class="n">content</span> <span class="o">+=</span> <span class="n">job_name</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
                            <span class="k">elif</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;conformers&#39;</span><span class="p">:</span>
                                <span class="n">content</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="n">job_type</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_name</span> \
                                           <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; (conformer</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1">), &#39;</span>
                            <span class="k">elif</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;tsg&#39;</span><span class="p">:</span>
                                <span class="n">content</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="n">job_type</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_name</span> \
                                           <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; (tsg</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1">), &#39;</span>
                <span class="n">content</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">content</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.save_restart_dict"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.save_restart_dict">[docs]</a>    <span class="k">def</span> <span class="nf">save_restart_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the restart_dict and save the restart.yml file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_restart</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Creating a restart file...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;output_multi_spc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_multi_spc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;running_jobs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;running_jobs&#39;</span><span class="p">][</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="n">job_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
                         <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>
                         <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_name</span> <span class="ow">and</span> <span class="s1">&#39;tsg&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">]</span> \
                        <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="n">get_i_from_job_name</span><span class="p">(</span><span class="n">job_name</span><span class="p">)]</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
                           <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">]</span> \
                        <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;tsg&#39;</span><span class="p">][</span><span class="n">get_i_from_job_name</span><span class="p">(</span><span class="n">job_name</span><span class="p">)]</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
                           <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;tsg&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dumping restart dictionary:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">save_yaml_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_path</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">)</span>    </div>
    
<div class="viewcode-block" id="Scheduler.make_reaction_labels_info_file"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.make_reaction_labels_info_file">[docs]</a>    <span class="k">def</span> <span class="nf">make_reaction_labels_info_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function for creating the `reactions labels.info` file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rxn_info_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;rxns&#39;</span><span class="p">,</span> <span class="s1">&#39;reaction labels.info&#39;</span><span class="p">)</span>
        <span class="n">old_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;rxns&#39;</span><span class="p">,</span> <span class="s1">&#39;reaction labels.old.info&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">old_file_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">old_file_path</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">,</span> <span class="n">old_file_path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;Reaction labels and respective TS labels:</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rxn_info_path</span></div>

<div class="viewcode-block" id="Scheduler.determine_adaptive_level"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.determine_adaptive_level">[docs]</a>    <span class="k">def</span> <span class="nf">determine_adaptive_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">original_level_of_theory</span><span class="p">:</span> <span class="n">Level</span><span class="p">,</span>
                                 <span class="n">job_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                 <span class="n">heavy_atoms</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Level</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the level of theory to be used according to the job type and number of heavy atoms.</span>
<span class="sd">        self.adaptive_levels is a dictionary of levels of theory for ranges of the number of heavy atoms in the</span>
<span class="sd">        species. Keys are tuples of (min_num_atoms, max_num_atoms), values are dictionaries with job type tuples</span>
<span class="sd">        as keys and levels of theory as values. The string &#39;inf&#39; is accepted instead of an integer in max_num_atoms.</span>

<span class="sd">        Args:</span>
<span class="sd">            original_level_of_theory (Level): The level of theory for non-sp/opt/freq job types.</span>
<span class="sd">            job_type (str): The job type for which the level of theory is determined.</span>
<span class="sd">            heavy_atoms (int): The number of heavy atoms in the species.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">atom_range</span><span class="p">,</span> <span class="n">adaptive_level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">atom_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inf&#39;</span> <span class="ow">and</span> <span class="n">heavy_atoms</span> <span class="o">&gt;=</span> <span class="n">atom_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">atom_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">heavy_atoms</span> <span class="o">&lt;=</span> <span class="n">atom_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine adaptive level of theory for </span><span class="si">{</span><span class="n">heavy_atoms</span><span class="si">}</span><span class="s1"> heavy atoms using &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;the following adaptive levels:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">job_type_tuple</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">adaptive_level</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="n">job_type_tuple</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">level</span>
        <span class="c1"># for any other job type use the original level of theory regardless of the number of heavy atoms</span>
        <span class="k">return</span> <span class="n">original_level_of_theory</span></div>

<div class="viewcode-block" id="Scheduler.initialize_output_dict"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.initialize_output_dict">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_output_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize self.output.</span>
<span class="sd">        Do not initialize keys that will contain paths (&#39;geo&#39;, &#39;freq&#39;, &#39;sp&#39;, &#39;composite&#39;),</span>
<span class="sd">        their existence indicate the job was terminated for restarting purposes.</span>
<span class="sd">        If ``label`` is not ``None``, will initialize for a specific species, otherwise will initialize for all species.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str, optional): A species label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_does_output_dict_contain_info</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">label</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">multi_species</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_multi_spc</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output_multi_spc</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">multi_species</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;paths&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">path_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="s1">&#39;sp&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">path_keys</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="s1">&#39;irc&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">species</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;irc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s1">&#39;job_types&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="s1">&#39;sp&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">,</span> <span class="s1">&#39;onedmin&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rotors&#39;</span><span class="p">,</span> <span class="s1">&#39;bde&#39;</span><span class="p">]:</span>
                            <span class="c1"># rotors could be invalidated due to many reasons,</span>
                            <span class="c1"># also could be falsely identified in a species that has no torsional modes.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="n">job_type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;job_types&#39;</span><span class="p">][</span><span class="n">job_type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">,</span> <span class="s1">&#39;isomorphism&#39;</span><span class="p">,</span> <span class="s1">&#39;convergence&#39;</span><span class="p">,</span> <span class="s1">&#39;restart&#39;</span><span class="p">,</span> <span class="s1">&#39;errors&#39;</span><span class="p">,</span> <span class="s1">&#39;warnings&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;convergence&#39;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></div>

    <span class="k">def</span> <span class="nf">_does_output_dict_contain_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine whether self.output contains any information other than the initialized structure.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether self.output contains any information, ``True`` if it does.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">species_output_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">key0</span><span class="p">,</span> <span class="n">val0</span> <span class="ow">in</span> <span class="n">species_output_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key0</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">,</span> <span class="s1">&#39;job_types&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">key1</span><span class="p">,</span> <span class="n">val1</span> <span class="ow">in</span> <span class="n">species_output_dict</span><span class="p">[</span><span class="n">key0</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">val1</span> <span class="ow">and</span> <span class="n">key1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rotors&#39;</span><span class="p">,</span> <span class="s1">&#39;bde&#39;</span><span class="p">]:</span>
                            <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">val0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="Scheduler.generate_final_ts_guess_report"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.generate_final_ts_guess_report">[docs]</a>    <span class="k">def</span> <span class="nf">generate_final_ts_guess_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a TS report for this ARC project and saves it as a YAML file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="n">ts_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">ts_dict</span><span class="p">[</span><span class="s1">&#39;multiplicity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">multiplicity</span>
                <span class="n">ts_dict</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">charge</span>
                <span class="n">ts_dict</span><span class="p">[</span><span class="s1">&#39;external_symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">external_symmetry</span>
                <span class="n">ts_dict</span><span class="p">[</span><span class="s1">&#39;optical_isomers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">optical_isomers</span>
                <span class="n">ts_dict</span><span class="p">[</span><span class="s1">&#39;run_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">run_time</span><span class="p">)</span>
                <span class="n">ts_dict</span><span class="p">[</span><span class="s1">&#39;successful_methods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">successful_methods</span>
                <span class="n">ts_dict</span><span class="p">[</span><span class="s1">&#39;unsuccessful_methods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">unsuccessful_methods</span>
                <span class="n">ts_dict</span><span class="p">[</span><span class="s1">&#39;chosen_ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">chosen_ts</span>
                <span class="n">ts_dict</span><span class="p">[</span><span class="s1">&#39;chosen_ts_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">chosen_ts_list</span>
                <span class="n">ts_dict</span><span class="p">[</span><span class="s1">&#39;ts_guesses_exhausted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">ts_guesses_exhausted</span>
                <span class="n">ts_dict</span><span class="p">[</span><span class="s1">&#39;ts_report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">ts_report</span>
                <span class="n">ts_dict</span><span class="p">[</span><span class="s1">&#39;rxn_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">rxn_label</span>
                <span class="n">ts_dict</span><span class="p">[</span><span class="s1">&#39;rxn_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">rxn_index</span>
                <span class="k">for</span> <span class="n">reaction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">reaction</span><span class="o">.</span><span class="n">ts_label</span> <span class="o">==</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
                        <span class="n">ts_dict</span><span class="p">[</span><span class="s1">&#39;family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">label</span> <span class="k">if</span> <span class="n">reaction</span><span class="o">.</span><span class="n">family</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ts_dict</span><span class="p">[</span><span class="s1">&#39;family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">ts_guesses</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="n">species</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">:</span>
                    <span class="n">ts_guesses</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsg</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(</span><span class="n">for_report</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ts_dict</span><span class="p">[</span><span class="s1">&#39;ts_guesses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts_guesses</span>
                <span class="n">content</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts_dict</span>
                <span class="n">tsg_fig_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;rxns&#39;</span><span class="p">,</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;ts_guesses.png&#39;</span><span class="p">)</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">plot_ts_guesses_by_e_and_method</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">tsg_fig_path</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;rxns&#39;</span><span class="p">,</span> <span class="s1">&#39;TS_guess_report.yml&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">save_yaml_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.save_e_elect"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.save_e_elect">[docs]</a>    <span class="k">def</span> <span class="nf">save_e_elect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the electronic energy of the corresponding species.</span>
<span class="sd">        It will append if the file already exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;e_elect_summary.yml&#39;</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">read_yaml_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">content</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">e_elect</span>
        <span class="n">save_yaml_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="species_has_freq"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.species_has_freq">[docs]</a><span class="k">def</span> <span class="nf">species_has_freq</span><span class="p">(</span><span class="n">species_output_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                     <span class="n">yml_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks whether a species has valid converged frequencies using it&#39;s output dict.</span>

<span class="sd">    Args:</span>
<span class="sd">        species_output_dict (dict): The species output dict (i.e., Scheduler.output[label]).</span>
<span class="sd">        yml_path (str): THe species Arkane YAML file path.</span>

<span class="sd">    Returns: bool</span>
<span class="sd">        Whether a species has valid converged frequencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">yml_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">species_output_dict</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">species_output_dict</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="species_has_geo"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.species_has_geo">[docs]</a><span class="k">def</span> <span class="nf">species_has_geo</span><span class="p">(</span><span class="n">species_output_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                    <span class="n">yml_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks whether a species has a valid converged geometry using it&#39;s output dict.</span>

<span class="sd">    Args:</span>
<span class="sd">        species_output_dict (dict): The species output dict (i.e., Scheduler.output[label]).</span>
<span class="sd">        yml_path (str): THe species Arkane YAML file path.</span>

<span class="sd">    Returns: bool</span>
<span class="sd">        Whether a species has a valid converged geometry.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">yml_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">species_output_dict</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">species_output_dict</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="species_has_sp"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.species_has_sp">[docs]</a><span class="k">def</span> <span class="nf">species_has_sp</span><span class="p">(</span><span class="n">species_output_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                   <span class="n">yml_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks whether a species has a valid converged single-point energy using it&#39;s output dict.</span>

<span class="sd">    Args:</span>
<span class="sd">        species_output_dict (dict): The species output dict (i.e., Scheduler.output[label]).</span>
<span class="sd">        yml_path (str): THe species Arkane YAML file path.</span>

<span class="sd">    Returns: bool</span>
<span class="sd">        Whether a species has a valid converged single-point energy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">yml_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">species_output_dict</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">species_output_dict</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="species_has_sp_and_freq"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.species_has_sp_and_freq">[docs]</a><span class="k">def</span> <span class="nf">species_has_sp_and_freq</span><span class="p">(</span><span class="n">species_output_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                            <span class="n">yml_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks whether a species has a valid converged single-point energy and valid converged frequencies.</span>

<span class="sd">    Args:</span>
<span class="sd">        species_output_dict (dict): The species output dict (i.e., Scheduler.output[label]).</span>
<span class="sd">        yml_path (str): THe species Arkane YAML file path.</span>

<span class="sd">    Returns: bool</span>
<span class="sd">        Whether a species has a valid converged single-point energy and frequencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">species_has_sp</span><span class="p">(</span><span class="n">species_output_dict</span><span class="p">,</span> <span class="n">yml_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">species_has_freq</span><span class="p">(</span><span class="n">species_output_dict</span><span class="p">,</span> <span class="n">yml_path</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2024, Alon Grinberg Dana

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>