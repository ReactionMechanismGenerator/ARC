

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>arc.job.trsh &mdash; ARC 1.1.0 Documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> ARC
          

          
          </a>

          
            
            
              <div class="version">
                1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../running.html">Running ARC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced.html">Advanced Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../output.html">Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">ARCâ€™s API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools.html">Standalone tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../media.html">Media</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cite.html">How to cite ARC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../licence.html">Licence</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ARC</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>arc.job.trsh</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for arc.job.trsh</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The ARC troubleshooting (&quot;trsh&quot;) module</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">arc.common</span> <span class="kn">import</span> <span class="p">(</span><span class="n">check_torsion_change</span><span class="p">,</span>
                        <span class="n">convert_to_hours</span><span class="p">,</span>
                        <span class="n">determine_ess</span><span class="p">,</span>
                        <span class="n">estimate_orca_mem_cpu_requirement</span><span class="p">,</span>
                        <span class="n">get_logger</span><span class="p">,</span>
                        <span class="n">get_number_with_ordinal_indicator</span><span class="p">,</span>
                        <span class="n">is_same_pivot</span><span class="p">,</span>
                        <span class="n">is_same_sequence_sublist</span><span class="p">,</span>
                        <span class="n">is_str_float</span>
                        <span class="p">)</span>
<span class="kn">from</span> <span class="nn">arc.exceptions</span> <span class="kn">import</span> <span class="n">InputError</span><span class="p">,</span> <span class="n">SpeciesError</span><span class="p">,</span> <span class="n">TrshError</span>
<span class="kn">from</span> <span class="nn">arc.imports</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">arc.level</span> <span class="kn">import</span> <span class="n">Level</span>
<span class="kn">from</span> <span class="nn">arc.job.local</span> <span class="kn">import</span> <span class="n">execute_command</span>
<span class="kn">from</span> <span class="nn">arc.job.ssh</span> <span class="kn">import</span> <span class="n">SSHClient</span>
<span class="kn">from</span> <span class="nn">arc.species</span> <span class="kn">import</span> <span class="n">ARCSpecies</span>
<span class="kn">from</span> <span class="nn">arc.species.conformers</span> <span class="kn">import</span> <span class="n">determine_smallest_atom_index_in_scan</span>
<span class="kn">from</span> <span class="nn">arc.species.converter</span> <span class="kn">import</span> <span class="p">(</span><span class="n">displace_xyz</span><span class="p">,</span> <span class="n">ics_to_scan_constraints</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">arc.species.species</span> <span class="kn">import</span> <span class="n">determine_rotor_symmetry</span>
<span class="kn">from</span> <span class="nn">arc.species.vectors</span> <span class="kn">import</span> <span class="n">calculate_dihedral_angle</span><span class="p">,</span> <span class="n">calculate_distance</span>
<span class="kn">from</span> <span class="nn">arc.parser</span> <span class="kn">import</span> <span class="p">(</span><span class="n">parse_1d_scan_coords</span><span class="p">,</span>
                        <span class="n">parse_normal_mode_displacement</span><span class="p">,</span>
                        <span class="n">parse_scan_args</span><span class="p">,</span>
                        <span class="n">parse_scan_conformers</span><span class="p">,</span>
                        <span class="n">parse_xyz_from_file</span><span class="p">,</span>
                        <span class="p">)</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>


<span class="n">delete_command</span><span class="p">,</span> <span class="n">inconsistency_ab</span><span class="p">,</span> <span class="n">inconsistency_az</span><span class="p">,</span> <span class="n">maximum_barrier</span><span class="p">,</span> <span class="n">preserve_params_in_scan</span><span class="p">,</span> <span class="n">rotor_scan_resolution</span><span class="p">,</span> \
    <span class="n">servers</span><span class="p">,</span> <span class="n">submit_filenames</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;delete_command&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;inconsistency_ab&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;inconsistency_az&#39;</span><span class="p">],</span> \
                                <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;maximum_barrier&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;preserve_params_in_scan&#39;</span><span class="p">],</span> \
                                <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;rotor_scan_resolution&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;servers&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;submit_filenames&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="determine_ess_status"><a class="viewcode-back" href="../../../api/trsh.html#arc.job.trsh.determine_ess_status">[docs]</a><span class="k">def</span> <span class="nf">determine_ess_status</span><span class="p">(</span><span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">species_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">job_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">job_log</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">software</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the reason that caused an ESS job to crash, assign error keywords for troubleshooting.</span>

<span class="sd">    Args:</span>
<span class="sd">        output_path (str): The path to the ESS output file.</span>
<span class="sd">        species_label (str): The species label.</span>
<span class="sd">        job_type (str): The job type (e.g., &#39;opt, &#39;freq&#39;, &#39;ts&#39;, &#39;sp&#39;).</span>
<span class="sd">        job_log (str, optional): The path to the server job log file (not the ESS output file) or its content.</span>
<span class="sd">        software (str, optional): The ESS software.</span>

<span class="sd">    Returns: Tuple[str, List[str], str, str]</span>
<span class="sd">        - The status. Either &#39;done&#39; or &#39;errored&#39;.</span>
<span class="sd">        - The standardized error keywords.</span>
<span class="sd">        - A description of the error.</span>
<span class="sd">        - The parsed line from the ESS output file indicating the error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keywords</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">determine_job_log_memory_issues</span><span class="p">(</span><span class="n">job_log</span><span class="o">=</span><span class="n">job_log</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;errored&#39;</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">line</span>

    <span class="k">if</span> <span class="n">software</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">software</span> <span class="o">=</span> <span class="n">determine_ess</span><span class="p">(</span><span class="n">log_file</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span>

    <span class="n">keywords</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="s1">&#39;&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;errored&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;NoOutput&#39;</span><span class="p">],</span> <span class="s1">&#39;Log file could not be read&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
        <span class="n">forward_lines</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">reverse_lines</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lines</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">forward_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">20</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;Normal termination&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(),</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reverse_lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;termination&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;l9999.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s1">&#39;link 9999&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Unconverged&#39;</span><span class="p">,</span> <span class="s1">&#39;GL9999&#39;</span><span class="p">]</span>  <span class="c1"># GL stand for Gaussian Link</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Unconverged&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;l101.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;InputError&#39;</span><span class="p">,</span> <span class="s1">&#39;GL101&#39;</span><span class="p">]</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;The blank line after the coordinate section is missing, &#39;</span> \
                                <span class="s1">&#39;or charge/multiplicity was not specified correctly.&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;l103.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;InternalCoordinateError&#39;</span><span class="p">,</span> <span class="s1">&#39;GL103&#39;</span><span class="p">,</span><span class="s1">&#39;NoSymm&#39;</span><span class="p">]</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Internal coordinate error&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;l108.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;InputError&#39;</span><span class="p">,</span> <span class="s1">&#39;GL108&#39;</span><span class="p">]</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;There are two blank lines between z-matrix and &#39;</span> \
                                <span class="s1">&#39;the variables, expected only one.&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;l202.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;OptOrientation&#39;</span><span class="p">,</span> <span class="s1">&#39;GL202&#39;</span><span class="p">]</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;During the optimization process, either the standard &#39;</span> \
                                <span class="s1">&#39;orientation or the point group of the molecule has changed.&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;l301.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GL301&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="s1">&#39;l401.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GL401&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="s1">&#39;l502.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SCF&#39;</span><span class="p">,</span> <span class="s1">&#39;GL502&#39;</span><span class="p">,</span> <span class="s1">&#39;NoSymm&#39;</span><span class="p">]</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Unconverged SCF&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;l508.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;no_xqc&#39;</span><span class="p">,</span> <span class="s1">&#39;GL508&#39;</span><span class="p">]</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Unconverged&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;l716.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ZMat&#39;</span><span class="p">,</span> <span class="s1">&#39;GL716&#39;</span><span class="p">]</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Angle in z-matrix outside the allowed range 0 &lt; x &lt; 180.&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;l906.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MP2&#39;</span><span class="p">,</span> <span class="s1">&#39;GL906&#39;</span><span class="p">]</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;The MP2 calculation has failed. It may be related to pseudopotential. &#39;</span> \
                                <span class="s1">&#39;Basis sets (CEP-121G*) that are used with polarization functions, &#39;</span> \
                                <span class="s1">&#39;where no polarization functions actually exist.&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;l913.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MaxOptCycles&#39;</span><span class="p">,</span> <span class="s1">&#39;GL913&#39;</span><span class="p">]</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Maximum optimization cycles reached.&#39;</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;GL301&#39;</span><span class="p">,</span> <span class="s1">&#39;GL401&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">]):</span>
                        <span class="n">additional_info</span> <span class="o">=</span> <span class="n">forward_lines</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">forward_lines</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s1">&#39;No data on chk file&#39;</span> <span class="ow">in</span> <span class="n">additional_info</span> \
                                <span class="ow">or</span> <span class="s1">&#39;Basis set data is not on the checkpoint file&#39;</span> <span class="ow">in</span> <span class="n">additional_info</span> \
                                <span class="ow">or</span> <span class="s1">&#39;Error in GetGes&#39;</span> <span class="ow">in</span> <span class="n">additional_info</span><span class="p">:</span>
                            <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CheckFile&#39;</span><span class="p">]</span>
                            <span class="n">error</span> <span class="o">=</span> <span class="n">additional_info</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="s1">&#39;GL301&#39;</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;Atomic number out of range for&#39;</span> <span class="ow">in</span> <span class="n">forward_lines</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">forward_lines</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]:</span>
                                <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;BasisSet&#39;</span><span class="p">)</span>
                                <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;The basis set </span><span class="si">{</span><span class="n">forward_lines</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">forward_lines</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">6</span><span class="p">]</span><span class="si">}</span><span class="s1"> &#39;</span> \
                                        <span class="sa">f</span><span class="s1">&#39;is not appropriate for the this chemistry.&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;InputError&#39;</span><span class="p">)</span>
                                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Either charge, multiplicity, or basis set was not &#39;</span> \
                                        <span class="s1">&#39;specified correctly. Alternatively, a specified atom does not match any &#39;</span> \
                                        <span class="s1">&#39;standard atomic symbol.&#39;</span>
                        <span class="k">elif</span> <span class="s1">&#39;GL401&#39;</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
                            <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;BasisSet&#39;</span><span class="p">)</span>
                            <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;The projection from the old to the new basis set has failed.&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;Erroneous write&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s1">&#39;Write error in NtrExt1&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DiskSpace&#39;</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Ran out of disk space.&#39;</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;NtrErr&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CheckFile&#39;</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;An operation on the check file was specified, but a .chk was not found or is incomplete.&#39;</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;malloc failed&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s1">&#39;galloc&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Memory&#39;</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Memory allocation failed (did you ask for too much?)&#39;</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;PGFIO/stdio: No such file or directory&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Scratch&#39;</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Wrongly specified the scratch directory. Correct the &quot;GAUSS_SCRDIR&quot; &#39;</span> \
                            <span class="s1">&#39;variable in the submit script, it should point to an existing directory. &#39;</span> \
                            <span class="s1">&#39;Make sure to add &quot;mkdir -p $GAUSS_SCRDIR&quot; to your submit script.&#39;</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="s1">&#39;a syntax error was detected&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;an ambiguous keyword was detected&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Syntax&#39;</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;There was a syntax error in the Gaussian input file. Check your Gaussian input file &#39;</span> \
                            <span class="s1">&#39;template under arc/job/inputs.py. Alternatively, perhaps the level of theory is not &#39;</span> \
                            <span class="s1">&#39;supported by Gaussian in the specific format it was given.&#39;</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="n">keywords</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">error</span> <span class="k">if</span> <span class="n">error</span> <span class="k">else</span> <span class="s1">&#39;Gaussian job terminated for an unknown reason. &#39;</span> \
                                        <span class="s1">&#39;It is possible there was a server node failure.&#39;</span>
            <span class="n">keywords</span> <span class="o">=</span> <span class="n">keywords</span> <span class="k">if</span> <span class="n">keywords</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;Unknown&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="s1">&#39;errored&#39;</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">line</span>

        <span class="k">elif</span> <span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">reverse_lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;Thank you very much for using Q-Chem&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># If this is an opt job, we must also check that the max num of cycles hasn&#39;t been reached,</span>
                    <span class="c1"># so don&#39;t break yet.</span>
                    <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_type</span> <span class="ow">and</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_type</span> <span class="ow">and</span> <span class="s1">&#39;ts&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_type</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;SCF failed&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SCF&#39;</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;SCF failed&#39;</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s1">&#39;DIIS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1"># These are **normal** lines that we should not capture:</span>
                    <span class="c1"># &quot;SCF converges when DIIS error is below 1.0E-08&quot;, or</span>
                    <span class="c1"># &quot;Cycle       Energy         DIIS Error&quot;</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SCF&#39;</span><span class="p">,</span> <span class="s1">&#39;DIIS&#39;</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;SCF failed&#39;</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;Invalid charge/multiplicity combination&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SpeciesError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The multiplicity and charge combination for species &#39;</span>
                                       <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">species_label</span><span class="si">}</span><span class="s1"> are wrong.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">in</span> <span class="n">job_type</span> <span class="ow">or</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">in</span> <span class="n">job_type</span> <span class="ow">or</span> <span class="s1">&#39;ts&#39;</span> <span class="ow">in</span> <span class="n">job_type</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;MAXIMUM OPTIMIZATION CYCLES REACHED&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MaxOptCycles&#39;</span><span class="p">]</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Maximum optimization cycles reached.&#39;</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;OPTIMIZATION CONVERGED&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">done</span><span class="p">:</span>  <span class="c1"># `done` should already be assigned</span>
                        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">error</span> <span class="k">if</span> <span class="n">error</span> <span class="k">else</span> <span class="s1">&#39;QChem job terminated for an unknown reason.&#39;</span>
            <span class="n">keywords</span> <span class="o">=</span> <span class="n">keywords</span> <span class="k">if</span> <span class="n">keywords</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;Unknown&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="s1">&#39;errored&#39;</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">line</span>

        <span class="k">elif</span> <span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;orca&#39;</span><span class="p">:</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reverse_lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;ORCA TERMINATED NORMALLY&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1"># not done yet, things can still go wrong (e.g., SCF energy might blow up)</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">forward_lines</span><span class="p">):</span>
                        <span class="k">if</span> <span class="s1">&#39;Starting incremental Fock matrix formation&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
                            <span class="k">while</span> <span class="ow">not</span> <span class="n">is_str_float</span><span class="p">(</span><span class="n">forward_lines</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]):</span>
                                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">scf_energy_initial_iteration</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">forward_lines</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="s1">&#39;TOTAL SCF ENERGY&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
                            <span class="c1"># this value is very close to the scf energy at last iteration and is easier to parse</span>
                            <span class="n">scf_energy_last_iteration</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">forward_lines</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>
                            <span class="k">break</span>
                    <span class="c1"># Check if final SCF energy makes sense</span>
                    <span class="n">scf_energy_ratio</span> <span class="o">=</span> <span class="n">scf_energy_last_iteration</span> <span class="o">/</span> <span class="n">scf_energy_initial_iteration</span>
                    <span class="n">scf_energy_ratio_threshold</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># it is rare that this ratio &gt; 2</span>
                    <span class="k">if</span> <span class="n">scf_energy_ratio</span> <span class="o">&gt;</span> <span class="n">scf_energy_ratio_threshold</span><span class="p">:</span>
                        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SCF&#39;</span><span class="p">]</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;The SCF energy seems diverged during iterations. SCF energy after initial &#39;</span> \
                                <span class="sa">f</span><span class="s1">&#39;iteration is </span><span class="si">{</span><span class="n">scf_energy_initial_iteration</span><span class="si">}</span><span class="s1">. SCF energy after final iteration &#39;</span> \
                                <span class="sa">f</span><span class="s1">&#39;is </span><span class="si">{</span><span class="n">scf_energy_last_iteration</span><span class="si">}</span><span class="s1">. The ratio between final and initial SCF energy &#39;</span> \
                                <span class="sa">f</span><span class="s1">&#39;is </span><span class="si">{</span><span class="n">scf_energy_ratio</span><span class="si">}</span><span class="s1">. This ratio is greater than the default threshold of &#39;</span> \
                                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">scf_energy_ratio_threshold</span><span class="si">}</span><span class="s1">. Please consider using alternative methods or larger &#39;</span> \
                                <span class="sa">f</span><span class="s1">&#39;basis sets.&#39;</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;ORCA finished by error termination in SCF&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SCF&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reverse_lines</span><span class="p">):</span>
                        <span class="k">if</span> <span class="s1">&#39;Please increase MaxCore&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># e.g., Please increase MaxCore to more than: 289 MB</span>
                                <span class="n">estimated_mem</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="mi">500</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Insufficient job memory.&#39;</span>
                                <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Memory&#39;</span><span class="p">)</span>
                                <span class="k">break</span>
                            <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Memory&#39;</span><span class="p">)</span>
                            <span class="c1"># e.g., Error (ORCA_SCF): Not enough memory available!</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">reverse_lines</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                            <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Orca suggests to increase per cpu core memory to </span><span class="si">{</span><span class="n">estimated_mem</span><span class="si">}</span><span class="s1"> MB.&#39;</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;SCF error in Orca.&#39;</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;ORCA finished by error termination in MDCI&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MDCI&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reverse_lines</span><span class="p">):</span>
                        <span class="k">if</span> <span class="s1">&#39;Please increase MaxCore&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
                            <span class="n">estimated_mem_list</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">reverse_lines</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;Please increase MaxCore&#39;</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="c1"># e.g., Please increase MaxCore - by at least ( 9717.9 MB)</span>
                                        <span class="c1"># This message appears multiple times, and suggests different memory at each</span>
                                        <span class="c1"># appearance. Need to store all suggested memory values, and then pick the</span>
                                        <span class="c1"># largest one. This error msg appears in Orca version 4.2.x</span>
                                        <span class="n">estimated_mem</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
                                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                        <span class="c1"># e.g., Please increase MaxCore</span>
                                        <span class="c1"># In old Orca versions, there is no indication on the minimum memory requirement</span>
                                        <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Insufficient job memory.&#39;</span>
                                        <span class="k">break</span>
                                    <span class="n">estimated_mem_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">estimated_mem</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">estimated_mem_list</span><span class="p">:</span>
                                <span class="n">estimated_max_mem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">estimated_mem_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">500</span>
                                <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Orca suggests to increase per cpu core memory to </span><span class="si">{</span><span class="n">estimated_max_mem</span><span class="si">}</span><span class="s1"> MB.&#39;</span>
                            <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Memory&#39;</span><span class="p">)</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">info</span>
                            <span class="k">break</span>
                        <span class="k">elif</span> <span class="s1">&#39;parallel calculation exceeds number of pairs&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># e.g., Error (ORCA_MDCI): Number of processes (16) in parallel calculation exceeds</span>
                                <span class="c1"># number of pairs (10) - error msg in Orca version 4.2.x</span>
                                <span class="n">max_core</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;()&#39;</span><span class="p">))</span>
                                <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Orca cannot utilize cpu cores more than electron pairs in a molecule. The &#39;</span> \
                                        <span class="sa">f</span><span class="s1">&#39;maximum number of cpu cores can be used for this job is </span><span class="si">{</span><span class="n">max_core</span><span class="si">}</span><span class="s1">.&#39;</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="c1"># e.g., Error (ORCA_MDCI): Number of processes in parallel calculation exceeds</span>
                                <span class="c1"># number of pairs - error msg in Orca version 4.1.x</span>
                                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Orca cannot utilize cpu cores more than electron pairs in a molecule. ARC &#39;</span> \
                                        <span class="s1">&#39;will estimate the number of cpu cores needed based on the number of heavy &#39;</span> \
                                        <span class="s1">&#39;atoms in the molecule.&#39;</span>
                            <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">info</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;MDCI error in Orca. Assuming memory allocation error.&#39;</span>
                        <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Memory&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;Error : multiplicity&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Input&#39;</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;The multiplicity and charge combination for species </span><span class="si">{</span><span class="n">species_label</span><span class="si">}</span><span class="s1"> are wrong.&#39;</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;UNRECOGNIZED OR DUPLICATED KEYWORD&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1"># e.g., UNRECOGNIZED OR DUPLICATED KEYWORD(S) IN SIMPLE INPUT LINE</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Syntax&#39;</span><span class="p">]</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">reverse_lines</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># this line in the log file suggests which keyword might be problematic</span>
                    <span class="n">problematic_keyword</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;There was keyword syntax error in the Orca input file. In particular, keywords &#39;</span> \
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">problematic_keyword</span><span class="si">}</span><span class="s1"> can either be duplicated or illegal. Please check your Orca &#39;</span> \
                            <span class="sa">f</span><span class="s1">&#39;input file template under arc/job/inputs.py. Alternatively, perhaps the level of &#39;</span> \
                            <span class="sa">f</span><span class="s1">&#39;theory or the job option is not supported by Orca in the format it was given.&#39;</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;There are no CABS&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1"># e.g., ** There are no CABS   basis functions on atom number   2 (Br) **</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Basis&#39;</span><span class="p">]</span>
                    <span class="n">problematic_atom</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;()&#39;</span><span class="p">)</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;There was a basis set error in the Orca input file. In particular, basis for atom type &#39;</span> \
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">problematic_atom</span><span class="si">}</span><span class="s1"> is missing. Please check if specified basis set supports this atom.&#39;</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;This wavefunction IS NOT FULLY CONVERGED!&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Convergence&#39;</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Specified wavefunction method is not converged. Please restart calculation with larger &#39;</span> \
                            <span class="s1">&#39;max iterations or with different convergence flags.&#39;</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;ORCA finished by error termination in GTOInt&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;GTOInt error in Orca. Assuming memory allocation error.&#39;</span>
                    <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;GTOInt&#39;</span><span class="p">)</span>
                    <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Memory&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">error</span> <span class="k">if</span> <span class="n">error</span> <span class="k">else</span> <span class="s1">&#39;Orca job terminated for an unknown reason.&#39;</span>
            <span class="n">keywords</span> <span class="o">=</span> <span class="n">keywords</span> <span class="k">if</span> <span class="n">keywords</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;Unknown&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="s1">&#39;errored&#39;</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">line</span>

        <span class="k">elif</span> <span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;molpro&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">reverse_lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;molpro calculation terminated&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> \
                        <span class="ow">or</span> <span class="s1">&#39;variable memory released&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">return</span> <span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(),</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;No convergence&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s1">&#39;?No convergence in rhfpr&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Unconverged&#39;</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Unconverged&#39;</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;error exit can be avoided using the IGNORE_ERROR option on the ORBITAL directive&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;IGNORE_ERROR in the ORBITAL directive&#39;</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Unconverged&#39;</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;A further&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s1">&#39;Mwords of memory are needed&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s1">&#39;Increase memory to&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1"># e.g.: `A further 246.03 Mwords of memory are needed for the triples to run.</span>
                    <span class="c1"># Increase memory to 996.31 Mwords.` (w/o the line break)</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Memory&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">line0</span> <span class="ow">in</span> <span class="n">reverse_lines</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39; For full I/O&#39;</span> <span class="ow">in</span> <span class="n">line0</span> <span class="ow">and</span> <span class="s1">&#39;increase memory by&#39;</span> <span class="ow">in</span> <span class="n">line0</span> <span class="ow">and</span> <span class="s1">&#39;Mwords to&#39;</span> <span class="ow">in</span> <span class="n">line0</span><span class="p">:</span>
                            <span class="n">memory_increase</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[\d.]+&quot;</span><span class="p">,</span> <span class="n">line0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Additional memory required: </span><span class="si">{</span><span class="n">memory_increase</span><span class="si">}</span><span class="s2"> MW&quot;</span>
                            <span class="k">break</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Additional memory required: </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1"> MW&#39;</span> <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="n">error</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;insufficient memory available - require&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1"># e.g.: `insufficient memory available - require              228765625  have</span>
                    <span class="c1">#        62928590</span>
                    <span class="c1">#        the request was for real words`</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Memory&#39;</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Additional memory required: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e6</span><span class="si">}</span><span class="s1"> MW&#39;</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;Insufficient memory to allocate&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s1">&#39;The problem occurs in memory&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1"># e.g.: `Insufficient memory to allocate a new array of length 321843600 8-byte words</span>
                    <span class="c1">#        The problem occurs in memory`</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Memory&#39;</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Additional memory required&#39;</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;Basis library exhausted&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1"># e.g.:</span>
                    <span class="c1"># ` SETTING BASIS          =    6-311G**</span>
                    <span class="c1">#</span>
                    <span class="c1">#</span>
                    <span class="c1">#  Using spherical harmonics</span>
                    <span class="c1">#</span>
                    <span class="c1">#  LIBRARY EXHAUSTED</span>
                    <span class="c1">#   Searching for I  S 6-311G</span>
                    <span class="c1">#   Library contains the following bases:</span>
                    <span class="c1">#  ? Error</span>
                    <span class="c1">#  ? Basis library exhausted</span>
                    <span class="c1">#  ? The problem occurs in Binput`</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BasisSet&#39;</span><span class="p">]</span>
                    <span class="n">basis_set</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">line0</span> <span class="ow">in</span> <span class="n">reverse_lines</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;SETTING BASIS&#39;</span> <span class="ow">in</span> <span class="n">line0</span><span class="p">:</span>
                            <span class="n">basis_set</span> <span class="o">=</span> <span class="n">line0</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Unrecognized basis set </span><span class="si">{</span><span class="n">basis_set</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;the problem occurs&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Unknown&#39;</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>
                    <span class="k">break</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">error</span> <span class="k">if</span> <span class="n">error</span> <span class="k">else</span> <span class="s1">&#39;Molpro job terminated for an unknown reason.&#39;</span>
            <span class="n">keywords</span> <span class="o">=</span> <span class="n">keywords</span> <span class="k">if</span> <span class="n">keywords</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;Unknown&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="s1">&#39;errored&#39;</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">line</span>

        <span class="k">elif</span> <span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;terachem&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;Job finished:&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(),</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;incorrect method&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;IncorrectMethod&#39;</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;incorrect method&#39;</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;error: &#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="c1"># e.g.: &quot;ERROR: Closed shell calculations can&#39;t have spin multiplicity 0.&quot;</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Unknown&#39;</span><span class="p">]</span>  <span class="c1"># Todo</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39;unable to open file: &#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;basis&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="c1"># e.g.: &quot;Unable to open file /&lt;..path..&gt;/TeraChem/basis/6-311++g[d,p]&quot;</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MissingBasisSet&#39;</span><span class="p">]</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Could not find basis set </span><span class="si">{0}</span><span class="s1"> in TeraChem&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                             <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">))</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">error</span> <span class="k">if</span> <span class="n">error</span> <span class="k">else</span> <span class="s1">&#39;TeraChem job terminated for an unknown reason.&#39;</span>
            <span class="n">keywords</span> <span class="o">=</span> <span class="n">keywords</span> <span class="k">if</span> <span class="n">keywords</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;Unknown&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="s1">&#39;errored&#39;</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">line</span>

    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(),</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span></div>


<div class="viewcode-block" id="determine_job_log_memory_issues"><a class="viewcode-back" href="../../../api/trsh.html#arc.job.trsh.determine_job_log_memory_issues">[docs]</a><span class="k">def</span> <span class="nf">determine_job_log_memory_issues</span><span class="p">(</span><span class="n">job_log</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the reason that caused an ESS job to crash, assign error keywords for troubleshooting.</span>

<span class="sd">    Args:</span>
<span class="sd">        job_log (str, optional): The path to the server job log file (not the ESS output file) or its content.</span>

<span class="sd">    Returns: Tuple[List[str], str, str]</span>
<span class="sd">        - The standardized error keywords.</span>
<span class="sd">        - A description of the error.</span>
<span class="sd">        - The parsed line from the ESS output file indicating the error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keywords</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">job_log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">job_log</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">job_log</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">job_log</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">mem_usage</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;MemoryUsage of job&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="c1"># E.g.: &quot;      3162  -  MemoryUsage of job (MB)&quot;</span>
                <span class="n">mem_usage</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;, used only </span><span class="si">{</span><span class="mf">0.001</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1"> GB&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;memory exceeded&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Memory&#39;</span><span class="p">]</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Insufficient job memory.&#39;</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="s1">&#39;using less than&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s1">&#39;percent of requested&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="c1"># e.g., &quot;using less than 20 percent of requested&quot;</span>
                <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Memory&#39;</span><span class="p">]</span>
                <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Memory requested is too high</span><span class="si">{</span><span class="n">mem_usage</span><span class="si">}</span><span class="s1">.&#39;</span>
                <span class="k">break</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="k">if</span> <span class="n">error</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="k">return</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">line</span></div>


<div class="viewcode-block" id="trsh_negative_freq"><a class="viewcode-back" href="../../../api/trsh.html#arc.job.trsh.trsh_negative_freq">[docs]</a><span class="k">def</span> <span class="nf">trsh_negative_freq</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">log_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">neg_freqs_trshed</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">job_types</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Troubleshooting cases where non-TS species have negative frequencies.</span>
<span class="sd">    We take +/-1.1 displacements, generating several new initial geometries.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species label.</span>
<span class="sd">        log_file (str): The frequency job log file.</span>
<span class="sd">        neg_freqs_trshed (list, optional): A list of negative frequencies the species was troubleshooted for.</span>
<span class="sd">        job_types (list, optional): The job types used for ARC, e.g., [&#39;opt&#39;, &#39;rotors&#39;].</span>

<span class="sd">    Todo:</span>
<span class="sd">        * get all torsions of the molecule (if weren&#39;t already generated),</span>
<span class="sd">          identify atom/s with largest displacements (top 2)</span>
<span class="sd">          determine torsions with unique PIVOTS where these atoms are in the &quot;scan&quot; and &quot;top&quot; but not pivotal</span>
<span class="sd">          generate a 360 scan using 30 deg increments and append all 12 results as conformers</span>
<span class="sd">          (consider rotor symmetry to append less conformers?)</span>

<span class="sd">    Returns: Tuple[list, list, list, list]</span>
<span class="sd">        - The current troubleshooted negative frequencies.</span>
<span class="sd">        - The new conformers to try optimizing.</span>
<span class="sd">        - Errors to report.</span>
<span class="sd">        - Warnings to report.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TrshError: If a negative frequency could not be determined.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">neg_freqs_trshed</span> <span class="o">=</span> <span class="n">neg_freqs_trshed</span> <span class="k">if</span> <span class="n">neg_freqs_trshed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">job_types</span> <span class="o">=</span> <span class="n">job_types</span> <span class="k">if</span> <span class="n">job_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;rotors&#39;</span><span class="p">]</span>
    <span class="n">output_errors</span><span class="p">,</span> <span class="n">output_warnings</span><span class="p">,</span> <span class="n">conformers</span><span class="p">,</span> <span class="n">current_neg_freqs_trshed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">]</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="n">factors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">max_times_to_trsh_neg_freq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">freqs</span><span class="p">,</span> <span class="n">normal_modes_disp</span> <span class="o">=</span> <span class="n">parse_normal_mode_displacement</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">log_file</span><span class="p">,</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">normal_modes_disp</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not troubleshoot negative frequency for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">output_errors</span><span class="p">,</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_trshed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_times_to_trsh_neg_freq</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> was troubleshooted for negative frequencies too many times.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;rotors&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_types</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;The rotor scans feature is turned off, &#39;</span>
                         <span class="s1">&#39;cannot troubleshoot geometry using dihedral modifications.&#39;</span><span class="p">)</span>
            <span class="n">output_warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rotors = False; &#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalidating species.&#39;</span><span class="p">)</span>
        <span class="n">output_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Error: Encountered negative frequencies too many times; Invalidating species; &#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">neg_freqs_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># store indices w.r.t. vibfreqs</span>
        <span class="n">largest_neg_freq_idx</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># index in vibfreqs</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">freqs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">neg_freqs_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">freqs</span><span class="p">[</span><span class="n">largest_neg_freq_idx</span><span class="p">]:</span>
                    <span class="n">largest_neg_freq_idx</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># assuming frequencies are ordered, break after the first positive freq encountered</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">freqs</span><span class="p">[</span><span class="n">largest_neg_freq_idx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TrshError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine a negative frequency for species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;while troubleshooting for it.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_trshed</span><span class="p">):</span>
            <span class="c1"># species has one negative frequency, and has not been troubleshooted for it before</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> has a negative frequency (</span><span class="si">{</span><span class="n">freqs</span><span class="p">[</span><span class="n">largest_neg_freq_idx</span><span class="p">]</span><span class="si">}</span><span class="s1">). Perturbing its &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;geometry using the respective vibrational normal mode displacement(s), &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;using an amplitude of </span><span class="si">{</span><span class="n">factor</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="n">neg_freqs_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">largest_neg_freq_idx</span><span class="p">]</span>  <span class="c1"># indices of the negative frequencies to troubleshoot for</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> \
                <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vf</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-04</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-02</span><span class="p">)</span> <span class="k">for</span> <span class="n">vf</span> <span class="ow">in</span> <span class="n">neg_freqs_trshed</span><span class="p">])</span> \
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_trshed</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">factors</span><span class="p">):</span>
            <span class="c1"># Species has one negative frequency, and has been troubleshooted for it before.</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">factors</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_trshed</span><span class="p">)]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> has a negative frequency (</span><span class="si">{</span><span class="n">freqs</span><span class="p">[</span><span class="n">largest_neg_freq_idx</span><span class="p">]</span><span class="si">}</span><span class="s1">) for the &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">get_number_with_ordinal_indicator</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_trshed</span><span class="p">))</span><span class="si">}</span><span class="s1"> time. &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;Perturbing its geometry using the respective vibrational &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;normal mode displacement(s), this time using a larger factor (x </span><span class="si">{</span><span class="n">factor</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="n">neg_freqs_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">largest_neg_freq_idx</span><span class="p">]</span>  <span class="c1"># indices of the negative frequencies to troubleshoot for</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vf</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-04</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-02</span><span class="p">)</span>
                                                 <span class="k">for</span> <span class="n">vf</span> <span class="ow">in</span> <span class="n">neg_freqs_trshed</span><span class="p">]):</span>
            <span class="c1"># species has more than one negative frequency, and has not been troubleshooted for it before</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_idx</span><span class="p">)</span><span class="si">}</span><span class="s1"> negative frequencies. Perturbing its geometry using &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;the vibrational normal mode displacement(s) of its largest negative frequency, &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">freqs</span><span class="p">[</span><span class="n">largest_neg_freq_idx</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">neg_freqs_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">largest_neg_freq_idx</span><span class="p">]</span>  <span class="c1"># indices of the negative frequencies to troubleshoot for</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vf</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-04</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-02</span><span class="p">)</span>
                                             <span class="k">for</span> <span class="n">vf</span> <span class="ow">in</span> <span class="n">neg_freqs_trshed</span><span class="p">]):</span>
            <span class="c1"># species has more than one negative frequency, and has been troubleshooted for it before</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_idx</span><span class="p">)</span><span class="si">}</span><span class="s1"> negative frequencies. Perturbing its geometry &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;using the vibrational normal mode displacement(s) of ALL negative frequencies&#39;</span><span class="p">)</span>
        <span class="c1"># Convert a numpy array to a list, important for saving the neg_freqs_trshed species attribute in the restart</span>
        <span class="n">freqs_list</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">current_neg_freqs_trshed</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">freqs_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">neg_freqs_idx</span><span class="p">]</span>  <span class="c1"># record trshed negative freqs</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">parse_xyz_from_file</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">neg_freq_idx</span> <span class="ow">in</span> <span class="n">neg_freqs_idx</span><span class="p">:</span>
            <span class="n">xyz_1</span><span class="p">,</span> <span class="n">xyz_2</span> <span class="o">=</span> <span class="n">displace_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="n">normal_modes_disp</span><span class="p">[</span><span class="n">neg_freq_idx</span><span class="p">],</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">factor</span><span class="p">)</span>
            <span class="n">conformers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz_1</span><span class="p">)</span>
            <span class="n">conformers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz_2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">current_neg_freqs_trshed</span><span class="p">,</span> <span class="n">conformers</span><span class="p">,</span> <span class="n">output_errors</span><span class="p">,</span> <span class="n">output_warnings</span></div>


<div class="viewcode-block" id="trsh_scan_job"><a class="viewcode-back" href="../../../api/trsh.html#arc.job.trsh.trsh_scan_job">[docs]</a><span class="k">def</span> <span class="nf">trsh_scan_job</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">scan_res</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                  <span class="n">scan</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                  <span class="n">scan_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                  <span class="n">methods</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                  <span class="n">log_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Troubleshooting rotor scans.</span>
<span class="sd">    Using the following methods:</span>

<span class="sd">    1. freeze specific internal coordinates identified by scan_quality_check()</span>
<span class="sd">    2. freeze all torsions other than the rotor to be scanned</span>
<span class="sd">    3. increasing the scan resolution</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species label.</span>
<span class="sd">        scan_res (int, float): The scan resolution in degrees.</span>
<span class="sd">        scan (list): The four atom indices representing the torsion to be troubleshooted.</span>
<span class="sd">        scan_list (list): Entries are the four-atom scan lists (1-indexed) of all torsions</span>
<span class="sd">                          (without duplicate pivots) in this species.</span>
<span class="sd">        methods (dict): The troubleshooting method/s to try. Example::</span>

<span class="sd">                            {&#39;inc_res&#39;: None,</span>
<span class="sd">                             &#39;freeze&#39;: &#39;all&#39; or [[1, 2, 3, 4], ...]}</span>

<span class="sd">        log_file (str, optional): The related output file path.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TrshError:</span>

<span class="sd">            1. ``scan`` is not included in the ``scan_list``</span>
<span class="sd">            2. Freeze method includes an invalid internal coordinates.</span>
<span class="sd">            3. Freeze method does not provide any solution.</span>

<span class="sd">        InputError: Invalid `methods` input.</span>

<span class="sd">    Returns: Tuple[str, int]</span>
<span class="sd">        - The scan troubleshooting keywords to be appended to the Gaussian input file.</span>
<span class="sd">        - The new scan resolution in degrees.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">scan</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scan_list</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">TrshError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not find the scan to troubleshoot in the scan list of species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">methods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Expected to get a dict of methods, got None.&#39;</span><span class="p">)</span>

    <span class="c1"># Method 1 and method 2</span>
    <span class="k">if</span> <span class="s1">&#39;freeze&#39;</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
        <span class="c1"># 1. Freeze specific internal coordinates identified by scan_quality_check()</span>
        <span class="k">if</span> <span class="n">methods</span><span class="p">[</span><span class="s1">&#39;freeze&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">scan_args</span> <span class="o">=</span> <span class="n">parse_scan_args</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Cannot read scan arguments, fall back to freeze all torsions</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not use freeze method for troubleshooting scan &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;job for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> with the current ESS.</span><span class="se">\n</span><span class="s1">Got:</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">methods</span><span class="p">[</span><span class="s1">&#39;freeze&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># methods = {&#39;freeze&#39;: [[1,2,3,4], ...]}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">methods</span><span class="p">[</span><span class="s1">&#39;freeze&#39;</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Could not use freeze method for troubleshooting scan job &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> as no information is given.&#39;</span><span class="p">)</span>
                <span class="n">problematic_ic</span> <span class="o">=</span> <span class="n">methods</span><span class="p">[</span><span class="s1">&#39;freeze&#39;</span><span class="p">]</span>
                <span class="c1"># Read internal coordinates already frozen from the previous job</span>
                <span class="n">already_frozen</span> <span class="o">=</span> <span class="n">scan_args</span><span class="p">[</span><span class="s1">&#39;freeze&#39;</span><span class="p">]</span>
                <span class="n">to_freeze</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># 1.1 Extract to-be-frozen bonds and angles, no need to prune:</span>
                <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">problematic_ic</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">to_freeze</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">TrshError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;Could not use freeze method for troubleshooting scan job for &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> as invalid internal coordinate </span><span class="si">{</span><span class="n">ic</span><span class="si">}</span><span class="s1"> is given.&#39;</span><span class="p">)</span>
                <span class="c1"># Remove bonds and angles in the problematic_ic</span>
                <span class="n">problematic_ic</span> <span class="o">=</span> <span class="p">[</span><span class="n">ic</span> <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">problematic_ic</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">]</span>

                <span class="c1"># 1.2 First treat torsions that share the same pivots as the scanned rotor.</span>
                <span class="c1">#     They cannot be frozen, so they need special treatments.</span>
                <span class="n">to_freeze_tmp</span> <span class="o">=</span> <span class="n">trsh_special_rotor</span><span class="p">(</span><span class="n">special_rotor</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span>
                                                   <span class="n">problematic_ic</span><span class="o">=</span><span class="n">problematic_ic</span><span class="p">,</span>
                                                   <span class="n">special_type</span><span class="o">=</span><span class="s1">&#39;scan&#39;</span><span class="p">)</span>
                <span class="n">to_freeze</span> <span class="o">+=</span> <span class="n">to_freeze_tmp</span>

                <span class="c1"># 1.3 Treat torsions which are frozen in the previous run. For some torsions, although</span>
                <span class="c1">#     one of the dihedrals are frozen, other dihedrals could be still problematic.</span>
                <span class="k">for</span> <span class="n">frozen_ic</span> <span class="ow">in</span> <span class="n">already_frozen</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frozen_ic</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">to_freeze_tmp</span> <span class="o">=</span> <span class="n">trsh_special_rotor</span><span class="p">(</span><span class="n">special_rotor</span><span class="o">=</span><span class="n">frozen_ic</span><span class="p">,</span>
                                                           <span class="n">problematic_ic</span><span class="o">=</span><span class="n">problematic_ic</span><span class="p">,</span>
                                                           <span class="n">special_type</span><span class="o">=</span><span class="s1">&#39;frozen&#39;</span><span class="p">)</span>
                        <span class="n">to_freeze</span> <span class="o">+=</span> <span class="n">to_freeze_tmp</span>

                <span class="c1"># 1.4 For other dihedrals, if encountering torsions with the same pivots</span>
                <span class="c1">#     just freeze the one first seen.</span>
                <span class="n">pruning</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">problematic_ic</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">pruning</span> \
                            <span class="ow">or</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">to_freeze</span> \
                            <span class="ow">or</span> <span class="n">torsion</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">to_freeze</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">to_freeze</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torsion</span><span class="p">)</span>
                    <span class="n">pruning</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ic</span> <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">problematic_ic</span> <span class="k">if</span> <span class="n">is_same_pivot</span><span class="p">(</span><span class="n">torsion</span><span class="p">,</span> <span class="n">ic</span><span class="p">)]</span>

        <span class="c1"># 2. Freeze all torsions other than the rotor to be scanned</span>
        <span class="k">if</span> <span class="n">methods</span><span class="p">[</span><span class="s1">&#39;freeze&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">scan_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">scan_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">scan</span><span class="p">))</span>
            <span class="n">to_freeze</span> <span class="o">=</span> <span class="n">scan_list</span>
            <span class="n">already_frozen</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Check the solution quality, should not include already frozen ics</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_freeze</span><span class="p">):</span>
            <span class="c1"># Start with problematic ICs, but cannot come up with a good solution.</span>
            <span class="k">raise</span> <span class="n">TrshError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Freeze method does not yield a solution for rotor &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;scan on </span><span class="si">{</span><span class="n">scan</span><span class="si">}</span><span class="s1"> of </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

        <span class="c1"># Convert to_freeze into an input block str</span>
        <span class="n">to_freeze</span> <span class="o">+=</span> <span class="n">already_frozen</span>
        <span class="n">software</span> <span class="o">=</span> <span class="n">determine_ess</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
        <span class="n">scan_trsh</span> <span class="o">=</span> <span class="n">ics_to_scan_constraints</span><span class="p">(</span><span class="n">ics</span><span class="o">=</span><span class="n">to_freeze</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">software</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If &#39;freeze&#39; is not included in the method</span>
        <span class="n">scan_trsh</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># 3. Increasing the scan resolution</span>
    <span class="k">if</span> <span class="s1">&#39;inc_res&#39;</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
        <span class="n">scan_res</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">scan_res</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="c1"># make sure mod(360, scan res) is 0:</span>
        <span class="k">if</span> <span class="n">scan_res</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">scan_res</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">scan_res</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">scan_trsh</span><span class="p">,</span> <span class="n">scan_res</span></div>


<div class="viewcode-block" id="trsh_special_rotor"><a class="viewcode-back" href="../../../api/trsh.html#arc.job.trsh.trsh_special_rotor">[docs]</a><span class="k">def</span> <span class="nf">trsh_special_rotor</span><span class="p">(</span><span class="n">special_rotor</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                       <span class="n">problematic_ic</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                       <span class="n">special_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;scan&#39;</span><span class="p">,</span>
                       <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Troubleshoot special rotor cases given all problematic torsional internal</span>
<span class="sd">    coordinates. Special rotors include rotor to be scanned and rotor already frozen.</span>
<span class="sd">    For example: If scan = [1, 2, 3, 4], `scan_quality_check()` might find [1, 2, 3, 5]</span>
<span class="sd">    problematic. However, we cannot simply freeze [1, 2, 3, 5] which definitely makes</span>
<span class="sd">    the scan failed. `trsh_special_rotor()` helps figure out the internal coordinates</span>
<span class="sd">    we need to actually freeze to troubleshoot the scan.</span>

<span class="sd">    Args:</span>
<span class="sd">        special_rotor (list): A list of four atoms indicating the special torsion</span>
<span class="sd">        problematic_ic (list): A list of torsions identified as problematic by</span>
<span class="sd">                               check_scan_quality. This list will be pruned.</span>
<span class="sd">        special_type: Indicate the type of the special rotor. Either ``scan`` for</span>
<span class="sd">                      the rotor to be scanned or `frozen` for the rotor were frozen</span>
<span class="sd">                      in the previous job</span>

<span class="sd">    Returns: list</span>
<span class="sd">        A list of internal coordinates to be frozen</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pruning</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">same_pivots_torsions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">to_freeze</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Find the torsion sharing three common atoms with the special_rotor</span>
    <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">problematic_ic</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">special_rotor</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">or</span> <span class="n">torsion</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">special_rotor</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">torsion</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">special_rotor</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="c1"># special_rotor = [1, 2, 3, 4],  torsion = [5, 2, 3, 4], freeze [5, 1, 2, 3] (top alignment)</span>
                <span class="c1"># to avoid flip</span>
                <span class="n">to_freeze</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">special_rotor</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="c1"># remove all [5, 2, 1, *] or [*, 1, 2, 5] or [1, 2, 5, *] or [*, 5, 2, 1]</span>
                <span class="n">sublist</span> <span class="o">=</span> <span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">special_rotor</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">special_rotor</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># special_rotor = [1, 2, 3, 4],  ic = [1, 2, 3, 5], freeze[2, 3, 4, 5] to avoid flip</span>
                <span class="n">to_freeze</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">special_rotor</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                <span class="c1"># remove all [*, 4, 3, 5] or [4, 3, 5, *] or [*, 5, 3, 4] or [5, 3, 4, *]</span>
                <span class="n">sublist</span> <span class="o">=</span> <span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">special_rotor</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">special_rotor</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">pruning</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ic</span> <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">problematic_ic</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">is_same_pivot</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">special_rotor</span><span class="p">)</span>
                            <span class="ow">or</span> <span class="n">is_same_sequence_sublist</span><span class="p">(</span><span class="n">sublist</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
                            <span class="ow">or</span> <span class="n">is_same_sequence_sublist</span><span class="p">(</span><span class="n">sublist</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ic</span><span class="p">))]</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">is_same_pivot</span><span class="p">(</span><span class="n">torsion</span><span class="p">,</span> <span class="n">special_rotor</span><span class="p">):</span>
            <span class="n">same_pivots_torsions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torsion</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># The following block will be executed only when bond break</span>
        <span class="c1"># is not triggered and same_pivots_torsions is not empty.</span>
        <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">same_pivots_torsions</span><span class="p">:</span>
            <span class="n">pruning</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torsion</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">special_type</span> <span class="o">==</span> <span class="s1">&#39;scan&#39;</span><span class="p">:</span>
                <span class="c1"># A rare case which might be due to a double flip of adjacent sp2 atoms.</span>
                <span class="c1"># Freeze alignments of both tops.</span>
                <span class="n">to_freeze</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">special_rotor</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">to_freeze</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">special_rotor</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">torsion</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">elif</span> <span class="n">special_type</span> <span class="o">==</span> <span class="s1">&#39;frozen&#39;</span><span class="p">:</span>
                <span class="c1"># If no better solution, just freeze all the torsions of the same pivots.</span>
                <span class="n">to_freeze</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torsion</span><span class="p">)</span>
    <span class="c1"># Remove pruned internal coordinates from the problematic_ic list.</span>
    <span class="k">for</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">pruning</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">torsion</span> <span class="ow">in</span> <span class="n">problematic_ic</span><span class="p">:</span>
            <span class="n">problematic_ic</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">problematic_ic</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">torsion</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">to_freeze</span></div>


<div class="viewcode-block" id="trsh_ess_job"><a class="viewcode-back" href="../../../api/trsh.html#arc.job.trsh.trsh_ess_job">[docs]</a><span class="k">def</span> <span class="nf">trsh_ess_job</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">level_of_theory</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Level</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                 <span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">job_status</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                 <span class="n">job_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">software</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">fine</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                 <span class="n">memory_gb</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">num_heavy_atoms</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">cpu_cores</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">ess_trsh_methods</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                 <span class="n">is_h</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Troubleshoot issues related to the electronic structure software, such as convergence.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species label.</span>
<span class="sd">        level_of_theory (Union[Level, dict, str]): The original level of theory dictionary of the problematic job.</span>
<span class="sd">        server (str): The server used for this job.</span>
<span class="sd">        job_status (dict): The ESS job status dictionary with standardized error keywords</span>
<span class="sd">                           as generated using the `determine_ess_status` function.</span>
<span class="sd">        job_type (str): The original job type.</span>
<span class="sd">        software (str): The ESS software.</span>
<span class="sd">        fine (bool): Whether the job used an ultrafine grid, `True` if it did.</span>
<span class="sd">        memory_gb (float): The memory in GB used for the job.</span>
<span class="sd">        num_heavy_atoms (int): Number of heavy atoms in a molecule.</span>
<span class="sd">        cpu_cores (int): The total number of cpu cores requested for a job.</span>
<span class="sd">        ess_trsh_methods (list): The troubleshooting methods tried for this job.</span>
<span class="sd">        is_h (bool): Whether the species is a hydrogen atom (or its isotope). e.g., H, D, T.</span>

<span class="sd">    Todo:</span>
<span class="sd">        - Change server to one that has the same ESS if running out of disk space.</span>

<span class="sd">    Returns: tuple</span>
<span class="sd">        - output_errors (list): Errors to report.</span>
<span class="sd">        - ess_trsh_methods (list): The updated troubleshooting methods tried for this job.</span>
<span class="sd">        - remove_checkfile (bool): Whether to remove the checkfile from the job, `True` to remove.</span>
<span class="sd">        - level_of_theory (Level): The new level of theory dictionary to use.</span>
<span class="sd">        - software (str, optional): The new ESS software to use.</span>
<span class="sd">        - job_type (str): The new job type to use.</span>
<span class="sd">        - fine (bool): whether the new job should use a fine grid, `True` if it should.</span>
<span class="sd">        - trsh_keyword (str): The troubleshooting keyword to use.</span>
<span class="sd">        - memory (float): The new memory in GB to use for the job.</span>
<span class="sd">        - shift (str): The shift to use (only in Molpro).</span>
<span class="sd">        - cpus (int): The total number of cpu cores requested for a job.</span>
<span class="sd">        - couldnt_trsh (bool): Whether a troubleshooting solution was found. `True` if it was not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">level_of_theory</span> <span class="o">=</span> <span class="n">Level</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">)</span>
    <span class="n">output_errors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">remove_checkfile</span><span class="p">,</span> <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
    <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
    <span class="n">memory</span> <span class="o">=</span> <span class="n">memory_gb</span>

    <span class="k">if</span> <span class="n">server</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;memory&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">servers</span><span class="p">[</span><span class="n">server</span><span class="p">]:</span>
        <span class="n">servers</span><span class="p">[</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;memory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">64</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;A &quot;memory&quot; key (relating to the *maximum* physical node memory) was not defined &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;for server </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s1">. Setting it to 64 GB (as a guess). This will affect job troubleshooting &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;methods which attempt to increase the job memory. This value should be specified in the &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;servers dictionary in settings.py&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;DiskSpace&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]:</span>
        <span class="n">output_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error: Could not troubleshoot </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">! &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;The job ran out of disc space on </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s1">; &#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not troubleshoot </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">! The job ran out of disc space on </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="s1">&#39;BasisSet&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span>\
            <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;Unrecognized basis set&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
                 <span class="ow">or</span> <span class="s1">&#39;is not appropriate for the this chemistry&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]):</span>
        <span class="n">output_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error: Could not recognize basis set </span><span class="si">{</span><span class="n">job_status</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">software</span><span class="si">}</span><span class="s1">; &#39;</span><span class="p">)</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> job in </span><span class="si">{</span><span class="n">software</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> that failed with &#39;</span>
                    <span class="s1">&#39;&quot;Basis set data is not on the checkpoint file&quot; by removing the checkfile.&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
        <span class="n">trsh_keyword</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># initialize as a list</span>
        <span class="n">logger_phrase</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Troubleshooting </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> job in </span><span class="si">{</span><span class="n">software</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">logger_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">fine</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">attempted_ess_trsh_methods</span> <span class="o">=</span> <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">ess_trsh_methods</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="c1"># Check if Checkfile removal is in the keywords. Removal occurs when:</span>
        <span class="c1"># - Basis Set Mismatch</span>
        <span class="c1"># - Corrupt or Incomplete Data</span>
        <span class="c1"># - Changing Computational Parameters</span>
        <span class="n">remove_checkfile</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="n">trsh_keyword_checkfile</span><span class="p">(</span><span class="n">job_status</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">couldnt_trsh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove_checkfile</span><span class="p">:</span>
             <span class="n">logger_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;that failed with &quot;Basis set data is not on the checkpoint file&quot; by removing the checkfile.&#39;</span><span class="p">)</span>

        <span class="c1"># Check if InternalCoordinateError is in the keyword or opt=(cartesian)</span>
        <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="n">trsh_keyword_cartesian</span><span class="p">(</span><span class="n">job_status</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span><span class="n">couldnt_trsh</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;cartesian&#39;</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="n">logger_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;using opt=cartesian&#39;</span><span class="p">)</span>
        <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="n">trsh_keyword_intaccuracy</span><span class="p">(</span><span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">couldnt_trsh</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;int=(Acc2E=14)&#39;</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
           <span class="n">logger_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;using int=(Acc2E=14)&#39;</span><span class="p">)</span>

        <span class="c1"># Check if SCF is in the keyword</span>
        <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="n">trsh_keyword_scf</span><span class="p">(</span><span class="n">job_status</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">couldnt_trsh</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;scf=(NDamp=30)&#39;</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="n">logger_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;using scf=(NDamp=30)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;scf=(qc)&#39;</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="n">logger_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;using scf=(qc)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;scf=(NoDIIS)&#39;</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="n">logger_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;using scf=(NoDIIS)&#39;</span><span class="p">)</span>

        <span class="c1"># Check if NoSymm</span>
        <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="n">trsh_keyword_nosymm</span><span class="p">(</span><span class="n">job_status</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">couldnt_trsh</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;NoSymm&#39;</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="n">logger_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;using nosymm&#39;</span><span class="p">)</span>

        <span class="c1"># Check if unconverged is in the keyword</span>
        <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">fine</span><span class="p">,</span> <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="n">trsh_keyword_unconverged</span><span class="p">(</span><span class="n">job_status</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">couldnt_trsh</span><span class="p">,</span> <span class="n">fine</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fine</span><span class="p">:</span>
            <span class="n">logger_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;using a fine grid&#39;</span><span class="p">)</span>


        <span class="c1"># Check if memory is in the keyword</span>
        <span class="k">if</span> <span class="s1">&#39;Memory&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;too high&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">server</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Increase memory allocation</span>
            <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">max_mem</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="n">server</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>  <span class="c1"># Node memory in GB, defaults to 128 if not specified</span>
            <span class="n">memory</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">memory_gb</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">max_mem</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">memory</span> <span class="o">&gt;</span> <span class="n">memory_gb</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> job in </span><span class="si">{</span><span class="n">software</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> using more memory: </span><span class="si">{</span><span class="n">memory</span><span class="si">}</span><span class="s1"> GB &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;instead of </span><span class="si">{</span><span class="n">memory_gb</span><span class="si">}</span><span class="s1"> GB&#39;</span><span class="p">)</span>
                <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">attempted_ess_trsh_methods</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attempted_ess_trsh_methods</span> <span class="o">==</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">logger_phrase</span><span class="si">}</span><span class="s1"> was not successful. Already attempted all possible troubleshooting methods. Will not troubleshoot again.&#39;</span><span class="p">)</span>
                <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">logger_info</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">logger_phrase</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logger_info</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">logger_info</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">logger_phrase</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logger_info</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;MaxOptCycles&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;max_cycles&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="c1"># this is a common error, increase max cycles and continue running from last geometry</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> job in </span><span class="si">{</span><span class="n">software</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> using max_cycles&#39;</span><span class="p">)</span>
            <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;max_cycles&#39;</span><span class="p">)</span>
            <span class="n">trsh_keyword</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   GEOM_OPT_MAX_CYCLES 250&#39;</span>  <span class="c1"># default is 50</span>
        <span class="k">elif</span> <span class="s1">&#39;SCF&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;DIIS_GDM&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="c1"># change the SCF algorithm and increase max SCF cycles</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> job in </span><span class="si">{</span><span class="n">software</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> using the DIIS_GDM SCF algorithm&#39;</span><span class="p">)</span>
            <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;DIIS_GDM&#39;</span><span class="p">)</span>
            <span class="n">trsh_keyword</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   SCF_ALGORITHM DIIS_GDM</span><span class="se">\n</span><span class="s1">   MAX_SCF_CYCLES 1000&#39;</span>  <span class="c1"># default is 50</span>
        <span class="k">elif</span> <span class="s1">&#39;SYM_IGNORE&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>  <span class="c1"># symmetry - look in manual, no symm if fails</span>
            <span class="c1"># change the SCF algorithm and increase max SCF cycles</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> job in </span><span class="si">{</span><span class="n">software</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> using SYM_IGNORE as well as the &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;DIIS_GDM SCF algorithm&#39;</span><span class="p">)</span>
            <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;SYM_IGNORE&#39;</span><span class="p">)</span>
            <span class="n">trsh_keyword</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   SCF_ALGORITHM DIIS_GDM</span><span class="se">\n</span><span class="s1">   MAX_SCF_CYCLES 250</span><span class="se">\n</span><span class="s1">   SYM_IGNORE     True&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">elif</span> <span class="s1">&#39;orca&#39;</span> <span class="ow">in</span> <span class="n">software</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;Memory&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]:</span>
            <span class="c1"># Increase memory allocation.</span>
            <span class="c1"># job_status will be for example</span>
            <span class="c1"># `Error  (ORCA_SCF): Not enough memory available! Please increase MaxCore to more than: 289 MB`.</span>
            <span class="k">if</span> <span class="s1">&#39;memory&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># parse Orca&#39;s memory requirement in MB</span>
                <span class="n">estimated_mem_per_core</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">estimated_mem_per_core</span> <span class="o">=</span> <span class="n">estimate_orca_mem_cpu_requirement</span><span class="p">(</span><span class="n">num_heavy_atoms</span><span class="o">=</span><span class="n">num_heavy_atoms</span><span class="p">,</span>
                                                                           <span class="n">server</span><span class="o">=</span><span class="n">server</span><span class="p">,</span>
                                                                           <span class="n">consider_server_limits</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">cpu_cores</span>
            <span class="c1"># round up to the next hundred</span>
            <span class="n">estimated_mem_per_core</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">estimated_mem_per_core</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="k">if</span> <span class="s1">&#39;max_total_job_memory&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]:</span>
                <span class="n">per_cpu_core_memory</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">memory_gb</span> <span class="o">/</span> <span class="n">cpu_cores</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The crashed Orca job </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> was ran with </span><span class="si">{</span><span class="n">cpu_cores</span><span class="si">}</span><span class="s1"> cpu cores and &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">per_cpu_core_memory</span><span class="si">}</span><span class="s1"> MB memory per cpu core. It requires at least &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">estimated_mem_per_core</span><span class="si">}</span><span class="s1"> MB per cpu core. Since the job had already requested the &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;maximum amount of available total node memory, ARC will attempt to reduce the number &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;of cpu cores to increase memory per cpu core.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;cpu&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
                    <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
                <span class="n">cpu_cores</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">cpu_cores</span> <span class="o">*</span> <span class="n">per_cpu_core_memory</span> <span class="o">/</span> <span class="n">estimated_mem_per_core</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>  <span class="c1"># be conservative</span>
                <span class="k">if</span> <span class="n">cpu_cores</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting job </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> using </span><span class="si">{</span><span class="n">cpu_cores</span><span class="si">}</span><span class="s1"> cpu cores.&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">cpu_cores</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># last resort</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting job </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> using only </span><span class="si">{</span><span class="n">cpu_cores</span><span class="si">}</span><span class="s1"> cpu core. Notice that the &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;required job time may be unrealistically long or exceed limits on servers.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not enough computational resource to accomplish job </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">. Please consider cheaper &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;methods or allocate more resources if possible.&#39;</span><span class="p">)</span>
                    <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">couldnt_trsh</span><span class="p">:</span>
                <span class="n">memory</span> <span class="o">=</span> <span class="n">estimated_mem_per_core</span> <span class="o">*</span> <span class="n">cpu_cores</span>  <span class="c1"># total memory for all cpu cores</span>
                <span class="n">memory</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">memory</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># convert MB to GB, add 5 extra GB (be conservative)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> job in </span><span class="si">{</span><span class="n">software</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> using </span><span class="si">{</span><span class="n">memory</span><span class="si">}</span><span class="s1"> GB total memory &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;and </span><span class="si">{</span><span class="n">cpu_cores</span><span class="si">}</span><span class="s1"> cpu cores.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;cpu&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]:</span>
            <span class="c1"># Reduce cpu allocation.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># job_status will be for example (Orca varsion 4.2.x)</span>
                <span class="c1"># Error (ORCA_MDCI): Number of processes (16) in parallel calculation exceeds number of pairs (10)</span>
                <span class="n">cpu_cores</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>  <span class="c1"># max_cpu_cores_allowed</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">cpu_cores</span> <span class="o">=</span> <span class="n">estimate_orca_mem_cpu_requirement</span><span class="p">(</span><span class="n">num_heavy_atoms</span><span class="o">=</span><span class="n">num_heavy_atoms</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="n">server</span><span class="p">,</span>
                                                              <span class="n">consider_server_limits</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> job in </span><span class="si">{</span><span class="n">software</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> using </span><span class="si">{</span><span class="n">cpu_cores</span><span class="si">}</span><span class="s1"> cpu cores.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;cpu&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;dlpno&#39;</span> <span class="ow">in</span> <span class="n">level_of_theory</span><span class="o">.</span><span class="n">method</span> <span class="ow">and</span> <span class="n">is_h</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;DLPNO method is not supported for H atom (or its isotope D or T) in Orca.&#39;</span><span class="p">)</span>
            <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">elif</span> <span class="s1">&#39;molpro&#39;</span> <span class="ow">in</span> <span class="n">software</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;Memory&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]:</span>
            <span class="c1"># Increase memory allocation.</span>
            <span class="c1"># molpro gives something like `&#39;errored: additional memory (mW) required: 996.31&#39;`.</span>
            <span class="c1"># job_status standardizes the format to be:  `&#39;Additional memory required: {0} MW&#39;`</span>
            <span class="c1"># The number is the ADDITIONAL memory required in GB</span>
            <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">)</span>
            <span class="n">add_mem_str</span> <span class="o">=</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># parse Molpro&#39;s requirement in MW</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">add_mem_str</span><span class="p">):</span>
                <span class="n">add_mem</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">add_mem_str</span><span class="p">)</span>
                <span class="n">add_mem</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">add_mem</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># round up to the next hundred</span>
                <span class="n">memory</span> <span class="o">=</span> <span class="n">memory_gb</span> <span class="o">+</span> <span class="n">add_mem</span> <span class="o">/</span> <span class="mf">128.</span> <span class="o">+</span> <span class="mi">5</span>  <span class="c1"># convert MW to GB, add 5 extra GB (be conservative)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The required memory is not specified</span>
                <span class="n">memory</span> <span class="o">=</span> <span class="n">memory_gb</span> <span class="o">*</span> <span class="mi">3</span>  <span class="c1"># convert MW to GB, add 5 extra GB (be conservative)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> job in </span><span class="si">{</span><span class="n">software</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> using memory: </span><span class="si">{</span><span class="n">memory</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> GB &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;instead of </span><span class="si">{</span><span class="n">memory_gb</span><span class="si">}</span><span class="s1"> GB&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;shift&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="c1"># Try adding a level shift for alpha- and beta-spin orbitals</span>
            <span class="c1"># Applying large negative level shifts like {rhf; shift,-1.0,-0.5}</span>
            <span class="c1"># will often stabilize convergence at the expense of making it somewhat slower.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> job in </span><span class="si">{</span><span class="n">software</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> using shift&#39;</span><span class="p">)</span>
            <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;shift&#39;</span><span class="p">)</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="s1">&#39;shift,-1.0,-0.5;&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;vdz&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="c1"># degrade the basis set</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> job in </span><span class="si">{</span><span class="n">software</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> using vdz&#39;</span><span class="p">)</span>
            <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;vdz&#39;</span><span class="p">)</span>
            <span class="n">trsh_keyword</span> <span class="o">=</span> <span class="s1">&#39;vdz&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;vdz &amp; shift&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="c1"># try adding a level shift for alpha- and beta-spin orbitals</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> job in </span><span class="si">{</span><span class="n">software</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> using vdz&#39;</span><span class="p">)</span>
            <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;vdz &amp; shift&#39;</span><span class="p">)</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="s1">&#39;shift,-1.0,-0.5;&#39;</span>
            <span class="n">trsh_keyword</span> <span class="o">=</span> <span class="s1">&#39;vdz&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;memory&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="c1"># Increase memory allocation, also run with a shift</span>
            <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">)</span>
            <span class="n">memory</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;memory&#39;</span><span class="p">]</span>  <span class="c1"># set memory to the value of an entire node (in GB)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> job in </span><span class="si">{</span><span class="n">software</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> using memory: </span><span class="si">{</span><span class="n">memory</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> GB &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;instead of </span><span class="si">{</span><span class="n">memory_gb</span><span class="si">}</span><span class="s1"> GB&#39;</span><span class="p">)</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="s1">&#39;shift,-1.0,-0.5;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">elif</span> <span class="s1">&#39;terachem&#39;</span> <span class="ow">in</span> <span class="n">software</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        scf diis+a</span>
<span class="sd">        maxit 50</span>

<span class="sd">        solve in freq:</span>
<span class="sd">        Maximum gradient component at reference geometry: 2.19e-02</span>
<span class="sd">        Maximum component of gradient is too large</span>
<span class="sd">        Optimize the geometry and try again</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Troubleshooting methods are not implemented for </span><span class="si">{</span><span class="n">software</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">couldnt_trsh</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not troubleshoot geometry optimization for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">! &#39;</span>
                     <span class="sa">f</span><span class="s1">&#39;Tried troubleshooting with the following methods: </span><span class="si">{</span><span class="n">ess_trsh_methods</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">output_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error: Could not troubleshoot </span><span class="si">{</span><span class="n">job_type</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">! &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;Tried troubleshooting with the following methods: </span><span class="si">{</span><span class="n">ess_trsh_methods</span><span class="si">}</span><span class="s1">; &#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">output_errors</span><span class="p">,</span>
            <span class="n">ess_trsh_methods</span><span class="p">,</span>
            <span class="n">remove_checkfile</span><span class="p">,</span>
            <span class="n">level_of_theory</span><span class="p">,</span>
            <span class="n">software</span><span class="p">,</span>
            <span class="n">job_type</span><span class="p">,</span>
            <span class="n">fine</span><span class="p">,</span>
            <span class="n">trsh_keyword</span><span class="p">,</span>
            <span class="n">memory</span><span class="p">,</span>
            <span class="n">shift</span><span class="p">,</span>
            <span class="n">cpu_cores</span><span class="p">,</span>
            <span class="n">couldnt_trsh</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="trsh_conformer_isomorphism"><a class="viewcode-back" href="../../../api/trsh.html#arc.job.trsh.trsh_conformer_isomorphism">[docs]</a><span class="k">def</span> <span class="nf">trsh_conformer_isomorphism</span><span class="p">(</span><span class="n">software</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="n">ess_trsh_methods</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Troubleshoot conformer optimization for a species that failed isomorphic test in</span>
<span class="sd">    `determine_most_stable_conformer` by specifying a &quot;good&quot; level of theory.</span>

<span class="sd">    Args:</span>
<span class="sd">        software (str): The ESS used.</span>
<span class="sd">        ess_trsh_methods (list, optional): The troubleshooting methods tried for this job.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TrshError: If the requested ``ess_trsh_methods`` is not supported.</span>

<span class="sd">    Returns: Optional[str]</span>
<span class="sd">        The level of theory to troubleshoot at.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ess_trsh_methods</span> <span class="o">=</span> <span class="n">ess_trsh_methods</span> <span class="k">if</span> <span class="n">ess_trsh_methods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
        <span class="n">conformer_trsh_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;wb97xd/def2TZVP&#39;</span><span class="p">,</span> <span class="s1">&#39;apfd/def2TZVP&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
        <span class="n">conformer_trsh_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;wb97x-d3/def2-TZVP&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;orca&#39;</span><span class="p">:</span>
        <span class="n">conformer_trsh_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;wB97X-D3/def2-TZVP&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;terachem&#39;</span><span class="p">:</span>
        <span class="n">conformer_trsh_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;wb97xd3/def2-TZVP&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The troubleshoot_conformer_isomorphism() method is not implemented for </span><span class="si">{</span><span class="n">software</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">level_of_theory</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">conformer_trsh_methods</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;conformer &#39;</span> <span class="o">+</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;conformer &#39;</span> <span class="o">+</span> <span class="n">method</span><span class="p">)</span>
        <span class="n">level_of_theory</span> <span class="o">=</span> <span class="n">method</span>
        <span class="k">break</span>
    <span class="k">return</span> <span class="n">level_of_theory</span></div>

<div class="viewcode-block" id="trsh_job_queue"><a class="viewcode-back" href="../../../api/trsh.html#arc.job.trsh.trsh_job_queue">[docs]</a><span class="k">def</span> <span class="nf">trsh_job_queue</span><span class="p">(</span><span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">job_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">max_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
                    <span class="n">attempted_queues</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot; A function to troubleshoot job queue issues. This function will attempt to determine if the user has provided a queue that provides more time than the walltime failed queue.</span>
<span class="sd">        If not, it will attempt to determine if there are any other queues available on the server that provide more time than the walltime failed queue.</span>

<span class="sd">    Args:</span>
<span class="sd">        server (str): Name of the server</span>
<span class="sd">        job_name (str): Name of the job</span>
<span class="sd">        max_time (int, optional): The max time that the current queue that the job failed on provied. Defaults to 24, measured in hours.</span>
<span class="sd">        attempted_queues (list, optional): Any queues that have already been attempted to run the job on. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[dict, bool]: A dictionary of the available queues and a boolean indicating if the function was successful.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">server_queues</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="n">server</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;queues&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>
    <span class="n">cluster_soft</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="n">server</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">,</span><span class="s1">&#39;Undefined&#39;</span><span class="p">)</span>
    <span class="n">excluded_queues</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="n">server</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;excluded_queues&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">())</span>

    <span class="c1"># Check if there are any available queues in server_queues that hasn&#39;t been tried yet</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">server_queues</span><span class="p">)</span> <span class="o">&gt;</span>  <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Make sure that the queue is not already in the attempted_queues list</span>
        <span class="n">server_queues</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">queue</span><span class="p">:</span> <span class="n">walltime</span> <span class="k">for</span> <span class="n">queue</span><span class="p">,</span> <span class="n">walltime</span> <span class="ow">in</span> <span class="n">server_queues</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">attempted_queues</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">queue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attempted_queues</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">convert_to_hours</span><span class="p">(</span><span class="n">walltime</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_time</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">server_queues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; Could not troubleshoot </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> on </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s1"> as all available queues have been tried. Will attempt to query the server for additional queues.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">server_queues</span><span class="p">,</span> <span class="kc">True</span>
    <span class="c1"># If the server is PBS, query which queues are available</span>
    <span class="k">if</span> <span class="n">cluster_soft</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pbs&#39;</span><span class="p">:</span>
        <span class="c1"># First determine which group the current user belongs to</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;groups&#39;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">execute_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;Error&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not troubleshoot </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> on </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s1"> as the groups command failed.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ([&#39;users zeus-users vkm-users gaussian grinberg-dana_prj docker&#39;], [])</span>
            <span class="n">user_groups</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not troubleshoot </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> on </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s1"> as the groups command did not return any groups.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>
            <span class="c1"># check if the term &#39;-users&#39; is in the group name, if so, remove it</span>
            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="s1">&#39;-users&#39;</span> <span class="ow">in</span> <span class="n">group</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">user_groups</span><span class="p">):</span>
                <span class="n">user_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-users&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">user_groups</span><span class="p">]</span>
        <span class="c1"># Now query the queues</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;qstat -q&#39;</span>
        <span class="n">output_queues</span> <span class="o">=</span> <span class="n">execute_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;Error&#39;</span> <span class="ow">in</span> <span class="n">output_queues</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not troubleshoot </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> on </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s1"> as the qstat command failed.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Need to parse output</span>
            <span class="c1"># Example:</span>
            <span class="c1">#             Queue            Memory CPU Time Walltime Node   Run   Que   Lm  State</span>
            <span class="c1"># ---------------- ------ -------- -------- ---- ----- ----- ----  -----</span>
            <span class="c1"># workq              --      --       --     --      0     0   --   D S</span>
            <span class="c1"># maytal_q           --      --       --     --      7     0   --   E R</span>
            <span class="c1"># vkm_all_q          --      --       --     --      0     0   --   D R</span>
            <span class="c1"># zeus_temp          --      --    24:00:00  --      0     0   --   D S</span>
            <span class="c1"># dagan_q            --      --       --     --      0     0   --   E R</span>
            <span class="c1"># frankel_q          --      --       --     --      0     0   --   E R</span>
            <span class="c1"># vkm_gm_q           --      --       --     --      0     0   --   E R</span>
            <span class="c1"># zeus_all_scalar    --      --    24:00:00  --      0     0   --   D S</span>
            <span class="c1"># yuval_q            --      --       --     --      0     0   --   E R</span>
            <span class="c1"># dan_q              --      --       --     --      7     0   --   E R</span>
            <span class="c1"># zeus_all_q         --      --    24:00:00  --      4     0   --   E R</span>
            <span class="c1"># zeus_long_q        --      --    168:00:0  --      0     0   --   E R</span>
            <span class="c1"># zeus_short_q       --      --    03:00:00  --      0     0   --   E R</span>
            <span class="c1"># gpu_v100_q         --      --    480:00:0  --      0     0   --   E R</span>
            <span class="c1"># brandon_q          --      --       --     --      0     0   --   E R</span>
            <span class="c1"># karp_q             --      --       --     --      0     0   --   E R</span>
            <span class="c1"># mafat_gm_q         --      --       --     --      0     0   --   E R</span>
            <span class="c1"># training_q         --      --    24:00:00  --      0     0   --   E R</span>
            <span class="c1"># mafat4_q           --      --       --     --      0     0   --   D R</span>
            <span class="c1"># zeus_new_q         --      --    72:00:00  --      0     0   --   E R</span>
            <span class="c1"># zeus_combined_q    --      --    24:00:00  --     17     0   --   E R</span>
            <span class="c1"># zeus_comb_short    --      --    03:00:00  --      0     0   --   E R</span>
            <span class="c1"># mafat_new_q        --      --       --     --     46     0   --   E R</span>
            <span class="c1"># dagan_comb_q       --      --       --     --      0     0   --   E R</span>
            <span class="c1"># dan_comb_q         --      --       --     --      0     0   --   E R</span>
            <span class="c1"># karp_comb_q        --      --       --     --      0     0   --   D R</span>
            <span class="c1"># brandon_comb_q     --      --       --     --      0     0   --   E R</span>
            <span class="c1"># train_gpu_q        --      --    24:00:00  --      0     0   --   E R</span>
            <span class="c1">#                                                ----- -----</span>
            <span class="c1">#                                                   81     0</span>
            <span class="c1"># 1. Get the queue names in the first column, and check if the state is &#39;E&#39; (enabled) or &#39;D&#39; (disabled) - Select only enabled queues</span>
            <span class="c1"># 2. Once we have a list of queues, we need to make sure we can submit to them. We can do this by check qstat -Qf &lt;queue_name&gt; and see output of acl_groups</span>
            <span class="c1"># 3. We also need to get the wall time for each queue</span>
            <span class="n">queues</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output_queues</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Queue&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;----&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;server&#39;</span><span class="p">):</span>
                    <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">9</span> <span class="ow">and</span> <span class="n">parts</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span>
                        <span class="n">queue_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">acl_groups</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;qstat -Qf </span><span class="si">{</span><span class="n">queue_name</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="n">output_specific_queue</span> <span class="o">=</span> <span class="n">execute_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="c1"># Parse Example:</span>
                        <span class="c1">#</span>
                        <span class="c1"># Queue: mafat_new_q</span>
                        <span class="c1"># queue_type = Execution</span>
                        <span class="c1"># total_jobs = 44</span>
                        <span class="c1"># state_count = Transit:0 Queued:0 Held:0 Waiting:0 Running:44 Exiting:0 Begu</span>
                        <span class="c1"># n:0</span>
                        <span class="c1"># resources_default.walltime = 3600:00:00</span>
                        <span class="c1"># acl_group_enable = True</span>
                        <span class="c1"># acl_groups = grinberg-dana_prj,halupovich_prj,yuvallevy_prj</span>
                        <span class="c1"># default_chunk.qlist = mafat_new_q</span>
                        <span class="c1"># resources_assigned.mem = 376625977kb</span>
                        <span class="c1"># resources_assigned.mpiprocs = 132</span>
                        <span class="c1"># resources_assigned.ncpus = 3254</span>
                        <span class="c1"># resources_assigned.nodect = 47</span>
                        <span class="c1"># max_run_res.ncpus = [o:PBS_ALL=3584]</span>
                        <span class="c1"># enabled = True</span>
                        <span class="c1"># started = True</span>
                        <span class="k">for</span> <span class="n">line_queue</span> <span class="ow">in</span> <span class="n">output_specific_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="c1"># Check walltime</span>
                            <span class="k">if</span> <span class="n">line_queue</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;resources_default.walltime&#39;</span><span class="p">):</span>
                                <span class="n">walltime</span> <span class="o">=</span> <span class="n">line_queue</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="n">queues</span><span class="p">[</span><span class="n">queue_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">walltime</span>
                            <span class="k">if</span> <span class="n">line_queue</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;acl_groups&#39;</span><span class="p">):</span>
                                <span class="n">acl_groups</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">groups</span> <span class="o">=</span> <span class="n">line_queue</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">group</span> <span class="ow">in</span> <span class="n">user_groups</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">):</span>
                                    <span class="k">break</span>  <span class="c1"># User is in one of the acl_groups, keep the queue</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">queues</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">queue_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># User is not in acl_groups, remove the queue</span>
                                    <span class="k">break</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">group</span> <span class="ow">in</span> <span class="n">queue_name</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">user_groups</span><span class="p">)</span> <span class="ow">and</span> <span class="n">acl_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">queues</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">queue_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Queue name does not contain any of the user&#39;s groups, remove the queue</span>
            <span class="c1"># Check if any of the found queues are part of the excluded queues list</span>
            <span class="k">if</span> <span class="n">excluded_queues</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">queue</span> <span class="ow">in</span> <span class="n">excluded_queues</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">queue</span> <span class="ow">in</span> <span class="n">queues</span><span class="p">:</span>
                        <span class="n">queues</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">queues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not troubleshoot </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> on </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s1"> as no queues were found.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">queues</span><span class="p">,</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not troubleshoot queue for </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> since the server is </span><span class="si">{</span><span class="n">cluster_soft</span><span class="si">}</span><span class="s1"> and not PBS.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="trsh_job_on_server"><a class="viewcode-back" href="../../../api/trsh.html#arc.job.trsh.trsh_job_on_server">[docs]</a><span class="k">def</span> <span class="nf">trsh_job_on_server</span><span class="p">(</span><span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">job_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">job_id</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                       <span class="n">job_server_status</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">remote_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">server_nodes</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Troubleshoot server errors.</span>

<span class="sd">    Args:</span>
<span class="sd">        server (str): The server name.</span>
<span class="sd">        job_name (str): The job&#39;s name (e.g., &#39;opt_a103&#39;).</span>
<span class="sd">        job_id (int, str): The job&#39;s ID on the server.</span>
<span class="sd">        job_server_status (str): The job server status (either &#39;initializing&#39;, &#39;running&#39;, &#39;errored&#39;, or &#39;done&#39;).</span>
<span class="sd">        remote_path (str): The remote path to the job folder.</span>
<span class="sd">        server_nodes (list, optional): The nodes already tried on this server for this job.</span>

<span class="sd">    Returns: Tuple[str, bool]</span>
<span class="sd">        - The new node on the server (or None).</span>
<span class="sd">        - Whether to re-run the job, `True` to rerun.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">server_nodes</span> <span class="o">=</span> <span class="n">server_nodes</span> <span class="k">if</span> <span class="n">server_nodes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">cluster_soft</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">job_server_status</span> <span class="o">!=</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Job </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1"> has server status &quot;</span><span class="si">{</span><span class="n">job_server_status</span><span class="si">}</span><span class="s1">&quot; on </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

    <span class="c1"># delete current server run</span>
    <span class="k">if</span> <span class="n">server</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">delete_command</span><span class="p">[</span><span class="n">cluster_soft</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="n">execute_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">SSHClient</span><span class="p">(</span><span class="n">server</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssh</span><span class="p">:</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">delete_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>

    <span class="c1"># find available node</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Troubleshooting by changing node.&#39;</span><span class="p">)</span>
    <span class="n">ssh</span> <span class="o">=</span> <span class="n">SSHClient</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">list_available_nodes</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">server_nodes</span><span class="p">:</span>
            <span class="n">server_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not find an available node on the server </span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># TODO: continue troubleshooting; if all else fails, put the job to sleep,</span>
        <span class="c1">#       and try again searching for a node</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>

    <span class="c1"># modify the submit file</span>
    <span class="n">remote_submit_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">submit_filenames</span><span class="p">[</span><span class="n">cluster_soft</span><span class="p">])</span>
    <span class="k">with</span> <span class="n">SSHClient</span><span class="p">(</span><span class="n">server</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssh</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">read_remote_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_submit_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cluster_soft</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;oge&#39;</span><span class="p">:</span>
        <span class="n">node_assign</span> <span class="o">=</span> <span class="s1">&#39;#$ -l h=&#39;</span>
        <span class="n">insert_line_num</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="k">elif</span> <span class="n">cluster_soft</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;slurm&#39;</span><span class="p">:</span>
        <span class="n">node_assign</span> <span class="o">=</span> <span class="s1">&#39;#$BATCH -w, --nodelist=&#39;</span>
        <span class="n">insert_line_num</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Other software?</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">denug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown cluster software </span><span class="si">{</span><span class="n">cluster_soft</span><span class="si">}</span><span class="s1"> is encountered when &#39;</span>
                     <span class="sa">f</span><span class="s1">&#39;troubleshooting by changing node.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node_assign</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_assign</span> <span class="o">+</span> <span class="n">node</span>
        <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">content</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">insert_line_num</span><span class="p">,</span> <span class="n">node_assign</span> <span class="o">+</span> <span class="n">node</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>  <span class="c1"># convert list into a single string, not to upset paramiko</span>

    <span class="c1"># resubmit</span>
    <span class="k">with</span> <span class="n">SSHClient</span><span class="p">(</span><span class="n">server</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssh</span><span class="p">:</span>
        <span class="n">ssh</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span>
                        <span class="n">submit_filenames</span><span class="p">[</span><span class="n">cluster_soft</span><span class="p">]),</span> <span class="n">file_string</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">node</span><span class="p">,</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="scan_quality_check"><a class="viewcode-back" href="../../../api/trsh.html#arc.job.trsh.scan_quality_check">[docs]</a><span class="k">def</span> <span class="nf">scan_quality_check</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">pivots</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                       <span class="n">energies</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                       <span class="n">scan_res</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">rotor_scan_resolution</span><span class="p">,</span>
                       <span class="n">used_methods</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">log_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">species</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ARCSpecies</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">preserve_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">trajectory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">original_xyz</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks the scan&#39;s quality:</span>

<span class="sd">    1. Based on intermediate conformers if available:</span>

<span class="sd">       - whether the initial and final points are consistent</span>
<span class="sd">       - whether it is relatively &quot;smooth&quot;</span>

<span class="sd">    2. Based on the PES curve (if intermediate conformers are unavailable):</span>

<span class="sd">       - whether the initial and final points are consistent</span>
<span class="sd">       - whether it is relatively &quot;smooth&quot;</span>

<span class="sd">    3. Common:</span>

<span class="sd">       - whether the optimized geometry indeed represents the minimum energy conformer (for a non-TS species)</span>
<span class="sd">       - whether the barrier height is reasonable</span>

<span class="sd">    4. Based on requested parameters to preserve:</span>

<span class="sd">       - whether specified atom distances to preserve criteria aren&#39;t violated</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The species label.</span>
<span class="sd">        pivots (list): The rotor pivots.</span>
<span class="sd">        energies (list): The scan energies in kJ/mol.</span>
<span class="sd">        scan_res (float, optional): The scan resolution in degrees.</span>
<span class="sd">        used_methods (list, optional): Troubleshooting methods already tried out.</span>
<span class="sd">        log_file (str, optional): The path to the output file.</span>
<span class="sd">        species (ARCSpecies, optional): The ARCSpecies this scan is related to.</span>
<span class="sd">        preserve_params (list, optional): Entries are length 2 lists of atom indices (1-indexed) between which the</span>
<span class="sd">                                          distance as well as a torsion dihedral angle with these atoms as its pivots</span>
<span class="sd">                                          must be preserved throughout the scan to a tolerance.</span>
<span class="sd">        trajectory (list, optional): Entries are Cartesian coordinates along the scan trajectory.</span>
<span class="sd">        original_xyz (dict, optional): The optimized coordinated for the species.</span>

<span class="sd">    Returns: Tuple[bool, str, str, dict]</span>
<span class="sd">        - Whether to invalidate this rotor, ``True`` to invalidate.</span>
<span class="sd">        - Reason for invalidating this rotor.</span>
<span class="sd">        - Error or warning message.</span>
<span class="sd">        - Troubleshooting methods to apply, including conformational changes.</span>

<span class="sd">    Todo:</span>
<span class="sd">        - adjust to ND</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">message</span><span class="p">,</span> <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
    <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">used_methods</span> <span class="o">=</span> <span class="n">used_methods</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">scan_conformers</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Check if the conformer based method is valid</span>
    <span class="k">if</span> <span class="n">log_file</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">scan_conformers</span> <span class="o">=</span> <span class="n">parse_scan_conformers</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Rotor scan quality check using conformer internal coordinates &#39;</span> \
                      <span class="sa">f</span><span class="s1">&#39;has not been implemented for current ESS. Using PES curve based &#39;</span> \
                      <span class="sa">f</span><span class="s1">&#39;check for rotor scan of </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> between pivots </span><span class="si">{</span><span class="n">pivots</span><span class="si">}</span><span class="s1">.&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="c1"># 1. Check based on intermediate conformers</span>
    <span class="k">if</span> <span class="n">scan_conformers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">species</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">species</span><span class="o">.</span><span class="n">is_ts</span><span class="p">):</span>
        <span class="n">bonds</span> <span class="o">=</span> <span class="n">scan_conformers</span><span class="p">[</span><span class="n">scan_conformers</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;R&#39;</span><span class="p">]</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">scan_conformers</span><span class="p">[</span><span class="n">scan_conformers</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">]</span>
        <span class="n">non_scan_rotor</span> <span class="o">=</span> <span class="n">scan_conformers</span><span class="p">[(</span><span class="n">scan_conformers</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">scan_conformers</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)]</span>
        <span class="n">scan_rotor</span> <span class="o">=</span> <span class="n">scan_conformers</span><span class="p">[</span><span class="n">scan_conformers</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>

        <span class="c1"># 1.1 Find significant changes of internal coordinates</span>
        <span class="n">expected_step_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">360</span> <span class="o">/</span> <span class="n">scan_res</span><span class="p">)</span>
        <span class="c1"># 5 below refers to type, atoms, scan, redundant and initial guess</span>
        <span class="n">actual_step_num</span> <span class="o">=</span> <span class="n">scan_conformers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span>
        <span class="n">step_num</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">expected_step_num</span><span class="p">,</span> <span class="n">actual_step_num</span><span class="p">)</span>
        <span class="n">changed_ic_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">index_1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">step_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index_1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Compare the &#39;adjacent&#39; conformers</span>
                <span class="n">index_2</span> <span class="o">=</span> <span class="n">index_1</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">scan_res</span>  <span class="c1"># scan[index_1] - scan[index_2] = scan_res</span>
            <span class="k">elif</span> <span class="n">step_num</span> <span class="o">==</span> <span class="n">expected_step_num</span><span class="p">:</span>
                <span class="c1"># Compare the first and the last conformer</span>
                <span class="n">index_2</span> <span class="o">=</span> <span class="n">step_num</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># When the scan is not finished as desired</span>
                <span class="k">continue</span>
            <span class="c1"># Identify changes by type</span>
            <span class="n">bond_change</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">bonds</span><span class="p">[</span><span class="n">index_1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bonds</span><span class="p">[</span><span class="n">index_2</span><span class="p">])</span> <span class="o">/</span>
                           <span class="p">(</span><span class="n">bonds</span><span class="p">[</span><span class="n">index_1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bonds</span><span class="p">[</span><span class="n">index_2</span><span class="p">]))</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">preserve_params_in_scan</span><span class="p">[</span><span class="s1">&#39;bond&#39;</span><span class="p">]</span>
            <span class="n">angle_change</span> <span class="o">=</span> <span class="p">(</span><span class="n">angles</span><span class="p">[</span><span class="n">index_1</span><span class="p">]</span> <span class="o">-</span> <span class="n">angles</span><span class="p">[</span><span class="n">index_2</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">preserve_params_in_scan</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">]</span>
            <span class="n">non_scan_rotor_change</span> <span class="o">=</span> <span class="n">check_torsion_change</span><span class="p">(</span><span class="n">torsions</span><span class="o">=</span><span class="n">non_scan_rotor</span><span class="p">,</span>
                                                         <span class="n">index_1</span><span class="o">=</span><span class="n">index_1</span><span class="p">,</span>
                                                         <span class="n">index_2</span><span class="o">=</span><span class="n">index_2</span><span class="p">,</span>
                                                         <span class="n">threshold</span><span class="o">=</span><span class="n">preserve_params_in_scan</span><span class="p">[</span><span class="s1">&#39;dihedral&#39;</span><span class="p">])</span>
            <span class="n">scan_rotor_change</span> <span class="o">=</span> <span class="n">check_torsion_change</span><span class="p">(</span><span class="n">torsions</span><span class="o">=</span><span class="n">scan_rotor</span><span class="p">,</span>
                                                     <span class="n">index_1</span><span class="o">=</span><span class="n">index_1</span><span class="p">,</span>
                                                     <span class="n">index_2</span><span class="o">=</span><span class="n">index_2</span><span class="p">,</span>
                                                     <span class="n">threshold</span><span class="o">=</span><span class="n">preserve_params_in_scan</span><span class="p">[</span><span class="s1">&#39;dihedral&#39;</span><span class="p">],</span>
                                                     <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
            <span class="c1"># Summarize changes</span>
            <span class="n">change_sum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">bond_change</span><span class="p">,</span>
                                    <span class="n">angle_change</span><span class="p">,</span>
                                    <span class="n">non_scan_rotor_change</span><span class="p">,</span>
                                    <span class="n">scan_rotor_change</span><span class="p">])</span>
            <span class="n">changed_ics</span> <span class="o">=</span> <span class="n">change_sum</span><span class="p">[</span><span class="n">change_sum</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="c1"># Save changes in the format of {conformer index: problematic ics}</span>
            <span class="k">if</span> <span class="n">changed_ics</span><span class="p">:</span>
                <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">changed_ic_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">index_1</span><span class="p">:</span> <span class="n">changed_ics</span><span class="p">})</span>

        <span class="c1"># 1.2 Check broken bond and any lowest conformation</span>
        <span class="c1"># Exclude those with broken bonds (different species)</span>
        <span class="c1"># Better to just freeze the broken bond when bond changing first happens</span>
        <span class="k">for</span> <span class="n">conf_index</span><span class="p">,</span> <span class="n">ics</span> <span class="ow">in</span> <span class="n">changed_ic_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># R(X,Y) refers to bonds in ics</span>
            <span class="n">broken_bonds</span> <span class="o">=</span> <span class="p">[</span><span class="n">ic</span> <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">ics</span> <span class="k">if</span> <span class="s1">&#39;R&#39;</span> <span class="ow">in</span> <span class="n">ic</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">broken_bonds</span> <span class="ow">and</span> <span class="n">conf_index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Find the bond that changes the most, to avoid accompanied changes, like C-O transforms</span>
                <span class="c1"># to C=O, which we don&#39;t want to freeze. If other bonds need to be frozen as well,</span>
                <span class="c1"># it can be done in the following troubleshooting.</span>
                <span class="n">bonds</span> <span class="o">=</span> <span class="n">scan_conformers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">broken_bonds</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">bond_change</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">bonds</span><span class="p">[</span><span class="n">conf_index</span><span class="p">]</span> <span class="o">-</span> <span class="n">bonds</span><span class="p">[</span><span class="n">conf_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span>
                               <span class="p">(</span><span class="n">bonds</span><span class="p">[</span><span class="n">conf_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">bonds</span><span class="p">[</span><span class="n">conf_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
                <span class="n">broken_bond_label</span> <span class="o">=</span> <span class="n">bond_change</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># the largest change</span>
                <span class="c1"># Freeze the bonds, no further freezing other ics to prevent over-constraining</span>
                <span class="n">broken_bonds</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan_conformers</span><span class="p">[</span><span class="s1">&#39;atoms&#39;</span><span class="p">][</span><span class="n">broken_bond_label</span><span class="p">]]</span>
                <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bond (</span><span class="si">{</span><span class="n">broken_bonds</span><span class="si">}</span><span class="s1">) broke during the scan.&#39;</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Rotor scan of </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> between pivots </span><span class="si">{</span><span class="n">pivots</span><span class="si">}</span><span class="s1"> has broken bonds: &#39;</span> \
                          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">broken_bonds</span><span class="si">}</span><span class="s1">. ARC will attempt to troubleshoot this rotor scan.&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="n">actions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;freeze&#39;</span><span class="p">:</span> <span class="n">broken_bonds</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">invalidate</span><span class="p">,</span> <span class="n">invalidation_reason</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">actions</span>

        <span class="c1"># If no bond broke, ideally all conformers should be isomorphic.</span>
        <span class="c1"># Switch to the lowest conformer</span>
        <span class="n">energy_diff</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
        <span class="c1"># Use tighter threshold to find lower conformer</span>
        <span class="k">if</span> <span class="n">energy_diff</span> <span class="o">&gt;=</span> <span class="mf">0.5</span> <span class="ow">or</span> <span class="n">energy_diff</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">energies</span><span class="p">))</span> \
                <span class="ow">and</span> <span class="p">(</span><span class="n">species</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">species</span><span class="o">.</span><span class="n">is_ts</span><span class="p">):</span>
            <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Another conformer for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> exists which is &#39;</span> \
                                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">energy_diff</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> kJ/mol lower.&#39;</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> is not oriented correctly around pivots </span><span class="si">{</span><span class="n">pivots</span><span class="si">}</span><span class="s1">, &#39;</span> \
                      <span class="sa">f</span><span class="s1">&#39;searching for a better conformation...&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="c1"># Find the dihedrals in degrees of the lowest conformer:</span>
            <span class="n">min_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
            <span class="n">conf_xyzs</span> <span class="o">=</span> <span class="n">parse_1d_scan_coords</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;change conformer&#39;</span><span class="p">:</span> <span class="n">conf_xyzs</span><span class="p">[</span><span class="n">min_index</span><span class="p">]}</span>
            <span class="k">return</span> <span class="n">invalidate</span><span class="p">,</span> <span class="n">invalidation_reason</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">actions</span>

        <span class="c1"># 1.3 Check consistency</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">changed_ic_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">changed_ic_dict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># A smooth scan with different initial and final conformer.</span>
            <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="s1">&#39;Inconsistent initial and final conformers&#39;</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Rotor scan of </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> between pivots </span><span class="si">{</span><span class="n">pivots</span><span class="si">}</span><span class="s1"> has inconsistent initial &#39;</span> \
                      <span class="sa">f</span><span class="s1">&#39;and final conformers.</span><span class="se">\n</span><span class="s1">Internal coordinates </span><span class="si">{</span><span class="n">changed_ic_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> are different. &#39;</span> \
                      <span class="sa">f</span><span class="s1">&#39;ARC will attempt to troubleshoot this rotor scan.&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;freeze&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">scan_conformers</span><span class="p">[</span><span class="s1">&#39;atoms&#39;</span><span class="p">][</span><span class="n">ic_label</span><span class="p">]</span>
                                  <span class="k">for</span> <span class="n">ic_label</span> <span class="ow">in</span> <span class="n">changed_ic_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">]]}</span>
            <span class="k">return</span> <span class="n">invalidate</span><span class="p">,</span> <span class="n">invalidation_reason</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">actions</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">changed_ic_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Not a smooth scan.</span>
            <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="s1">&#39;Significant difference observed between consecutive conformers&#39;</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Rotor scan of </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> between pivots </span><span class="si">{</span><span class="n">pivots</span><span class="si">}</span><span class="s1"> is inconsistent between &#39;</span> \
                      <span class="sa">f</span><span class="s1">&#39;two consecutive conformers.</span><span class="se">\n</span><span class="s1">Inconsistent consecutive conformers and problematic &#39;</span> \
                      <span class="sa">f</span><span class="s1">&#39;internal coordinates:&#39;</span>
            <span class="n">changed_ic_label</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ics</span> <span class="ow">in</span> <span class="n">changed_ic_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Do not include the initial/final differences which may include more ics</span>
                    <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">conformer #</span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s1">&gt;3d</span><span class="si">}</span><span class="s1"> / #</span><span class="si">{</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s1">&gt;3d</span><span class="si">}</span><span class="s1">        &#39;</span>
                    <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ics</span><span class="p">)</span>
                <span class="n">changed_ic_label</span> <span class="o">+=</span> <span class="n">ics</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ARC will attempt to troubleshoot this rotor scan.&#39;</span>
            <span class="c1"># list(set()) is used to remove duplicate labels</span>
            <span class="n">changed_ic_label</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">changed_ic_label</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;freeze&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">scan_conformers</span><span class="p">[</span><span class="s1">&#39;atoms&#39;</span><span class="p">][</span><span class="n">ic_label</span><span class="p">]</span>
                                  <span class="k">for</span> <span class="n">ic_label</span> <span class="ow">in</span> <span class="n">changed_ic_label</span><span class="p">]}</span>
            <span class="k">return</span> <span class="n">invalidate</span><span class="p">,</span> <span class="n">invalidation_reason</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">actions</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 2. Check rotor scan quality according to the PES curve</span>
        <span class="c1"># 2.1. Check consistency between initial and final points</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">inconsistency_az</span><span class="p">:</span>
            <span class="c1"># initial and final points differ by more than `inconsistency_az` kJ/mol.</span>
            <span class="c1"># seems like this rotor broke the conformer. Invalidate</span>
            <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;initial and final points are inconsistent by more than </span><span class="si">{</span><span class="n">inconsistency_az</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> kJ/mol&#39;</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Rotor scan of </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> between pivots </span><span class="si">{</span><span class="n">pivots</span><span class="si">}</span><span class="s1"> is inconsistent by more &#39;</span> \
                      <span class="sa">f</span><span class="s1">&#39;than </span><span class="si">{</span><span class="n">inconsistency_az</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> kJ/mol between initial and final positions. &#39;</span> \
                      <span class="sa">f</span><span class="s1">&#39;Initial energy = </span><span class="si">{</span><span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, final energy = </span><span class="si">{</span><span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">. ARC will &#39;</span> \
                      <span class="sa">f</span><span class="s1">&#39;attempt to troubleshoot this rotor scan.&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inc_res&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;freeze&#39;</span><span class="p">:</span> <span class="s1">&#39;all&#39;</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">invalidate</span><span class="p">,</span> <span class="n">invalidation_reason</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">actions</span>

        <span class="c1"># 2.2. Check consistency between consecutive points</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">energies</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">energies</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">inconsistency_ab</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">energies</span><span class="p">):</span>
                <span class="c1"># Two consecutive points on the scan differ by more than `inconsistency_ab` kJ/mol.</span>
                <span class="c1"># This is a serious inconsistency. Invalidate</span>
                <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Two consecutive points are inconsistent by more than &#39;</span> \
                                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">inconsistency_ab</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> kJ/mol&#39;</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Rotor scan of </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> between pivots </span><span class="si">{</span><span class="n">pivots</span><span class="si">}</span><span class="s1"> is inconsistent by &#39;</span> \
                          <span class="sa">f</span><span class="s1">&#39;more than </span><span class="si">{</span><span class="n">inconsistency_ab</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> kJ/mol between &#39;</span> \
                          <span class="sa">f</span><span class="s1">&#39;two consecutive points. ARC will attempt to troubleshoot this rotor scan.&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="c1"># Propose a method</span>
                <span class="c1"># Try increasing resolution firstly, and try increasing res. and freezing all</span>
                <span class="c1"># torsions jointly, afterwards.</span>
                <span class="c1"># TODO: If we figure out that solely increasing res. is not effective,</span>
                <span class="c1"># we can simplify the process to actions = {&#39;inc_res&#39;: None, &#39;freeze&#39;: &#39;all&#39;}</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="s1">&#39;scan_res&#39;</span> <span class="ow">in</span> <span class="n">used_method</span> <span class="k">for</span> <span class="n">used_method</span> <span class="ow">in</span> <span class="n">used_methods</span><span class="p">]):</span>
                    <span class="c1"># Check if increasing scan resolution is ever applied</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">used_method</span><span class="p">[</span><span class="s1">&#39;scan_trsh&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">used_method</span> <span class="ow">in</span> <span class="n">used_methods</span><span class="p">]):</span>
                        <span class="c1"># Case where freezing torisions has not been applied</span>
                        <span class="n">actions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inc_res&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;freeze&#39;</span><span class="p">:</span> <span class="s1">&#39;all&#39;</span><span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Since all torsions are frozen, there&#39;s not much we can do except increasing</span>
                        <span class="c1"># scan resolution. But it is not that effective either. So stop and do nothing.</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Case where neither increasing scan resolution nor freezing</span>
                    <span class="c1"># torisions has been applied</span>
                    <span class="n">actions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inc_res&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">invalidate</span><span class="p">,</span> <span class="n">invalidation_reason</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">actions</span>

        <span class="c1"># 2.3 Check energy and change conformation if needed:</span>
        <span class="n">energy_diff</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">energy_diff</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">energy_diff</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">energies</span><span class="p">))</span> \
                <span class="ow">and</span> <span class="p">(</span><span class="n">species</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">species</span><span class="o">.</span><span class="n">is_ts</span><span class="p">):</span>
            <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Another conformer for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> exists which is </span><span class="si">{</span><span class="n">energy_diff</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> kJ/mol lower.&#39;</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Species </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> is not oriented correctly around pivots </span><span class="si">{</span><span class="n">pivots</span><span class="si">}</span><span class="s1">. &#39;</span> \
                      <span class="sa">f</span><span class="s1">&#39;Another conformer exists which is </span><span class="si">{</span><span class="n">energy_diff</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> kJ/mol lower. &#39;</span> \
                      <span class="sa">f</span><span class="s1">&#39;searching for a better conformation...&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="c1"># Find the lowest conformer, and use the new conformer for further jobs.</span>
            <span class="c1"># Since at this point, the scan has passed previous checks, the possibility</span>
            <span class="c1"># to switch to a non-isomorphic conformer is low.</span>
            <span class="n">min_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
            <span class="n">conf_xyzs</span> <span class="o">=</span> <span class="n">parse_1d_scan_coords</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;change conformer&#39;</span><span class="p">:</span> <span class="n">conf_xyzs</span><span class="p">[</span><span class="n">min_index</span><span class="p">]}</span>
            <span class="k">return</span> <span class="n">invalidate</span><span class="p">,</span> <span class="n">invalidation_reason</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">actions</span>

    <span class="c1"># 3. Check the barrier height</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">energies</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">maximum_barrier</span><span class="p">:</span>
        <span class="c1"># The barrier for the internal rotation is higher than `maximum_barrier`</span>
        <span class="n">num_wells</span> <span class="o">=</span> <span class="n">determine_rotor_symmetry</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                             <span class="n">pivots</span><span class="o">=</span><span class="n">pivots</span><span class="p">,</span>
                                             <span class="n">rotor_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                             <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
                                             <span class="n">return_num_wells</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                             <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">num_wells</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;The rotor scan has a barrier of </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> &#39;</span> \
                                  <span class="sa">f</span><span class="s1">&#39;kJ/mol, which is higher than the maximal barrier for rotation &#39;</span> \
                                  <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">maximum_barrier</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> kJ/mol)&#39;</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Rotor scan of </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> between pivots </span><span class="si">{</span><span class="n">pivots</span><span class="si">}</span><span class="s1"> has a barrier &#39;</span> \
                      <span class="sa">f</span><span class="s1">&#39;larger than </span><span class="si">{</span><span class="n">maximum_barrier</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> kJ/mol. Invalidating rotor.&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">invalidate</span><span class="p">,</span> <span class="n">invalidation_reason</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">actions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The maximal barrier for rotor </span><span class="si">{</span><span class="n">pivots</span><span class="si">}</span><span class="s1"> of </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> is &#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">energies</span><span class="p">))</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> kJ/mol, which is higher than the set threshold &#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;of </span><span class="si">{</span><span class="n">maximum_barrier</span><span class="si">}</span><span class="s1"> kJ/mol. Since this mode when treated as torsion has </span><span class="si">{</span><span class="n">num_wells</span><span class="si">}</span><span class="s1">, &#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;this mode is not invalidated: treating it as a vibrational mode will be less accurate than &#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;the hindered rotor treatment, since the entropy contribution from the population of &#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;this species at the higher wells will not be taken into account. NOT invalidating this &#39;</span>
                           <span class="sa">f</span><span class="s1">&#39;torsional mode.&#39;</span><span class="p">)</span>

    <span class="c1"># 4. Check requested atom constraints are preserved (particularly useful for TSs)</span>
    <span class="k">if</span> <span class="n">preserve_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">pivots</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">preserve_params</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trajectory</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># check that the distance between this atom pair is preserved relative to the previous entry</span>
                    <span class="c1"># in the trajectory, as well as relative to the original value (final_xyz).</span>
                    <span class="n">current_distance</span> <span class="o">=</span> <span class="n">calculate_distance</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">previous_distance</span> <span class="o">=</span> <span class="n">calculate_distance</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">trajectory</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">original_distance</span> <span class="o">=</span> <span class="n">calculate_distance</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">original_xyz</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">previous_distance</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">preserve_params_in_scan</span><span class="p">[</span><span class="s1">&#39;bond&#39;</span><span class="p">])</span> <span class="o">&lt;</span> \
                            <span class="n">current_distance</span> <span class="o">&lt;</span> \
                            <span class="n">previous_distance</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">preserve_params_in_scan</span><span class="p">[</span><span class="s1">&#39;bond&#39;</span><span class="p">])</span> \
                            <span class="ow">or</span> <span class="n">original_distance</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">preserve_params_in_scan</span><span class="p">[</span><span class="s1">&#39;bond&#39;</span><span class="p">])</span> <span class="o">&lt;</span> \
                            <span class="n">current_distance</span> <span class="o">&lt;</span> \
                            <span class="n">original_distance</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">preserve_params_in_scan</span><span class="p">[</span><span class="s1">&#39;bond&#39;</span><span class="p">]):</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">pivots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The rotor breaks the TS around pivots </span><span class="si">{</span><span class="n">pivots</span><span class="si">}</span><span class="s2">: In trajectory </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, the distance &quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;between pivots is </span><span class="si">{</span><span class="n">current_distance</span><span class="si">}</span><span class="s2"> Angstroms, which is &quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">current_distance</span> <span class="o">/</span> <span class="n">previous_distance</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> of the previous frame, and &quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">current_distance</span> <span class="o">/</span> <span class="n">original_distance</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> of the original geometry.&quot;</span>
                        <span class="k">break</span>

                    <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">scan</span> <span class="o">=</span> <span class="p">[</span><span class="n">determine_smallest_atom_index_in_scan</span><span class="p">(</span><span class="n">atom1</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                                      <span class="n">atom2</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                                                      <span class="n">mol</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">mol</span><span class="p">)]</span>
                        <span class="n">scan</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
                        <span class="n">scan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">determine_smallest_atom_index_in_scan</span><span class="p">(</span><span class="n">atom1</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                                                  <span class="n">atom2</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                                  <span class="n">mol</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">mol</span><span class="p">))</span>
                        <span class="c1"># check that a dihedral angle with this atom pair as its pivots is preserved relative to the</span>
                        <span class="c1"># previous entry in the trajectory, as well as relative to the original value (final_xyz).</span>
                        <span class="n">current_dihedral</span> <span class="o">=</span> <span class="n">calculate_dihedral_angle</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">torsion</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">previous_dihedral</span> <span class="o">=</span> <span class="n">calculate_dihedral_angle</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">trajectory</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">torsion</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">original_dihedral</span> <span class="o">=</span> <span class="n">calculate_dihedral_angle</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">original_xyz</span><span class="p">,</span> <span class="n">torsion</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_dihedral</span> <span class="o">-</span> <span class="n">previous_dihedral</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">preserve_params_in_scan</span><span class="p">[</span><span class="s1">&#39;dihedral&#39;</span><span class="p">]</span> \
                                <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_dihedral</span> <span class="o">-</span> <span class="n">original_dihedral</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">preserve_params_in_scan</span><span class="p">[</span><span class="s1">&#39;dihedral&#39;</span><span class="p">]:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">pivots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The rotor breaks the TS around pivots </span><span class="si">{</span><span class="n">pivots</span><span class="si">}</span><span class="s2">: In trajectory </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, the &quot;</span> \
                                      <span class="sa">f</span><span class="s2">&quot;dihedral angle is </span><span class="si">{</span><span class="n">current_dihedral</span><span class="si">}</span><span class="s2"> degrees, a &quot;</span> \
                                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">current_dihedral</span> <span class="o">-</span> <span class="n">previous_dihedral</span><span class="p">)</span><span class="si">}</span><span class="s2"> change relative to the previous &quot;</span> \
                                      <span class="sa">f</span><span class="s2">&quot;frame, and a </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">current_dihedral</span> <span class="o">-</span> <span class="n">original_dihedral</span><span class="p">)</span><span class="si">}</span><span class="s2"> change relative to &quot;</span> \
                                      <span class="sa">f</span><span class="s2">&quot;the original geometry.&quot;</span>
                            <span class="k">break</span>

        <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Cannot check that the dihedral angle of </span><span class="si">{</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1"> is consistent throughout rotor &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;scans without a .mol attribute&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="n">message</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">invalidate</span><span class="p">,</span> <span class="n">invalidation_reason</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">actions</span>

    <span class="k">return</span> <span class="n">invalidate</span><span class="p">,</span> <span class="n">invalidation_reason</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">actions</span></div>

<div class="viewcode-block" id="trsh_keyword_checkfile"><a class="viewcode-back" href="../../../api/trsh.html#arc.job.trsh.trsh_keyword_checkfile">[docs]</a><span class="k">def</span> <span class="nf">trsh_keyword_checkfile</span><span class="p">(</span><span class="n">job_status</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">couldnt_trsh</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the job requires removal of checkfile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;CheckFile&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keywords&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;checkfile=None&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
        <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;checkfile=None&#39;</span><span class="p">)</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">couldnt_trsh</span>
    <span class="k">elif</span> <span class="s1">&#39;checkfile=None&#39;</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">couldnt_trsh</span>

    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">couldnt_trsh</span></div>

<div class="viewcode-block" id="trsh_keyword_intaccuracy"><a class="viewcode-back" href="../../../api/trsh.html#arc.job.trsh.trsh_keyword_intaccuracy">[docs]</a><span class="k">def</span> <span class="nf">trsh_keyword_intaccuracy</span><span class="p">(</span><span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">couldnt_trsh</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the job requires change of 2 electron integral accuracy</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;int=(Acc2E=14)&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
        <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;int=(Acc2E=14)&#39;</span><span class="p">)</span>
        <span class="n">trsh_keyword</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;int=(Acc2E=14)&#39;</span><span class="p">)</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="s1">&#39;int=(Acc2E=14)&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trsh_keyword</span> <span class="ow">and</span> <span class="s1">&#39;int=(Acc2E=14)&#39;</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
        <span class="n">trsh_keyword</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;int=(Acc2E=14)&#39;</span><span class="p">)</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">couldnt_trsh</span></div>

<div class="viewcode-block" id="trsh_keyword_cartesian"><a class="viewcode-back" href="../../../api/trsh.html#arc.job.trsh.trsh_keyword_cartesian">[docs]</a><span class="k">def</span> <span class="nf">trsh_keyword_cartesian</span><span class="p">(</span><span class="n">job_status</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">couldnt_trsh</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the job requires change of cartesian coordinate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;InternalCoordinateError&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> \
                <span class="ow">and</span> <span class="s1">&#39;cartesian&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span> <span class="ow">and</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;opt&#39;</span><span class="p">:</span>
        <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cartesian&#39;</span><span class="p">)</span>
        <span class="n">trsh_keyword</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;opt=(cartesian)&#39;</span><span class="p">)</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="s1">&#39;cartesian&#39;</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span> <span class="ow">and</span> \
            <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">and</span> <span class="s1">&#39;cartesian&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trsh_keyword</span><span class="p">:</span>
        <span class="n">trsh_keyword</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;opt=(cartesian)&#39;</span><span class="p">)</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">couldnt_trsh</span></div>

<div class="viewcode-block" id="trsh_keyword_scf"><a class="viewcode-back" href="../../../api/trsh.html#arc.job.trsh.trsh_keyword_scf">[docs]</a><span class="k">def</span> <span class="nf">trsh_keyword_scf</span><span class="p">(</span><span class="n">job_status</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">couldnt_trsh</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the job requires change of scf</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scf_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;scf=\((.*?)\)&quot;</span> <span class="c1"># e.g., scf=(xqc,MaxCycle=1000), will match xqc,MaxCycle=1000</span>
    <span class="k">if</span> <span class="s1">&#39;SCF&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;scf=(qc)&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
        <span class="c1"># try both qc and nosymm</span>
        <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;scf=(qc)&#39;</span><span class="p">)</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="s1">&#39;SCF&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;scf=(NDamp=30)&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
        <span class="c1"># Switching off Pulay&#39;s Direct Inversion</span>
        <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;scf=(NDamp=30)&#39;</span><span class="p">)</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="s1">&#39;SCF&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;scf=(NoDIIS)&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
        <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;scf=(NoDIIS)&#39;</span><span class="p">)</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="s1">&#39;SCF&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;guess=INDO&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
        <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;guess=INDO&#39;</span><span class="p">)</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">trsh_keyword</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;guess=INDO&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s1">&#39;scf&#39;</span> <span class="ow">in</span> <span class="n">keyword</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">):</span>
        <span class="n">scf_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">match</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">scf_pattern</span><span class="p">,</span> <span class="n">element</span><span class="p">)]</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">scf_pattern</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">trsh_keyword</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;scf=(&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scf_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">couldnt_trsh</span></div>

<div class="viewcode-block" id="trsh_keyword_unconverged"><a class="viewcode-back" href="../../../api/trsh.html#arc.job.trsh.trsh_keyword_unconverged">[docs]</a><span class="k">def</span> <span class="nf">trsh_keyword_unconverged</span><span class="p">(</span><span class="n">job_status</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">couldnt_trsh</span><span class="p">,</span> <span class="n">fine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the job requires change of scf</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;Unconverged&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;fine&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fine</span><span class="p">:</span>
        <span class="c1"># try a fine grid for SCF and integral</span>
        <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;fine&#39;</span><span class="p">)</span>
        <span class="n">fine</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fine</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">fine</span><span class="p">,</span> <span class="n">couldnt_trsh</span></div>

<div class="viewcode-block" id="trsh_keyword_nosymm"><a class="viewcode-back" href="../../../api/trsh.html#arc.job.trsh.trsh_keyword_nosymm">[docs]</a><span class="k">def</span> <span class="nf">trsh_keyword_nosymm</span><span class="p">(</span><span class="n">job_status</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">couldnt_trsh</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the job requires change of nosymm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;NoSymm&#39;</span> <span class="ow">in</span> <span class="n">job_status</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;NoSymm&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">:</span>
        <span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NoSymm&#39;</span><span class="p">)</span>
        <span class="n">trsh_keyword</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nosymm&#39;</span><span class="p">)</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="s1">&#39;nosymm&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trsh_keyword</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="s1">&#39;NoSymm&#39;</span> <span class="ow">in</span> <span class="n">keyword</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">ess_trsh_methods</span><span class="p">):</span>
        <span class="n">trsh_keyword</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nosymm&#39;</span><span class="p">)</span>
        <span class="n">couldnt_trsh</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">trsh_keyword</span><span class="p">,</span> <span class="n">couldnt_trsh</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2024, Alon Grinberg Dana

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>