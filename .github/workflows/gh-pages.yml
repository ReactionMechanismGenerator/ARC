name: github pages

on:
  push:
    branches: [ main, docs ]
  pull_request:
    branches: [ main, docs ]
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ── clone ARC repo ───────────────────────────────────────────
      - name: Checkout ARC
        uses: actions/checkout@v4
        with:
          repository: ReactionMechanismGenerator/ARC
          path: ARC
          fetch-depth: 1

      # ── pull RMG sources ────────────────────────────────────────
      - name: Checkout RMG‑Py
        uses: actions/checkout@v4
        with:
          repository: ReactionMechanismGenerator/RMG-Py
          path: RMG-Py
          fetch-depth: 1

      - name: Checkout RMG‑database
        uses: actions/checkout@v4
        with:
          repository: ReactionMechanismGenerator/RMG-database
          path: RMG-database
          fetch-depth: 1

      # ── build‑only env ───────────────────────────────────────────
      - name: Set up micromamba (rmg_env)
        uses: mamba-org/setup-micromamba@v2
        with:
          environment-name: rmg_env
          environment-file: RMG-Py/environment.yml
          cache-environment: true
          cache-downloads: true
          generate-run-shell: false

      - name: Build RMG‑Py in rmg_env
        run: micromamba run -n rmg_env make -C RMG-Py -j"$(nproc)"

      # ── docs env (wrapper shell) ────────────────────────────────
      - name: Set up micromamba (arc_env)
        uses: mamba-org/setup-micromamba@v2
        with:
          environment-name: arc_env
          environment-file: ARC/environment.yml
          cache-environment: true
          cache-downloads: true

      # ── Complie ARC ──────────────────────
      - name: Build ARC in arc_env
        run: micromamba run -n arc_env make compile -C ARC -j"$(nproc)"
      
      # ── Install pyrdl ──────────────────────
      - name: Install pyrdl
        run: micromamba run -n arc_env make install-pyrdl -C ARC -j"$(nproc)"

      # ── minimal TeX for png‑math in Sphinx ──────────────────────
      - name: System TeX tools
        run: sudo apt-get update -y && sudo apt-get -y install texlive-latex-extra dvipng

      # ── add legacy ABI runtime for NumPy/PyDAS ─────────────────
      - name: Add legacy gfortran runtime
        run: micromamba install -y -n arc_env -c conda-forge libgfortran=3
        shell: micromamba-shell {0}

      # ── build HTML docs ─────────────────────────────────────────
      - name: Set env vars & Build docs
        run: |
          export RMG_PATH="$GITHUB_WORKSPACE/RMG-Py"
          export RMG_DB_PATH="$GITHUB_WORKSPACE/RMG-database"
          export PYTHONPATH="$GITHUB_WORKSPACE/RMG-Py:$GITHUB_WORKSPACE/ARC:$PYTHONPATH"
          export PATH="$GITHUB_WORKSPACE/ARC:$PATH"
          make -C ARC/docs html
        shell: micromamba-shell {0}

      - name: List built docs
        run: ls -R ARC/docs/build/html


      # ── deploy only on push ─────────────────────────────────────
      - name: Deploy to GitHub Pages
        if: github.event_name == 'push'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./ARC/docs/build/html/
